name: Quality Assurance Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'nanashi8.github.io/public/data/**'
      - 'nanashi8.github.io/src/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'nanashi8.github.io/public/data/**'
      - 'nanashi8.github.io/src/**'
      - 'scripts/**'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Run comprehensive quality validation
      id: validation
      run: |
        echo "ğŸ” å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å“è³ªæ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."
        python3 scripts/validate_all_content.py
        echo "validation_result=$?" >> $GITHUB_OUTPUT
    
    - name: Run UI specifications validation
      if: always()
      id: ui_validation
      run: |
        echo "ğŸ¨ UIä»•æ§˜æ›¸æº–æ‹ æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."
        python3 scripts/validate_ui_specifications.py
        echo "ui_validation_result=$?" >> $GITHUB_OUTPUT
    
    - name: Run detailed passage quality check
      if: always()
      id: passage_quality
      run: |
        echo "ğŸ“– é•·æ–‡ãƒ‘ãƒƒã‚»ãƒ¼ã‚¸è©³ç´°æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."
        python3 scripts/validate_passage_quality.py
        echo "passage_quality_result=$?" >> $GITHUB_OUTPUT
    
    - name: Check for quality regression
      if: always()
      run: |
        echo "ğŸ“Š å“è³ªä½ä¸‹ãƒã‚§ãƒƒã‚¯..."
        python3 scripts/check_quality_regression.py
    
    - name: Generate quality report
      if: always()
      run: |
        echo "ğŸ“ å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        python3 scripts/generate_quality_report.py --output quality_report.md
    
    - name: Comment PR with quality report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality_report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
    
    - name: Fail if quality standards not met
      if: steps.validation.outputs.validation_result != '0' || steps.ui_validation.outputs.ui_validation_result != '0'
      run: |
        echo "âŒ å“è³ªåŸºæº–æœªé”æˆã€‚æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚"
        if [ "${{ steps.validation.outputs.validation_result }}" != "0" ]; then
          echo "  - ãƒ‡ãƒ¼ã‚¿å“è³ªã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
        fi
        if [ "${{ steps.ui_validation.outputs.ui_validation_result }}" != "0" ]; then
          echo "  - UIä»•æ§˜æ›¸ã¸ã®æº–æ‹ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
        fi
        exit 1
