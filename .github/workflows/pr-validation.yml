name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PRå“è³ªæ¤œè¨¼
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            src/**/*.{ts,tsx,js,jsx}
            **/*.test.{ts,tsx,js,jsx}

      - name: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        run: |
          echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npm run type-check

      - name: ãƒªãƒ³ãƒˆï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ãƒˆå®Ÿè¡Œä¸­..."
          npm run lint

      - name: å½±éŸ¿ã™ã‚‹ãƒ†ã‚¹ãƒˆã®æ¤œå‡º
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ§ª å½±éŸ¿ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ¤œå‡ºä¸­..."
          npm run test:related -- ${{ steps.changed-files.outputs.all_changed_files }}

      - name: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‘½åãƒã‚§ãƒƒã‚¯
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

          # WordProgressã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä½¿ç”¨ã‚’æ¤œè¨¼
          FORBIDDEN_PROPS=$(grep -rn "progress\.\(correctCount\|incorrectCount\|attemptCount\)" src/ || true)

          if [ -n "$FORBIDDEN_PROPS" ]; then
            echo "::error::ç¦æ­¢ã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™"
            echo "::error::correctCount, incorrectCount, attemptCount ã¯ä½¿ç”¨ç¦æ­¢ã§ã™"
            echo "::error::ä»£ã‚ã‚Šã«ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:"
            echo "::error::  - memorizationCorrect, memorizationAttempts"
            echo "::error::  - translationCorrect, translationAttempts"
            echo "::error::  - spellingCorrect, spellingAttempts"
            echo "$FORBIDDEN_PROPS"
            exit 1
          fi

          echo "âœ… ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯æˆåŠŸ"

      - name: ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ” ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯..."

          # ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ã‚’æ¤œå‡º
          DUPLICATES=$(grep -rn "effectiveCorrect.*stillLearning.*0\.5" src/ | wc -l || true)

          if [ "$DUPLICATES" -gt 1 ]; then
            echo "::warning::ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡æ•°ç®‡æ‰€ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™"
            echo "::warning::src/ai/utils/categoryDetermination.ts ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
            grep -rn "effectiveCorrect.*stillLearning.*0\.5" src/
          fi

      - name: PRæ¤œè¨¼å®Œäº†
        run: |
          echo "âœ… ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼å®Œäº†"
          echo "- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.changed-files.outputs.all_changed_files_count }} files"
          echo "- å‹ãƒã‚§ãƒƒã‚¯: æˆåŠŸ"
          echo "- ãƒªãƒ³ãƒˆ: æˆåŠŸ"
          echo "- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‘½å: æˆåŠŸ"
