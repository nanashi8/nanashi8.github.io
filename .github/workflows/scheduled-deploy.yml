name: Scheduled Night Deploy

on:
  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST = UTC+9ã€ã¤ã¾ã‚ŠUTC 17:00ï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = JST 2:00

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå¤‰æ›´ãŒãªãã¦ã‚‚å®Ÿè¡Œï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write
  deployments: write

concurrency:
  group: 'scheduled-pages'
  cancel-in-progress: true

jobs:
  check-changes:
    name: å¤‰æ›´ç¢ºèª
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      last_deploy_sha: ${{ steps.check.outputs.last_deploy_sha }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 10

      - name: å‰å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‹ã‚‰ã®å¤‰æ›´ã‚’ç¢ºèª
        id: check
        run: |
          # å‰å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°ã‚’å–å¾—
          LAST_TAG=$(git tag --sort=-creatordate | grep -E '^deploy-' | head -n 1)

          if [ -z "$LAST_TAG" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤"
          else
            echo "last_deploy_sha=$(git rev-list -n 1 $LAST_TAG)" >> $GITHUB_OUTPUT

            # mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã¨æ¯”è¼ƒ
            CHANGES=$(git diff --name-only $LAST_TAG..HEAD -- ':!**.md' ':!docs/**' ':!.github/**' | wc -l)

            if [ "$CHANGES" -gt 0 ] || [ "${{ inputs.force_deploy }}" = "true" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦: $CHANGES ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´"
              git diff --name-only $LAST_TAG..HEAD -- ':!**.md' ':!docs/**' ':!.github/**'
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  å¤‰æ›´ãªã— - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—"
            fi
          fi

  quality-check:
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint check
        run: npm run lint:errors-only

      - name: CSS lint
        run: npm run lint:css

  build-and-deploy:
    name: ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      - name: Build
        run: npm run build

      - name: ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
        run: |
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—"
            exit 1
          fi

          SIZE=$(du -sh dist | cut -f1)
          echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ: $SIZE"

      - uses: actions/configure-pages@v4

      - uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°ä½œæˆ
        run: |
          TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG_NAME" -m "Deep night deployment at $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push origin "$TAG_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: é€šçŸ¥
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: needs.build-and-deploy.result == 'success'
        run: |
          echo "ğŸŒ™ æ·±å¤œãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "â° æ™‚åˆ»: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M JST')"
          echo "âœ… æœ¬ç•ªç’°å¢ƒæ›´æ–°æ¸ˆã¿"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
        if: needs.build-and-deploy.result == 'failure'
        run: |
          echo "âŒ æ·±å¤œãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          echo "âš ï¸  æ‰‹å‹•ã§ç¢ºèªãŒå¿…è¦ã§ã™"

  skip-notification:
    name: ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
    needs: check-changes
    if: needs.check-changes.outputs.has_changes != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: å¤‰æ›´ãªã—é€šçŸ¥
        run: |
          echo "â„¹ï¸  å‰å›ãƒ‡ãƒ—ãƒ­ã‚¤ã‹ã‚‰å¤‰æ›´ãªã—"
          echo "â­ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—"
