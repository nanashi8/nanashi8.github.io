name: Refactoring Safety Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
  push:
    branches: [main]
    paths:
      - 'src/**'

jobs:
  safety-check:
    runs-on: ubuntu-latest
    name: Validate code structure and integrity

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check src/ directory integrity
        id: check-src
        run: |
          SRC_COUNT=$(find src -type f 2>/dev/null | wc -l | tr -d ' ')
          echo "src_files=$SRC_COUNT" >> $GITHUB_OUTPUT

          if [ "$SRC_COUNT" -lt 100 ]; then
            echo "::error::âš ï¸ Only $SRC_COUNT files in src/ directory (expected: 100+)"
            echo "::error::This might indicate accidental file loss during refactoring"
            exit 1
          fi

          echo "âœ… src/ integrity check passed: $SRC_COUNT files"

      - name: Check for critical files
        run: |
          CRITICAL_FILES=(
            "src/App.tsx"
            "src/main.tsx"
            "index.html"
            "package.json"
            "vite.config.ts"
          )

          MISSING_FILES=()
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "::error::âŒ Critical files missing:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          fi

          echo "âœ… All critical files present"

      - name: Check for SimpleWord contamination
        run: |
          if git ls-files | grep -E '^SimpleWord/|\.xcodeproj|\.xcworkspace|\.swift$' | head -1; then
            echo "::error::âŒ SimpleWord iOS project files detected in git tracking"
            echo "::error::These files should not be in the web app repository"
            echo "::error::Please remove and add to .gitignore"
            exit 1
          fi

          echo "âœ… No SimpleWord contamination detected"

      - name: Verify TypeScript compilation
        run: npm run typecheck

      - name: Run linter
        run: npm run lint

      - name: Security audit - npm dependencies
        id: npm-audit
        run: |
          echo "ğŸ” Running npm audit for security vulnerabilities..."

          # Run npm audit with JSON output
          npm audit --json > npm-audit.json 2>&1 || true

          # Parse results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Security Audit Results:"
          echo "  ğŸ”´ CRITICAL: $CRITICAL"
          echo "  ğŸŸ  HIGH: $HIGH"
          echo "  ğŸŸ¡ MODERATE: $MODERATE"
          echo "  ğŸ”µ LOW: $LOW"

          # Check for critical vulnerabilities
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::âŒ CRITICAL security vulnerabilities found: $CRITICAL"
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::warning::âš ï¸ HIGH severity vulnerabilities found: $HIGH"
            echo "::warning::These should be fixed before production deployment"
          fi

      - name: Check for secret leaks (TruffleHog)
        id: secret-check
        run: |
          echo "ğŸ” Scanning for exposed secrets..."

          # Check for common secret patterns
          PATTERNS=(
            'api[_-]?key'
            'api[_-]?secret'
            'password'
            'token'
            'secret'
            'sentry[_-]?dsn'
          )

          FOUND=0
          for PATTERN in "${PATTERNS[@]}"; do
            if git log --all -p | grep -i "\"$PATTERN\".*:.*\"" | grep -v "\.example\|\.template" | head -1; then
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo "::warning::âš ï¸ Potential secret pattern detected in commit history"
            echo "::warning::Please verify no actual secrets are exposed"
            echo "::warning::See: https://docs.github.com/en/code-security/secret-scanning"
          else
            echo "âœ… No obvious secret patterns detected"
          fi

      - name: Build project
        run: npm run build

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "::error::âŒ Build output directory 'dist' not found"
            exit 1
          fi

          DIST_SIZE=$(du -sh dist | cut -f1)
          echo "âœ… Build successful: $DIST_SIZE"

      - name: Analyze file changes (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“Š Analyzing changes in this PR..."

          # Get base branch file count
          git checkout ${{ github.event.pull_request.base.sha }}
          BASE_COUNT=$(find src -type f 2>/dev/null | wc -l | tr -d ' ')

          # Get current file count
          git checkout ${{ github.event.pull_request.head.sha }}
          HEAD_COUNT=$(find src -type f 2>/dev/null | wc -l | tr -d ' ')

          DIFF=$((HEAD_COUNT - BASE_COUNT))

          echo "Base branch: $BASE_COUNT files"
          echo "This PR: $HEAD_COUNT files"
          echo "Difference: $DIFF files"

          # Check for large file deletions
          DELETED_COUNT=$(git diff --diff-filter=D --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep "^src/" | wc -l | tr -d ' ')

          if [ "$DELETED_COUNT" -gt 10 ]; then
            echo "::warning::âš ï¸ Large number of files deleted: $DELETED_COUNT"
            echo "::warning::Please verify this is intentional refactoring"
            echo ""
            echo "Deleted files:"
            git diff --diff-filter=D --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep "^src/" | head -20
          fi

          if [ "$DIFF" -lt -20 ]; then
            echo "::warning::âš ï¸ Significant file count decrease: $DIFF"
            echo "::warning::Ensure this is intentional consolidation, not accidental deletion"
          fi

      - name: Report status
        if: success()
        run: |
          echo "âœ… All safety checks passed"
          echo ""
          echo "Summary:"
          echo "- src/ files: ${{ steps.check-src.outputs.src_files }}"
          echo "- Critical files: Present"
          echo "- SimpleWord: Clean"
          echo "- Security - CRITICAL: ${{ steps.npm-audit.outputs.critical }}"
          echo "- Security - HIGH: ${{ steps.npm-audit.outputs.high }}"
          echo "- TypeScript: Compiled"
          echo "- Linter: Passed"
          echo "- Build: Success"

  checkpoint-reminder:
    runs-on: ubuntu-latest
    name: Remind about checkpoints
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR description for checkpoint
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR mentions checkpoint
            const hasCheckpoint = /checkpoint|ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ/i.test(body);

            if (!hasCheckpoint && pr.changed_files > 5) {
              const message = [
                '## ğŸ”’ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯',
                '',
                `ã“ã® PR ã¯ ${pr.changed_files} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚`,
                '',
                '### ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç¢ºèª',
                'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä½œæ¥­å‰ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã‹ï¼Ÿ',
                '',
                '```bash',
                './scripts/refactor-checkpoint.sh save phase2-[ä½œæ¥­å]',
                '```',
                '',
                '### æ¨å¥¨ã•ã‚Œã‚‹ç¢ºèªé …ç›®',
                '- [ ] ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆæ¸ˆã¿',
                '- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰æˆåŠŸ',
                '- [ ] æ®µéšçš„ã«ã‚³ãƒŸãƒƒãƒˆï¼ˆ1æ©Ÿèƒ½ = 1ã‚³ãƒŸãƒƒãƒˆï¼‰',
                '- [ ] `docs/processes/REFACTORING_SAFETY.md` ã®æ‰‹é †ã‚’ç¢ºèª',
                '',
                'è©³ç´°: [REFACTORING_SAFETY.md](../blob/main/docs/processes/REFACTORING_SAFETY.md)'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message
              });
            }
