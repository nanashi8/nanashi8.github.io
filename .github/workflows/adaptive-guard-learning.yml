name: é©å¿œçš„ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  - å¤±æ•—å­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      record-failure:
        description: 'å¤±æ•—ã‚’è¨˜éŒ²ã™ã‚‹ï¼ˆpatternId:errorMessage:testsFailedï¼‰'
        required: false
      record-recovery:
        description: 'å¾©æ—§ã‚’è¨˜éŒ²ã™ã‚‹ï¼ˆpatternIdï¼‰'
        required: false

jobs:
  test-and-learn:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨å¤±æ•—å­¦ç¿’
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: æ‰‹å‹•å¤±æ•—è¨˜éŒ²ï¼ˆworkflow_dispatchçµŒç”±ï¼‰
        if: github.event.inputs.record-failure
        run: |
          IFS=':' read -r PATTERN_ID ERROR_MSG TESTS_FAILED <<< "${{ github.event.inputs.record-failure }}"
          node scripts/analyze-failure-pattern.mjs record "$PATTERN_ID" "$ERROR_MSG" "$TESTS_FAILED"

      - name: æ‰‹å‹•å¾©æ—§è¨˜éŒ²ï¼ˆworkflow_dispatchçµŒç”±ï¼‰
        if: github.event.inputs.record-recovery
        run: |
          node scripts/analyze-failure-pattern.mjs recover "${{ github.event.inputs.record-recovery }}"

      - name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯
        id: type-check
        continue-on-error: true
        run: |
          npm run type-check 2>&1 | tee type-check.log

      - name: å‹ã‚¨ãƒ©ãƒ¼åˆ†æ
        if: steps.type-check.outcome == 'failure'
        run: |
          # Property does not exist ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
          if grep -q "Property .* does not exist on type" type-check.log; then
            echo "ğŸš¨ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            ERROR_MSG=$(grep "Property .* does not exist on type" type-check.log | head -1)
            node scripts/analyze-failure-pattern.mjs record "property-naming-error" "$ERROR_MSG" "0"

            # Instructionsæ›´æ–°
            node scripts/update-instructions.mjs update
          fi

      - name: ESLintå®Ÿè¡Œ
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: unit-test
        continue-on-error: true
        run: |
          npm run test:unit 2>&1 | tee test.log

      - name: ãƒ†ã‚¹ãƒˆå¤±æ•—åˆ†æ
        if: steps.unit-test.outcome == 'failure'
        run: |
          # ãƒ†ã‚¹ãƒˆå¤±æ•—æ•°ã‚’å–å¾—
          FAILED_COUNT=$(grep -oP '\d+(?= failed)' test.log | head -1 || echo "0")

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "ğŸš¨ ãƒ†ã‚¹ãƒˆå¤±æ•—æ¤œå‡º: ${FAILED_COUNT}ä»¶"

            # expected vs received ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºï¼ˆãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ã®å¯èƒ½æ€§ï¼‰
            if grep -q "expected.*received" test.log; then
              ERROR_MSG=$(grep "expected.*received" test.log | head -1)
              node scripts/analyze-failure-pattern.mjs record "refactoring-logic-change" "$ERROR_MSG" "$FAILED_COUNT"

              # Instructionsæ›´æ–°
              node scripts/update-instructions.mjs update
            fi
          fi

      - name: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        run: |
          node scripts/analyze-failure-pattern.mjs report

      - name: Instructionsè‡ªå‹•æ›´æ–°
        if: failure()
        run: |
          node scripts/update-instructions.mjs all

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ›´æ–°ï¼‰
        if: failure()
        run: |
          git config user.name "Adaptive Guard System"
          git config user.email "guard-system@example.com"

          git add .aitk/failure-patterns.json
          git add .aitk/instructions/adaptive-guard-system.instructions.md
          git add scripts/adaptive-guard-checks.sh

          if git diff --staged --quiet; then
            echo "â„¹ï¸  å¤‰æ›´ãªã—"
          else
            git commit -m "ğŸ¤– é©å¿œçš„ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ : å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’ [skip ci]"
            git push
          fi

      - name: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failure-patterns
          path: |
            .aitk/failure-patterns.json
            .aitk/instructions/adaptive-guard-system.instructions.md
            type-check.log
            test.log

      - name: åæ–‚çŠ¶æ…‹é€šçŸ¥
        if: always()
        run: |
          echo "ğŸ“Š é©å¿œçš„ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  - åæ–‚çŠ¶æ…‹"
          node scripts/analyze-failure-pattern.mjs report

  convergence-check:
    name: åæ–‚åˆ¤å®š
    needs: test-and-learn
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: åæ–‚åˆ¤å®š
        run: |
          node -e "
          const fs = require('fs');
          const patterns = JSON.parse(fs.readFileSync('.aitk/failure-patterns.json', 'utf-8'));
          const successRate = patterns.convergenceMetrics.currentSuccessRate;
          const threshold = patterns.metadata.convergenceThreshold;

          if (successRate >= threshold) {
            console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯åæ–‚ã—ã¾ã—ãŸ');
            console.log(\`æˆåŠŸç‡: \${(successRate * 100).toFixed(1)}%\`);
            process.exit(0);
          } else {
            console.log('ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ã¯å­¦ç¿’ä¸­ã§ã™');
            console.log(\`æˆåŠŸç‡: \${(successRate * 100).toFixed(1)}% / \${(threshold * 100).toFixed(1)}%\`);
            process.exit(0);
          }
          "
