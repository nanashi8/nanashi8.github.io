name: ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å¥åº·è¨ºæ–­

on:
  # æ¯é€±æœˆæ›œæ—¥ åˆå‰9æ™‚(JST)ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 1'  # UTC 0:00 = JST 9:00 (æœˆæ›œæ—¥)
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚‚å®Ÿè¡Œ
  pull_request:
    branches: [ main ]

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v6
      
    - name: ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­ã‚’å®Ÿè¡Œ
      id: health_check
      run: |
        chmod +x scripts/health-check.sh
        bash scripts/health-check.sh > health-report.txt 2>&1 || echo "HEALTH_CHECK_FAILED=true" >> $GITHUB_ENV
        cat health-report.txt
      continue-on-error: true
      
    - name: è¨ºæ–­çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: health-check-report
        path: health-report.txt
        retention-days: 30
        
    - name: å•é¡ŒãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆ
      if: steps.health_check.outputs.failed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('health-report.txt', 'utf8');
          
          const today = new Date().toISOString().split('T')[0];
          const title = `ğŸ¥ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å¿…è¦: ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­ (${today})`;
          
          const body = `## ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ
          
          å®šæœŸè¨ºæ–­ã§ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
          
          **å®Ÿè¡Œæ—¥æ™‚**: ${today}
          **å®Ÿè¡Œç’°å¢ƒ**: GitHub Actions
          
          ### ğŸ“‹ è¨ºæ–­çµæœ
          
          \`\`\`
          ${report}
          \`\`\`
          
          ### ğŸ”§ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          
          1. è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª: [docs/quality/HEALTH_CHECK_REPORT.md](../blob/main/docs/quality/HEALTH_CHECK_REPORT.md)
          2. å„ªå…ˆåº¦ã®é«˜ã„å•é¡Œã‹ã‚‰å¯¾å¿œã‚’é–‹å§‹
          3. å¯¾å¿œå®Œäº†å¾Œã« \`npm run health-check\` ã§å†è¨ºæ–­
          
          ### ğŸ“Š å„ªå…ˆåº¦ã‚¬ã‚¤ãƒ‰
          
          - ğŸ”´ **é«˜**: å‹å®šç¾©é‡è¤‡ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ â†’ å³åº§ã«å¯¾å¿œ
          - ğŸŸ¡ **ä¸­**: ãƒ•ã‚¡ã‚¤ãƒ«è‚¥å¤§åŒ–ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ â†’ 1-2é€±é–“ä»¥å†…
          - ğŸŸ¢ **ä½**: å‘½åè¦å‰‡ã€ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« â†’ æ¬¡å›ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ™‚
          
          ### âœ… å¯¾å¿œå¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          
          - [ ] æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’ç¢ºèª
          - [ ] å„ªå…ˆåº¦ã®é«˜ã„é …ç›®ã«å¯¾å¿œ
          - [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ \`npm run health-check\` ã‚’å®Ÿè¡Œ
          - [ ] å•é¡ŒãŒè§£æ¶ˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
          - [ ] ã“ã®ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          
          ---
          
          **è‡ªå‹•ç”Ÿæˆ**: GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ \`.github/workflows/health-check.yml\`
          **æ‰‹å‹•å®Ÿè¡Œ**: \`npm run health-check\`
          `;
          
          // æ—¢å­˜ã®æœªã‚¯ãƒ­ãƒ¼ã‚ºã®å¥åº·è¨ºæ–­ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’æ¤œç´¢
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'health-check,maintenance'
          });
          
          // æ—¢å­˜ã®ã‚¤ã‚·ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
          if (issues.data.length > 0) {
            const latestIssue = issues.data[0];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: latestIssue.number,
              body: `## ğŸ”„ æ–°ã—ã„è¨ºæ–­çµæœ (${today})\n\nå•é¡ŒãŒç¶™ç¶šã—ã¦æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n<details>\n<summary>æœ€æ–°ã®è¨ºæ–­çµæœã‚’è¡¨ç¤º</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>`
            });
            console.log(`æ—¢å­˜ã®ã‚¤ã‚·ãƒ¥ãƒ¼ #${latestIssue.number} ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
          } else {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check', 'maintenance', 'automated']
            });
            console.log(`æ–°ã—ã„ã‚¤ã‚·ãƒ¥ãƒ¼ #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
          }
      
    - name: è¨ºæ–­æˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if: steps.health_check.outputs.failed != 'true'
      run: |
        echo "âœ… ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­å®Œäº†: å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        echo "ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¯è‰¯å¥½ãªçŠ¶æ…‹ã§ã™ ğŸ‰"
