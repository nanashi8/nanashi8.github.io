name: å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹AI

on:
  # æ¯æ—¥åˆå‰3æ™‚ã«å®Ÿè¡Œï¼ˆJSTï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = JST 03:00

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'è‡ªå‹•ä¿®æ­£ã‚’é©ç”¨ã™ã‚‹'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry runãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿®æ­£ã‚’å®Ÿéš›ã«ã¯é©ç”¨ã—ãªã„ï¼‰'
        required: false
        type: boolean
        default: true

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          pip install -r config/requirements.txt || echo "config/requirements.txtãªã—"

      - name: å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹AIå®Ÿè¡Œ
        id: maintenance
        run: |
          python3 scripts/maintenance_ai.py \
            --verbose \
            ${{ github.event.inputs.auto_fix == 'true' && '--auto-fix' || '' }} \
            ${{ github.event.inputs.dry_run == 'false' && '--no-dry-run' || '' }}
        continue-on-error: true

      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’Artifactã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-report-${{ github.run_number }}
          path: maintenance_report.json
          retention-days: 30

      - name: Issueä½œæˆï¼ˆCRITICALå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('maintenance_report.json', 'utf8'));

            if (report.critical_issues > 0) {
              const criticalIssues = report.issues
                .filter(i => i.severity === 'CRITICAL')
                .map(i => `- **${i.category}**: ${i.description}`)
                .join('\n');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹AI: CRITICALå•é¡Œã‚’æ¤œå‡º`,
                body: `## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ

            å®Ÿè¡Œæ™‚åˆ»: ${report.timestamp}

            ### ğŸ“Š ã‚µãƒãƒªãƒ¼
            - ç·å•é¡Œæ•°: ${report.total_issues}
            - **CRITICAL**: ${report.critical_issues}
            - WARNING: ${report.warning_issues}
            - INFO: ${report.info_issues}

            ### âŒ CRITICALå•é¡Œ

            ${criticalIssues}

            ### ğŸ”§ å¯¾å‡¦æ–¹æ³•

            1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ \`python3 scripts/maintenance_ai.py --verbose\` ã‚’å®Ÿè¡Œ
            2. å•é¡Œã‚’ç¢ºèªãƒ»ä¿®æ­£
            3. è‡ªå‹•ä¿®æ­£ãŒå¯èƒ½ãªå ´åˆ: \`python3 scripts/maintenance_ai.py --auto-fix --no-dry-run\`

            è©³ç´°ã¯ [Artifact](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            `,
                labels: ['maintenance', 'critical', 'automated']
              });
            }

      # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰ã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
      # - name: Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      #   if: always()
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      #   run: |
      #     # SLACK_WEBHOOK_URL ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é€šçŸ¥ã‚’å®Ÿè¡Œ
      #     if [ -n "$SLACK_WEBHOOK_URL" ]; then
      #       REPORT=$(cat maintenance_report.json)
      #       CRITICAL=$(echo $REPORT | jq -r '.critical_issues')
      #       WARNING=$(echo $REPORT | jq -r '.warning_issues')
      #       curl -X POST "$SLACK_WEBHOOK_URL" \
      #         -H 'Content-Type: application/json' \
      #         -d "{\"text\": \"å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹AIå®Œäº†: CRITICAL=$CRITICAL, WARNING=$WARNING\"}"
      #     fi
