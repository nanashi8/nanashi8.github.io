name: Documentation Link Check

on:
  pull_request:
    paths:
      - '**.md'
      - 'docs/**'
      - '.aitk/instructions/**'
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'docs/**'

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'yes'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run advanced link analysis
        run: |
          echo "üîç Running advanced link analysis..."
          node scripts/analyze-doc-links.mjs

          # Êñ≠Á∑öÊï∞„ÇíÂèñÂæó
          BROKEN_COUNT=$(node scripts/analyze-doc-links.mjs | grep -oP '‚ùå Êñ≠Á∑ö„É™„É≥„ÇØ: \K\d+')
          echo "Found $BROKEN_COUNT broken links"

          # Ë®±ÂÆπÈñæÂÄ§ÔºàarchiveÂÜÖ„ÇÑfalse positiveÂê´„ÇÄÔºâ
          THRESHOLD=80
          if [ "$BROKEN_COUNT" -gt "$THRESHOLD" ]; then
            echo "‚ùå Too many broken links: $BROKEN_COUNT (threshold: $THRESHOLD)"
            exit 1
          fi

          echo "‚úÖ Link quality acceptable: $BROKEN_COUNT broken links"

      - name: Check docs integrity
        run: |
          echo "Checking for broken internal links..."
          # ÁßªÂãïÁ¶ÅÊ≠¢„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          CRITICAL_FILES=(
            "docs/guidelines/META_AI_TROUBLESHOOTING.md"
            "docs/guidelines/QUESTION_SCHEDULER_QUICK_GUIDE.md"
            "docs/specifications/QUESTION_SCHEDULER_SPEC.md"
            "docs/quality/QUESTION_SCHEDULER_QA_PIPELINE.md"
            "docs/references/NEW_HORIZON_OFFICIAL_UNIT_STRUCTURE.md"
          )

          MISSING_FILES=()
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ùå Critical files are missing:"
            printf '%s\n' "${MISSING_FILES[@]}"
            echo "These files are listed in docs/.donotmove and must not be moved."
            exit 1
          fi

          echo "‚úÖ All critical files exist"
