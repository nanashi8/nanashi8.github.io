name: Project Self-Healing

on:
  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11:00ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'ä¿®æ­£ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã™ã‚‹'
        required: false
        default: true
        type: boolean

jobs:
  self-heal:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç”¨

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: æ§‹é€ æ¤œè¨¼
      id: validate
      run: |
        echo "ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’æ¤œè¨¼ä¸­..."
        python3 scripts/validate_project_structure.py || echo "validation_failed=true" >> $GITHUB_OUTPUT

    - name: è‡ªå‹•ä¿®å¾©
      id: fix
      run: |
        echo "ğŸ”§ å•é¡Œã‚’è‡ªå‹•ä¿®å¾©ä¸­..."
        python3 scripts/auto_fix_project_structure.py

    - name: ä¿®å¾©å¾Œã®æ¤œè¨¼
      run: |
        echo "âœ… ä¿®å¾©çµæœã‚’æ¤œè¨¼ä¸­..."
        python3 scripts/validate_project_structure.py

    - name: Instructions ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°
      run: |
        echo "ğŸ“š Instructions ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ä¸­..."
        python3 -c "from scripts.auto_fix_project_structure import update_instructions_index; update_instructions_index()"

    - name: å¤‰æ›´ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      if: ${{ github.event.inputs.auto_commit != 'false' }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ¤– å¤‰æ›´ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆä¸­..."
          git add .
          git commit -m "ğŸ¤– è‡ªå‹•ä¿®å¾©: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®æœ€é©åŒ–

          - v2ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±åˆ
          - é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          - å¤ã„å‚ç…§ã®æ›´æ–°
          - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®æ•´ç†
          - Instructions ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°

          Generated by: Project Self-Healing Workflow"
          git push
          echo "âœ… è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
        else
          echo "âœ¨ ä¿®å¾©ä¸è¦ï¼ˆæ§‹é€ ã¯æ­£å¸¸ï¼‰"
        fi

    - name: é€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      if: failure()
      run: |
        echo "âŒ è‡ªå·±ä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
