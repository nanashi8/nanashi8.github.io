name: Servant Auto Learning

on:
  # æ¯Žæ—¥æ·±å¤œ2æ™‚ã«å®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“11æ™‚ = UTC 2æ™‚ï¼‰
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

  # å¤§é‡ã®pushãŒã‚ã£ãŸå ´åˆã‚‚å®Ÿè¡Œ
  push:
    branches:
      - main
    # 5ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šã®å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'

jobs:
  auto-learn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆå­¦ç¿’ã«å¿…è¦ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Git History Learning
        run: |
          echo "ðŸ§  Gitå±¥æ­´ã‹ã‚‰å­¦ç¿’ä¸­..."
          node scripts/learn-from-git-history.mjs

      - name: Run AI Failure Learning
        run: |
          echo "ðŸ›¡ï¸ AIå¤±æ•—å±¥æ­´ã‹ã‚‰å­¦ç¿’ä¸­..."
          node scripts/learn-from-ai-failures.mjs || echo "â„¹ï¸ AIå¤±æ•—å±¥æ­´ãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"

      - name: Check if learning is needed
        id: check
        run: |
          # å‰å›žã®å­¦ç¿’ã‹ã‚‰ä½•ã‚³ãƒŸãƒƒãƒˆã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
          LAST_LEARNING_COMMIT=$(git log --grep="auto-learn:" --format="%H" -1 || echo "")

          if [ -z "$LAST_LEARNING_COMMIT" ]; then
            # åˆå›žå­¦ç¿’
            COMMITS_SINCE=100
          else
            # å‰å›žå­¦ç¿’ã‹ã‚‰ã®ã‚³ãƒŸãƒƒãƒˆæ•°
            COMMITS_SINCE=$(git rev-list --count ${LAST_LEARNING_COMMIT}..HEAD)
          fi

          echo "commits_since=$COMMITS_SINCE" >> $GITHUB_OUTPUT

          # 10ã‚³ãƒŸãƒƒãƒˆä»¥ä¸Šã‚ã‚Œã°å­¦ç¿’å®Ÿè¡Œ
          if [ $COMMITS_SINCE -ge 10 ]; then
            echo "should_learn=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Š å‰å›žã®å­¦ç¿’ã‹ã‚‰${COMMITS_SINCE}ã‚³ãƒŸãƒƒãƒˆ â†’ å­¦ç¿’å®Ÿè¡Œ"
          else
            echo "should_learn=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Š å‰å›žã®å­¦ç¿’ã‹ã‚‰${COMMITS_SINCE}ã‚³ãƒŸãƒƒãƒˆ â†’ ã‚¹ã‚­ãƒƒãƒ—"
          fi

      - name: Run Git history learning
        if: steps.check.outputs.should_learn == 'true'
        run: |
          echo "ðŸ§  ã‚µãƒ¼ãƒãƒ³ãƒˆ: Gitå±¥æ­´ã‹ã‚‰å­¦ç¿’é–‹å§‹..."
          npm run guard:learn-history

      - name: Commit learned patterns
        if: steps.check.outputs.should_learn == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add .aitk/failure-patterns.json
            git add .aitk/instructions/adaptive-guard-system.instructions.md
            git add docs/GIT_HISTORY_LEARNING_REPORT.md
            git add scripts/adaptive-guard-checks.sh

            COMMITS_COUNT=${{ steps.check.outputs.commits_since }}

            COMMIT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "chore(auto-learn): ã‚µãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•å­¦ç¿’ï¼ˆ${COMMITS_COUNT}ã‚³ãƒŸãƒƒãƒˆåˆ†ï¼‰
            
            è‡ªå‹•å­¦ç¿’å®Ÿè¡Œ:
            - å‰å›žã®å­¦ç¿’ã‹ã‚‰${COMMITS_COUNT}ã‚³ãƒŸãƒƒãƒˆ
            - å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
            - Instructionsè‡ªå‹•æ›´æ–°
            - å­¦ç¿’ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            
            å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼: GitHub Actions
            å®Ÿè¡Œæ—¥æ™‚: ${COMMIT_DATE}"

            git push

            echo "âœ… å­¦ç¿’çµæžœã‚’ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          else
            echo "â„¹ï¸  å­¦ç¿’çµæžœã«å¤‰æ›´ãªã—"
          fi

      - name: Create summary
        if: steps.check.outputs.should_learn == 'true'
        run: |
          echo "## ðŸ›¡ï¸ ã‚µãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•å­¦ç¿’å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **å­¦ç¿’ã‚³ãƒŸãƒƒãƒˆæ•°**: ${{ steps.check.outputs.commits_since }}ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "docs/GIT_HISTORY_LEARNING_REPORT.md" ]; then
            echo "### ðŸ“‹ å­¦ç¿’çµæžœ" >> $GITHUB_STEP_SUMMARY
            head -30 docs/GIT_HISTORY_LEARNING_REPORT.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify if skipped
        if: steps.check.outputs.should_learn == 'false'
        run: |
          echo "## â„¹ï¸ ã‚µãƒ¼ãƒãƒ³ãƒˆå­¦ç¿’ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å‰å›žã®å­¦ç¿’ã‹ã‚‰${{ steps.check.outputs.commits_since }}ã‚³ãƒŸãƒƒãƒˆï¼ˆé–¾å€¤: 10ã‚³ãƒŸãƒƒãƒˆï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ¬¡å›žã®è‡ªå‹•å­¦ç¿’: æ˜Žæ—¥ 2:00 (JST)" >> $GITHUB_STEP_SUMMARY
