name: Test Coverage Report

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:unit:coverage || echo "No tests found yet"
        continue-on-error: true

      - name: Analyze coverage and suggest improvements
        id: analyze
        run: |
          echo "## üìä „ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà" > coverage-report.md
          echo "" >> coverage-report.md

          # „Ç´„Éê„É¨„ÉÉ„Ç∏„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            FUNCS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
            STMTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)

            echo "### ÁèæÂú®„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏" >> coverage-report.md
            echo "- üìù Lines: ${LINES}% (ÁõÆÊ®ô: 70%)" >> coverage-report.md
            echo "- üîß Functions: ${FUNCS}% (ÁõÆÊ®ô: 70%)" >> coverage-report.md
            echo "- üåø Branches: ${BRANCHES}% (ÁõÆÊ®ô: 70%)" >> coverage-report.md
            echo "- üìä Statements: ${STMTS}% (ÁõÆÊ®ô: 70%)" >> coverage-report.md
            echo "" >> coverage-report.md

            # Êé®Â•®„ÉÜ„Çπ„ÉàÊà¶Áï•
            echo "### üí° Êé®Â•®„ÉÜ„Çπ„ÉàÊà¶Áï•" >> coverage-report.md
            echo "" >> coverage-report.md
            echo "#### üéØ ÂÑ™ÂÖàÂ∫¶HIGHÔºàTDDÊé®Â•®Ôºâ" >> coverage-report.md
            echo "‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÅØ**„ÉÜ„Çπ„Éà„Éï„Ç°„Éº„Çπ„Éà**„ÅßÈñãÁô∫„Åô„Çã„Åì„Å®„ÇíÊé®Â•®:" >> coverage-report.md
            echo "- \`src/utils/*\` - „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ÔºàÁõÆÊ®ô100%Ôºâ" >> coverage-report.md
            echo "- \`src/features/*/\` - „Ç≥„Ç¢„É≠„Ç∏„ÉÉ„ÇØÔºàÁõÆÊ®ô90%Ôºâ" >> coverage-report.md
            echo "- \`src/ai/*/\` - AIÈñ¢ÈÄ£„Ç¢„É´„Ç¥„É™„Ç∫„É†ÔºàÁõÆÊ®ô90%Ôºâ" >> coverage-report.md
            echo "" >> coverage-report.md

            echo "#### ‚ö° ÂÑ™ÂÖàÂ∫¶MEDIUMÔºà„ÉÜ„Çπ„ÉàÊé®Â•®Ôºâ" >> coverage-report.md
            echo "- \`src/hooks/*\` - React HooksÔºàÁõÆÊ®ô80%Ôºâ" >> coverage-report.md
            echo "- \`src/storage/*\` - „Éá„Éº„ÇøÊ∞∏Á∂öÂåñÔºàÁõÆÊ®ô80%Ôºâ" >> coverage-report.md
            echo "" >> coverage-report.md

            echo "#### üì¶ ÂÑ™ÂÖàÂ∫¶LOWÔºàE2E„ÅßÂçÅÂàÜÔºâ" >> coverage-report.md
            echo "- \`src/components/*\` - UI„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàÁõÆÊ®ô60%Ôºâ" >> coverage-report.md
            echo "  - Playwright„Å´„Çà„ÇãÁµ±Âêà„ÉÜ„Çπ„Éà„ÅßÂçÅÂàÜ" >> coverage-report.md
            echo "  - Ë§áÈõë„Å™„É≠„Ç∏„ÉÉ„ÇØ„ÅÆ„Åø„É¶„Éã„ÉÉ„Éà„ÉÜ„Çπ„Éà" >> coverage-report.md
            echo "" >> coverage-report.md

            echo "### üêõ „Éê„Ç∞‰øÆÊ≠£„ÅÆÂøÖÈ†à„É´„Éº„É´" >> coverage-report.md
            echo "„Éê„Ç∞‰øÆÊ≠£ÊôÇ„ÅØ**ÂøÖ„Åö**‰ª•‰∏ã„ÅÆÊâãÈ†Ü„ÇíÂÆà„Å£„Å¶„Åè„Å†„Åï„ÅÑ:" >> coverage-report.md
            echo "1. „Éê„Ç∞„ÇíÂÜçÁèæ„Åô„Çã„ÉÜ„Çπ„Éà„ÇíÊõ∏„ÅèÔºàÂ§±Êïó„ÇíÁ¢∫Ë™çÔºâ" >> coverage-report.md
            echo "2. „Ç≥„Éº„Éâ„Çí‰øÆÊ≠£" >> coverage-report.md
            echo "3. „ÉÜ„Çπ„Éà„ÅåÈÄö„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç" >> coverage-report.md
            echo "4. „É™„Ç∞„É¨„ÉÉ„Ç∑„Éß„É≥Èò≤Ê≠¢ÂÆå‰∫Ü‚úÖ" >> coverage-report.md

            echo "lines=$LINES" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è „Ç´„Éê„É¨„ÉÉ„Ç∏„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" >> coverage-report.md
            echo "lines=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Comment PR with coverage report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('coverage-report.md', 'utf8');

            // Êó¢Â≠ò„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÊ§úÁ¥¢
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('„ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: Check coverage threshold
        run: |
          LINES=${{ steps.analyze.outputs.lines }}
          if (( $(echo "$LINES < 70" | bc -l) )); then
            echo "‚ö†Ô∏è „Ç´„Éê„É¨„ÉÉ„Ç∏„ÅåÁõÆÊ®ôÔºà70%Ôºâ„Çí‰∏ãÂõû„Å£„Å¶„ÅÑ„Åæ„Åô: ${LINES}%"
            echo "üí° ÈáçË¶Å„Å™„É≠„Ç∏„ÉÉ„ÇØ„Åã„ÇâÂÑ™ÂÖàÁöÑ„Å´„ÉÜ„Çπ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
          else
            echo "‚úÖ „Ç´„Éê„É¨„ÉÉ„Ç∏ÁõÆÊ®ôÈÅîÊàê: ${LINES}%"
          fi
