# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Deployment State Machine (Reusable)

on:
  workflow_call:
    inputs:
      state:
        required: true
        type: string
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹: manual | scheduled | auto | safe'
      skip-quality-check:
        required: false
        type: boolean
        default: false
        description: 'å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹'
      force:
        required: false
        type: boolean
        default: false
        description: 'å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå¤‰æ›´ãŒãªãã¦ã‚‚å®Ÿè¡Œï¼‰'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages-${{ inputs.state }}'
  cancel-in-progress: true

jobs:
  # State 1: Pre-deployment validation
  validate:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤æ¡ä»¶ã®æ¤œè¨¼
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.decision.outputs.should-deploy }}
      reason: ${{ steps.decision.outputs.reason }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å¤‰æ›´æ¤œå‡ºã®ãŸã‚

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¯å¦åˆ¤å®š
        id: decision
        run: |
          echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹: ${{ inputs.state }}"

          case "${{ inputs.state }}" in
            "manual")
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "reason=æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼" >> $GITHUB_OUTPUT
              ;;
            "scheduled")
              # å‰å›ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
              if [ "${{ inputs.force }}" == "true" ]; then
                echo "should-deploy=true" >> $GITHUB_OUTPUT
                echo "reason=å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤" >> $GITHUB_OUTPUT
              elif git diff --quiet HEAD~1 2>/dev/null; then
                echo "should-deploy=false" >> $GITHUB_OUTPUT
                echo "reason=å¤‰æ›´ãªã—" >> $GITHUB_OUTPUT
              else
                echo "should-deploy=true" >> $GITHUB_OUTPUT
                echo "reason=å¤‰æ›´æ¤œå‡º" >> $GITHUB_OUTPUT
              fi
              ;;
            "auto")
              # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿
              if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                echo "should-deploy=true" >> $GITHUB_OUTPUT
                echo "reason=mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push" >> $GITHUB_OUTPUT
              else
                echo "should-deploy=false" >> $GITHUB_OUTPUT
                echo "reason=mainãƒ–ãƒ©ãƒ³ãƒä»¥å¤–" >> $GITHUB_OUTPUT
              fi
              ;;
            "safe")
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "reason=å®‰å…¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‰‹å‹•æ‰¿èªå¾…ã¡ï¼‰" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "::error::Unknown state: ${{ inputs.state }}"
              exit 1
              ;;
          esac

      - name: åˆ¤å®šçµæœ
        run: |
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®š:"
          echo "- å®Ÿè¡Œ: ${{ steps.decision.outputs.should-deploy }}"
          echo "- ç†ç”±: ${{ steps.decision.outputs.reason }}"

  # State 2: Quality gate (optional)
  quality-gate:
    name: å“è³ªã‚²ãƒ¼ãƒˆ
    needs: validate
    if: needs.validate.outputs.should-deploy == 'true' && !inputs.skip-quality-check
    uses: ./.github/workflows/quality-strategy.yml
    with:
      strategy: build

  # State 3: Build
  build:
    name: ãƒ“ãƒ«ãƒ‰
    needs: [validate, quality-gate]
    if: needs.validate.outputs.should-deploy == 'true' && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-workspace

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: |
          echo "ğŸ”¨ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
          npm run build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  # State 4: Deploy
  deploy:
    name: GitHub Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: build
    if: |
      (inputs.state == 'safe' && github.event_name == 'workflow_dispatch') ||
      (inputs.state != 'safe')
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“¦ çŠ¶æ…‹: ${{ inputs.state }}"

  # State 5: Post-deployment validation (safe mode only)
  post-validation:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼
    needs: deploy
    if: inputs.state == 'safe'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ¥ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          # å®Ÿéš›ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ 
          echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
