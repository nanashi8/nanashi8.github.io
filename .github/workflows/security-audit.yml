name: Security Audit

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST (00:00 UTC)
    - cron: '0 0 * * 1'
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [main]
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        id: audit
        run: |
          echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ" > audit-report.md
          echo "" >> audit-report.md
          
          # npm audit ã‚’å®Ÿè¡Œï¼ˆJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
          npm audit --json > audit.json || true
          
          # æ·±åˆ»åº¦ã‚’é›†è¨ˆ
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit.json)
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
          
          echo "**æ·±åˆ»åº¦åˆ¥ã®è„†å¼±æ€§æ•°**:" >> audit-report.md
          echo "- ğŸ”´ Critical: $CRITICAL" >> audit-report.md
          echo "- ğŸŸ  High: $HIGH" >> audit-report.md
          echo "- ğŸŸ¡ Moderate: $MODERATE" >> audit-report.md
          echo "- ğŸŸ¢ Low: $LOW" >> audit-report.md
          echo "" >> audit-report.md
          
          # è©³ç´°ã‚’è¿½åŠ 
          echo "<details><summary>è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</summary>" >> audit-report.md
          echo "" >> audit-report.md
          echo '```' >> audit-report.md
          npm audit >> audit-report.md || true
          echo '```' >> audit-report.md
          echo "</details>" >> audit-report.md
          
          # ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "total=$(($CRITICAL + $HIGH + $MODERATE))" >> $GITHUB_OUTPUT

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.md
          retention-days: 30

      - name: Check for critical/high vulnerabilities
        if: steps.audit.outputs.critical > 0 || steps.audit.outputs.high > 0
        run: |
          echo "âŒ Critical ã¾ãŸã¯ High ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "Critical: ${{ steps.audit.outputs.critical }}"
          echo "High: ${{ steps.audit.outputs.high }}"
          echo ""
          echo "ğŸ’¡ ä¿®æ­£æ–¹æ³•:"
          echo "  npm audit fix"
          echo "  ã¾ãŸã¯"
          echo "  npm audit fix --force ï¼ˆç ´å£Šçš„å¤‰æ›´ã‚’å«ã‚€ï¼‰"
          exit 1

      - name: Comment PR (if PR)
        if: github.event_name == 'pull_request' && steps.audit.outputs.total > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Create issue (if scheduled and vulnerabilities found)
        if: github.event_name == 'schedule' && steps.audit.outputs.total > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            const total = ${{ steps.audit.outputs.total }};
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º: ${total}ä»¶`,
              body: report,
              labels: ['security', 'dependencies']
            });

      - name: Summary
        run: |
          echo "### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${{ steps.audit.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "- High: ${{ steps.audit.outputs.high }}" >> $GITHUB_STEP_SUMMARY
          echo "- Moderate: ${{ steps.audit.outputs.moderate }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.audit.outputs.total }}" -eq "0" ]; then
            echo "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
