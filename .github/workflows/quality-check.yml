# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: å“è³ªä¿è¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆStrategy Patterné©ç”¨ç‰ˆï¼‰

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™:
# - Strategy Pattern: å“è³ªãƒã‚§ãƒƒã‚¯æˆ¦ç•¥ã‚’åˆ†é›¢
# - Composite Action: å…±é€šå‡¦ç†ã‚’å†åˆ©ç”¨å¯èƒ½ã«
# - Matrix Strategy: ä¸¦åˆ—å®Ÿè¡Œã§é«˜é€ŸåŒ–

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Strategy Pattern: è¤‡æ•°ã®å“è³ªãƒã‚§ãƒƒã‚¯æˆ¦ç•¥ã‚’ä¸¦åˆ—å®Ÿè¡Œ
  quality-checks:
    strategy:
      matrix:
        check: [lint, css, build, test, security]
      fail-fast: false  # å…¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

    name: ${{ matrix.check }}
    uses: nanashi8/nanashi8.github.io/.github/workflows/quality-strategy.yml@main
    with:
      strategy: ${{ matrix.check }}


  # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼ˆtestæˆ¦ç•¥æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  coverage:
    needs: quality-checks
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-workspace

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆ
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          npm run test:coverage

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  integration-test:
    needs: quality-checks
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-workspace

      - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run test:integration || {
            echo "::warning::çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 0
          }

  # å¯¾ç—‡ç™‚æ³•æ¤œçŸ¥
  anti-pattern-check:
    needs: quality-checks
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸš« å¯¾ç—‡ç™‚æ³•æ¤œçŸ¥ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” å¯¾ç—‡ç™‚æ³•çš„ä¿®æ­£ã‚’æ¤œçŸ¥ä¸­..."
          chmod +x scripts/check-symptomatic-fixes.sh
          ./scripts/check-symptomatic-fixes.sh || {
            echo "::error::å¯¾ç—‡ç™‚æ³•çš„ãªä¿®æ­£ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "è©³ç´°: docs/guidelines/NO_SYMPTOMATIC_FIXES_POLICY.md"
            exit 1
          }

  # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
  report:
    needs: [quality-checks, coverage, integration-test, anti-pattern-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†é€šçŸ¥
        run: |
          echo "âœ… å“è³ªãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"
          echo "- ESLint: ${{ needs.quality-checks.result }}"
          echo "- Stylelint: ${{ needs.quality-checks.result }}"
          echo "- TypeScript & Build: ${{ needs.quality-checks.result }}"
          echo "- Unit Test: ${{ needs.quality-checks.result }}"
          echo "- Security: ${{ needs.quality-checks.result }}"
          echo "- Coverage: ${{ needs.coverage.result }}"
          echo "- Integration Test: ${{ needs.integration-test.result }}"
          echo "- Anti-pattern Check: ${{ needs.anti-pattern-check.result }}"


