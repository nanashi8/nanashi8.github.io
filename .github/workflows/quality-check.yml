name: å“è³ªä¿è¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality-check:
    name: å‹ãƒã‚§ãƒƒã‚¯ãƒ»ãƒªãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” TypeScriptå‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          npm run type-check || {
            echo "::error::TypeScriptå‹ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "::error::src/storage/progress/types.ts ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }
          echo "âœ… å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"

      - name: ESLintå®Ÿè¡Œ
        run: |
          echo "ğŸ” ESLintå®Ÿè¡Œä¸­..."
          npm run lint || {
            echo "::error::ESLintã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "::error::npm run lint:fix ã§è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œã—ã¦ãã ã•ã„"
            exit 1
          }
          echo "âœ… ãƒªãƒ³ãƒˆæˆåŠŸ"

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run test:unit
          echo "âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸ"

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆ
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          npm run test:coverage

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          npm run test:integration || {
            echo "::warning::çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 0
          }

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results/

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-screenshots
          path: playwright-report/

      - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†é€šçŸ¥
        if: success()
        run: |
          echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "- TypeScriptå‹ãƒã‚§ãƒƒã‚¯: æˆåŠŸ"
          echo "- ESLint: æˆåŠŸ"
          echo "- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: æˆåŠŸ"
          echo "- ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ: ç”Ÿæˆå®Œäº†"
