name: DocPart - Document Component Validation

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'docs/_components.yaml'
      - 'scripts/docpart/**'
      - '.docpartrc.yaml'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/_components.yaml'

jobs:
  validate-components:
    name: Validate Document Components
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check _components.yaml exists
        id: check-components
        run: |
          if [ -f "docs/_components.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run DocPart lint
        if: steps.check-components.outputs.exists == 'true'
        run: npm run docpart:lint
        continue-on-error: false

      - name: Generate dependency graph
        if: steps.check-components.outputs.exists == 'true'
        run: npm run docpart:graph

      - name: Check for graph changes
        if: steps.check-components.outputs.exists == 'true'
        run: |
          if [ -n "$(git status --porcelain docs/_graph.*)" ]; then
            echo "‚ö†Ô∏è  Dependency graph has changed. Review docs/_graph.mmd"
            git diff docs/_graph.mmd | head -50
          fi

      - name: Upload graph artifacts
        if: steps.check-components.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: |
            docs/_graph.mmd
            docs/_graph.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.check-components.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // _graph.json „ÇíË™≠„ÅøËæº„Çì„ÅßÁµ±Ë®à„ÇíÂèñÂæó
            let stats = 'Graph statistics not available';
            try {
              const graphData = JSON.parse(fs.readFileSync('docs/_graph.json', 'utf8'));
              const nodesByType = {};
              graphData.nodes.forEach(node => {
                nodesByType[node.type] = (nodesByType[node.type] || 0) + 1;
              });

              stats = `
              **Document Component Statistics**

              - Total components: ${graphData.nodes.length}
              - Total dependencies: ${graphData.edges.length}

              Component types:
              ${Object.entries(nodesByType).map(([type, count]) => `  - ${type}: ${count}`).join('\n')}

              üìä [View dependency graph](../actions/runs/${{ github.run_id }})
              `;
            } catch (e) {
              console.log('Failed to read graph data:', e);
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üì¶ Document Component Validation

              ‚úÖ Document components validated successfully!

              ${stats}

              üí° **Tips:**
              - Download the graph artifacts to visualize dependencies
              - Open \`docs/_graph.mmd\` in VS Code with Mermaid Preview
              - Run \`npm run docpart:lint\` locally for detailed validation
              `
            });

  warn-if-no-components:
    name: Check for _components.yaml
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if _components.yaml exists
        id: check
        run: |
          if [ ! -f "docs/_components.yaml" ]; then
            echo "missing=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment if missing
        if: steps.check.outputs.missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ÑπÔ∏è Document Component System Not Initialized

              \`docs/_components.yaml\` is not found. To enable document component tracking:

              \`\`\`bash
              npm run docpart:init
              git add docs/_components.yaml
              git commit -m "docs: initialize document component system"
              \`\`\`

              This will enable:
              - Dependency tracking between documents
              - Automatic link validation
              - Dependency graph visualization

              See [\`docs/design/DOCPART_SPECIFICATION.md\`](../blob/main/docs/design/DOCPART_SPECIFICATION.md) for details.
              `
            });
