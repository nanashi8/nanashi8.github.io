var M=Object.defineProperty;var v=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var l=(e,t,n)=>v(e,typeof t!="symbol"?t+"":t,n);import{s as A,d as f,t as b,a as y,e as T,b as D}from"./index-C0XiAais.js";import"./chart-vendor-Eu4deRvW.js";import"./react-vendor-C14am9Lm.js";const h="ml-answer-confidence-v1",x=12e4;function R(e){return Number.isFinite(e)?Math.max(0,Math.min(1,e)):0}function z(e){const t=new Uint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return btoa(n)}function F(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}class I{constructor(t){l(this,"model",null);l(this,"inputDim");l(this,"trainCount",0);l(this,"loading",null);this.inputDim=t}async ensureInitialized(){if(!this.model){if(this.loading)return this.loading;this.loading=(async()=>{const t=A({layers:[f({inputShape:[this.inputDim],units:16,activation:"relu",kernelInitializer:"glorotUniform"}),f({units:8,activation:"relu"}),f({units:1,activation:"sigmoid"})]});t.compile({optimizer:b.adam(.001),loss:"binaryCrossentropy",metrics:["accuracy"]}),this.model=t,await this.loadFromLocalStorage()})(),await this.loading}}predict(t){if(!this.model)return{pCorrect:.5};if(!Array.isArray(t)||t.length!==this.inputDim)return{pCorrect:.5};const n=y([t],[1,this.inputDim]),i=this.model.predict(n),r=i.dataSync()[0]??.5;return n.dispose(),i.dispose(),{pCorrect:R(r)}}async learn(t,n){if(!this.model||!Array.isArray(t)||t.length!==this.inputDim)return;const i=y([t],[1,this.inputDim]),r=y([[n?1:0]],[1,1]);try{await this.model.fit(i,r,{epochs:1,batchSize:1,shuffle:!1,verbose:0}),this.trainCount+=1,this.trainCount%10===0&&await this.saveToLocalStorage()}catch{}finally{i.dispose(),r.dispose()}}async saveToLocalStorage(){if(this.model&&!(typeof localStorage>"u"))try{const n=this.model.getWeights().map((a,u)=>({name:`w${u}`,tensor:a})),{data:i,specs:r}=await T(n),s={version:1,savedAt:Date.now(),specs:r,dataB64:z(i),meta:{trainCount:this.trainCount}},c=JSON.stringify(s);if(c.length>x){try{localStorage.removeItem(h)}catch{}return}localStorage.setItem(h,c)}catch{}}async loadFromLocalStorage(){var t;if(this.model&&!(typeof localStorage>"u"))try{const n=localStorage.getItem(h);if(!n)return;const i=JSON.parse(n);if(!i||i.version!==1||!Array.isArray(i.specs)||typeof i.dataB64!="string")return;const r=F(i.dataB64),s=await D(r,i.specs),c=this.model.getWeights(),a=c.map((u,m)=>s[`w${m}`]).filter(Boolean);a.length===c.length&&(this.model.setWeights(a),this.trainCount=((t=i.meta)==null?void 0:t.trainCount)??this.trainCount)}catch{try{localStorage.removeItem(h)}catch{}}}}let g=null;function B(e){return g||(g=new I(e)),g}function o(e){return Number.isFinite(e)?Math.max(0,Math.min(1,e)):0}function p(e){const t=o(e);return t<.2?1:t<.4?2:t<.6?3:t<.8?4:5}function d(e,t,n=0){return!Number.isFinite(e)||!Number.isFinite(t)||t===0?n:e/t}function L(e){const t=e.progress,n=(t==null?void 0:t.memorizationAttempts)??(t==null?void 0:t.totalAttempts)??0,i=(t==null?void 0:t.memorizationCorrect)??(t==null?void 0:t.correctCount)??0,r=(t==null?void 0:t.incorrectCount)??0,s=(t==null?void 0:t.consecutiveCorrect)??0,c=n>0?i/n:.5,a=t!=null&&t.lastStudied?(e.timestamp-(t.lastStudied??0))/864e5:999,u=(t==null?void 0:t.averageResponseTime)??3e3,m=new Date(e.timestamp),C=m.getHours(),w=m.getDay(),S=Math.log10(Math.max(50,e.responseTimeMs))/4;return[o(S),o(C/23),o(w/6),o(d(n,50,0)),o(c),o(d(s,10,0)),o(d(r,20,0)),o(d(a,30,1)),o(Math.log10(Math.max(50,u))/4),o(d((t==null?void 0:t.difficultyScore)??0,1,0))]}function N(e){var a,u;if(!e.wasCorrect)return{confidence5:1,score01:0,source:"heuristic"};const t=((a=e.progress)==null?void 0:a.averageResponseTime)??3e3,n=t>0?t/Math.max(200,e.responseTimeMs):1,i=o(Math.log2(Math.max(.25,Math.min(4,n)))/2+.5),r=((u=e.progress)==null?void 0:u.consecutiveCorrect)??0,s=o(r/6),c=o(.65*i+.35*s);return{confidence5:p(c),score01:c,source:"heuristic"}}async function E(e){const t=e.timestamp??Date.now();if(!e.wasCorrect)return{confidence5:1,score01:0,source:"deep"};const n=L({progress:e.progress,responseTimeMs:e.responseTimeMs,timestamp:t});try{const i=B(n.length);await i.ensureInitialized();const r=i.predict(n),s=o(r.pCorrect);return i.learn(n,e.wasCorrect).catch(()=>{}),{confidence5:p(s),score01:s,source:"deep"}}catch{return N({progress:e.progress,wasCorrect:e.wasCorrect,responseTimeMs:e.responseTimeMs})}}export{E as estimateConfidence5};
//# sourceMappingURL=answerConfidence5-CVw27QPR.js.map
