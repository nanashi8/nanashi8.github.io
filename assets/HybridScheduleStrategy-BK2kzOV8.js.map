{"version":3,"file":"HybridScheduleStrategy-BK2kzOV8.js","sources":["../../src/ai/scheduler/strategies/HybridScheduleStrategy.ts"],"sourcesContent":["/**\n * HybridScheduleStrategy - ハイブリッドモードのスケジューリング戦略\n *\n * 既存AIの順序を尊重しながら、Position計算とDTAを適用する戦略\n *\n * 【特徴】\n * - 既存のAI優先度を保持\n * - Position分散を有効化（hybridMode=false設定）\n * - 復習単語（incorrect/still_learning）を確実に上位配置\n *\n * 【使用例】\n * ```typescript\n * const strategy = new HybridScheduleStrategy(dependencies);\n * const result = await strategy.schedule(context);\n * ```\n */\n\nimport type { ScheduleResult, PrioritizedQuestion as PQ } from '../types';\nimport type { ScheduleContext } from './ScheduleStrategy';\nimport { BaseScheduleStrategy } from './ScheduleStrategy';\nimport { logger } from '@/utils/logger';\n\nexport class HybridScheduleStrategy extends BaseScheduleStrategy {\n  /**\n   * ハイブリッドモードでスケジューリング\n   *\n   * @param context - スケジューリングコンテキスト\n   * @returns スケジューリング結果\n   */\n  async schedule(context: ScheduleContext): Promise<ScheduleResult> {\n    const { params, startTime, dependencies } = context;\n    const scheduler = dependencies.scheduler; // QuestionScheduler（Context）\n\n    this.log('ハイブリッドモード開始', {\n      questionCount: params.questions.length,\n      mode: params.mode,\n    });\n\n    // 1. コンテキスト構築\n    const scheduleContext = scheduler.buildContext(params);\n\n    // 2. シグナル検出\n    const signals = scheduler.detectSignals(scheduleContext);\n\n    // 3. 優先度計算（hybridMode=false でPosition分散を有効化）\n    const prioritized: PQ[] = scheduler.calculatePriorities(\n      params.questions,\n      scheduleContext,\n      signals,\n      false // hybridMode=false → Position分散有効\n    );\n\n    // 4. 振動防止フィルター適用\n    const filtered: PQ[] = scheduler.applyAntiVibration(prioritized, scheduleContext);\n\n    // 5. ソート・バランス調整\n    const sorted: PQ[] = scheduler.sortAndBalance(filtered, params, scheduleContext);\n\n    // 6. 後処理\n    const questions = scheduler.postProcess(sorted, scheduleContext);\n\n    // 7. 振動スコア計算\n    const vibrationScore = dependencies.antiVibration.calculateVibrationScore(\n      sorted,\n      scheduleContext.recentAnswers,\n      20\n    );\n\n    // 8. デバッグ情報\n    const incorrectQuestions = sorted.filter((pq: PQ) => pq.position >= 70);\n    const stillLearningQuestions = sorted.filter(\n      (pq: PQ) => pq.position >= 40 && pq.position < 70\n    );\n    const reviewNeeded = incorrectQuestions.length + stillLearningQuestions.length;\n    const totalQuestions = sorted.length;\n\n    logger.info('[HybridScheduleStrategy] 優先単語配置完了', {\n      incorrectWords: incorrectQuestions.slice(0, 5).map((pq: PQ) => pq.question.word),\n      stillLearningWords: stillLearningQuestions.slice(0, 5).map((pq: PQ) => pq.question.word),\n      incorrectCount: incorrectQuestions.length,\n      stillLearningCount: stillLearningQuestions.length,\n      otherCount: totalQuestions - reviewNeeded,\n      reviewRatio:\n        totalQuestions > 0 ? `${((reviewNeeded / totalQuestions) * 100).toFixed(0)}%` : '0%',\n      top5: sorted.slice(0, 5).map((pq: PQ) => `${pq.question.word}(${pq.status?.category})`),\n    });\n\n    const processingTime = performance.now() - startTime;\n\n    logger.info(`[HybridScheduleStrategy] スケジューリング完了`, {\n      processingTime: Math.round(processingTime) + 'ms',\n      vibrationScore,\n      incorrectCount: incorrectQuestions.length,\n      stillLearningCount: stillLearningQuestions.length,\n      totalCount: questions.length,\n    });\n\n    return this.buildResult(sorted, {\n      source: 'HybridScheduleStrategy',\n      elapsed: processingTime,\n      vibrationScore,\n      signalCount: signals.length,\n    });\n  }\n}\n"],"names":["HybridScheduleStrategy","BaseScheduleStrategy","context","params","startTime","dependencies","scheduler","scheduleContext","signals","prioritized","filtered","sorted","questions","vibrationScore","incorrectQuestions","pq","stillLearningQuestions","reviewNeeded","totalQuestions","logger","_a","processingTime"],"mappings":"iKAsBO,MAAMA,UAA+BC,CAAqB,CAO/D,MAAM,SAASC,EAAmD,CAChE,KAAM,CAAE,OAAAC,EAAQ,UAAAC,EAAW,aAAAC,CAAA,EAAiBH,EACtCI,EAAYD,EAAa,UAE/B,KAAK,IAAI,cAAe,CACtB,cAAeF,EAAO,UAAU,OAChC,KAAMA,EAAO,IAAA,CACd,EAGD,MAAMI,EAAkBD,EAAU,aAAaH,CAAM,EAG/CK,EAAUF,EAAU,cAAcC,CAAe,EAGjDE,EAAoBH,EAAU,oBAClCH,EAAO,UACPI,EACAC,EACA,EAAA,EAIIE,EAAiBJ,EAAU,mBAAmBG,EAAaF,CAAe,EAG1EI,EAAeL,EAAU,eAAeI,EAAUP,EAAQI,CAAe,EAGzEK,EAAYN,EAAU,YAAYK,EAAQJ,CAAe,EAGzDM,EAAiBR,EAAa,cAAc,wBAChDM,EACAJ,EAAgB,cAChB,EAAA,EAIIO,EAAqBH,EAAO,OAAQI,GAAWA,EAAG,UAAY,EAAE,EAChEC,EAAyBL,EAAO,OACnCI,GAAWA,EAAG,UAAY,IAAMA,EAAG,SAAW,EAAA,EAE3CE,EAAeH,EAAmB,OAASE,EAAuB,OAClEE,EAAiBP,EAAO,OAE9BQ,EAAO,KAAK,oCAAqC,CAC/C,eAAgBL,EAAmB,MAAM,EAAG,CAAC,EAAE,IAAKC,GAAWA,EAAG,SAAS,IAAI,EAC/E,mBAAoBC,EAAuB,MAAM,EAAG,CAAC,EAAE,IAAKD,GAAWA,EAAG,SAAS,IAAI,EACvF,eAAgBD,EAAmB,OACnC,mBAAoBE,EAAuB,OAC3C,WAAYE,EAAiBD,EAC7B,YACEC,EAAiB,EAAI,IAAKD,EAAeC,EAAkB,KAAK,QAAQ,CAAC,CAAC,IAAM,KAClF,KAAMP,EAAO,MAAM,EAAG,CAAC,EAAE,IAAKI,GAAA,OAAW,SAAGA,EAAG,SAAS,IAAI,KAAIK,EAAAL,EAAG,SAAH,YAAAK,EAAW,QAAQ,IAAG,CAAA,CACvF,EAED,MAAMC,EAAiB,YAAY,IAAA,EAAQjB,EAE3C,OAAAe,EAAO,KAAK,sCAAuC,CACjD,eAAgB,KAAK,MAAME,CAAc,EAAI,KAC7C,eAAAR,EACA,eAAgBC,EAAmB,OACnC,mBAAoBE,EAAuB,OAC3C,WAAYJ,EAAU,MAAA,CACvB,EAEM,KAAK,YAAYD,EAAQ,CAC9B,OAAQ,yBACR,QAASU,EACT,eAAAR,EACA,YAAaL,EAAQ,MAAA,CACtB,CACH,CACF"}