const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HybridScheduleStrategy-BFSVRB6t.js","assets/ScheduleStrategy-BFw-1z1Q.js","assets/index-aXzsyY-c.js","assets/chart-vendor-Eu4deRvW.js","assets/react-vendor-C14am9Lm.js","assets/index-CXDNW-zE.css"])))=>i.map(i=>d[i]);
import{P as F,_ as D,p as E,G as L,w as z,l as q}from"./index-aXzsyY-c.js";import{B as V}from"./ScheduleStrategy-BFw-1z1Q.js";import"./chart-vendor-Eu4deRvW.js";import"./react-vendor-C14am9Lm.js";class W extends V{async schedule(y){var k;const{params:o,startTime:I,dependencies:c}=y,l=c.scheduler;this.log("FinalPriorityモード開始",{questionCount:o.questions.length,mode:o.mode});const i=l.buildContext(o),T=l.detectSignals(i),m=l.loadProgressCache(),u=(m==null?void 0:m.wordProgress)??{},f=o.mode==="grammar"?"grammar":o.mode==="memorization"?"memorization":"comprehensive",O=(o.sessionStats.correct||0)+(o.sessionStats.incorrect||0)+(o.sessionStats.still_learning||0)+(o.sessionStats.mastered||0);let S=0,h=0,P=0,w=0;for(const t of Object.values(u)){const s=new F(o.mode).calculate(t);s>=70?P++:s>=40?h++:s>=20?w++:S++}const b={totalAttempts:O,correctAnswers:o.sessionStats.correct||0,incorrectAnswers:o.sessionStats.incorrect||0,stillLearningAnswers:o.sessionStats.still_learning||0,sessionStartTime:i.sessionStartTime,sessionDuration:o.sessionStats.duration||0,consecutiveIncorrect:0,masteredCount:S,stillLearningCount:h,incorrectCount:P,newCount:w,consecutiveCorrect:o.sessionStats.consecutiveCorrect||0};if(!c.aiCoordinator){this.logError("AICoordinatorが未初期化、ハイブリッドモードにフォールバック");const t=await D(()=>import("./HybridScheduleStrategy-BFSVRB6t.js"),__vite__mapDeps([0,1,2,3,4,5])).then(s=>s.HybridScheduleStrategy);return new t(c).schedule(y)}const C=[];for(const t of o.questions){const e=u[t.word]??i.wordProgress[t.word]??null,s=l.getWordStatusFromCache(t.word,i.mode,m),a=(s==null?void 0:s.position)??new F(o.mode).calculate(e);let r=0,n=0;if(e)switch(o.mode){case"memorization":r=e.memorizationAttempts||0,n=e.memorizationCorrect||0;break;case"translation":r=e.translationAttempts||0,n=e.translationCorrect||0;break;case"spelling":r=e.spellingAttempts||0,n=e.spellingCorrect||0;break;case"grammar":r=e.grammarAttempts||0,n=e.grammarCorrect||0;break}const g=s??{category:E(a),position:a,lastStudied:(e==null?void 0:e.lastStudied)||0,attempts:r,correct:n,streak:(e==null?void 0:e.consecutiveCorrect)||0,forgettingRisk:0,reviewInterval:1},B=await c.aiCoordinator.analyzeAndCoordinate({word:{word:t.word,meaning:t.meaning,reading:t.reading,difficulty:t.difficulty,category:t.category,source:t.source,type:t.type,isPhraseOnly:t.isPhraseOnly},progress:e,sessionStats:b,currentTab:f,allProgress:u},a/100);C.push({question:t,position:a,finalPriority:B.finalPriority,status:g,attempts:(g==null?void 0:g.attempts)??0,timeBoost:1})}const p=new L,A=p.boostStillLearningQuestions(C).result;for(const t of A)t.position>=60&&t.position<70&&(((k=t.status)==null?void 0:k.attempts)??0)>0&&(t.finalPriority=(t.finalPriority??0)+100);const{result:R}=p.adjustPositionForInterleaving(A),j=[...R].sort((t,e)=>(e.finalPriority??0)-(t.finalPriority??0)),d=p.interleaveByCategory(j);try{const t=d.slice(0,30).map((s,a)=>{var r,n;return{rank:a+1,word:s.question.word,position:s.position,finalPriority:s.finalPriority??0,category:(r=s.status)==null?void 0:r.category,attempts:((n=s.status)==null?void 0:n.attempts)??0}});z("debug_finalPriority_output",t,{mode:i.mode});const e={currentTab:f,totalQuestions:o.questions.length,allProgressCount:Object.keys(u||{}).length,aiSessionStats:b,timestamp:new Date().toISOString(),mode:i.mode};z("debug_finalPriority_sessionStats",e,{mode:i.mode})}catch{}const x=l.postProcess(d,i),v=c.antiVibration.calculateVibrationScore(d,i.recentAnswers,20),_=performance.now()-I;return q.info("[FinalPriorityScheduleStrategy] スケジューリング完了",{processingTime:Math.round(_)+"ms",vibrationScore:v,aiEnabled:!0,totalCount:x.length,top5FinalPriority:d.slice(0,5).map(t=>({word:t.question.word,finalPriority:(t.finalPriority??0).toFixed(3),position:t.position}))}),this.buildResult(d,{source:"FinalPriorityScheduleStrategy",elapsed:_,vibrationScore:v,signalCount:T.length})}}export{W as FinalPriorityScheduleStrategy};
//# sourceMappingURL=FinalPriorityScheduleStrategy-3azAbeJl.js.map
