{"version":3,"file":"DefaultScheduleStrategy-CnBVq84Z.js","sources":["../../src/ai/scheduler/strategies/DefaultScheduleStrategy.ts"],"sourcesContent":["/**\n * DefaultScheduleStrategy - „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞Êà¶Áï•\n *\n * Ê®ôÊ∫ñÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ\n *\n * „ÄêÁâπÂæ¥„Äë\n * - DTAÔºàTime-Dependent AdjustmentÔºâ„Å´„Çà„ÇãÂÑ™ÂÖàÂ∫¶Ë™øÊï¥\n * - PositionË®àÁÆó„Å®„Ç´„ÉÜ„Ç¥„É™„ÉºÂàÜÈ°û\n * - ÊåØÂãïÈò≤Ê≠¢„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®\n * - GamificationAI„Å´„Çà„ÇãÊñ∞Ë¶èË™û„Éª„Åæ„Å†„Åæ„Å†Ë™û„ÅÆ„Éñ„Éº„Çπ„Éà\n *\n * „Äê‰ΩøÁî®‰æã„Äë\n * ```typescript\n * const strategy = new DefaultScheduleStrategy(dependencies);\n * const result = await strategy.schedule(context);\n * ```\n */\n\nimport type { ScheduleResult, PrioritizedQuestion as PQ } from '../types';\nimport type { Question } from '@/types';\nimport type { ScheduleContext } from './ScheduleStrategy';\nimport { BaseScheduleStrategy } from './ScheduleStrategy';\nimport { logger } from '@/utils/logger';\nimport { writeDebugJSON } from '@/utils/debugStorage';\n\nexport class DefaultScheduleStrategy extends BaseScheduleStrategy {\n  /**\n   * „Éá„Éï„Ç©„É´„Éà„É¢„Éº„Éâ„Åß„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞\n   *\n   * @param context - „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà\n   * @returns „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞ÁµêÊûú\n   */\n  async schedule(context: ScheduleContext): Promise<ScheduleResult> {\n    const { params, startTime, dependencies } = context;\n    const scheduler = dependencies.scheduler; // QuestionSchedulerÔºàContextÔºâ\n\n    this.log('„Éá„Éï„Ç©„É´„Éà„É¢„Éº„ÉâÈñãÂßã', {\n      questionCount: params.questions.length,\n      mode: params.mode,\n    });\n\n    // 1. „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊßãÁØâ\n    const scheduleContext = scheduler.buildContext(params);\n\n    // 2. „Ç∑„Ç∞„Éä„É´Ê§úÂá∫\n    const signals = scheduler.detectSignals(scheduleContext);\n\n    // 3. ÂÑ™ÂÖàÂ∫¶Ë®àÁÆóÔºàDTAÁµ±Âêà + PositionÂàÜÊï£Ôºâ\n    const prioritized: PQ[] = scheduler.calculatePriorities(\n      params.questions,\n      scheduleContext,\n      signals,\n      false // hybridMode=false\n    );\n\n    // 4. ÊåØÂãïÈò≤Ê≠¢„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®\n    const filtered: PQ[] = scheduler.applyAntiVibration(prioritized, scheduleContext);\n\n    // 5. „ÇΩ„Éº„Éà„Éª„Éê„É©„É≥„ÇπË™øÊï¥\n    const sorted: PQ[] = scheduler.sortAndBalance(filtered, params, scheduleContext);\n\n    // 6. ÂæåÂá¶ÁêÜÔºà„ÅÑ„ÇÇ„Å•„ÇãÂºèÂ≠¶Áøí„Å™„Å©Ôºâ\n    const questions: Question[] = scheduler.postProcess(sorted, scheduleContext);\n\n    // 7. „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±‰øùÂ≠ò\n    try {\n      const top30 = questions.slice(0, 30).map((q: Question, _idx: number) => {\n        const pq = sorted.find((pq: PQ) => pq.question.word === q.word);\n        return {\n          word: q.word,\n          position: pq?.position || 0,\n          category: pq?.status?.category,\n          attempts: pq?.status?.attempts || 0,\n        };\n      });\n\n      const payload = {\n        timestamp: new Date().toISOString(),\n        mode: scheduleContext.mode,\n        source: 'DefaultScheduleStrategy',\n        top30,\n      };\n\n      writeDebugJSON('debug_postProcess_output', payload, { mode: scheduleContext.mode });\n    } catch {\n      // localStorageÂ§±Êïó„ÅØÁÑ°Ë¶ñ\n    }\n\n    // 8. ÊåØÂãï„Çπ„Ç≥„Ç¢Ë®àÁÆó\n    const vibrationScore = dependencies.antiVibration.calculateVibrationScore(\n      sorted,\n      scheduleContext.recentAnswers,\n      20\n    );\n\n    // 9. È†ÜÂ∫èÊï¥ÂêàÊÄßÊ§úË®º\n    const sortedTop10Positions = sorted.slice(0, 10).map((pq: PQ) => pq.position);\n    const questionsTop10Positions = questions\n      .slice(0, 10)\n      .map((q: Question) => sorted.find((pq: PQ) => pq.question.word === q.word)?.position ?? 0);\n\n    const orderMismatch = !sortedTop10Positions.every(\n      (pos, idx) => pos === questionsTop10Positions[idx]\n    );\n\n    if (orderMismatch && import.meta.env.DEV) {\n      console.error(\n        'üö® [DefaultScheduleStrategy] CRITICAL: postProcess()„ÅåsortAndBalance()„ÅÆÈ†ÜÂ∫è„ÇíÁ†¥Â£ä„Åó„Åæ„Åó„ÅüÔºÅ',\n        {\n          sortedTop10: sorted\n            .slice(0, 10)\n            .map((pq: PQ) => ({ word: pq.question.word, pos: pq.position })),\n          questionsTop10: questions.slice(0, 10).map((q: Question) => ({\n            word: q.word,\n            pos: sorted.find((pq: PQ) => pq.question.word === q.word)?.position ?? 0,\n          })),\n        }\n      );\n    }\n\n    const processingTime = performance.now() - startTime;\n\n    const resultDebug = {\n      top10Words: questions.slice(0, 10).map((q: Question) => q.word),\n      top10Positions: sorted\n        .slice(0, 10)\n        .map((pq: PQ) => ({ word: pq.question.word, position: pq.position })),\n      orderMismatch,\n    };\n\n    logger.info(`[DefaultScheduleStrategy] „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞ÂÆå‰∫Ü`, {\n      processingTime: Math.round(processingTime) + 'ms',\n      vibrationScore,\n      signalCount: signals.length,\n      resultDebug,\n    });\n\n    // 10. „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇílocalStorage„Å´‰øùÂ≠ò\n    try {\n      const existing = JSON.parse(localStorage.getItem('debug_scheduler_results') || '[]');\n      existing.push({\n        timestamp: new Date().toISOString(),\n        ...resultDebug,\n      });\n      if (existing.length > 10) existing.shift();\n      localStorage.setItem('debug_scheduler_results', JSON.stringify(existing));\n    } catch {\n      // ignore\n    }\n\n    return this.buildResult(sorted, {\n      source: 'DefaultScheduleStrategy',\n      elapsed: processingTime,\n      vibrationScore,\n      signalCount: signals.length,\n    });\n  }\n}\n"],"names":["DefaultScheduleStrategy","BaseScheduleStrategy","context","params","startTime","dependencies","scheduler","scheduleContext","signals","prioritized","filtered","sorted","questions","top30","q","_idx","pq","_a","_b","payload","writeDebugJSON","vibrationScore","sortedTop10Positions","questionsTop10Positions","orderMismatch","pos","idx","processingTime","resultDebug","logger","existing"],"mappings":"wKAyBO,MAAMA,UAAgCC,CAAqB,CAOhE,MAAM,SAASC,EAAmD,CAChE,KAAM,CAAE,OAAAC,EAAQ,UAAAC,EAAW,aAAAC,CAAA,EAAiBH,EACtCI,EAAYD,EAAa,UAE/B,KAAK,IAAI,aAAc,CACrB,cAAeF,EAAO,UAAU,OAChC,KAAMA,EAAO,IAAA,CACd,EAGD,MAAMI,EAAkBD,EAAU,aAAaH,CAAM,EAG/CK,EAAUF,EAAU,cAAcC,CAAe,EAGjDE,EAAoBH,EAAU,oBAClCH,EAAO,UACPI,EACAC,EACA,EAAA,EAIIE,EAAiBJ,EAAU,mBAAmBG,EAAaF,CAAe,EAG1EI,EAAeL,EAAU,eAAeI,EAAUP,EAAQI,CAAe,EAGzEK,EAAwBN,EAAU,YAAYK,EAAQJ,CAAe,EAG3E,GAAI,CACF,MAAMM,EAAQD,EAAU,MAAM,EAAG,EAAE,EAAE,IAAI,CAACE,EAAaC,IAAiB,SACtE,MAAMC,EAAKL,EAAO,KAAMK,GAAWA,EAAG,SAAS,OAASF,EAAE,IAAI,EAC9D,MAAO,CACL,KAAMA,EAAE,KACR,UAAUE,GAAA,YAAAA,EAAI,WAAY,EAC1B,UAAUC,EAAAD,GAAA,YAAAA,EAAI,SAAJ,YAAAC,EAAY,SACtB,WAAUC,EAAAF,GAAA,YAAAA,EAAI,SAAJ,YAAAE,EAAY,WAAY,CAAA,CAEtC,CAAC,EAEKC,EAAU,CACd,UAAW,IAAI,KAAA,EAAO,YAAA,EACtB,KAAMZ,EAAgB,KACtB,OAAQ,0BACR,MAAAM,CAAA,EAGFO,EAAe,2BAA4BD,EAAS,CAAE,KAAMZ,EAAgB,KAAM,CACpF,MAAQ,CAER,CAGA,MAAMc,EAAiBhB,EAAa,cAAc,wBAChDM,EACAJ,EAAgB,cAChB,EAAA,EAIIe,EAAuBX,EAAO,MAAM,EAAG,EAAE,EAAE,IAAKK,GAAWA,EAAG,QAAQ,EACtEO,EAA0BX,EAC7B,MAAM,EAAG,EAAE,EACX,IAAKE,UAAgB,QAAAG,EAAAN,EAAO,KAAMK,GAAWA,EAAG,SAAS,OAASF,EAAE,IAAI,IAAnD,YAAAG,EAAsD,WAAY,EAAC,EAErFO,EAAgB,CAACF,EAAqB,MAC1C,CAACG,EAAKC,IAAQD,IAAQF,EAAwBG,CAAG,CAAA,EAkB7CC,EAAiB,YAAY,IAAA,EAAQvB,EAErCwB,EAAc,CAClB,WAAYhB,EAAU,MAAM,EAAG,EAAE,EAAE,IAAKE,GAAgBA,EAAE,IAAI,EAC9D,eAAgBH,EACb,MAAM,EAAG,EAAE,EACX,IAAKK,IAAY,CAAE,KAAMA,EAAG,SAAS,KAAM,SAAUA,EAAG,UAAW,EACtE,cAAAQ,CAAA,EAGFK,EAAO,KAAK,uCAAwC,CAClD,eAAgB,KAAK,MAAMF,CAAc,EAAI,KAC7C,eAAAN,EACA,YAAab,EAAQ,OACrB,YAAAoB,CAAA,CACD,EAGD,GAAI,CACF,MAAME,EAAW,KAAK,MAAM,aAAa,QAAQ,yBAAyB,GAAK,IAAI,EACnFA,EAAS,KAAK,CACZ,UAAW,IAAI,KAAA,EAAO,YAAA,EACtB,GAAGF,CAAA,CACJ,EACGE,EAAS,OAAS,IAAIA,EAAS,MAAA,EACnC,aAAa,QAAQ,0BAA2B,KAAK,UAAUA,CAAQ,CAAC,CAC1E,MAAQ,CAER,CAEA,OAAO,KAAK,YAAYnB,EAAQ,CAC9B,OAAQ,0BACR,QAASgB,EACT,eAAAN,EACA,YAAab,EAAQ,MAAA,CACtB,CACH,CACF"}