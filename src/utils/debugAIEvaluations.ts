/**
 * AIè©•ä¾¡ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 *
 * ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦AIè©•ä¾¡ã‚’ç¢ºèª:
 * - window.showAIEvaluations() // ã™ã¹ã¦ã®è©•ä¾¡ã‚’è¡¨ç¤º
 * - window.showAIEvaluations('yellow') // ç‰¹å®šã®å˜èªã®è©•ä¾¡ã‚’è¡¨ç¤º
 * - window.clearAIEvaluations() // è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
 */

interface AIEvaluation {
  category: string;
  basePriority: number;
  timeBoost: number;
  finalPriority: number;
  aiEvaluations: Record<string, number>;
  timestamp: string;
}

/**
 * ã™ã¹ã¦ã®AIè©•ä¾¡ã‚’è¡¨ç¤º
 */
export function showAIEvaluations(wordFilter?: string): void {
  try {
    const stored = localStorage.getItem('debug_ai_evaluations');
    if (!stored) {
      console.log('ğŸ“Š AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const evaluations: Record<string, AIEvaluation> = JSON.parse(stored);
    const entries = Object.entries(evaluations);

    if (wordFilter) {
      const filtered = entries.filter(([word]) =>
        word.toLowerCase().includes(wordFilter.toLowerCase())
      );
      displayEvaluations(filtered);
    } else {
      displayEvaluations(entries);
    }
  } catch (e) {
    console.error('âŒ AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
  }
}

/**
 * è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
 */
function displayEvaluations(entries: [string, AIEvaluation][]): void {
  console.log(`\nğŸ“Š AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ (${entries.length}ä»¶)\n`);
  console.log('å½¢å¼: ç·åˆè©•ä¾¡[è¨˜æ†¶/èªçŸ¥è² è·/èª¤ç­”äºˆæ¸¬/å®šç€åº¦/é›£æ˜“åº¦/é–“éš”åå¾©/å¿˜å´]\n');

  entries
    .sort((a, b) => b[1].finalPriority - a[1].finalPriority)
    .forEach(([word, evaluation]) => {
      const scores = [
        evaluation.aiEvaluations.memory,
        evaluation.aiEvaluations.cognitiveLoad,
        evaluation.aiEvaluations.errorPrediction,
        evaluation.aiEvaluations.retention,
        evaluation.aiEvaluations.difficulty,
        evaluation.aiEvaluations.spaceRepetition,
        evaluation.aiEvaluations.forgetting,
      ]
        .map((v) => v.toFixed(1))
        .join('/');

      const categoryEmoji = (() => {
        switch (evaluation.category) {
          case 'incorrect':
            return 'ğŸ”´';
          case 'still_learning':
            return 'ğŸŸ¡';
          case 'mastered':
            return 'ğŸŸ¢';
          case 'new':
            return 'âšª';
          default:
            return 'âšª';
        }
      })();

      console.log(
        `${categoryEmoji} ${word.padEnd(20)} ${evaluation.finalPriority.toFixed(1).padStart(6)}[${scores}] (${evaluation.category})`
      );
    });

  console.log('\nå‡¡ä¾‹:');
  console.log('  ğŸ”´ incorrect (è¦å¾©ç¿’)');
  console.log('  ğŸŸ¡ still_learning (å­¦ç¿’ä¸­)');
  console.log('  ğŸŸ¢ mastered (å®šç€æ¸ˆ)');
  console.log('  âšª new (æœªå­¦ç¿’)\n');
}

/**
 * AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
 */
export function clearAIEvaluations(): void {
  try {
    localStorage.removeItem('debug_ai_evaluations');
    console.log('âœ… AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('âŒ AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', e);
  }
}

/**
 * ç‰¹å®šã®å˜èªã®è©³ç´°ãªè©•ä¾¡ã‚’è¡¨ç¤º
 */
export function showDetailedEvaluation(word: string): void {
  try {
    const stored = localStorage.getItem('debug_ai_evaluations');
    if (!stored) {
      console.log('ğŸ“Š AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const evaluations: Record<string, AIEvaluation> = JSON.parse(stored);
    const evaluation = evaluations[word];

    if (!evaluation) {
      console.log(`âŒ "${word}" ã®è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      return;
    }

    console.log(`\nğŸ“Š "${word}" ã®è©³ç´°AIè©•ä¾¡\n`);
    console.log(`ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${evaluation.category}`);
    console.log(`ãƒ™ãƒ¼ã‚¹å„ªå…ˆåº¦: ${evaluation.basePriority.toFixed(1)}`);
    console.log(`æ™‚é–“ãƒ–ãƒ¼ã‚¹ãƒˆ: +${evaluation.timeBoost.toFixed(1)}`);
    console.log(`æœ€çµ‚å„ªå…ˆåº¦: ${evaluation.finalPriority.toFixed(1)}`);
    console.log(`\nå„AIæ‹…å½“ã®è©•ä¾¡ (0-100):`);
    console.log(`  è¨˜æ†¶AI (Memory):          ${evaluation.aiEvaluations.memory.toFixed(1)}`);
    console.log(
      `  èªçŸ¥è² è·AI (CognitiveLoad): ${evaluation.aiEvaluations.cognitiveLoad.toFixed(1)}`
    );
    console.log(
      `  èª¤ç­”äºˆæ¸¬AI (ErrorPrediction): ${evaluation.aiEvaluations.errorPrediction.toFixed(1)}`
    );
    console.log(`  å®šç€åº¦AI (Retention):      ${evaluation.aiEvaluations.retention.toFixed(1)}`);
    console.log(`  é›£æ˜“åº¦AI (Difficulty):     ${evaluation.aiEvaluations.difficulty.toFixed(1)}`);
    console.log(
      `  é–“éš”åå¾©AI (SpaceRepetition): ${evaluation.aiEvaluations.spaceRepetition.toFixed(1)}`
    );
    console.log(`  å¿˜å´ãƒªã‚¹ã‚¯AI (Forgetting): ${evaluation.aiEvaluations.forgetting.toFixed(1)}`);
    console.log(`\næ›´æ–°æ—¥æ™‚: ${evaluation.timestamp}\n`);
  } catch (e) {
    console.error('âŒ AIè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
if (typeof window !== 'undefined') {
  (window as any).showAIEvaluations = showAIEvaluations;
  (window as any).clearAIEvaluations = clearAIEvaluations;
  (window as any).showDetailedEvaluation = showDetailedEvaluation;
}
