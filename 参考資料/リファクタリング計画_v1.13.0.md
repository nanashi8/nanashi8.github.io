# プロジェクト構造見直し - リファクタリング計画

作成日: 2025年10月28日  
バージョン: v1.13.0

## 📊 現状分析サマリー

### 🚨 緊急対応が必要なファイル

| ファイル | 行数 | 基準 | 超過率 | 優先度 |
|---------|------|------|--------|--------|
| QuizView.swift | 696行 | 200-300行 | **232%** | 🔴 最優先 |
| QuizSettingsView.swift | 553行 | 200-300行 | **184%** | 🔴 最優先 |
| ChoiceCardView.swift | 514行 | 200-300行 | **171%** | 🔴 最優先 |
| QuizSettings.swift | 429行 | 300-400行 | **107%** | 🟠 高 |
| FileUtils.swift | 284行 | - | - | 🟡 中 |

### ⚠️ 分割検討が必要なファイル

| ファイル | 行数 | 状態 |
|---------|------|------|
| CSVIDEnsurer.swift | 260行 | 境界線 |
| IDMapMaintenance.swift | 222行 | 境界線 |
| QuizSettingsStore.swift | 209行 | 境界線 |
| CSVLoader.swift | 202行 | 境界線 |

---

## 🎯 リファクタリング計画

### フェーズ1: QuizView.swift の分割（最優先）

**現状の問題点:**
- 696行の巨大ファイル
- 複数の責務が混在（UI・ロジック・データロード・CSV解析）
- テストが困難
- 保守性が低い

**分割後の構成:**

```
Features/Quiz/Views/
├── QuizView.swift (メイン画面、150行程度)
├── Components/
│   ├── QuizLoadingView.swift (20行)
│   ├── QuizErrorView.swift (60行)
│   ├── QuizEmptyView.swift (40行)
│   ├── QuizContentView.swift (100行)
│   └── QuizNavigationButtonsView.swift (既存)
├── Services/
│   ├── QuizDataLoader.swift (CSV読み込み、150行)
│   ├── QuizBatchManager.swift (バッチ管理、100行)
│   ├── QuizHistoryManager.swift (履歴管理、80行)
│   └── CSVHeaderParser.swift (ヘッダ解析、100行)
└── Models/
    ├── QuizChoice.swift (選択肢モデル、30行)
    └── QuizState.swift (状態管理、50行)
```

**分割詳細:**

#### 1. UI コンポーネントの分離

**QuizLoadingView.swift** (20行)
```swift
/// クイズ読み込み中の表示
struct QuizLoadingView: View {
    var body: some View {
        VStack(spacing: 16) {
            ProgressView()
            Text("問題を読み込み中...")
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
    }
}
```

**QuizErrorView.swift** (60行)
```swift
/// クイズエラー表示
struct QuizErrorView: View {
    let message: String
    let onDismiss: () -> Void
    
    var body: some View {
        // 現在の errorView の内容
    }
}
```

**QuizEmptyView.swift** (40行)
```swift
/// 問題なし表示
struct QuizEmptyView: View {
    let onDismiss: () -> Void
    
    var body: some View {
        // 現在の emptyView の内容
    }
}
```

**QuizContentView.swift** (100行)
```swift
/// クイズメインコンテンツ
struct QuizContentView: View {
    let currentItem: QuestionItem?
    let choices: [QuizChoice]
    let csvName: String
    let learningMode: String
    // ...その他の必要なプロパティ
    
    var body: some View {
        // 現在の quizContent の内容
    }
}
```

#### 2. サービスクラスの分離

**QuizDataLoader.swift** (150行)
```swift
/// クイズデータの読み込みを担当
final class QuizDataLoader {
    /// CSV からクイズデータを読み込む
    func loadQuizData(
        csvName: String,
        filters: QuizFilters
    ) -> Result<QuizLoadResult, QuizLoadError> {
        // 現在の loadCSVAndStart の内容
        // - CSV読み込み
        // - フィルタリング
        // - データ検証
    }
    
    /// フィルタ適用
    private func applyFilters(
        to items: [QuestionItem],
        filters: QuizFilters
    ) -> [QuestionItem] {
        // 現在の applyFilters の内容
    }
}

struct QuizLoadResult {
    let items: [QuestionItem]
    let csvURL: URL?
    let headerLabels: [String: String]
}

enum QuizLoadError: LocalizedError {
    case csvNotSelected
    case csvNotFound(String)
    case noMatchingQuestions
    
    var errorDescription: String? {
        // エラーメッセージ
    }
}
```

**QuizBatchManager.swift** (100行)
```swift
/// クイズのバッチ管理を担当
final class QuizBatchManager {
    /// バッチを準備
    func prepareBatch(
        from items: [QuestionItem],
        batchSize: Int,
        repeatCount: Int
    ) -> [QuestionItem] {
        // 現在の prepareBatch の内容
    }
    
    /// ラウンドロビンシャッフル
    private func roundRobinShuffle(
        items: [QuestionItem],
        pool: [QuestionItem]
    ) -> [QuestionItem] {
        // 現在の roundRobinShuffle の内容
    }
}
```

**QuizHistoryManager.swift** (80行)
```swift
/// クイズ履歴の管理を担当
final class QuizHistoryManager {
    private var history: [UUID] = []
    private var historyIndex: Int = -1
    
    /// 履歴に追加
    func addToHistory(_ id: UUID) {
        // 履歴管理ロジック
    }
    
    /// 前の問題に戻れるか
    func canGoPrevious() -> Bool {
        return historyIndex > 0
    }
    
    /// 次の問題に進めるか
    func canGoNext() -> Bool {
        // 実装
    }
    
    /// 前の問題のIDを取得
    func previousQuestionID() -> UUID? {
        // 実装
    }
}
```

**CSVHeaderParser.swift** (100行)
```swift
/// CSV ヘッダの解析を担当
struct CSVHeaderParser {
    /// ヘッダから論理キー->表示ラベルマップを作成
    func buildHeaderLabelMap(
        from headerColumns: [String]
    ) -> [String: String] {
        // 現在の buildHeaderLabelMap の内容
    }
    
    /// CSV行を分割
    func splitCSVLine(_ line: String) -> [String] {
        // 現在の splitCSVLineLocal の内容
    }
    
    /// CSV URLからヘッダを読み取る
    func parseHeader(from url: URL) -> [String: String] {
        // CSV読み取り + ヘッダ解析
    }
}
```

#### 3. モデルの分離

**QuizChoice.swift** (30行)
```swift
/// クイズの選択肢
struct QuizChoice: Identifiable {
    let id: UUID
    let label: String
    let explanation: String?
    let isCorrect: Bool
    let item: QuestionItem? // 詳細情報表示用
}
```

**QuizState.swift** (50行)
```swift
/// クイズの状態管理
struct QuizState {
    // データ状態
    var items: [QuestionItem] = []
    var order: [QuestionItem] = []
    var pool: [QuestionItem] = []
    var currentItem: QuestionItem? = nil
    
    // UI状態
    var choices: [QuizChoice] = []
    var selectedChoiceID: UUID? = nil
    var correctAnswerID: UUID? = nil
    var dontKnowID: UUID = UUID()
    
    // アニメーション状態
    var shouldAnimatePassedCount: Bool = false
    var shouldAnimateTotalCount: Bool = false
    
    // ローディング・エラー状態
    var isLoading: Bool = true
    var errorMessage: String? = nil
    
    // CSVヘッダ
    var csvHeaderLabels: [String: String] = [:]
}
```

#### 4. リファクタリング後の QuizView.swift (150行程度)

```swift
import SwiftUI

/// クイズ画面の実装
/// 適応型学習アルゴリズムによる効率的な単語学習を提供
struct QuizView: View {
    // 環境オブジェクト
    @EnvironmentObject var wordScoreStore: WordScoreStore
    @EnvironmentObject var currentCSV: CurrentCSV
    @EnvironmentObject var quizSettings: QuizSettings
    @EnvironmentObject var scoreStore: ScoreStore
    @StateObject private var sessionStore = QuizSessionStore.shared
    
    // 状態管理
    @State private var state = QuizState()
    
    // サービス
    private let dataLoader = QuizDataLoader()
    private let batchManager = QuizBatchManager()
    private let historyManager = QuizHistoryManager()
    
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        Group {
            if state.isLoading {
                QuizLoadingView()
            } else if let error = state.errorMessage {
                QuizErrorView(message: error, onDismiss: { dismiss() })
            } else if state.items.isEmpty {
                QuizEmptyView(onDismiss: { dismiss() })
            } else {
                QuizContentView(
                    currentItem: state.currentItem,
                    choices: state.choices,
                    csvName: currentCSV.name ?? "",
                    learningMode: quizSettings.model.learningMode.displayName,
                    // ...その他のプロパティ
                )
            }
        }
        .navigationTitle("クイズ")
        .navigationBarTitleDisplayMode(.inline)
        .onAppear {
            loadQuizData()
        }
    }
    
    // MARK: - メソッド
    
    /// クイズデータを読み込む
    private func loadQuizData() {
        guard let csvName = currentCSV.name else {
            state.errorMessage = "CSVファイルが選択されていません。"
            state.isLoading = false
            return
        }
        
        // データロード
        let result = dataLoader.loadQuizData(
            csvName: csvName,
            filters: QuizFilters(
                fields: quizSettings.fields,
                difficulties: quizSettings.difficulties
            )
        )
        
        switch result {
        case .success(let loadResult):
            state.items = loadResult.items
            state.csvHeaderLabels = loadResult.headerLabels
            
            // セッション開始
            startSession(csvName: csvName)
            
            // バッチ準備
            prepareBatch()
            
            state.isLoading = false
            
        case .failure(let error):
            state.errorMessage = error.localizedDescription
            state.isLoading = false
        }
    }
    
    /// セッションを開始
    private func startSession(csvName: String) {
        wordScoreStore.switchToCSV(csvName)
        
        let totalQuestions = quizSettings.numberOfQuestions > 0 
            ? min(quizSettings.numberOfQuestions, state.items.count) 
            : state.items.count
        let batchSize = min(quizSettings.questionsPerBatch, totalQuestions)
        
        if !sessionStore.canResumeSession(csvName: csvName) {
            sessionStore.startSession(
                csvName: csvName,
                batchSize: batchSize,
                totalQuestions: totalQuestions
            )
        }
    }
    
    /// バッチを準備
    private func prepareBatch() {
        let pool = batchManager.prepareBatch(
            from: state.items,
            batchSize: sessionStore.batchSize,
            repeatCount: max(1, quizSettings.repeatCount)
        )
        state.pool = pool
        prepareQuestion()
    }
    
    // 残りのメソッドも簡潔に...
}
```

---

### フェーズ2: QuizSettingsView.swift の分割

**現状:** 553行

**分割後の構成:**

```
Views/
├── QuizSettingsView.swift (メイン、150行)
└── Components/
    ├── QuizBasicSettingsSection.swift (80行)
    ├── QuizFilterSettingsSection.swift (100行)
    ├── QuizAdvancedSettingsSection.swift (100行)
    └── QuizPresetSelector.swift (60行)
```

---

### フェーズ3: ChoiceCardView.swift の分割

**現状:** 514行

**分割後の構成:**

```
QuizComponents/
├── ChoiceCardView.swift (メイン、100行)
└── Components/
    ├── ChoiceCardContent.swift (80行)
    ├── ChoiceCardDetailView.swift (150行)
    ├── ChoiceCardAnimation.swift (60行)
    └── ChoiceCardStyles.swift (50行)
```

---

### フェーズ4: QuizSettings.swift の分割

**現状:** 429行（ViewModel/Store）

**分割後の構成:**

```
Stores/
├── QuizSettings.swift (メイン、150行)
└── Services/
    ├── QuizSettingsValidator.swift (80行)
    ├── QuizSettingsPresets.swift (100行)
    └── QuizSettingsPersistence.swift (80行)
```

---

## 📅 実施スケジュール

### 第1週: QuizView.swift の分割
- Day 1-2: Components 分離（UI部品）
- Day 3-4: Services 分離（ロジック）
- Day 5: Models 分離 + 統合テスト

### 第2週: QuizSettingsView.swift の分割
- Day 1-2: セクション別に分割
- Day 3: 統合テスト

### 第3週: ChoiceCardView.swift の分割
- Day 1-2: コンポーネント分割
- Day 3: 統合テスト

### 第4週: QuizSettings.swift の分割 + 最終確認
- Day 1-2: Services 分離
- Day 3-5: 全体テスト + ドキュメント更新

---

## ✅ 分割時のチェックリスト

各ファイル分割時に以下を確認:

- [ ] Git で現在の状態をコミット
- [ ] 分割後のディレクトリ構造を設計
- [ ] 1つずつ分割し、都度ビルド確認
- [ ] 日本語コメントを追加
- [ ] プレビューが動作するか確認
- [ ] 単体テストを追加
- [ ] 意味のある単位でコミット

---

## 🎯 期待される効果

### 定量的効果
- **平均ファイル行数**: 696行 → 150行以下（78%削減）
- **最大ファイル行数**: 696行 → 200行以下（71%削減）
- **テスト容易性**: モジュール単位でテスト可能に

### 定性的効果
- **可読性**: スクロールなしで全体把握可能
- **保守性**: 修正箇所の特定が容易
- **並行作業**: 複数人で同時作業可能
- **再利用性**: Component/Service の他機能での利用

---

## 📚 参考資料

- `参考資料/ファイル分割ガイド.md`: 分割の具体的手順
- `.github/copilot-instructions.md`: プロジェクト固有の分割基準
- `SIMPLIFICATION_COMPLETION_REPORT.md`: 過去のリファクタリング事例

---

## 📝 進捗管理

| フェーズ | ファイル | 状態 | 担当 | 完了日 |
|---------|---------|------|------|--------|
| 1 | QuizView.swift | 🔲 未着手 | - | - |
| 2 | QuizSettingsView.swift | 🔲 未着手 | - | - |
| 3 | ChoiceCardView.swift | 🔲 未着手 | - | - |
| 4 | QuizSettings.swift | 🔲 未着手 | - | - |

---

## ⚠️ リスクと対策

### リスク1: ビルドエラー
- **対策**: 1つずつ分割し、都度ビルド確認

### リスク2: 機能デグレ
- **対策**: 分割前後で動作テストを実施

### リスク3: Git コンフリクト
- **対策**: 小さく頻繁にコミット、feature ブランチで作業

### リスク4: 過度な分割
- **対策**: ファイル分割ガイドの基準に従う（10行ファイルを作らない）

---

## 🔄 次のステップ

1. このリファクタリング計画をチームでレビュー
2. フェーズ1（QuizView.swift）から着手
3. 各フェーズ完了後に進捗を更新
4. 全フェーズ完了後にプロジェクト構造ドキュメントを更新

---

**作成者**: AI Assistant  
**最終更新**: 2025年10月28日
