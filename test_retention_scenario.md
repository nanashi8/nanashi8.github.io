# 定着率計算の検証

## 現在のシステムの動作

### ケース1: ユーザー様の想定（10問）
- 5問: 連続正解 → 定着扱い
- 5問: 不正解 → 復習中

**現在の定着率計算:**
```
masteredCount = 5
appearedCount = 10
retentionRate = (5 / 10) * 100 = 50%  ✅ 正しい
```

**ただし、定着判定の条件が複雑:**

### 定着判定基準（現在）

#### ✅ 確実に定着扱い:
1. **1発正解**: 1回目で正解 → 即定着（除外期間3日）
2. **連続2回正解**: 連続で2回正解 → 定着（除外期間7日）
3. **連続3回正解**: 連続で3回正解 → 定着（除外期間14日）

#### ⚠️ 条件付き定着:
4. **高精度安定型**: 3回以上挑戦 + 正答率90% + 連続2回正解
5. **長期記憶型**: 7日以上間隔で連続2回正解
6. **高回数安定型**: 5回以上挑戦 + 正答率80% + 最新正解

### 問題点

#### 問題1: 「5問連続正解」の解釈
「5問連続正解」は以下のどちらか？

**パターンA: 5つの単語で各1回正解**
- 単語A: 1回正解 → ✅ 定着（1発正解）
- 単語B: 1回正解 → ✅ 定着（1発正解）
- 単語C: 1回正解 → ✅ 定着（1発正解）
- 単語D: 1回正解 → ✅ 定着（1発正解）
- 単語E: 1回正解 → ✅ 定着（1発正解）
→ 定着率 = 5/10 = 50% ✅

**パターンB: 1つの単語で連続5回正解**
- 単語A: 連続5回正解 → ✅ 定着（長期記憶、除外期間60日）
- 単語F~J: 不正解
→ 定着率 = 1/6 = 16.7%（単語Aと不正解5単語）

#### 問題2: 不正解の扱い
「5問不正解」の場合:

**シナリオ1: 初めて出題された単語で不正解**
- 単語F: 0回正解, 1回不正解 → ❌ 未定着
- consecutiveCorrect = 0

**シナリオ2: 以前正解していた単語で不正解**
- 単語F: 2回正解, 1回不正解 → ❌ 未定着（連続正解がリセット）
- consecutiveCorrect = 0（不正解でリセットされる）

**シナリオ3: 復習中の単語（正解と不正解を繰り返す）**
- 単語F: 3回正解, 2回不正解 → ❌ 未定着
- 正答率 = 60%（定着基準の80%未満）

### 実際の定着率計算例

#### 例1: 単純なケース
```
10個の単語に初めて挑戦:
- 5個: 1回目で正解 → ✅ 定着（1発正解）
- 5個: 1回目で不正解 → ❌ 未定着

定着率 = 5/10 = 50% ✅ ユーザー様の想定通り
```

#### 例2: 複雑なケース
```
10個の単語を複数回挑戦:
- 単語A: ○○ → ✅ 定着（連続2回）
- 単語B: ○ → ✅ 定着（1発正解）
- 単語C: ○×○ → ❌ 未定着（連続性なし）
- 単語D: ×○○ → ✅ 定着（連続2回）
- 単語E: ○×× → ❌ 未定着（連続性リセット）
- 単語F: ××× → ❌ 未定着
- 単語G: ×○× → ❌ 未定着
- 単語H: ○○○ → ✅ 定着（連続3回）
- 単語I: ○× → ❌ 未定着
- 単語J: ×× → ❌ 未定着

定着率 = 4/10 = 40%
```

## 改善提案

### 提案1: 定着判定基準の簡素化

現在は8つの複雑なパターンがありますが、以下に簡素化:

```typescript
// シンプル版
function isWordMastered(wp: WordProgress): boolean {
  const totalAttempts = wp.correctCount + wp.incorrectCount;
  const accuracy = wp.correctCount / totalAttempts;
  
  // 3段階の定着判定
  if (wp.consecutiveCorrect >= 3) return true;  // 確実定着
  if (wp.consecutiveCorrect >= 2 && accuracy >= 0.8) return true;  // 安定定着
  if (totalAttempts === 1 && wp.correctCount === 1) return true;  // 1発定着
  
  return false;
}
```

### 提案2: 段階的定着レベルの表示

定着率を単純な%ではなく、段階で表示:

```
🟢 完全定着: 連続3回以上正解（10単語）
🟡 仮定着: 連続2回正解（5単語）
🔴 学習中: 上記以外（15単語）

総合定着度: 50%（完全定着33% + 仮定着17%）
```

### 提案3: 補修モードの可視化改善

現在の定着率に加えて:
- **要復習単語数**: 5語
- **補修中単語数**: 3語（正答率50-80%）
- **苦手単語数**: 2語（正答率50%未満）

### 提案4: 「実効定着率」の導入

時間経過を考慮した定着率:

```typescript
// 時間減衰を考慮
function getEffectiveRetentionRate() {
  let effectiveScore = 0;
  
  appearedWords.forEach(wp => {
    if (isMastered(wp)) {
      const daysSince = (Date.now() - wp.lastStudied) / (1000 * 60 * 60 * 24);
      const decayFactor = Math.exp(-daysSince / 30); // 30日で約63%減衰
      effectiveScore += decayFactor;
    }
  });
  
  return (effectiveScore / appearedWords.length) * 100;
}
```

## まとめ

### ユーザー様の理解は正しいです ✅

**10問中5問連続正解、5問不正解 → 定着率50%**

ただし、以下の条件があります:
1. 「連続正解」= 同じ単語で2回以上連続正解（または1発正解）
2. 不正解した単語は未定着扱い
3. 正解と不正解を繰り返す単語も未定着

### より直感的な運用方法

**現在の問題点:**
- 定着判定が8パターンもあり複雑
- 連続正解のリセット条件が厳しい
- 補修モードからの脱出条件が不明確

**改善案:**
1. 定着判定を3段階に簡素化
2. 定着レベル（完全/仮/学習中）を可視化
3. 補修必要単語を明示的に表示
4. 時間経過を考慮した「実効定着率」を追加表示
