# 01-04 CSV仕様

**文書番号**: 01-04  
**最終更新**: 2025-11-04  
**バージョン**: 2.0  
**ステータス**: 最新

---

## 📋 目次

1. [CSVフォーマット概要](#csvフォーマット概要)
2. [ヘッダ仕様](#ヘッダ仕様)
3. [CSV種類別仕様](#csv種類別仕様)
4. [パース処理](#パース処理)
5. [選択肢生成](#選択肢生成)
6. [表示順序](#表示順序)

---

## 📄 CSVフォーマット概要

### 基本仕様

| 項目 | 仕様 |
|-----|------|
| **エンコーディング** | UTF-8 |
| **列数** | 7列固定 |
| **ヘッダ行** | 必須（1行目） |
| **データ行** | 2行目以降 |
| **区切り文字** | カンマ (`,`) |
| **複数値の区切り** | セミコロン (`;`) |

### ファイル構造

```
ヘッダ行（1行目）
データ行（2行目以降）
```

**例**:
```csv
語句,読み（ひらがな）,意味,語源等解説,関連語と意味,関連分野,難易度
あはれ,あはれ,しみじみとした情趣,感動詞から,もののあはれ,文学,2
```

---

## 📑 ヘッダ仕様

### ヘッダ駆動型パース

SimpleWordは**ヘッダ駆動型パース**を採用しています。これにより、CSVのヘッダを読み取って動的にラベルを決定します。

### 列マッピング

各列は以下の**キー**にマッピングされます：

| 列位置 | キー | 用途 |
|-------|------|------|
| 1列目 | `term` | 語句・年号 |
| 2列目 | `reading` | 読み・発音・登場人物 |
| 3列目 | `meaning` | 意味・和訳・史実名 |
| 4列目 | `etymology` | 語源等解説・解説 |
| 5列目 | `relatedWords` | 関連語・関連史実 |
| 6列目 | `relatedFields` | 関連分野 |
| 7列目 | `difficulty` | 難易度 |

### ヘッダ検出ロジック

**実装場所**: `Common/Data/DataSource/CSVDataSource.swift`

```swift
private func detectHeaders(in csvContent: String) -> [String: String] {
    // 1行目をヘッダとして読み取り
    // 各列を対応するキーにマッピング
}
```

**マッピング例**:
- 「語句」→ `term`
- 「読み（ひらがな）」→ `reading`
- 「意味」→ `meaning`

---

## 📚 CSV種類別仕様

### 1. 中学歴史

**ヘッダ**:
```csv
年号,登場人物,史実名,解説,関連史実,関連分野,難易度
```

**列マッピング**:
- `term`: 年号（例: 「4世紀頃」）
- `reading`: 登場人物（例: 「大和朝廷の豪族たち」）
- `meaning`: 史実名（例: 「大和政権の成立」）
- `etymology`: 解説（例: 「弥生時代後期に...」）
- `relatedWords`: 関連史実（例: 「古墳文化」）
- `relatedFields`: 関連分野（例: 「政治」）
- `difficulty`: 難易度（例: 「2」）

**データ例**:
```csv
年号,登場人物,史実名,解説,関連史実,関連分野,難易度
4世紀頃,大和朝廷の豪族たち,大和政権の成立,弥生時代後期に各地の豪族が力を持つようになる,古墳文化;律令以前の統合過程,その他,2
```

### 2. 中学古典単語

**ヘッダ**:
```csv
語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度
```

**列マッピング**:
- `term`: 語句（例: 「あはれ」）
- `reading`: 読み（例: 「あはれ」）
- `meaning`: 意味（例: 「しみじみとした情趣」）
- `etymology`: 語源等解説（例: 「感動詞「あはれ」から」）
- `relatedWords`: 関連語と意味（例: 「もののあはれ」）
- `relatedFields`: 関連分野（例: 「文学・美学」）
- `difficulty`: 難易度（例: 「2」）

**データ例**:
```csv
語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度
あはれ,あはれ,しみじみとした情趣,感動詞「あはれ」から,「もののあはれ」,文学・美学,2
```

### 3. 中学英単語・英熟語

**ヘッダ**:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
```

**列マッピング**:
- `term`: 語句（例: 「apple」）
- `reading`: 発音（例: 「アップル」）
- `meaning`: 和訳（例: 「りんご」）
- `etymology`: 語源等解説（例: 「古英語æppelから」）
- `relatedWords`: 関連語と意味（例: 「fruit / 果物」）
- `relatedFields`: 関連分野（例: 「食べ物」）
- `difficulty`: 難易度（例: 「1」）

**データ例**:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
apple,アップル,りんご,古英語æppelから,fruit / 果物,食べ物,1
```

### 4. 中学英会話

**ヘッダ**:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
```

**列マッピング**: 英単語と同じ

**データ例**:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
Hello!,ハロー,こんにちは！,古英語の挨拶語,Hi / やあ,挨拶,1
```

### 5. Xcode（プログラミング用語）

**ヘッダ**:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
```

**列マッピング**: 英単語と同じ

---

## 🔍 パース処理

### パース処理の流れ

```
1. ファイル読み込み
   ↓
2. エンコーディング検証（UTF-8）
   ↓
3. ヘッダ行の解析
   ↓
4. ヘッダマッピングの作成
   ↓
5. データ行のパース
   ↓
6. QuestionItemモデルの生成
```

### 実装場所

- **CSVDataSource**: `Common/Data/DataSource/CSVDataSource.swift`
- **QuestionItemCSVSchema**: `Common/Data/Schema/QuestionItemCSVSchema.swift`
- **CSVLoader**: `SimpleWord/Utils/CSVLoader.swift`

### パース関数

```swift
func load(from url: URL) async throws -> [QuestionItem] {
    // 1. ファイル読み込み
    let csvContent = try String(contentsOf: url, encoding: .utf8)
    
    // 2. ヘッダ検出
    let headerLabels = detectHeaders(in: csvContent)
    
    // 3. データ行のパース
    let rows = parseCSV(csvContent)
    
    // 4. QuestionItemの生成
    return rows.compactMap { row in
        parseRow(row, headers: headerLabels)
    }
}
```

---

## 🎯 選択肢生成

### 選択肢の生成元

**重要**: 選択肢は**CSV固定列3（`rawColumns[2]`：意味/和訳/史実名）**から生成されます。

**理由**:
- ヘッダ駆動型パーサの影響を受けない
- 常に正確な選択肢が表示される
- CSV種類に関わらず一貫した動作

### 実装場所

`SimpleWord/Features/Quiz/Views/QuizView.swift`

```swift
private func generateChoices(
    for correctItem: QuestionItem,
    from allItems: [QuestionItem]
) -> [String] {
    // CSV固定列3から選択肢を生成
    let correctAnswer = correctItem.rawColumns.count > 2 
        ? correctItem.rawColumns[2] 
        : correctItem.meaning
    
    // 他の3つの選択肢も固定列3から取得
    let wrongChoices = allItems
        .filter { $0.id != correctItem.id }
        .prefix(3)
        .map { $0.rawColumns.count > 2 ? $0.rawColumns[2] : $0.meaning }
    
    return ([correctAnswer] + wrongChoices).shuffled()
}
```

---

## 📊 表示順序

### CSV種類の自動判定

**実装場所**: `SimpleWord/QuizComponents/ChoiceCardView.swift`

```swift
private enum CSVType {
    case history    // 中学歴史
    case classical  // 中学古典単語
    case english    // 中学英単語・英会話・xcode
}

private func detectCSVType(from headerLabels: [String: String]) -> CSVType {
    let term = headerLabels["term"] ?? ""
    let reading = headerLabels["reading"] ?? ""
    let meaning = headerLabels["meaning"] ?? ""
    
    // 中学歴史の判定
    if term.contains("年号") && reading.contains("登場人物") && meaning.contains("史実") {
        return .history
    }
    
    // 中学古典単語の判定
    if reading.contains("ひらがな") {
        return .classical
    }
    
    // 中学英単語・英会話・xcodeの判定
    if reading.contains("カタカナ") || reading.contains("発音") || meaning.contains("和訳") {
        return .english
    }
    
    return .english // デフォルト
}
```

### CSV種類別の表示順序

#### 中学歴史

**表示順序**: 年号 → 史実名（表示済み） → 解説 → 登場人物 → 関連史実 → 関連分野 & 難易度

#### 中学古典単語

**表示順序**: 語句 → 発音 → 意味（表示済み） → 用法 → 関連語 → 関連分野 & 難易度

#### 中学英単語・英会話・xcode

**表示順序**: 語句(発音) → 和訳（表示済み） → 語源等解説 → 関連語と意味 → 関連分野 & 難易度

**特徴**: 発音を語句の直後に括弧付きで表示（例: `Hello! (ハロー)`）

---

## 🔧 CSV作成ガイドライン

### 必須要件

1. **エンコーディング**: UTF-8で保存
2. **ヘッダ行**: 必ず1行目に配置
3. **列数**: 7列固定
4. **データの整合性**: すべての行が7列を持つ

### 推奨事項

1. **セミコロン区切り**: 関連語、関連分野は`;`で区切る
2. **空欄の扱い**: データがない場合は空欄のまま（削除しない）
3. **難易度**: 1-5の整数値を使用
4. **一貫性**: 同じCSV内では同じフォーマットを維持

### 例

**良い例**:
```csv
語句,読み（ひらがな）,意味,語源等解説,関連語と意味,関連分野,難易度
あはれ,あはれ,しみじみとした情趣,感動詞から,もののあはれ,文学,2
```

**悪い例**（列数が不足）:
```csv
語句,読み,意味
あはれ,あはれ,しみじみとした情趣
```

---

## 📚 関連ドキュメント

- **前のドキュメント**: `01-03_データモデル仕様.md`
- **次のドキュメント**: `01-05_クイズ機能仕様.md`
- **実装詳細**: `CSV_HEADER_DRIVEN_IMPLEMENTATION_REPORT.md`
- **選択肢生成**: `CSV_FIXED_COLUMN_CHOICE_GENERATION_REPORT.md`
- **表示順序**: `CSV_TYPE_SPECIFIC_DISPLAY_REPORT.md`

---

**文書履歴**:
- 2025-11-04: 初版作成、CSV仕様を統合
- 2025-10-27: CSVヘッダ更新対応

**管理者**: SimpleWord開発チーム
