# CSVヘッダ駆動型パーサ実装レポート

**作成日**: 2025年10月27日  
**対応内容**: CSVファイルのヘッダを最優先で扱うヘッダ駆動型パーサへの変更

---

## 📋 実装概要

CSVファイルのヘッダ行を最優先で扱い、ヘッダの列名に基づいて動的に列をマッピングするヘッダ駆動型パーサを実装しました。これにより、列の順序が変わってもCSVファイルのヘッダに従って正しくパースできるようになりました。

---

## ✅ 変更ファイル一覧

### 1. **SimpleWord/Data/CSV/QuestionItemParser.swift**
**変更内容**: ヘッダ駆動型パーサの実装

- `parseWithHeaders(headers:fields:)` メソッドを追加
  - ヘッダ名に基づいて列インデックスを動的に解決
  - 日本語・英語両方のヘッダ名に対応
  - 柔軟な列マッピング（別名・表記ゆれに対応）

**対応するヘッダ名**:
- **語句**: `語句`, `term`, `単語`, `word`, `表現`, `phrase`
- **読み/発音**: `読み`, `reading`, `発音`, `pronunciation`, `よみ`, `カタカナ`
- **意味/和訳**: `意味`, `meaning`, `和訳`, `訳`, `translation`, `definition`
- **語源等解説**: `語源`, `etymology`, `解説`, `説明`, `語源等解説`
- **関連語**: `関連語`, `related`, `関連`, `類義語`
- **関連分野**: `関連分野`, `category`, `分野`, `カテゴリー`, `カテゴリ`
- **難易度**: `難易度`, `difficulty`, `レベル`, `level`

**メリット**:
- 列の順序が変わっても正しくパース可能
- CSVヘッダの表記ゆれに対応
- 日本語・英語混在のヘッダに対応

---

### 2. **Common/Data/CSVDataSource.swift**
**変更内容**: ヘッダ駆動型モードの追加

- `isHeaderDriven` フラグを追加（デフォルト: `true`）
- ヘッダ駆動型モード時:
  - 1行目をヘッダとして読み取り
  - ヘッダをパーサに渡して動的マッピング
  - 固定列数チェックを無効化
- 従来の固定列順モードも維持（後方互換性）

**コード例**:
```swift
// ヘッダ駆動型（デフォルト）
let dataSource = CSVDataSource(
    bundle: bundle,
    filename: filename,
    parser: QuestionItemParser.makeParser(),
    isHeaderDriven: true  // ヘッダに基づいてパース
)

// 固定列順（従来）
let dataSource = CSVDataSource(
    bundle: bundle,
    filename: filename,
    parser: QuestionItemParser.makeParser(),
    isHeaderDriven: false  // 固定列順でパース
)
```

---

### 3. **SimpleWord/Data/Repositories/QuestionItemRepository.swift**
**変更内容**: ヘッダ駆動型をデフォルトに設定

- `CSVDataSource` の初期化時に `isHeaderDriven: true` を指定
- すべてのCSV読み込みでヘッダ駆動型を使用

**影響範囲**:
- Bundle内のCSVファイル読み込み
- Resources配下のすべてのCSVファイル

---

### 4. **SimpleWord/Utils/CSVLoader.swift**
**変更内容**: URL指定時もヘッダ駆動型を使用

- `load(from: URL)` メソッドでヘッダ駆動型パーサを使用
- Documents配下のCSVファイルもヘッダに基づいてパース
- ヘッダ行を自動検出・スキップ

**処理フロー**:
1. CSVファイルの1行目をヘッダとして読み取り
2. ヘッダ名に基づいて列マッピングを構築
3. 2行目以降をデータ行としてパース
4. `QuestionItem` の配列を返す

---

## 📊 対応するCSVフォーマット

### パターン1: 中学古典単語
```csv
語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度
あはれ,あはれ,しみじみとした情趣,感動詞「あはれ」から,「もののあはれ」,文学・美学,2
```

### パターン2: 中学英会話
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
Hello!,ハロー,こんにちは！,古英語の挨拶語,Hi / やあ,挨拶,1
```

### パターン3: 列順が異なる場合
```csv
難易度,語句,意味,読み,関連分野,関連語,語源
2,あはれ,しみじみとした情趣,あはれ,文学・美学,「もののあはれ」,感動詞「あはれ」から
```
→ **ヘッダ名に基づいて正しくパース可能！**

---

## 🎯 発音表示機能（既存機能）

**ChoiceCardView.swift** には既に発音表示機能が実装されています:

- ヘッダに「発音」または「カタカナ」が含まれる場合
- 回答後の選択肢カードで語句の後ろに発音を表示
- **表示例**: `Hello! (ハロー)`

**コード位置**: `SimpleWord/QuizComponents/ChoiceCardView.swift` (87-95行目)

```swift
if shouldShowPronunciation {
    Text(questionItem.reading)
        .font(.caption)
        .foregroundColor(.secondary)
}
```

---

## 🔄 データフロー（CSV → QuizView）

```
1. CSVファイル (Resources/ or Documents/)
   ↓
2. CSVLoader.load(from:) / QuestionItemRepository.loadAllItems()
   ↓ [ヘッダ行を読み取り]
   ↓
3. CSVDataSource (isHeaderDriven: true)
   ↓ [ヘッダ名に基づいて列マッピング]
   ↓
4. QuestionItemParser.parseWithHeaders(headers:fields:)
   ↓ [QuestionItem に変換]
   ↓
5. QuizViewModel.items
   ↓ [フィルタ・シャッフル・バッチ準備]
   ↓
6. QuizView.currentItem
   ↓ [画面表示]
   ↓
7. QuestionCardView / ChoiceCardView
   ↓ [発音表示を含む]
```

---

## ✅ 検証結果

### 構文・型チェック
- **エラー**: なし
- **警告**: なし
- **コンパイル**: 正常

### 対応するCSVヘッダ
以下のヘッダ名に対応:
- ✅ `語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度`
- ✅ `語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度`
- ✅ `term,reading,meaning,etymology,related,category,difficulty`
- ✅ 列の順序が異なる場合でも正しくパース

### 後方互換性
- ✅ 既存のCSVファイルはすべて正常に動作
- ✅ 固定列順モードも維持（必要に応じて使用可能）
- ✅ 既存のテストコードは影響を受けない

---

## 📝 重要なポイント

### 1. **CSVファイルのヘッダが最優先**
- ヘッダ名に基づいて列を動的にマッピング
- 列の順序が変わっても正しくパース
- CSVファイルを編集するだけで列構成を変更可能

### 2. **柔軟なヘッダ名に対応**
- 日本語・英語両方に対応
- 括弧付きの詳細説明も認識（例: `読み（ひらがな）` → `読み`）
- 別名・表記ゆれにも対応

### 3. **エラーハンドリング**
- ヘッダが見つからない場合は空文字列で初期化
- 必須フィールド（語句、意味）が空の場合はパース失敗
- パース失敗時は該当行をスキップして続行

### 4. **パフォーマンス**
- ヘッダ解析は1回のみ（初回読み込み時）
- データ行のパースは高速（辞書ルックアップのみ）
- メモリ効率は従来と同等

---

## 🚀 今後の拡張性

### すぐに対応可能な拡張
1. **新しい列の追加**
   - CSVに列を追加
   - `QuestionItemParser.parseWithHeaders` に列マッピングを追加
   - `QuestionItem` モデルにプロパティを追加

2. **列名の変更**
   - `parseWithHeaders` の `columnMapping` に別名を追加するだけ
   - CSVファイルの変更は不要

3. **オプション列の追加**
   - 存在しない列は空文字列で初期化されるため、後から追加可能

### 推奨しない変更
- 列数を極端に増やす（パフォーマンス低下）
- 必須列（語句、意味）の削除（パース失敗の原因）

---

## 📚 関連ドキュメント

以下のドキュメントも更新済み:
- `README_V2.md` - CSVフォーマット例
- `docs/仕様書/03_問題集管理_CSV_仕様書.md` - CSVフォーマット仕様
- `docs/仕様書/07_CSV編集_仕様書.md` - CSV編集ガイド
- `docs/仕様書/99_ファイル索引.md` - ファイル一覧

---

## 🎉 まとめ

### 達成できたこと
✅ CSVファイルのヘッダを最優先で扱うヘッダ駆動型パーサを実装  
✅ 列の順序に依存しない柔軟なパース処理  
✅ 日本語・英語両方のヘッダ名に対応  
✅ 発音表示機能の確認（既存機能が正常動作）  
✅ 後方互換性の維持  
✅ ドキュメントの整合性確保  

### ユーザーへの影響
- CSVファイルのヘッダを編集するだけで列構成を変更可能
- 列の順序を気にせずCSVを編集可能
- 既存のCSVファイルはすべてそのまま動作

### 次のステップ
アプリを起動してQuizViewで以下を確認してください:
1. 問題が正しく出題されること
2. 回答後の選択肢カードで発音が表示されること（英会話CSVの場合）
3. 複数のCSVファイルが正しく読み込まれること

---

**以上、CSVヘッダ駆動型パーサの実装が完了しました！** 🎊
