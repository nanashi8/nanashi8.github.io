# エラー解決プロトコル

最終更新: 2025年10月23日

## 目的

このドキュメントは、GitHub Copilotがエラー修正を行う際の標準手順を定義し、修正漏れやデグレードを防止するためのプロトコルです。

---

## 重要な教訓：過去の失敗事例

### 事例1: QuizView無限ループ問題（2025-10-23）

**問題**: ContentViewからQuizViewへの画面遷移が動作せず、CPUとメモリが際限なく増加

**根本原因**:
1. 環境オブジェクト（@EnvironmentObject）の注入漏れ
2. `.onReceive`修飾子による無限ループ

```swift
// ❌ 無限ループを引き起こすコード
.onReceive(currentCSV.$name) { _ in
    loadContent()  // ビュー更新 → 再レンダリング → onReceive発火 → 無限ループ
}
```

**学んだこと**:
- SwiftUIのビューライフサイクルを深く理解する必要がある
- `.onReceive`や`.onChange`は慎重に使用する
- 環境オブジェクトの伝搬を明示的に確認する

---

## エラー解決の標準手順

### ⚠️ 重要な前提

**修正は一度で完璧にすることを目指すのではなく、段階的に問題を切り分けて解決する**

1. まずビルドエラーを解決
2. 次に実行時エラーを解決
3. 最後に動作を検証

**各段階で必ず実機/シミュレータでの動作確認を行う**

---

### フェーズ1: 問題の完全な理解（15分）

#### 1.1 ユーザーからの情報収集（必須）
- [ ] エラーメッセージの全文を確認
- [ ] 再現手順を**ステップバイステップ**で確認
- [ ] 期待される動作を確認
- [ ] 環境情報（OS、Xcodeバージョン、デバイス）を確認
- [ ] **前回の修正内容を確認**（同じ問題を繰り返さないため）

#### 1.2 症状の詳細分析（必須）
- [ ] コンパイルエラー vs ランタイムエラー vs UIの問題 を識別
- [ ] エラーの発生タイミングを特定（起動時、画面遷移時、ボタンタップ時など）
- [ ] 関連する機能・画面を特定
- [ ] **Debug Navigator（CPU、メモリ、ネットワーク）の情報を確認**
  - CPUが異常に高い → 無限ループの可能性
  - メモリが際限なく増加 → メモリリークまたは無限ループ
  - 画面遷移しない → 環境オブジェクト不足またはNavigation設定ミス

#### 1.3 影響範囲の特定（必須）
- [ ] 影響を受けるファイルをリストアップ
- [ ] 依存関係を確認（特に@EnvironmentObject、@StateObject、@ObservedObject）
- [ ] 環境オブジェクトの伝搬経路を**明示的に**確認
- [ ] NavigationStackの階層構造を確認

#### 1.4 過去の類似事例の確認（推奨）
- [ ] このドキュメントの「重要な教訓」セクションを確認
- [ ] 類似の症状がないか検索

### フェーズ2: 根本原因の特定（15分）

#### 2.1 コードの詳細調査
```bash
# 必ず実行するチェック項目
1. file_search で関連ファイルを検索
2. read_file で完全なコードを読み取る（部分的な読み取りは避ける）
3. grep_search で依存関係を調査
4. get_errors でコンパイルエラーを確認
```

#### 2.2 SwiftUI特有の問題パターンチェック

**パターン1: 環境オブジェクトの欠落**
```swift
// ❌ 悪い例
NavigationLink(destination: SomeView()) { ... }

// ✅ 良い例
NavigationLink(destination: SomeView()
    .environmentObject(store1)
    .environmentObject(store2)) { ... }
```

**パターン2: 無限ループ（Reactive Programming）**
```swift
// ❌ 悪い例：ビューの再レンダリングがトリガーを再発火
.onReceive(publisher) { _ in
    self.stateVariable = newValue  // これがビュー更新 → 再レンダリング → onReceive
}

// ✅ 良い例：条件付きで更新
.onReceive(publisher) { newValue in
    if self.stateVariable != newValue {
        self.stateVariable = newValue
    }
}

// ✅ より良い例：.onAppearのみ使用
.onAppear {
    loadData()
}
```

**パターン3: @Published プロパティの連鎖更新**
```swift
// ❌ 悪い例
@Published var property1: String {
    didSet { updateProperty2() }  // これが無限ループの原因になる可能性
}
```

**パターン4: NavigationStackとNavigationViewの混在**
```swift
// ❌ 悪い例：iOS 16以降は非推奨
NavigationView { ... }

// ✅ 良い例
NavigationStack { ... }
```

#### 2.3 デバッグログの活用
```swift
// 重要なライフサイクルイベントにログを追加
.onAppear {
    print("🎯 [\(Self.self)] appeared")
    loadData()
}

.onDisappear {
    print("👋 [\(Self.self)] disappeared")
}
```

### フェーズ3: 修正の実装（20分）

#### 3.1 修正前のチェックリスト
- [ ] 修正対象ファイルの全体を読み取った
- [ ] 依存関係を把握した
- [ ] 環境オブジェクトの注入経路を確認した
- [ ] 副作用を最小限にする方法を検討した

#### 3.2 修正の実装
- [ ] **最小限の変更**で問題を解決する
- [ ] コメントで変更理由を明記する
- [ ] 既存のコーディング規約に従う

#### 3.3 修正後の必須チェック
```bash
# 必ず実行する検証
1. get_errors で新たなエラーがないか確認
2. run_in_terminal でビルドを実行
3. 関連する画面の動作確認
4. メモリリークがないか確認（Instruments使用推奨）
```

### フェーズ4: 検証とテスト（15分）

#### 4.1 ビルド検証
```bash
xcodebuild -project SimpleWord.xcodeproj \
  -scheme SimpleWord \
  -configuration Debug \
  -destination 'platform=iOS Simulator,id=DEVICE_ID' \
  clean build
```

#### 4.2 実行時検証チェックリスト
- [ ] 対象画面への遷移が正常に動作する
- [ ] CPUとメモリの消費が正常範囲内である
- [ ] 環境オブジェクトが正しく注入されている
- [ ] 画面遷移後の機能が正常に動作する
- [ ] エラーログやクラッシュが発生しない

#### 4.3 リグレッション確認
- [ ] 修正により他の機能が壊れていないか
- [ ] 既存のテストが全て通過するか
- [ ] 関連する画面遷移が全て動作するか

### フェーズ5: ドキュメント化（5分）

#### 5.1 修正内容の記録
- [ ] 何が問題だったか
- [ ] なぜそれが問題だったか
- [ ] どのように修正したか
- [ ] 今後の予防策

---

## SwiftUI開発における重要な原則

### 1. 環境オブジェクトの明示的な伝搬

**原則**: NavigationLinkで遷移する際は、必要な環境オブジェクトを明示的に注入する

```swift
// ✅ 正しい実装
NavigationLink(destination: DetailView()
    .environmentObject(store)
    .environmentObject(settings)) {
    Text("詳細")
}
```

### 2. Reactive Programmingの慎重な使用

**原則**: `.onReceive`や`.onChange`は無限ループを引き起こす可能性があるため、必ず条件チェックを入れる

```swift
// ✅ 正しい実装
.onReceive(publisher) { newValue in
    // 条件チェックで無限ループを防止
    guard self.currentValue != newValue else { return }
    self.currentValue = newValue
}
```

### 3. ビューライフサイクルの理解

**ライフサイクル順序**:
1. `init()` - ビューの初期化
2. `body` - ビューの構築
3. `.onAppear` - ビューが表示される直前
4. `.onDisappear` - ビューが消える直前

**原則**: データロードは`.onAppear`で行い、`.onReceive`での自動リロードは避ける

### 4. 状態管理の単一責任

**原則**: 各@Publishedプロパティは単一の責任を持ち、didSetでの連鎖更新は避ける

---

## 緊急時の対応フロー

### CPU/メモリが際限なく増加する場合

1. **即座に疑うべき箇所**:
   ```swift
   // これらのパターンをチェック
   .onReceive(...)
   .onChange(...)
   didSet { ... }
   willSet { ... }
   ```

2. **デバッグ手順**:
   ```swift
   // 各修飾子にログを追加
   .onReceive(publisher) { value in
       print("⚠️ onReceive triggered: \(value)")
       // 処理
   }
   ```

3. **修正方針**:
   - `.onReceive`を削除し、`.onAppear`のみにする
   - 条件チェックを追加する
   - PublisherとSubscriberの関係を見直す

### 画面遷移が動作しない場合

1. **即座にチェックすべき項目**:
   - [ ] NavigationStack/NavigationViewが正しく配置されているか
   - [ ] 環境オブジェクトが注入されているか
   - [ ] 遷移先のViewのinitが成功するか

2. **デバッグログ追加**:
   ```swift
   NavigationLink(destination: {
       print("🔗 Creating destination view")
       return DetailView()
           .environmentObject(store)
   }()) {
       Text("Go")
   }
   ```

---

## チェックリストテンプレート

### エラー修正前チェックリスト

```markdown
- [ ] 問題の症状を完全に理解した
- [ ] 再現手順を確認した
- [ ] 関連ファイルを全て読み取った
- [ ] 依存関係を把握した
- [ ] 根本原因を特定した
- [ ] 修正方針を決定した
```

### エラー修正後チェックリスト

```markdown
- [ ] get_errorsでエラーがないことを確認
- [ ] ビルドが成功することを確認
- [ ] 対象機能が正常に動作することを確認
- [ ] CPU/メモリ消費が正常範囲内であることを確認
- [ ] リグレッションがないことを確認
- [ ] 修正内容をドキュメント化した
```

---

## 自動化ツールとスクリプト

### ビルド＆検証スクリプト

```bash
#!/bin/bash
# build_and_verify.sh

echo "🔨 Building project..."
xcodebuild -project SimpleWord.xcodeproj \
  -scheme SimpleWord \
  -configuration Debug \
  -destination 'platform=iOS Simulator,name=iPhone 17' \
  clean build 2>&1 | tee build.log

if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "✅ Build succeeded"
    
    # エラーと警告の数を集計
    ERROR_COUNT=$(grep -c "error:" build.log || true)
    WARNING_COUNT=$(grep -c "warning:" build.log || true)
    
    echo "📊 Errors: $ERROR_COUNT"
    echo "📊 Warnings: $WARNING_COUNT"
    
    if [ $ERROR_COUNT -eq 0 ]; then
        echo "🎉 No errors found!"
        exit 0
    else
        echo "❌ Found $ERROR_COUNT errors"
        exit 1
    fi
else
    echo "❌ Build failed"
    exit 1
fi
```

---

## GitHub Copilotへの指示（このドキュメントを常に参照）

### エラー修正時の必須アクション

1. **このドキュメントを参照する**
2. **標準手順に従う**
3. **チェックリストを完遂する**
4. **検証を必ず実行する**

### 報告フォーマット

修正完了時は以下のフォーマットで報告する：

```markdown
## 修正完了報告

### 問題
- [問題の説明]

### 根本原因
- [原因の詳細]

### 修正内容
- [ファイル名]: [変更内容]

### 検証結果
- [ ] ビルド成功
- [ ] 動作確認完了
- [ ] リグレッションなし
- [ ] CPU/メモリ正常

### 今後の予防策
- [予防策の提案]
```

---

## 更新履歴

- 2025-10-23: 初版作成（QuizView無限ループ問題を受けて）
