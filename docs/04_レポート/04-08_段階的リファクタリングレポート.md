# 段階的リファクタリングレポート

**作成日**: 2025年11月9日  
**対象**: SimpleWordプロジェクト全体  
**目的**: エラー頻発の解消、アーキテクチャの簡素化、Swift 6並行性対応

---

## 📋 概要

プロジェクトのエラーが頻発しているため、以下の段階的リファクタリングを実施します：

1. **Phase 1**: 緊急のビルドエラー修正 ✅ **完了**
2. **Phase 2**: アーキテクチャの整理 🔄 **進行中**
3. **Phase 3**: Swift 6並行性対応 📝 **計画中**
4. **Phase 4**: コードの簡素化 📝 **計画中**

---

## ✅ Phase 1: 緊急のビルドエラー修正（完了）

### 修正内容

#### 1. CoreDataWordIDProvider.swift
**問題**: `existing.uuid`がString型なのにOptional型としてバインドしようとしていた  
**修正**: 明示的に変数に代入してから`UUID(uuidString:)`を呼び出す

```swift
// 修正前
if let existing = try? context.fetch(req).first,
   let u = existing.uuid {  // ❌ String型をOptionalとしてバインド
    result = UUID(uuidString: u)
}

// 修正後
if let existing = try? context.fetch(req).first {
    let uuidString = existing.uuid  // ✅ String型として取得
    result = UUID(uuidString: uuidString)  // Optional<UUID>を返す
}
```

#### 2. IDMapMaintenance.swift
**問題**: Swift 6の並行性で`@Sendable`クロージャ内での変数変更が警告されていた  
**修正**: `performAndWait`の戻り値を使用してクロージャ外で値を受け取る

```swift
// 修正前
var count = 0
ctx.performAndWait {
    count = ... // ⚠️ キャプチャした変数の変更
}

// 修正後
let result = ctx.performAndWait { () -> Stats in
    let count = ...
    return Stats(count: count, ...) // ✅ 戻り値で返す
}
```

### ビルド結果
```
** BUILD SUCCEEDED **
```

---

## 🔄 Phase 2: アーキテクチャの整理（進行中）

### 現在の設計分析

#### データ取得の経路

```
View
  ↓
CSVLoader (SimpleWord/Utils/)
  ↓
QuestionItemRepository (Common/Data/Repository/)
  ↓
CSVDataSource (Common/Data/DataSource/)
  ↓
QuestionItemParser (Common/Data/Parcer/)
```

#### 発見された重複・問題点

1. **Legacy アダプター** - 使用されていない
   - `LegacyCSVLoaderAdapter.swift`
   - `LegacyCSVQuestionLoaderAdapter.swift`
   - 実際のコードで`import`されていない
   - `@available(*, deprecated)`だが削除されていない

2. **CSVLoader の役割重複**
   - `CSVLoader`は単純に`QuestionItemRepository`をラップしているだけ
   - 直接`QuestionItemRepository`を使用すれば良い

3. **複数のパーサーモード**
   - ヘッダ駆動型（推奨）
   - 固定列順モード（後方互換性）
   - 実質的にヘッダ駆動型に統一されているが、コードが残っている

### 整理計画

#### ステップ1: Legacyファイルの削除 ✨
- `Common/Data/Legacy/` フォルダを完全削除
- ドキュメント参照のみで実コード使用なし

#### ステップ2: CSVLoaderの簡素化
- `CSVLoader`を削除して`QuestionItemRepository`に直接置き換え
- または、`CSVLoader`を薄いファサードとして再定義

#### ステップ3: パーサーモードの統一
- 固定列順モードのコードを削除
- ヘッダ駆動型のみに統一

---

## 📝 Phase 3: Swift 6並行性対応（計画中）

### 対応項目

1. **actor導入**
   - データストア（`QuizSessionStore`、`ScoreStore`など）を`actor`に変更
   - データ競合を完全に防止

2. **@MainActor配置**
   - UI更新を行うViewModelに`@MainActor`を適切に配置
   - `@Published`プロパティの安全性確保

3. **Sendable準拠**
   - モデル型（`QuestionItem`、`QuizSettings`など）を`Sendable`に準拠
   - 並行処理で安全に渡せるようにする

---

## 📝 Phase 4: コードの簡素化（計画中）

### 対応項目

1. **過剰な抽象化の削除**
   - 使用されていないプロトコルの削除
   - 単一実装のプロトコルの削除

2. **責務の明確化**
   - 各クラスの責務を明確にする
   - コメントで「何を」「なぜ」を明示

3. **テスタビリティの向上**
   - 依存性注入を適切に使用
   - モックしやすい設計

---

## 🎯 期待される効果

### ビルドの安定性
- ✅ ビルドエラーの解消
- ✅ Swift 6並行性警告の解消
- 📈 コンパイル時間の短縮（アーキテクチャ簡素化により）

### コードの可読性
- 📈 不要な抽象化の削除により理解しやすくなる
- 📈 責務が明確になり、修正箇所が特定しやすくなる
- 📈 新機能追加時の影響範囲が明確になる

### 保守性の向上
- 📈 重複コードの削除により保守箇所が減少
- 📈 テストしやすくなる
- 📈 バグの混入リスクが低下

---

## 📊 進捗状況

| Phase | ステータス | 完了率 |
|-------|-----------|--------|
| Phase 1: ビルドエラー修正 | ✅ 完了 | 100% |
| Phase 2: アーキテクチャ整理 | 🔄 進行中 | 30% |
| Phase 3: Swift 6並行性対応 | 📝 計画中 | 0% |
| Phase 4: コードの簡素化 | 📝 計画中 | 0% |

**全体進捗**: 32%

---

## 🚀 次のステップ

1. **Phase 2を完了させる**
   - Legacyファイルの削除
   - CSVLoaderの簡素化
   - パーサーモードの統一

2. **Phase 3に着手**
   - actorの導入計画を立てる
   - @MainActorの配置を決定

3. **継続的なテスト**
   - 各フェーズごとにビルドテストを実施
   - 機能が正しく動作することを確認

---

**このレポートは随時更新されます。**
