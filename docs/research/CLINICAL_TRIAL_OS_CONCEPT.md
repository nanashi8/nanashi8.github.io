# 未知駆動開発(UDD)の代謝監視の検証可能性について

**作成日**: 2026年1月13日  
**ステータス**: 検証設計フェーズ（A：後追いシミュレーション）  
**関連**: 未知駆動開発（UDD）方法論（別ドキュメント化予定）

## 要約（3000字以内）

本構想は「未知駆動開発（UDD）を代謝データ監視に適用できるか」を、外部公開データを用いた後追いシミュレーション（A案）で**検証可能な形に落とす**ことを目的とする。ここでの成果は性能の断言ではなく、分割設計・リーク対策・前処理の扱いを固定し、結果が良くても悪くても「壊れ方」を原因分解して次の観測や設計変更へ接続できることにある。

基本仮説は、マーカー固定の監視よりも「全観測（既知/未同定ピークを含む）」の方が、異常・未知を取りこぼしにくいという点にある。ただし、全観測で精度が上がる保証はしない。むしろ代謝ではバッチ・欠損・前処理差が大きな偽性要因になるため、**偽性分離（前処理）とValidate-first（分割とリーク遮断）**を最初に固める。

データ形によって検証目的は分岐する。
- **時系列＋イベントラベルあり**：早期兆候（リードタイム）や偽警報率まで含めて評価する。
- **時系列なし（ケース/コントロール等）**：目的を「外部分割で再現する判別＋不確実性/OODで未知を分類」へ寄せ、リードタイム評価は行わない。

検証の中心は、(1) 前処理のfitは訓練側のみ、(2) 時間順/患者リーク禁止、(3) 可能ならバッチ/施設で外部分割、(4) ベースライン（マーカー固定・ルールベース等）との比較、(5) 指標はAUROC/AUPRCだけでなく運用指標（偽警報・閾値運用・キャリブレーション・再現性）を含める、である。未知は「分布未知/観測未知/ラベル未知/評価未知（リーク等）」などに分解し、失敗がどの未知に属するかをログとして残す。

停止条件（次へ行かない判断）は、外部分割で崩壊して原因分解できない、偽警報率が運用不能、データ品質（QC逸脱/欠損/バッチ）で結論がほぼ決まる、などを明示する。

次のアクションは、公開データ候補を1つ選び（候補：MetaboLightsのMTBLS17/19/1など）、アクセッション/DOI・ライセンス・欠損点を固定した上で評価プロトコルを確定し、後追い逐次シミュレーションを回してGo/No-Go判定へ進む。

---

## 0. この文書の狙い（検証可能性の評価）

この文書は「UDDの代謝監視」が実運用で有効だと断言するものではない。
外部公開データを用いた **後追いシミュレーション（A案）** により、
次を **検証可能な形に落とす** ことが狙いである。

### 0-1. 何を“検証できた”とするか

- **Validate-firstが成立**：分割設計とリーク対策を固定した上で、評価が回る（手続きとして破綻しない）
- **結果より原因分解**：うまくいってもいかなくても、失敗原因を「分布未知/観測未知/ラベル未知/評価未知」などへ分類し、
  次の観測・設計変更につなげられる

### 0-2. このフェーズで主張しないこと（できないこと）

- リアルタイム介入（用量調整等）の有効性
- 「全観測なら精度が上がる」などの性能保証
- 規制・GxP・責任分界の充足（ここは別プロジェクト）

### 0-3. データ形による目的の分岐（重要）

- **時系列＋イベントラベルあり**：早期兆候（リードタイム）まで評価対象にできる
- **時系列なし（ケース/コントロール）**：目的は「外部分割で再現する判別＋未知の分類」に寄せ、
  リードタイム評価は行わない

### 0-4. 用語について

本文中に出てくる「治験OS」は、将来像（参照アーキテクチャ）を指す呼称として扱う。
この文書の主眼は、将来像を **今ある公開データでどこまで検証できるか** にある。

## 1. 核心的な問い：なぜマーカーではなく全観測監視なのか

### 従来の治験（マーカー駆動）
```
仮説: 「代謝物Xが薬効のマーカーである」
 ↓
代謝物Xのみを測定・監視
 ↓
結果: Xが変化しなければ「効果なし」と判断
```

**問題点**：
- 人間が選んだマーカーだけを見る＝それ以外の変化を見逃す
- 未知のマーカー・組み合わせパターンは検出不可能
- 有害事象の予兆が別の代謝経路に出ていても気づけない

### UDD代謝監視（全観測監視＋未知駆動）
```
観測: LC-MS全ピーク（既知・未知含む）×時系列×全患者
 ↓
AI監視: 「いつもと違う」パターンを自動検出（OOD/異常検知）
 ↓
仮説生成: 「患者群Aで未知ピーク群Yが増加→有害事象と相関」
 ↓
偽性削減: ピーク同定・追加測定・プロトコル調整
 ↓
真性漸近: 新マーカー発見＋プロトコル最適化
```

**利点**：
- 実験機器が認識できる全データが監視対象
- 人間の仮説の外側（未知）も自動で捕捉
- （将来像として）リアルタイムで学習→次の患者で検証

---

## 2. 参照アーキテクチャ：UDD代謝監視の5層（将来像）

### レイヤー0：データ統合基盤（Observation Layer）

**役割**：全観測データをリアルタイムで集約

**データソース**：
- **代謝データ（全ピーク）**
  - LC-MS/GC-MS: 全ピーク表（m/z, retention time, intensity）
  - NMR: 全スペクトル
  - **重要**：未同定ピークも含めて全て保存
- **臨床データ**
  - バイタルサイン（連続測定）
  - 血液検査（従来項目）
  - 有害事象ログ
  - 薬剤投与記録（用量・時刻）
- **メタデータ**
  - 患者背景（年齢・性別・併用薬・食事）
  - サンプル前処理条件
  - 測定機器・バッチ情報

**技術要件**：
- リアルタイム性：測定後24時間以内に統合
- データフォーマット標準化（mzML, ISA-Tab等）
- バッチ効果補正の自動適用

---

### レイヤー1：前処理・偽性分離層（Preprocess & Noise Filtering）

**役割**：観測データから「測定ノイズ（偽性）」を分離

**処理**：
1. **バッチ効果補正**
   - 測定日・機器の違いによるドリフトを補正
   - 内部標準物質・QCサンプルで校正
2. **欠損値処理**
   - ピーク検出閾値以下→検出限界として扱う
   - 完全ランダム欠損（MCAR）vs 情報的欠損（MNAR）の判別
3. **外れ値の初期フィルタ**
   - 明らかな測定エラー（サンプル取り違え等）を除外
   - **注意**：生物学的な外れ値（真の異常）は残す

**出力**：
- 補正済みデータ行列（患者×全ピーク×時点）
- 信頼度スコア（各測定値の品質）

---

### レイヤー2：未知検知・異常検出層（Unknown Detection）

**役割**：「いつもと違う」パターンをリアルタイムで検出

#### 2-1. ベースライン異常検知
各患者のベースライン（投薬前）から、投薬後の乖離を検出。

**手法**：
- **Hotelling's T²統計量**：多変量での異常度
- **マハラノビス距離**：ベースラインからの距離
- **Isolation Forest / LOF**：局所密度ベースの異常検知

**出力例**：
```
患者ID: P042
時点: Day 7
異常スコア: 0.87 (閾値0.75超)
寄与ピーク: m/z 234.1234 (RT 5.2min), m/z 456.7890 (RT 8.9min)
→ この2ピークが通常範囲を逸脱
```

#### 2-2. OOD（Out-of-Distribution）検知
「これまで見たことがないパターン」の検出。

**手法**：
- **Energy-based OOD**：モデルの出力エネルギーで判定
- **Deep Ensemble**：複数モデルの不一致度
- **Mahalanobis距離（特徴空間）**：既知患者群の分布外を検出

**出力例**：
```
患者ID: P081
OODスコア: 0.92
解釈: 既存の「応答群」「非応答群」のどちらにも属さない代謝プロファイル
→ 新しい患者サブタイプの可能性
```

#### 2-3. 時系列パターン異常
変化の"速度"や"パターン"の異常を検出。

**手法**：
- **Dynamic Time Warping (DTW)**：正常時系列との距離
- **Autoencoder再構成誤差**：時系列の圧縮・復元で異常検知
- **変化点検出**：突然の代謝シフトを捕捉

**出力例**：
```
患者ID: P103
異常時点: Day 3 → Day 4
検出内容: 胆汁酸代謝系が急激に変化（正常では緩やか）
→ 肝機能障害の予兆可能性
```

---

### レイヤー3：予測・仮説生成層（Hypothesis Generation）

**役割**：観測された異常から、**なぜその変化が起きたか**の仮説を生成

#### 3-1. 応答性予測モデル
ベースライン代謝→薬剤応答性の予測。

**入力**：
- Day 0（投薬前）の全代謝プロファイル
- 患者背景情報

**出力**：
- 応答確率（0-1）
- **不確実性**（予測区間・エントロピー）
- 寄与ピーク（SHAP値等で解釈）

**例**：
```
患者ID: P150
予測: 応答確率 0.72 ± 0.15 (不確実性中)
寄与上位ピーク:
  1. m/z 345.2100 (正の寄与 +0.18)
  2. m/z 789.4567 (負の寄与 -0.12)
→ このパターンは「応答群」に近い
```

#### 3-2. 有害事象リスク予測
代謝変化→有害事象発生の予測。

**学習データ**：
- 過去の有害事象発生患者の時系列代謝データ
- 発生の2-7日前のパターンを学習

**出力**：
```
患者ID: P042
リスクスコア: 0.88 (高リスク)
予測イベント: 肝機能障害（AST/ALT上昇）
リードタイム: 推定3日前
推奨アクション: 追加肝機能検査・用量減量検討
```

#### 3-3. 患者層別化（サブグループ発見）
代謝プロファイルで患者を自動クラスタリング。

**手法**：
- **教師なしクラスタリング**（k-means, DBSCAN）
- **階層クラスタリング**：代謝経路の近さで分類
- **トピックモデル**：複数の代謝パターンの混合として表現

**出力例**：
```
発見: 患者群を3サブグループに分類
  Group A (n=25): 糖代謝優位型 → 標準用量で効果良好
  Group B (n=18): 脂質代謝優位型 → 用量50%減でも同等効果
  Group C (n=12): 混合型 → 効果予測困難（追加観測必要）
```

---

### レイヤー4：介入・偽性削減層（Intervention & Noise Reduction）

**役割**：検出された異常・不確実性に対して、**どう介入するか**を決定

#### 4-1. 追加観測の推奨
不確実性が高い患者に、追加測定を推奨。

**判断基準**：
- 予測の不確実性が閾値超（例：±0.2以上）
- OODスコアが高い（未知パターン）
- 重要な意思決定の前（用量変更・継続判断）

**推奨例**：
```
患者ID: P081
状況: OODスコア高・予測不確実
推奨: 
  1. 追加代謝測定（脂質詳細プロファイル）
  2. トランスクリプトーム解析（遺伝子発現）
  3. 患者への詳細問診（食事・併用薬）
→ これらで「未知」を「既知」に変換
```

#### 4-2. プロトコル最適化
観測結果から、プロトコル自体を修正。

**適応的デザインの例**：
```
中間解析時点（n=50）
発見: Group Bは低用量でも効果同等
提案: 
  - 次のn=25はGroup B判定後に用量50%で開始
  - 有害事象リスク低減＋コスト削減
判断: 独立データ安全性監視委員会（DSMB）承認必要
```

#### 4-3. 早期中止判断
無益性（futility）や安全性問題の早期検出。

**基準**：
- 応答率が事前設定閾値を下回る確率が95%超
- 有害事象リスクが許容範囲超
- OOD患者の増加（プロトコルの前提が崩れている）

---

### レイヤー5：学習・真性漸近層（Learning & Truth Convergence）

**役割**：全患者の観測結果からモデルを更新し、**真性（本質的構造）へ漸近**

#### 5-1. 逐次学習（Online Learning）
患者1人のデータが追加されるたびにモデルを更新。

**手法**：
- **ベイズ更新**：事前分布→事後分布の更新
- **Incremental Learning**：過去データを保持せず逐次更新
- **Experience Replay**：重要な過去症例を再学習

**この層で主張しないこと（重要）**：
- 観測が増えれば精度が上がる、とは断言しない（データ品質・リーク・ラベル定義で悪化しうる）
- 「逐次学習＝オンライン運用の正当性」を自動的に保証しない（GxP/規制・再現性・監査が別問題）

**この層で実際に検証すること（計測項目）**：
- 予測性能の推移（例：AUROC/AUPRC/感度/特異度）を、患者追加順序の違いも含めて分布で評価
- 不確実性推定の健全性（キャリブレーション、予測区間の妥当性）
- OOD/異常検知の再現性（同一条件・別バッチ・別施設での再現）
- 患者層別化の安定性（クラスタの再現性、割当の頑健性）

#### 5-2. 偽性削減の可視化
何が改善されたかを記録・可視化。

**トラッキング指標**：
- **予測不確実性の減少**：時間経過での予測区間幅の縮小
- **OOD率の低下**：未知パターンが既知に移行
- **未同定ピークの同定率**：何個のピークが「既知」になったか

**ダッシュボード例（数値は例示しない）**：
```
進行状況（n=?, 期間=?）
━━━━━━━━━━━━━━━━━━━━━━━━━━━
データ品質: バッチ数=?, 欠損率=?, QC逸脱=?
性能（予測）: AUROC=?, AUPRC=?, キャリブレーション誤差=?
性能（異常）: 早期警報リードタイム分布=?, 偽警報率=?
未知管理: OOD率=?, 未同定ピークの追跡数=?, 同定進捗=?
━━━━━━━━━━━━━━━━━━━━━━━━━━━
解釈: 改善/悪化は「計測」し、改善を前提にしない
```

#### 5-3. 知見の蓄積・転移学習
複数の治験で学習した知見を次の治験へ転移。

**シナリオ**：
```
治験A（抗がん剤X）で学習:
  「ベースライン代謝物Yが高い患者は応答良好」
  
治験B（抗がん剤X + 併用薬Z）で転移:
  治験Aの知見を事前分布として使用
  → 治験Bでの学習が加速（少数例で精度向上）
```

---

## 3. Aで進める：後追いシミュレーションでの検証（検証可能性評価）

ここでは「実運用できる」ことを前提にせず、**後追い（retrospective）で“UDD代謝監視（将来像）が何を提供しうるか／何が破綻するか”**を検証する。

### 3-1. 目的（達成したいことの定義）

- **目的A（時系列あり）**：全観測監視（未同定ピーク含む）が、既存のマーカー前提よりも「異常の早期兆候」を拾える可能性があるかを検証する
- **目的A'（時系列なし）**：ケース/コントロール等のラベルを、外部分割（バッチ等）で再現よく判別できるか、また不確実性/OODで「未知」を運用可能に分類できるかを検証する
- **目的B**：逐次学習・OOD検知・不確実性推定が、リークなしで成立するかを検証する
- **目的C**：どの段階で“偽性（測定ノイズ・バッチ・欠損・メタデータ欠落）”が支配的になり、システムが誤作動するかを明確にする

### 3-2. データ要件（最低限）

- **時系列がある場合**：患者単位で投与前（ベースライン）と投与後の少なくとも2点
- **時系列がない場合**：患者（またはサンプル）単位のラベル（例：Disease/Group/Case-Control）
- **バッチ/施設情報**：ない場合は“未知の偽性”として扱い、限界を明記する
- **代謝データの表現**：
  - 最低：ピークテーブル（m/z, RT, intensity）
  - 望ましい：QCサンプル、内部標準、同定済みピークのアノテーション

### 3-2.5. 外部公開データで進める（ソースと選定条件）

後追いシミュレーション（A）は、外部公開データだけでも着手できる。重要なのは「入手できる」よりも、**リーク対策込みで評価が成立するデータ形**かどうか。

#### 公開データの主な入手元（候補）

- **MetaboLights**：代謝データ＋メタデータ（ISA-Tab）が比較的揃いやすい
- **Metabolomics Workbench**：臨床寄りデータが見つかることがある
- **Zenodo / Figshare / OSF**：論文付随データとして公開されている場合がある（メタデータの欠落に注意）
- **論文付録（Supplementary）**：ピークテーブルだけが公開されているケース（QC/バッチ情報が抜けやすい）

#### 検索キーワード（サイト内検索の目安）

- longitudinal / time course / baseline / pre post / intervention
- clinical / trial / treatment / adverse event / toxicity
- plasma / serum（まず血液系が扱いやすい）

#### まず狙うべきデータの形（優先順）

1. **同一患者の投与前後（2点以上）＋イベントラベル**（安全性または効果）
2. **バッチ/施設/QC情報がある**（ない場合は限界を明記し、フェーズ1の停止条件に抵触しやすい）
3. **生データ（mzML等）か、少なくとも“ピーク抽出条件が明記されたピークテーブル”**

#### ライセンス・倫理チェック（公開でも必須）

- データの利用条件（CC-BY等）と再配布可否を確認
- 個人同定リスクがない形に加工済みであること（公開リポジトリでも前提にしない）
- 「イベントラベル」が臨床的に何を意味するか（定義・判定タイミング）を必ず確認

### 3-2.6. 取得〜標準化チェックリスト（Phase 1成果物の一部）

- **取得**：アクセッション/DOI、取得日時、取得元URL、ライセンスを記録
- **原データ保全**：ダウンロードしたアーカイブのハッシュ（例：SHA-256）を残す
- **メタデータ整備**：
  - 患者ID（匿名ID）
  - 採取時点（Day、週、投与回数などの“順序”が分かる形）
  - バッチ/施設/機器（分かる範囲）
  - イベント（AE/効果）の定義・判定時点
- **表現統一**：
  - 代謝データを「患者×時点×特徴量」に落とす（特徴量＝ピーク or 同定代謝物）
  - 欠損の意味（非検出/未測定）を分ける
- **分割ルール固定**：時間順・施設/バッチ・患者リーク禁止を明文化してから学習を回す

### 3-3. 後追いシミュレーションの設計（リーク対策を含む）

このフェーズの主張は「リアルタイムに学習できる」ではなく、**“リアルタイムを模した制約下で、どこまで検証可能な兆候を出せるか”**で評価する。

#### データ分割（必須）
- **時間順分割**：未来の患者・未来の時点を訓練に混ぜない
- **施設/バッチ分割**（可能なら）：施設Aで訓練→施設Bで評価、など
- **同一患者のリーク禁止**：同一患者の将来時点を使って過去時点のモデルを強化しない

#### 比較対象（ベースライン）
- **マーカー固定**：既知少数マーカーのみでモデル化
- **全観測だが非逐次**：全データをまとめて学習（上限性能の参考）
- **ルールベース**：閾値アラート（現場で採用されがちな“弱いが説明しやすい”方法）

#### 評価指標（「精度が上がる」を分解して測る）
- **予測性能**：AUROC/AUPRC だけでなく、偽陽性が許容できる範囲での感度（運用上の曲線）
- **早期警報の有用性**：
  - リードタイム分布（何日前に兆候を出せたか）
  - 偽警報率（アラート疲れを起こす水準か）
  - アラートの“再現性”（再測定・別バッチで同じ患者に同じ傾向が出るか）
- **時系列がない場合**：早期警報（リードタイム）の評価は行わず、外部分割での再現性・キャリブレーション・不確実性/OODの内訳（分布未知/観測未知/評価未知）を重視する
- **キャリブレーション**：予測確率が確率として意味を持つか（意思決定に耐えるか）
- **未知の扱い**：OODフラグが「単なるノイズ警報」になっていないか（原因の内訳を出す）

### 3-4. 進行ログの例（成功を前提にしない）

後追いシミュレーションで重要なのは、**「良い結果」より「壊れ方が見えること」**。

```
ステップ: 患者を1人追加（n=k→k+1）
観測: ベースライン＋投与後データ

検出: 異常スコア↑ / OOD↑ / 不確実性↑
解釈: 
  - バッチ起因の疑い（QC逸脱）
  - メタデータ欠落（併用薬不明）
  - 真の生物学的変化の可能性

アクション（後追いなので“提案”として記録）:
  - 追加測定推奨（MS/MS、再抽出、別ロット）
  - ラベル定義の再確認（AEの定義揺れ）
  - モデルの凍結/再学習（ドリフト検出）

評価: 
  - その提案が“もし実施されていたら”偽陽性/偽陰性がどう変わるか
```

---

---

## 4. 技術スタック（実装に必要な要素）

### データ基盤
- **データレイク**: AWS S3 / Azure Blob（生データ保存）
- **データベース**: PostgreSQL + TimescaleDB（時系列最適化）
- **リアルタイム処理**: Apache Kafka / AWS Kinesis

### 前処理・品質管理
- **バッチ効果補正**: ComBat, SVA（R/Python）
- **欠損値補完**: missForest, KNN imputation
- **品質管理**: PCA, QC sample tracking

### AI/ML
- **異常検知**: Isolation Forest, LOF, Autoencoder（scikit-learn, PyTorch）
- **OOD検知**: Energy-based, Mahalanobis, Deep Ensemble
- **予測モデル**: XGBoost, Random Forest, Neural Networks
- **不確実性推定**: Bayesian Neural Networks, Quantile Regression

### 可視化・ダッシュボード
- **リアルタイム監視**: Grafana, Plotly Dash
- **代謝経路可視化**: Cytoscape.js, MetaboAnalyst
- **レポート自動生成**: R Markdown, Jupyter Book

### インフラ
- **計算資源**: GPU cluster（モデル学習）
- **セキュリティ**: HIPAA準拠、データ暗号化
- **監査証跡**: 全処理のログ記録（GxP対応）

---

## 5. 規制・倫理面での考慮事項

### FDA/PMDAへの対応
- **適応的デザイン**の事前届出
- **AI使用の透明性**：モデルの説明可能性（SHAP, LIME）
- **検証計画**：独立データセットでの性能検証

### データ安全性監視委員会（DSMB）
- リアルタイム学習の結果を定期報告
- プロトコル変更の判断基準を事前設定
- 統計的有意性の調整（多重検定）

### 患者同意
- 「AI監視システム使用」の説明・同意
- データ使用範囲（他治験への転移学習含む）
- オプトアウト権の保証

---

## 6. 期待される効果（定量的目標）

この文書では「効果」を先に断言しない。代わりに、A（後追いシミュレーション）で**検証する仮説**と、**成立条件**を定義する。

### 6-1. 検証する仮説（観測可能な形にする）

- **仮説H1（早期兆候）**：全観測監視は、既知マーカー固定よりも“早期に”異常兆候を提示できる場合がある
  - 成立判定：リードタイム分布が改善し、かつ偽警報率が許容域に収まる
- **仮説H2（未知管理）**：OOD/不確実性フラグは、単なるノイズ検出ではなく「追加観測すべきケース」を選別できる場合がある
  - 成立判定：フラグが立った症例で、後追い解析により原因（バッチ/欠損/真の変化）が説明可能である割合が一定以上
- **仮説H3（再現性）**：同様の兆候が、別バッチ/別施設でも再現する場合がある
  - 成立判定：外部分割（施設/バッチ）で性能が崩壊しない、または崩壊要因が特定できる

### 6-2. 成立しない（＝やらない方が良い）ケースの明文化

- メタデータ欠落が支配的で、異常検知が“生活要因/併用薬/採血時刻”の反映になってしまう
- ラベル（有害事象/効果）が曖昧で、学習がラベルノイズに引っ張られる
- 施設/バッチを跨いだ瞬間に性能が崩壊し、補正の根拠も立たない
- 予測確率のキャリブレーションが悪く、意思決定に使えない

---

---

## 7. ロードマップ：段階的実装

### Phase 1: 概念実証（後追いシミュレーション）

**スコープ**：本番運用ではなく、後追いで「UDD代謝監視（将来像）が出す提案」の妥当性を検証する。

**目標**：
- リーク対策込みで、逐次学習・OOD・不確実性・異常検知の評価が回ること
- どの偽性が致命傷になるか（バッチ/欠損/メタデータ欠落/ラベル定義）を具体的に特定すること

**成果物（最低限）**：
- 評価プロトコル（分割方法、ベースライン、指標、停止条件）
- 再現可能な実験ログ（パラメータ、乱数、前処理、結果）
- Go/No-Go判定（次のフェーズに進む根拠、進まない根拠）

**停止条件（これが出たら“次へ行かない”）**：
- 外部分割で性能が崩壊し、原因分解ができない
- 偽警報率が高く、運用の提案として成立しない
- データ品質（QC逸脱/欠損/バッチ）で結果がほぼ決まってしまう

### Phase 2: パイロット治験（参考・範囲外）

Phase 1のGo判定が出た場合のみ検討する。ここでは詳細設計は書かない（規制/運用/責任分界が別プロジェクト）。

### Phase 3: 本格展開（参考・範囲外）

Phase 2の結果と規制当局の見解を踏まえて判断する。

---

## 8. まとめ：全観測監視がもたらすパラダイムシフト

### 従来（マーカー駆動）
```
仮説 → 測定 → 解析 → 知見
 ↑_________________________|
      （次の治験で検証）
```
- **線形的**：1サイクル＝数年
- **閉じた系**：仮説の外は見えない
- **事後的**：治験終了後に初めて学習

### UDD代謝監視（全観測監視＋未知駆動）
```
全測定 → AI監視 → 異常検知 → 仮説生成 → 介入
  ↑______________|_____________|___________|
         （リアルタイムループ）
```
- **並列的**：1患者ごとに学習
- **開いた系**：未知も自動捕捉
- **リアルタイム**：治験中に継続最適化

これは、あなたが定義した**未知駆動開発（UDD）**を、代謝監視に適用する際の「検証可能な設計」として表現したものです。

---

## 9. 補遺：機械学習の基礎理論をUDDへ転用・統合する

ここでは、特定の講義名や組織名に依存せず、**機械学習の基礎理論**をUDDに接続する。
狙いは「モデルを賢くする」ではなく、**未知の種類を分解し、偽性を減らし、検証可能なループに落とす**こと。

### 9-1. UDDの各層と基礎理論の対応

- **Observe（観測）**：データ生成過程、サンプリング、欠損、測定誤差、メタデータ整備
- **Interpret（解釈）**：目的関数（損失）、評価指標、誤差分解、キャリブレーション
- **Hypothesis（仮説）**：仮説空間（モデルクラス）の選択、表現（特徴/潜在表現）の選択
- **Transform（変換）**：正則化、最適化（学習率/収束）、特徴量設計、表現学習
- **Validate（検証）**：分割設計（リーク禁止）、外部分割、アブレーション、頑健性・再現性

後追いシミュレーション（A）では、特に **Validate** を最初に固める（分割とリーク対策が決まらない限り、結果の解釈が成立しない）。

### 9-2. 「未知」を種類別に管理する（運用できる分類）

UDDにおける未知は、次のように分解できる。分解すると「次に何を観測し、どんな検証で潰すか」が決まる。

- **分布未知（シフト/OOD）**：施設・機器・バッチ・時代・患者背景が違う
- **仮説未知（モデル不足）**：扱う構造がモデルクラスに入っていない（非線形、相互作用、潜在因子、時系列など）
- **観測未知（測定/前処理）**：欠損の意味、ピーク抽出条件、QC逸脱、正規化の妥当性
- **ラベル未知（定義/ノイズ）**：イベント定義が揺れる、判定時点が曖昧、アノテーション誤り
- **最適化未知（学習不安定）**：収束しない、局所解、ハイパラが支配的
- **評価未知（リーク/指標ミス）**：未来情報混入、患者リーク、外部分割なし、指標が運用と不整合

この分類は「原因究明のためのラベル」でもある。後追いシミュレーションでは、各失敗がどの未知に属するかをログに残す。

### 9-3. 偽性削減＝“よくある破綻”を先に封じるチェックリスト

#### データ・分割（Validate優先）

- 時間順分割（未来混入なし）
- 同一患者リーク禁止（将来時点・重複サンプル・派生特徴）
- 可能なら外部分割（施設/バッチ）
- 前処理のfitは訓練側のみ（正規化/補正/特徴選択の再学習ルール）

#### 指標（Interpretの固定）

- AUROC/AUPRCだけで終わらせない（偽警報率・閾値運用・リードタイム分布）
- 予測確率のキャリブレーション（意思決定に使えるか）
- “改善した”ではなく、改善が **外部分割でも再現** するか

#### モデル（Hypothesis/Transformの最小化）

- 複雑化は段階的に（ベースライン→全観測→逐次学習→不確実性→OOD の順に追加）
- アブレーションで「どの要素が効いたか」を残す
- 不確実性推定が“適当な数値”になっていないか（キャリブレーションとセット）

### 9-4. UDD代謝監視（代謝全観測）への具体的な落とし込み

代謝データは観測未知が大きい（バッチ、欠損、未同定ピーク）。その前提で、次のように“検証の形”へ落とす。

- **前処理の差分実験**：補正/欠損処理の違いで結論が変わるか（変わるなら“偽性支配”）
- **未同定ピークの扱い**：
  - 追跡ID（m/z, RT, peak group）で同一性を保ち、同一性が崩れたら観測未知として扱う
  - “同定できた数”を成果にしない（同定できなくても予兆として有用かを評価する）
- **早期警報の評価**：
  - 何日前にアラートが出たか（リードタイム）
  - そのアラートが別バッチでも再現するか
  - アラートが臨床イベント定義（ラベル）と整合するか

---

## 次のアクション

要望に合わせて **A（後追いシミュレーション）** で進める。

1. **データ候補の確定（外部公開データ）**
  - MetaboLights / Metabolomics Workbench / Zenodo等から、時系列＋イベントラベルが揃う候補をショートリスト化
  - そのうち1つを選び、アクセッション/DOI・ライセンス・欠損点（メタデータ不足など）を記録し、Phase 1の入力として固定
  - 候補データが **時系列なし** の場合は、目的を「目的A'（外部分割で再現する判別＋未知の分類）」に切り替え、
    リードタイム指標は使わない
  - （暫定）MetaboLightsの候補（APIで機械抽出、要：ライセンス/ラベル最終確認）
    - **MTBLS17**（Homo sapiens / blood serum / LC-MS）
      - DOI: `10.1016/j.aca.2012.07.013`
      - sampleTable行数: 1050（目安） / サイズ: 33.37GiB
      - 期待できるメタデータ: `Disease` 列あり、`Injection`（バッチ相当）あり / 時系列列は見当たらない（=主にケース/コントロール想定）
      - URL: https://www.ebi.ac.uk/metabolights/MTBLS17
    - **MTBLS19**（Homo sapiens / blood serum / LC-MS）
      - DOI: `10.1021/pr300673x`
      - sampleTable行数: 360（目安） / サイズ: 11.04GiB
      - 期待できるメタデータ: `Disease` 列あり、`Batch` 列あり / 時系列列は見当たらない
      - URL: https://www.ebi.ac.uk/metabolights/MTBLS19
    - **MTBLS1**（Homo sapiens / urine / NMR）
      - DOI: `10.1152/physiolgenomics.00194.2006`
      - sampleTable行数: 132（目安） / サイズ: 226.76MiB
      - 注意: APIのsampleTable上は `Disease` や明示的バッチ列が見当たらない（ラベルはISA-Tabやサンプル名規則から確定が必要）
      - URL: https://www.ebi.ac.uk/metabolights/MTBLS1
  - ライセンスはAPIレスポンスに明示されないため、各studyページ（上記URL）で必ず確認して記録する
2. **評価プロトコルの固定（最優先）**
  - 分割方法（時間順・施設/バッチ）とリーク禁止ルール
  - ベースライン（マーカー固定/ルールベース/全観測一括学習）
  - 指標（早期警報・偽警報・キャリブレーション・再現性）
3. **後追い逐次シミュレーションの実行**
  - 「1患者ずつ追加」「時点ごとの制約」を守って学習と評価を回す
4. **Go/No-Go判定**
  - 改善が見えたかではなく、“壊れ方が分解できたか”を含めて判断する
