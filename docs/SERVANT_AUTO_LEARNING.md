# サーバント自動学習システム

## 🎯 概要

**高速開発（AIペアコーディング）に対応した自動学習システム**

AIとのペアコーディングでは、常人の数倍の速度でコミットが積み重なります。
このシステムは、**短いサイクルで自動的にGit履歴を学習**し、
サーバントの知識を常に最新に保ちます。

---

## 🔄 自動学習のトリガー

### **1. Post-commit Hook（最優先）**

```bash
# 設定: 15コミットごとに自動学習
LEARNING_CYCLE=15
```

**動作**：

```
コミット1: 📊 コミット数 1/15
コミット2: 📊 コミット数 2/15
...
コミット15: 🧠 学習サイクル到達！
           ↓
      バックグラウンドで学習実行
           ↓
      カウントリセット → 0/15
```

**特徴**：

- ✅ **次のコミットをブロックしない**（バックグラウンド実行）
- ✅ **15コミット = 約1-2時間の開発**で自動学習
- ✅ **ローカルで完結**（CI/CD不要）

---

### **2. GitHub Actions（日次 + 大量push時）**

**トリガー1: 毎日深夜2時（JST）**

```yaml
schedule:
  - cron: '0 2 * * *' # 毎日深夜2時
```

**トリガー2: 大量変更時**

```yaml
push:
  branches: [main]
  paths:
    - 'src/**'
    - 'tests/**'
    - 'scripts/**'
```

**動作**：

```
1. 前回の学習から何コミットあったかチェック
2. 10コミット以上 → 学習実行
3. 10コミット未満 → スキップ

学習実行後:
  - failure-patterns.json 更新
  - Instructions 自動更新
  - 学習レポート生成
  - 自動コミット & Push
```

---

## 📊 学習サイクルの設定

### **現在の設定**

| トリガー                   | 閾値       | 頻度（高速開発時） |
| -------------------------- | ---------- | ------------------ |
| **Post-commit**            | 15コミット | **1-2時間ごと**    |
| **GitHub Actions（日次）** | 10コミット | 毎日深夜2時        |
| **GitHub Actions（push）** | 10コミット | 大量変更時         |

### **設定のカスタマイズ**

#### **より頻繁に学習したい場合**

```bash
# .husky/post-commit の編集
LEARNING_CYCLE=10  # 10コミットごと（約1時間）
```

#### **頻度を下げたい場合**

```bash
LEARNING_CYCLE=30  # 30コミットごと（約3-4時間）
```

---

## 🚀 使い方

### **1. 自動学習の確認**

```bash
# 現在のコミットカウント確認
npm run guard:check-cycle

# 出力例: 7
# → あと8コミットで自動学習
```

### **2. 手動学習**

```bash
# すぐに学習を実行したい場合
npm run guard:learn-history

# カウントをリセット
npm run guard:reset-cycle
```

### **3. 学習履歴の確認**

```bash
# Git履歴から学習ログを確認
git log --grep="auto-learn:" --oneline

# 出力例:
# c1756cb chore(auto-learn): サーバント自動学習（15コミット分）
# a234bcd chore(auto-learn): サーバント自動学習（17コミット分）
```

---

## 📈 高速開発での学習サイクル

### **シナリオ: AIとのペアコーディング**

```
時刻    コミット数  アクション
────────────────────────────────────
9:00    0/15       開発開始
9:30    5/15       順調に進行
10:00   10/15      中間地点
10:30   15/15      🧠 自動学習実行！
                   ↓
10:31   0/15       カウントリセット
11:00   5/15       継続開発
11:30   10/15
12:00   15/15      🧠 自動学習実行！
                   ↓
12:01   0/15       カウントリセット
```

**効果**：

- **1-2時間ごとに最新の失敗パターンを学習**
- サーバントの知識が常に最新
- 同じ失敗を短時間で繰り返さない

---

## 🎯 学習内容

### **自動学習で更新されるもの**

1. **failure-patterns.json**
   - 新しい失敗パターン追加
   - 既存パターンの発生回数更新
   - ホットスポット更新

2. **Instructions**
   - `.aitk/instructions/adaptive-guard-system.instructions.md`
   - 高リスクパターンを自動抽出
   - AI向けの警告メッセージ生成

3. **学習レポート**
   - `docs/GIT_HISTORY_LEARNING_REPORT.md`
   - 解析コミット数
   - 抽出パターン数
   - ホットスポット一覧

4. **チェックスクリプト**
   - `scripts/adaptive-guard-checks.sh`
   - CI/CDで使用する検証スクリプト

---

## 🔍 学習プロセスの可視化

### **Post-commit時の出力**

```
📊 サーバント: コミット数 15/15

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧠 サーバント: 学習サイクル到達（15コミット）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 Git履歴から最新の失敗パターンを学習中...

🔄 学習をバックグラウンドで実行中...
   （次のコミットを妨げません）
```

### **GitHub Actionsの出力**

```
📊 前回の学習から15コミット → 学習実行
🧠 サーバント: Git履歴から学習開始...
✅ 学習結果をコミット完了
```

---

## ⚙️ トラブルシューティング

### **Q: 学習が実行されない**

```bash
# カウントファイルを確認
cat .aitk/.commit-count

# 権限を確認
ls -la .husky/post-commit

# 手動実行でテスト
.husky/post-commit
```

### **Q: 学習を今すぐ実行したい**

```bash
# 手動実行
npm run guard:learn-history

# カウントリセット（次回15コミット後に実行）
npm run guard:reset-cycle
```

### **Q: 学習頻度を変更したい**

```bash
# .husky/post-commit を編集
vi .husky/post-commit

# LEARNING_CYCLE の値を変更
LEARNING_CYCLE=10  # 10コミットごと
```

---

## 📊 効果測定

### **Before（手動学習のみ）**

```
学習頻度: 週1回程度
失敗パターン: 古い情報
警告精度: 低い
```

### **After（自動学習）**

```
学習頻度: 1-2時間ごと（15コミット）
失敗パターン: 常に最新
警告精度: 高い

効果:
- 同じ失敗の繰り返しを即座に防止
- ホットスポットの早期発見
- 高速開発に追従
```

---

## 🎓 学習の仕組み

```
Post-commit Hook
     ↓
コミットカウント +1
     ↓
15コミット到達？
     ↓ YES
バックグラウンドで:
  1. npm run guard:learn-history
  2. Git履歴解析
  3. 失敗パターン抽出
  4. ホットスポット更新
  5. Instructions更新
  6. カウントリセット
     ↓
サーバントが最新の知識で警告
```

---

## 💡 推奨設定

### **高速開発（AIペアコーディング）**

```bash
LEARNING_CYCLE=15  # 1-2時間ごと（推奨）
```

### **通常開発**

```bash
LEARNING_CYCLE=30  # 3-4時間ごと
```

### **低頻度開発**

```bash
LEARNING_CYCLE=50  # GitHub Actionsの日次学習に任せる
```

---

## 🚀 まとめ

**自動学習システムの特徴**：

✅ **完全自動** - コミットするだけで学習
✅ **高速対応** - 1-2時間ごとに最新化
✅ **非ブロッキング** - 開発速度を妨げない
✅ **3段階トリガー** - ローカル + CI/CD
✅ **常に最新** - サーバントが進化し続ける

**高速開発に最適化されたサーバント** 🛡️

---

**生成日時**: 2025-12-20
