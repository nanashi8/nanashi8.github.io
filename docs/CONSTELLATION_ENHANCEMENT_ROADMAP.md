# 天体儀（Constellation）機能拡張ロードマップ

**プロジェクト**: Servant VS Code拡張機能
**目標**: 大規模プロジェクト（10,000+ファイル）に対応した高度な依存関係可視化
**プロトタイプ版**: v0.3.21 ✅
**対象**: 改修工程数算定 + 実装計画

---

## 📊 現在の状態（v0.3.21 プロトタイプ）

| 指標 | 値 | 評価 |
|------|-----|------|
| **データサイズ** | 448 KB | ✅ 標準範囲 |
| **ノード数** | 873 | ✅ 標準 |
| **エッジ数** | 708 | ✅ 標準 |
| **通信方式** | postMessage | ✅ 業界標準 |
| **レンダリング** | Three.js フル描画 | ⚠️ スケール限界: 5,000ノード |
| **フレームレート** | 60fps@小規模 | ⚠️ 大規模データで低下 |

### 制限事項
- ノード数が5,000を超えるとフレームレート低下
- 詳細度はカメラ距離に関わらず一定
- 画面外のノードも描画されている
- メモリ使用量が線形増加

---

## 🎯 拡張計画：3フェーズ

### **Phase 1: パフォーマンス最適化**（優先度：HIGH）
**目標**: 20,000ノードまでスムーズに描画

#### 1-1) LOD（Level of Detail）実装
**説明**: カメラ距離に基づいて自動的にノードの詳細度を変更

```
距離 < 50m:   高詳細（32セグメント + ラベル + エッジ）
距離 50-150m: 中詳細（16セグメント）
距離 > 150m:  低詳細（点のみ）
```

**ファイル**: ConstellationViewPanel.ts → updateNodeLOD()
**工程数**: 3-4日
**検証指標**:
- 20,000ノードで60fps維持
- メモリ使用量30%削減
- ズーム時の自然な詳細度変化

#### 1-2) 仮想スクロール（Frustum Culling）
**説明**: カメラの視錐台（Frustum）内のノードのみをメモリに保持

```
カメラ視野内のノード    → Scene に追加（描画）
カメラ視野外のノード    → Poolに移動（非描画）
```

**ファイル**: ConstellationViewPanel.ts → updateVisibleNodes()
**工程数**: 3-4日
**検証指標**:
- メモリ使用量50%削減
- 大幅なカメラ移動時のラグ解消
- GPU メモリ圧力低下

**実装順序**: 1-1 → 1-2（依存性なし、並列可）

---

### **Phase 2: スケーラビリティ拡張**（優先度：MEDIUM-HIGH）
**目標**: 100,000ノード対応、リアルタイム更新

#### 2-1) ページング/増分ロード
**説明**: 初期データ500ノード送信 → ユーザースクロール時に追加ロード

**フロー**:
```
[Extension] → 初期500ノード送信 → [WebView]
                                      ↓
                                スクロール検出
                                      ↓
                         [WebView] → リクエスト → [Extension]
                                      ↓
                              次の500ノード受信
```

**ファイル**:
- ConstellationViewPanel.ts: _sendInitialData(), onGetMoreNodes()
- WebView HTML: scroll handler, paging state

**工程数**: 4-5日
**検証指標**:
- 初期ロード時間 < 1秒
- 初期メモリ < 100MB
- スクロール時の遅延 < 100ms

#### 2-2) Web Worker 統合
**説明**: レイアウト計算をメインスレッド外で実行

**計算内容**: 
- ノード位置の最適化
- エッジの曲率計算
- 依存関係の解析

**ファイル**:
- media/graph-worker.js （新規）
- ConstellationViewPanel.ts: Worker管理

**工程数**: 3-4日
**検証指標**:
- レイアウト計算時間 < 500ms
- UI応答性向上（フレーム落ちなし）
- CPU負荷50%削減

**実装順序**: 2-1 → 2-2（2-2は2-1の計算時間短縮に使用）

---

### **Phase 3: データ処理最適化**（優先度：MEDIUM）
**目標**: 超大規模データ（1MB+）対応、オフライン動作

#### 3-1) データ圧縮
**説明**: gzip圧縮によるネットワーク転送量削減

```
JSON 100KB → gzip 30KB（70%圧縮）
pako ライブラリで WebView側で展開
```

**ファイル**:
- ConstellationViewPanel.ts: 圧縮ロジック
- package.json: pako依存追加

**工程数**: 2-3日
**検証指標**:
- 圧縮率 65-75%
- 展開時間 < 100ms
- TLS/HTTP2との相性確認

#### 3-2) IndexedDB キャッシング
**説明**: 描画済みデータをブラウザのローカルDBに保存

**用途**:
- グラフの再計算スキップ
- オフラインモード
- セッション間のリソース共有

**ファイル**:
- media/indexeddb-adapter.js （新規）
- ConstellationViewPanel.ts: キャッシュ管理

**工程数**: 2-3日
**検証指標**:
- キャッシュ命中率 > 80%
- 再ロード時間 50%削減
- ストレージ容量管理

**実装順序**: 3-1 → 3-2（依存性なし）

---

### **Phase 4: 高度な機能**（優先度：LOW-MEDIUM）
**目標**: 可視化品質向上、ユーザー体験強化

#### 4-1) 動的なスタイリング
- ノード色をメトリクス（複雑度、変更頻度）で自動着色
- エッジの太さを関係強度で調整
- ラベルの自動配置調整

**工程数**: 3-4日

#### 4-2) インタラクション拡張
- ノード選択時の依存関係ハイライト
- フィルタリング UI（言語別、複雑度別）
- 検索機能（正規表現対応）

**工程数**: 4-5日

#### 4-3) 複数グラフサポート
- Git履歴 → 時系列グラフ
- ブランチ比較 → 差分グラフ
- タイムラプス可視化

**工程数**: 5-6日

---

## 📈 工程数統計

### 最小構成（Phase 1 のみ）
| フェーズ | タスク | 工程数 | 合計 |
|---------|--------|--------|------|
| Phase 1 | LOD実装 | 3-4日 | 6-8日 |
| | 仮想スクロール | 3-4日 | |
| **小計** | | | **6-8日** |

### 推奨構成（Phase 1 + 2）
| フェーズ | タスク | 工程数 | 合計 |
|---------|--------|--------|------|
| Phase 1 | LOD + 仮想スクロール | 6-8日 | 14-18日 |
| Phase 2 | ページング | 4-5日 | |
| | Web Worker | 3-4日 | |
| **小計** | | | **14-18日** |

### フル実装（Phase 1-3）
| フェーズ | タスク | 工程数 | 合計 |
|---------|--------|--------|------|
| Phase 1 | LOD + 仮想スクロール | 6-8日 | 23-31日 |
| Phase 2 | ページング + Worker | 7-9日 | |
| Phase 3 | 圧縮 + キャッシング | 4-6日 | |
| **小計** | | | **23-31日** |

### 統合テスト・ドキュメント（全フェーズ）
| タスク | 工程数 |
|--------|--------|
| 統合テスト | 3-4日 |
| パフォーマンス測定 | 2-3日 |
| ドキュメント作成 | 2日 |
| **小計** | **7-9日** |

**総工程数（全機能）**: **30-40日** （2週間×2-3スプリント）

---

## 🛠️ 実装順序（推奨）

### Sprint 1（1-2週間）: Phase 1 + プロトタイプ検証
```
Week 1:
  Mon-Tue: LOD実装 + 単体テスト
  Wed:     仮想スクロール実装
  Thu-Fri: 統合テスト、20,000ノード検証

v0.3.22 リリース（Phase 1完了版）
```

### Sprint 2（1-2週間）: Phase 2 実装
```
Week 1:
  Mon-Tue: ページング実装 + 初期化ロジック
  Wed-Thu: Web Worker統合、UIハンドラ
  Fri:     統合テスト、100,000ノード検証

v0.3.23 リリース（Phase 2完了版）
```

### Sprint 3（1週間）: Phase 3 + 最適化
```
Week 1:
  Mon:     圧縮・キャッシング実装
  Tue-Wed: IndexedDB統合
  Thu:     パフォーマンス測定
  Fri:     ドキュメント、リリース準備

v0.3.24 リリース（フル実装版）
```

---

## ✅ 品質保証指標

### パフォーマンス目標

| 指標 | Phase 1後 | Phase 2後 | Phase 3後 |
|------|----------|----------|----------|
| **フレームレート** | 60fps@10K | 60fps@50K | 60fps@100K |
| **初期ロード** | 2秒 | 1秒 | 0.5秒 |
| **メモリ（ピーク）** | 200MB | 150MB | 100MB |
| **ズーム時遅延** | < 50ms | < 30ms | < 20ms |

### テスト範囲

| テスト種別 | 対象 | 内容 |
|----------|------|------|
| **単体テスト** | 各コンポーネント | LOD計算、Worker通信 |
| **統合テスト** | 全機能 | データフロー、UIインタラクション |
| **ストレステスト** | 最大ノード数 | 100,000ノード×複数セッション |
| **回帰テスト** | 既存機能 | 古いバージョンとの比較 |

---

## 📦 依存関係・ライブラリ

### 新規追加（必須）
```json
{
  "pako": "^2.1.0"  // gzip圧縮用（Phase 3）
}
```

### 検討中（オプション）
```json
{
  "idb": "^8.0.0"        // IndexedDB wrapper
  "web-worker": "latest" // Worker型定義
}
```

---

## 🔄 後戻り計画

各フェーズ完了後、以下を確認：

1. **v0.3.21 → v0.3.22** (Phase 1)
   - 既存ユーザーのパフォーマンス向上を確認
   - リグレッション（破損）がないか検証
   - フィードバック収集

2. **v0.3.22 → v0.3.23** (Phase 2)
   - ページング動作確認
   - 大規模プロジェクト（5,000+ファイル）での安定性
   - UI/UX改善点収集

3. **v0.3.23 → v0.3.24** (Phase 3)
   - 圧縮率測定
   - キャッシュヒット率監視
   - オフラインモード検証

---

## 🚀 推奨開始スケジュール

| マイルストーン | 日程 | バージョン | 目標 |
|-------------|-----|----------|------|
| **プロトタイプ確認** | 2026年1月7日 | 0.3.21 | ✅ 確実表示 |
| **Phase 1 完了** | 1月14-17日 | 0.3.22 | 20Kノード対応 |
| **Phase 2 完了** | 1月21-24日 | 0.3.23 | 100Kノード対応 |
| **Phase 3 完了** | 1月28-31日 | 0.3.24 | フル実装版 |
| **公開リリース** | 2月上旬 | 1.0.0 | 正式版 |

---

## 📝 次のステップ

### 今すぐ（本日）
- [ ] VSIX 0.3.21をインストール
- [ ] 🌟天体儀が正常に表示されることを確認
- [ ] デバッグログで通信フローを確認

### Sprint 1 開始前
- [ ] Phase 1の詳細設計
- [ ] テスト計画書作成
- [ ] Developer環境セットアップ

### Sprint 1 開始（1月14日）
- [ ] LOD実装開始
- [ ] 仮想スクロール設計
- [ ] 20,000ノード用テストデータ生成

---

**最終更新**: 2026年1月7日
**作成者**: AI Assistant (GitHub Copilot)
**ステータス**: 🟢 実装準備完了
