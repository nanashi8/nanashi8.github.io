# 選択肢カード表示順序修正レポート

**作成日**: 2025年10月28日  
**対応内容**: ユーザー指定の表示順序に完全対応

---

## 📋 修正内容

ChoiceCardViewの回答後の詳細表示を、ユーザーが指定した順序に完全対応しました。

### ✅ 修正ファイル

- `SimpleWord/QuizComponents/ChoiceCardView.swift`

---

## 🎯 各CSV種類別の表示順序（完全対応）

### 1. 中学歴史

**CSVヘッダ構造:**
```csv
年号,登場人物,史実名,解説,関連史実,関連分野,難易度
```

**回答後の選択肢カード表示順序:**
1. **年号** (term): 4世紀頃
2. **史実名** (meaning): 大和政権の成立
3. **解説** (etymology): 弥生時代後期に各地の豪族が...
4. **登場人物** (reading): 大和朝廷の豪族たち
5. **関連史実** (relatedWords): 古墳文化・律令以前の統合過程
6. **関連分野** (relatedFields): その他
7. **難易度** (difficulty): 2

### 2. 中学古典単語

**CSVヘッダ構造:**
```csv
語句,発音,意味,用法,関連語,関連分野,難易度
```

**回答後の選択肢カード表示順序:**
1. **語句** (term): いと
2. **発音** (reading): いと
3. **意味** (meaning): とても
4. **用法** (etymology): 古(用法):「とても」；現(近い語):『いみじ』...
5. **関連語** (relatedWords): いみじ:非常に
6. **関連分野** (relatedFields): 家族
7. **難易度** (difficulty): 1

### 3. 中学英単語・中学英熟語・中学英会話・xcode

**CSVヘッダ構造:**
```csv
語句,発音,和訳,語源等解説,関連語と意味,関連分野,難易度
```

**回答後の選択肢カード表示順序:**
1. **語句** (term): Hello!
2. **発音** (reading): (ハロー) ← 語句の後ろに括弧付きで表示
3. **和訳** (meaning): こんにちは
4. **語源等解説** (etymology): 英語の挨拶の定番
5. **関連語と意味** (relatedWords): Hi:やあ
6. **関連分野** (relatedFields): 感情
7. **難易度** (difficulty): 1

---

## 🔧 主な変更点

### 変更前

**問題点:**
- メインテキスト（meaning）で表示済みとして、詳細情報から省略していた
- ユーザーが指定した順序と異なっていた

**表示例（中学歴史）:**
```
大和政権の成立 ✓

年号: 4世紀頃
解説: 弥生時代後期に...
登場人物: 大和朝廷の豪族たち
関連史実: 古墳文化...
関連分野: その他
難易度: 2
```
→ **史実名が表示されていない！**

### 変更後

**改善点:**
- すべてのフィールドを指定された順序で表示
- meaning（史実名/意味/和訳）も詳細情報に含める

**表示例（中学歴史）:**
```
大和政権の成立 ✓

年号: 4世紀頃
史実名: 大和政権の成立
解説: 弥生時代後期に各地の豪族が...
登場人物: 大和朝廷の豪族たち
関連史実: 古墳文化・律令以前の統合過程
関連分野: その他
難易度: 2
```
→ **完璧！**

---

## 📊 CSV種類の自動判定

### 判定ロジック

```swift
private func detectCSVType(from headerLabels: [String: String]) -> CSVType {
    // termラベルで判定
    if let termLabel = headerLabels["term"] {
        if termLabel.contains("年号") {
            return .history  // 中学歴史
        }
    }
    
    // readingラベルで判定
    if let readingLabel = headerLabels["reading"] {
        if readingLabel.contains("登場人物") {
            return .history  // 中学歴史
        } else if readingLabel.contains("ひらがな") {
            return .classical  // 中学古典単語
        } else if readingLabel.contains("カタカナ") || readingLabel.contains("発音") {
            return .english  // 中学英単語・英会話
        }
    }
    
    // meaningラベルで判定
    if let meaningLabel = headerLabels["meaning"] {
        if meaningLabel.contains("史実") {
            return .history  // 中学歴史
        } else if meaningLabel.contains("和訳") {
            return .english  // 中学英単語・英会話
        }
    }
    
    return .english  // デフォルト
}
```

### 対応するCSVファイル

- **中学歴史**: `年号` または `登場人物` または `史実` を含むヘッダ
- **中学古典単語**: `ひらがな` を含むヘッダ
- **中学英単語・英会話・xcode**: `カタカナ`、`発音`、`和訳` を含むヘッダ

---

## ✅ 検証結果

### ビルド結果
- **コンパイルエラー**: なし
- **警告**: なし
- **ビルドステータス**: **BUILD SUCCEEDED** ✅

### 表示順序の確認

#### 中学歴史
✅ 年号 → 史実名 → 解説 → 登場人物 → 関連史実 → 関連分野 → 難易度

#### 中学古典単語
✅ 語句 → 発音 → 意味 → 用法 → 関連語 → 関連分野 → 難易度

#### 中学英単語・英会話
✅ 語句 → 発音 → 和訳 → 語源等解説 → 関連語と意味 → 関連分野 → 難易度

---

## 🎨 UI/UX の改善

### 1. 情報の完全性
- すべてのフィールドが表示されるため、ユーザーは完全な情報を得られる
- 学習に必要な情報が欠けることがない

### 2. 一貫性
- CSVの種類に関わらず、すべてのフィールドが表示される
- ユーザーが混乱しない

### 3. 可読性
- ラベル（年号:、史実名: など）が明確
- フィールドの区別が容易
- 色分けにより正解/不正解が視覚的に分かりやすい

---

## 🚀 動作確認方法

### 1. 中学歴史CSVで確認
1. アプリを起動
2. 設定で「中学歴史」を選択
3. クイズを開始
4. 任意の選択肢を選択
5. 回答後の詳細表示を確認
   - ✅ 年号が表示される
   - ✅ 史実名が表示される（メインテキストと同じ内容）
   - ✅ 解説が表示される
   - ✅ 登場人物が表示される
   - ✅ 関連史実が表示される
   - ✅ 関連分野と難易度が表示される

### 2. 中学古典単語で確認
1. 設定で「中学古典単語」を選択
2. クイズを開始
3. 回答後の詳細表示を確認
   - ✅ 語句が表示される
   - ✅ 発音が表示される
   - ✅ 意味が表示される（メインテキストと同じ内容）
   - ✅ 用法が表示される
   - ✅ 関連語が表示される
   - ✅ 関連分野と難易度が表示される

### 3. 中学英会話で確認
1. 設定で「中学英会話」を選択
2. クイズを開始
3. 回答後の詳細表示を確認
   - ✅ 語句が表示される
   - ✅ 発音が括弧付きで表示される（例: Hello! (ハロー)）
   - ✅ 和訳が表示される（メインテキストと同じ内容）
   - ✅ 語源等解説が表示される
   - ✅ 関連語と意味が表示される
   - ✅ 関連分野と難易度が表示される

---

## 📝 技術的な詳細

### コード構造

```swift
// CSV種類の判定
let csvType = detectCSVType(from: headerLabels)

// 種類に応じた表示メソッドを呼び出し
switch csvType {
case .history:
    displayHistoryDetails(questionItem, textColor)
case .classical:
    displayClassicalDetails(questionItem, textColor)
case .english:
    displayEnglishDetails(questionItem, textColor)
}
```

### 各表示メソッド

- `displayHistoryDetails()`: 中学歴史用の表示順序
- `displayClassicalDetails()`: 中学古典単語用の表示順序
- `displayEnglishDetails()`: 中学英単語・英会話用の表示順序

### ヘルパーメソッド

- `labelFor()`: CSVヘッダからラベル文字列を取得

---

## 🎉 まとめ

### 達成できたこと
✅ ユーザーが指定した表示順序に完全対応  
✅ すべてのフィールド（meaning含む）を表示  
✅ CSV種類の自動判定  
✅ 一貫性のある表示  
✅ ビルドエラーゼロ  

### ユーザーへの影響
- **情報の完全性**: すべてのフィールドが表示され、学習に必要な情報が欠けない
- **使いやすさ**: 指定された順序で表示されるため、期待通りの動作
- **学習効果**: 詳細情報が充実し、復習に役立つ

---

**以上、ユーザー指定の表示順序に完全対応しました！** 🎊
