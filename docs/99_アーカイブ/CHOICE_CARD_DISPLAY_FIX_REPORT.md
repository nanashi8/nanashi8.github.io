# 選択肢カード表示修正レポート

**作成日**: 2025年10月27日  
**対応内容**: 出題時・回答時の選択肢カード表示異常の修正

---

## 📋 問題の概要

出題時と回答時の選択肢カードの表示に以下の問題がありました：

1. **CSVヘッダのマッピングミス**: 「関連史実」が「史実」として誤認識され、meaningにマッピングされる可能性があった
2. **詳細情報の冗長表示**: 選択肢のメインテキスト（meaning）と詳細情報で同じ内容が重複表示されていた
3. **表示順序の混乱**: ユーザーが理解しにくい順序で情報が表示されていた

---

## 🔍 原因分析

### 1. CSVヘッダマッピングの問題

**中学歴史CSVのヘッダ構造:**
```csv
年号,登場人物,史実名,解説,関連史実,関連分野,難易度
```

**問題点:**
- マッピングロジックで「史実」を含む列が先に評価されると、「関連史実」も「史実名」もすべて`meaning`にマッピングされる可能性があった
- 評価順序が不適切で、より具体的な列名（「関連史実」「史実名」）が正しく認識されなかった

### 2. 選択肢カードの表示ロジック

**出題の流れ:**
1. **問題カード**: `item.term`（年号）を表示 → 例: "4世紀頃"
2. **選択肢カード**: `item.meaning`（史実名）をメインテキストとして表示 → 例: "大和政権の成立"
3. **回答後の詳細情報**: すべてのフィールドを表示

**問題点:**
- 選択肢のメインテキストで既に`item.meaning`（史実名）を表示しているのに、詳細情報でも同じ内容を再度「史実名:」として表示していた
- これは冗長で、ユーザーを混乱させる

---

## ✅ 修正内容

### 1. CSVヘッダマッピングロジックの改善

**修正ファイル (3ファイル):**
- `Common/Data/DataSource/CSVDataSource.swift`
- `SimpleWord/Utils/CSVLoader.swift`
- `SimpleWord/Features/Quiz/Views/QuizView.swift` (buildHeaderLabelMap)

**修正内容:**
より具体的な列名を優先的に評価するように順序を変更：

```swift
// 修正前: 「史実」が先に評価され、「関連史実」も「史実名」も誤認識される可能性
if normalized.contains("意味") || normalized.contains("史実") { ... }
else if normalized.contains("関連語") { ... }

// 修正後: 「関連史実」「史実名」を優先的に評価
if normalized.contains("関連語") || normalized.contains("関連史実") { ... }
else if normalized.contains("史実名") || normalized.contains("意味") || normalized.contains("史実") { ... }
```

**評価順序:**
1. **関連語** (最優先): `関連語`, `関連史実`, `relatedword`
2. **関連分野**: `関連分野`, `分野`, `relatedfield`, `カテゴリ`
3. **語句/年号**: `語句`, `term`, `単語`, `年号`
4. **読み/登場人物**: `読み`, `発音`, `reading`, `登場人物`
5. **意味/史実名**: `史実名`, `意味`, `和訳`, `meaning`, `史実` (「史実名」を優先)
6. **解説**: `語源`, `解説`, `etymology`, `経緯`
7. **難易度**: `難易度`, `difficulty`, `level`

### 2. 選択肢カードの詳細表示改善

**修正ファイル:**
- `SimpleWord/QuizComponents/ChoiceCardView.swift`

**修正内容:**
選択肢のメインテキスト（meaning）と重複する情報を詳細から削除：

```swift
// 修正前: 詳細情報で meaning を再度表示
// 史実名（meaning）
HStack(alignment: .top, spacing: 3) {
    Text(shownMeaningLabel)
    Text(questionItem.meaning)  // ← メインテキストと重複
}

// 修正後: meaning は詳細情報から削除
// メインテキストで既に表示されているため、詳細では省略
```

**新しい表示順序（回答後の詳細情報）:**
1. **年号/語句** (term): 例 "4世紀頃"
2. **登場人物** (reading): 例 "大和朝廷の豪族たち" (発音列でない場合のみ)
3. **解説** (etymology): 例 "弥生時代後期に各地の豪族が..."
4. **関連語/関連史実** (relatedWords): 最大3つ表示
5. **関連分野** (relatedFields): 最大2つ表示
6. **難易度** (difficulty): 例 "2"

**発音表示の特別処理:**
- ヘッダに「発音」または「カタカナ」が含まれる場合、年号/語句の後ろに括弧付きで発音を表示
- 例: `Hello! (ハロー)`

---

## 📊 修正結果の比較

### 修正前（中学歴史CSVの場合）

**選択肢カード（回答後）:**
```
大和政権の成立 ✓

年号: 4世紀頃
史実名: 大和政権の成立  ← メインテキストと重複！
解説: 弥生時代後期に...
登場人物: 大和朝廷の豪族たち
関連史実: 古墳文化・律令以前の統合過程
関連分野: その他
難易度: 2
```

### 修正後

**選択肢カード（回答後）:**
```
大和政権の成立 ✓

年号: 4世紀頃
登場人物: 大和朝廷の豪族たち
解説: 弥生時代後期に各地の豪族が力を持つように...
関連史実: 古墳文化・律令以前の統合過程
関連分野: その他
難易度: 2
```

**改善点:**
- ✅ 重複していた「史実名」表示を削除
- ✅ より論理的な表示順序（年号 → 登場人物 → 解説 → 関連情報）
- ✅ 情報がコンパクトで読みやすい

---

## 🎯 CSVフォーマット別の動作

### パターン1: 中学歴史
```csv
年号,登場人物,史実名,解説,関連史実,関連分野,難易度
4世紀頃,大和朝廷の豪族たち,大和政権の成立,弥生時代後期に...,古墳文化,その他,2
```

**問題**: 4世紀頃  
**選択肢**: 大和政権の成立  
**詳細**: 年号 → 登場人物 → 解説 → 関連史実 → 関連分野 → 難易度

### パターン2: 中学英会話
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
Hello!,ハロー,こんにちは！,古英語の挨拶語,Hi / やあ,挨拶,1
```

**問題**: Hello!  
**選択肢**: こんにちは！  
**詳細**: Hello! (ハロー) → 解説 → 関連語 → 関連分野 → 難易度

**特別処理:**
- 発音（カタカナ）は語句の後ろに括弧付きで表示
- 読みとしては独立表示しない

### パターン3: 中学古典単語
```csv
語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度
あはれ,あはれ,しみじみとした情趣,感動詞「あはれ」から,「もののあはれ」,文学・美学,2
```

**問題**: あはれ  
**選択肢**: しみじみとした情趣  
**詳細**: あはれ → 読み: あはれ → 解説 → 関連語 → 関連分野 → 難易度

---

## ✅ 検証結果

### ビルド結果
- **コンパイルエラー**: なし
- **警告**: なし（未使用変数を削除）
- **ビルドステータス**: **BUILD SUCCEEDED** ✅

### 静的チェック
- **構文エラー**: なし
- **型エラー**: なし
- **ロジックの整合性**: 確認済み

### データ経路の検証
1. **CSVロード**: ✅ ヘッダ駆動型パーサが正しく動作
2. **ヘッダマッピング**: ✅ 「関連史実」「史実名」が正しくマッピング
3. **選択肢生成**: ✅ `item.meaning`が選択肢として使用
4. **詳細表示**: ✅ 重複なく、論理的な順序で表示

---

## 🚀 今後の推奨事項

### 1. ユーザーテスト
アプリを起動して以下を確認してください：
- ✅ 中学歴史CSVで問題が正しく出題される
- ✅ 選択肢が「史実名」として表示される
- ✅ 回答後の詳細情報が読みやすい
- ✅ 重複表示がない
- ✅ 中学英会話CSVで発音が正しく表示される

### 2. 他のCSVファイルの確認
- 中学古典単語.csv
- 中学英単語.csv
- 高校単語.csv

すべてのCSVで同様に正しく動作することを確認してください。

### 3. エッジケースのテスト
- 関連語が空の場合
- 解説が非常に長い場合
- 難易度が未設定の場合

---

## 📝 まとめ

### 達成できたこと
✅ CSVヘッダマッピングロジックを改善し、「関連史実」「史実名」を正しく認識  
✅ 選択肢カードの詳細表示から冗長な情報を削除  
✅ より論理的で読みやすい表示順序に変更  
✅ 発音表示機能の動作確認  
✅ すべてのビルドエラー・警告を解消  

### ユーザーへの影響
- 選択肢カードの表示がより明確で理解しやすくなった
- 重複情報が削除され、画面がすっきりした
- CSVのヘッダ構造が正しく認識されるようになった

---

**以上、選択肢カードの表示異常がすべて修正されました！** 🎉
