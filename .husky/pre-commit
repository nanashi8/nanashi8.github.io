#!/bin/sh

echo "🔍 Pre-commit チェック開始..."
echo "⚠️  【重要】すべてのエラー・警告を完全に解消する必要があります"
echo ""

# -4. ドキュメント命名規則チェック（配線保護）
.husky/check-doc-naming || exit 1
echo ""

# -3. 効率化ガード（無駄な作業を検出）
.husky/efficiency-guard.sh || true
echo ""

# -2. サーバント危険パターン検出（学習データベース活用）
echo "🛡️  サーバント: 危険パターン検出中..."
STAGED_FILES=$(git diff --cached --name-only | grep -E '\.(tsx?|jsx?)$' || true)
if [ -n "$STAGED_FILES" ]; then
  # スペース含むファイル名に対応
  echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 node scripts/detect-dangerous-patterns.mjs || true
  # 注意: このスクリプトは警告のみで、コミットをブロックしない
  # （学習が十分に進んだ後、ブロック機能を有効化可能）
else
  echo "   TypeScript/JavaScriptファイルの変更なし（スキップ）"
fi
echo ""

# -1. ダークモード禁止チェック（最優先）
echo "🚨 ダークモード禁止チェック実行中..."
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?|css)$' > /dev/null; then
  node scripts/check-no-dark-mode.mjs || {
    echo ""
    echo "❌ ダークモードクラスが検出されました"
    echo "📋 現在の方針: ダークモードは使用しません"
    echo ""
    echo "💡 修正方法:"
    echo "  1. dark: プレフィックスをすべて削除"
    echo "  2. .dark-mode セレクタを削除"
    echo ""
    echo "一括削除コマンド:"
    echo "  find src -name '*.tsx' -exec sed -i '' 's/ dark:[a-z-]*[a-z0-9-]*//g' {} \\;"
    echo ""
    echo "⛔ --no-verify でのバイパスは推奨されません"
    exit 1
  }
fi
echo "✅ ダークモードクラスは検出されませんでした"
echo ""

# -0.5. 仕様書遵守チェック（調整済み設定値の変更を検出）
echo "🛡️  仕様書遵守チェック実行中..."
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?|css)$' > /dev/null; then
  node scripts/check-specification-compliance.mjs || {
    echo ""
    echo "❌ 仕様違反が検出されました"
    echo ""
    echo "⛔ --no-verify でのバイパスは推奨されません"
    exit 1
  }
fi
echo ""

# 0. 品質神経系統チェック（Grammar問題ファイルが変更されている場合）
if git diff --cached --name-only | grep -E 'public/data/.*(verb-form|fill-in-blank|sentence-ordering).*\.json$' > /dev/null; then
  echo "🧠 品質神経系統 起動中..."

  # 変更されたGrammar問題ファイルをチェック
  CHANGED_FILES=$(git diff --cached --name-only | grep -E 'public/data/.*(verb-form|fill-in-blank|sentence-ordering).*\.json$')

  for FILE in $CHANGED_FILES; do
    python3 scripts/quality_nervous_system.py "$FILE" || {
      echo ""
      echo "🚨 品質神経系統が異常を検知しました"
      echo "📋 検出された問題:"
      echo "   - 語彙の多様性不足"
      echo "   - 主語の連続使用"
      echo "   - 選択肢の不適切さ"
      echo ""
      echo "💡 対応手順:"
      echo "  1. docs/guidelines/grammar/GRAMMAR_GENERATION_GUIDELINES.md を確認"
      echo "  2. 問題を修正"
      echo "  3. 再度コミット"
      echo ""
      echo "⛔ --no-verify でのバイパスは禁止されています"
      exit 1
    }
  done

  echo "✅ 品質神経系統チェック完了"
  echo ""
fi

# 0.1. テスト実装ガード（テストファイルが変更されている場合）
if git diff --cached --name-only | grep -E 'tests/.*\.test\.(ts|tsx)$' > /dev/null; then
  echo "🛡️  テスト実装ガード実行中..."

  # 各変更されたテストファイルに対してガードを実行
  git diff --cached --name-only | grep -E 'tests/.*\.test\.(ts|tsx)$' | while read TEST_FILE; do
    if [ -f "$TEST_FILE" ]; then
      bash scripts/test-implementation-guard.sh "$TEST_FILE" || {
        echo ""
        echo "❌ テスト実装ガードにより中断されました"
        echo "📚 必須手順:"
        echo "  1. .aitk/instructions/testing-guidelines.instructions.md を読む"
        echo "  2. 実際のデータファイルを確認する"
        echo "  3. 既存実装（src/配下のパーサー）を確認する"
        echo ""
        echo "💡 確認後に再度コミットしてください"
        exit 1
      }
    fi
  done

  echo "✅ テスト実装ガード完了"
  echo ""
fi

# 1. ステージされたファイルのみをチェック
echo "📝 変更ファイルを確認中..."

# 1.5. Prettierチェック（コード整形）- ステージング済みファイルのみ
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(tsx?|jsx?|css|json|md)$' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "✨ Prettierコード整形チェック中（ステージング済みファイルのみ）..."

  # ステージング済みファイルのみチェック
  echo "$STAGED_FILES" | xargs npx prettier --check > /dev/null 2>&1 || {
    echo ""
    echo "⚠️  コード整形が必要なファイルがあります"
    echo "💡 自動整形を実行中..."

    # ステージング済みファイルのみ整形
    echo "$STAGED_FILES" | xargs npx prettier --write

    # 整形後に自動で再ステージング
    echo "$STAGED_FILES" | xargs git add

    echo "✅ 整形完了（自動的に再ステージングしました）"
    echo ""
  }
fi

# 2. ESLintチェック（TypeScript/TSXファイルのみ、エラーのみ）
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?)$' > /dev/null; then
  echo "🔎 ESLintチェック実行中（エラーのみ）..."
  npm run lint:errors-only || {
    echo ""
    echo "❌ ESLintエラーが検出されました"
    echo "💡 修正方法: npm run lint で詳細を確認"
    echo "💡 警告も確認: npm run quality:strict"
    echo "💡 強制コミット: git commit --no-verify（非推奨）"
    exit 1
  }
fi

# 3. TypeScript型チェック
echo "🔍 TypeScript型チェック実行中..."
npm run typecheck || {
  echo ""
  echo "❌ TypeScript型エラーが検出されました"
  echo "💡 any型、未使用変数も含めてすべて修正してください"
  echo "💡 修正方法: npm run typecheck で詳細を確認"
  echo "💡 VS Code問題パネルで0エラーを確認してください"
  exit 1
}

# 4. データ品質チェック（CSVファイルが変更されている場合）
if git diff --cached --name-only | grep -E 'public/data/.*\.(csv|json)$' > /dev/null; then
  echo "📊 データ品質チェック実行中..."

  # データ品質チェックを実行
  npm run check:data-quality > /tmp/data-quality-check.log 2>&1
  CHECK_STATUS=$?

  # エラー数を抽出（0より大きければコミット拒否）
  ERROR_COUNT=$(grep "🔴 エラー:" /tmp/data-quality-check.log | grep -oE '[0-9]+' | head -1)
  if [ ! -z "$ERROR_COUNT" ] && [ "$ERROR_COUNT" -gt 0 ]; then
    echo ""
    echo "❌ データ品質エラーが検出されました！"
    echo ""
    grep -A 10 "🔴 エラー:" /tmp/data-quality-check.log | head -20
    echo ""
    echo "💡 修正方法:"
    echo "  1. npm run check:data-quality で詳細を確認"
    echo "  2. scripts/auto-fix-all.py で自動修正（実装予定）"
    echo "  3. 手動で該当エントリを修正"
    echo ""
    echo "詳細レポート: scripts/output/data-quality-report.txt"
    exit 1
  fi

  # 警告数を抽出（警告がある場合は通知のみ）
  WARNING_COUNT=$(grep "🟡 警告:" /tmp/data-quality-check.log | grep -oE '[0-9]+' | head -1)
  if [ ! -z "$WARNING_COUNT" ] && [ "$WARNING_COUNT" -gt 0 ]; then
    echo ""
    echo "⚠️  データ品質警告が検出されました"
    grep -A 5 "🟡 警告:" /tmp/data-quality-check.log | head -10
    echo ""
    echo "💡 警告も修正することを推奨します"
    echo "💡 それでもコミットする場合: git commit --no-verify"
    # 警告は許可する（exit 0）が、ユーザーに通知
  fi

  echo "✅ データ品質チェック完了"
fi

# 5. CSSチェック（CSSファイルが変更されている場合）
if git diff --cached --name-only | grep '\.css$' > /dev/null; then
  echo "🎨 CSSチェック実行中..."
  npm run lint:css || {
    echo ""
    echo "❌ CSSエラーが検出されました"
    echo "💡 自動修正: npm run lint:css:fix"
    echo "💡 手動確認: npm run lint:css"
    exit 1
  }
fi

# 5. ビルドチェック（重要なファイルが変更されている場合）
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?|css)$' > /dev/null; then
  echo "🏗️  ビルドチェック実行中..."
  BUILD_OUTPUT=$(npm run build 2>&1)
  BUILD_STATUS=$?

  if [ $BUILD_STATUS -ne 0 ]; then
    echo ""
    echo "❌ ビルドに失敗しました"
    echo "$BUILD_OUTPUT"
    exit 1
  fi

  # ビルド警告もチェック（通知のみ、コミットは許可）
  if echo "$BUILD_OUTPUT" | grep -i "warning" > /dev/null; then
    echo ""
    echo "⚠️  ビルド警告が検出されました（コミットは許可）"
    echo "$BUILD_OUTPUT" | grep -i "warning" | head -3
    echo "💡 時間があるときに修正することを推奨します"
  fi

  echo "✅ ビルド成功"
fi

# 6. プロジェクト構造検証（軽量）
echo "🏗️  プロジェクト構造検証中..."
if command -v python3 &> /dev/null; then
  python3 scripts/validate_project_structure.py || {
    echo ""
    echo "❌ プロジェクト構造に問題があります"
    echo "💡 詳細: python3 scripts/validate_project_structure.py"
    exit 1
  }
else
  echo "⚠️  Python3が見つかりません（スキップ）"
fi

# 7. 最終確認
echo ""
echo "✨ すべてのチェックが完了しました！"
echo "📊 VS Code問題パネルで0エラー・0警告を確認してください"

# 7. テスト戦略ガイド（情報提供のみ、ブロックしない）
bash scripts/test-strategy-guide.sh
