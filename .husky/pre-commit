#!/bin/sh

echo "🔍 Pre-commit チェック開始..."
echo "⚠️  【重要】すべてのエラー・警告を完全に解消する必要があります"
echo ""

# 1. ステージされたファイルのみをチェック
echo "📝 変更ファイルを確認中..."

# 1.5. Prettierチェック（コード整形）
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?|css|json|md)$' > /dev/null; then
  echo "✨ Prettierコード整形チェック中..."
  npm run format:check || {
    echo ""
    echo "⚠️  コード整形が必要なファイルがあります"
    echo "💡 自動修正: npm run format"
    echo "💡 手動確認後にコミットしてください"
    exit 1
  }
fi

# 2. ESLintチェック（TypeScript/TSXファイルのみ、エラーのみ）
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?)$' > /dev/null; then
  echo "🔎 ESLintチェック実行中（エラーのみ）..."
  npm run lint:errors-only || {
    echo ""
    echo "❌ ESLintエラーが検出されました"
    echo "💡 修正方法: npm run lint で詳細を確認"
    echo "💡 警告も確認: npm run quality:strict"
    echo "💡 強制コミット: git commit --no-verify（非推奨）"
    exit 1
  }
fi

# 3. TypeScript型チェック
echo "🔍 TypeScript型チェック実行中..."
npm run typecheck || {
  echo ""
  echo "❌ TypeScript型エラーが検出されました"
  echo "💡 any型、未使用変数も含めてすべて修正してください"
  echo "💡 修正方法: npm run typecheck で詳細を確認"
  echo "💡 VS Code問題パネルで0エラーを確認してください"
  exit 1
}

# 4. データ品質チェック（CSVファイルが変更されている場合）
if git diff --cached --name-only | grep -E 'public/data/.*\.(csv|json)$' > /dev/null; then
  echo "📊 データ品質チェック実行中..."
  
  # データ品質チェックを実行
  npm run check:data-quality > /tmp/data-quality-check.log 2>&1
  CHECK_STATUS=$?
  
  # エラー数を抽出（0より大きければコミット拒否）
  ERROR_COUNT=$(grep "🔴 エラー:" /tmp/data-quality-check.log | grep -oE '[0-9]+' | head -1)
  if [ ! -z "$ERROR_COUNT" ] && [ "$ERROR_COUNT" -gt 0 ]; then
    echo ""
    echo "❌ データ品質エラーが検出されました！"
    echo ""
    grep -A 10 "🔴 エラー:" /tmp/data-quality-check.log | head -20
    echo ""
    echo "💡 修正方法:"
    echo "  1. npm run check:data-quality で詳細を確認"
    echo "  2. scripts/auto-fix-all.py で自動修正（実装予定）"
    echo "  3. 手動で該当エントリを修正"
    echo ""
    echo "詳細レポート: scripts/output/data-quality-report.txt"
    exit 1
  fi
  
  # 警告数を抽出（警告がある場合は通知のみ）
  WARNING_COUNT=$(grep "🟡 警告:" /tmp/data-quality-check.log | grep -oE '[0-9]+' | head -1)
  if [ ! -z "$WARNING_COUNT" ] && [ "$WARNING_COUNT" -gt 0 ]; then
    echo ""
    echo "⚠️  データ品質警告が検出されました"
    grep -A 5 "🟡 警告:" /tmp/data-quality-check.log | head -10
    echo ""
    echo "💡 警告も修正することを推奨します"
    echo "💡 それでもコミットする場合: git commit --no-verify"
    # 警告は許可する（exit 0）が、ユーザーに通知
  fi
  
  echo "✅ データ品質チェック完了"
fi

# 5. CSSチェック（CSSファイルが変更されている場合）
if git diff --cached --name-only | grep '\.css$' > /dev/null; then
  echo "🎨 CSSチェック実行中..."
  npm run lint:css || {
    echo ""
    echo "❌ CSSエラーが検出されました"
    echo "💡 自動修正: npm run lint:css:fix"
    echo "💡 手動確認: npm run lint:css"
    exit 1
  }
fi

# 5. ビルドチェック（重要なファイルが変更されている場合）
if git diff --cached --name-only | grep -E '\.(tsx?|jsx?|css)$' > /dev/null; then
  echo "🏗️  ビルドチェック実行中..."
  BUILD_OUTPUT=$(npm run build 2>&1)
  BUILD_STATUS=$?
  
  if [ $BUILD_STATUS -ne 0 ]; then
    echo ""
    echo "❌ ビルドに失敗しました"
    echo "$BUILD_OUTPUT"
    exit 1
  fi
  
  # ビルド警告もチェック（通知のみ、コミットは許可）
  if echo "$BUILD_OUTPUT" | grep -i "warning" > /dev/null; then
    echo ""
    echo "⚠️  ビルド警告が検出されました（コミットは許可）"
    echo "$BUILD_OUTPUT" | grep -i "warning" | head -3
    echo "💡 時間があるときに修正することを推奨します"
  fi
  
  echo "✅ ビルド成功"
fi

# 6. プロジェクト構造検証（軽量）
echo "🏗️  プロジェクト構造検証中..."
if command -v python3 &> /dev/null; then
  python3 scripts/validate_project_structure.py || {
    echo ""
    echo "❌ プロジェクト構造に問題があります"
    echo "💡 詳細: python3 scripts/validate_project_structure.py"
    exit 1
  }
else
  echo "⚠️  Python3が見つかりません（スキップ）"
fi

# 7. 最終確認
echo ""
echo "✨ すべてのチェックが完了しました！"
echo "📊 VS Code問題パネルで0エラー・0警告を確認してください"
