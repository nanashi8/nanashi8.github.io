#!/bin/sh

# Post-commit hook: コミット後の自動学習トリガー

# 学習サイクル設定
LEARNING_CYCLE=15  # 15コミットごとに学習

# コミットカウントファイル
COUNT_FILE=".aitk/.commit-count"
mkdir -p .aitk

# 現在のコミット数を取得
if [ -f "$COUNT_FILE" ]; then
  COMMIT_COUNT=$(cat "$COUNT_FILE")
else
  COMMIT_COUNT=0
fi

# カウントをインクリメント
COMMIT_COUNT=$((COMMIT_COUNT + 1))
echo "$COMMIT_COUNT" > "$COUNT_FILE"

# 学習サイクルに達したか確認
if [ $COMMIT_COUNT -ge $LEARNING_CYCLE ]; then
  echo "🧠 サーバント: 学習サイクル到達（${COMMIT_COUNT}/${LEARNING_CYCLE}コミット）- バックグラウンドで学習実行中..."

  # 学習実行（バックグラウンドで実行して次のコミットをブロックしない）
  (
    npm run guard:learn-history > /dev/null 2>&1

    # カウントをリセット
    echo "0" > "$COUNT_FILE"
  ) &
else
  # 通常は出力なし（静かに実行）
  :
fi
