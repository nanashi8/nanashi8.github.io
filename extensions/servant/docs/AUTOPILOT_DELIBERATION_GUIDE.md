# サーバント審議システム: 意見を求める状況とAI自動調査

## 📋 概要

このドキュメントでは、サーバント（Servant Autopilot）が「審議（承認）」を求める状況と、作業後に残すべき振り返り情報を **ユーザーに質問せず** に集めて学習へ反映する流れ（Copilot向け事後照会 + JSON取り込み）を説明します。

## 🎯 サーバントが判断支援する状況

サーバントは以下のような状況で、ユーザーに判断や意見を求めます。

### 1. 事後レビュー時（作業完了後）

**タイミング**: AI処理（ファイル編集など）が完了した後

**やること（UIで質問しない）**:
1. Output に「事後照会（Copilot/AI向け）」のプロンプトを出力
2. Copilot Chat に貼り付けて回答（JSON）を得る
3. そのJSONを「取り込みコマンド」でサーバントに渡し、学習・記録へ反映

**目的**:
- AI（Copilot）がより良い判断をしやすい入力（制約/振り返り/リスク）を整える
- 次回の事前誘導（最善手順）を改善するためのデータを蓄積する
- 「提案が採用されたか」をユーザーに聞かずに、AI返答のJSONとして残す

### 2. 事前審議（高リスク作業の前）

**タイミング**: 以下の条件を満たす場合
- コンパイルエラーが存在する
- 多数のファイルを変更する（20ファイル以上）
- 重要なファイル（設定ファイル、指示書など）を変更する

**質問内容**:
- **「この作業を続行しますか？」**
- リスク要因と影響範囲を表示
- 推奨される対策を提示

**目的**:
- 重大な問題を事前に防ぐ
- ユーザーに十分な情報を提供して判断を支援

### 3. 仕様確認の強制（変更前）

**タイミング**: 
- 特定のファイルタイプを変更する前
- 前回の仕様確認から一定時間経過している

**質問内容**:
- **「仕様書を確認しましたか？」**
- 関連する指示書やドキュメントを表示

**目的**:
- 誤った実装を防ぐ
- プロジェクトルールの遵守を保証

## 🤖 失敗/エラー時のAI自動調査

失敗/エラーが検出され、ユーザーが「振り返りする」を選択した場合、追加質問なしで自動調査が実行されます（Outputにレポートを出します）。

### 実行される調査

#### 1. 🎓 上級SE視点でのコード品質評価

以下の5つの観点から総合的に評価します（各100点満点）:

| 評価項目 | チェック内容 | 減点要因の例 |
|---------|------------|------------|
| **設計品質** | - ファイル数と変更規模のバランス<br>- 領域結合度<br>- テスト/実装比率<br>- コンパイルエラー・Lint違反 | - 20ファイル以上の変更（-15点）<br>- 4領域以上にまたがる変更（-10点）<br>- テスト未追加（-25点）<br>- コンパイルエラー存在（-50点） |
| **保守性** | - 変更の粒度<br>- リファクタリング指標（削除率）<br>- ドキュメント更新 | - ファイルあたり100行以上の変更（-15点）<br>- 大規模変更でドキュメント未更新（-5点） |
| **可読性** | - 関数の長さ<br>- ネストの深さ<br>- 命名規則 | （今後実装予定） |
| **テスト戦略** | - テストファイルの存在<br>- テスト/実装比率<br>- E2Eテストの有無 | - 実装変更でテスト未追加（-30点） |
| **ドキュメンテーション** | - ドキュメント更新<br>- 指示書更新<br>- DECISIONS.md記録 | - 大規模変更でドキュメント未更新（-15点）<br>- DECISIONS.md未記録（-5点） |

**総合スコア**: 各項目の平均値（0〜100点）

#### 2. 📊 変更内容の分析

- 変更ファイル数・行数の統計
- ファイルタイプの分類
- 複数領域にまたがる変更の検出
- 変更規模の適切性評価

#### 3. 🔍 コード品質の基本チェック

- コンパイルエラーの有無
- Lint違反の有無
- アクション成功/失敗の判定

#### 4. 📖 関連指示書の確認

- 変更ファイルに関連する指示書を自動検出
- ルール違反がないか確認
- 関連ドキュメントへのリンクを表示

#### 5. 📚 Git履歴からの学習

- 過去の類似変更を検索
- 同じファイルの変更パターンを分析
- 参考になるコミットを提示

#### 6. 💡 総合評価と推奨事項

- 検出された問題を優先度別に整理
- 次にやるべきことを具体的に提案
- コード品質向上のための推奨事項を生成

### 出力レポートの構成

調査完了後、以下の情報が Output パネルに表示されます:

```
==============================================================================
🔍 自動調査レポート
==============================================================================

🎓 上級SE視点: コード品質評価レポート
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟢 総合スコア: 85/100

✅ 設計品質: 90/100
   問題:
   ⚠️ 警告: ファイル数が多い（12ファイル）
      影響: レビューが困難になる可能性
      対策: 論理的な単位で分割を検討
   強み:
   ✨ テストカバレッジを考慮（テストファイル: 4件）

✅ 保守性: 85/100
   強み:
   ✨ 小さく理解しやすい変更

... (他のカテゴリ)

🎯 優先推奨事項:
   🔴 高優先度:
   1. テスト coverage を向上させる
      理由: 重要な機能にテストが不足

   🟡 中優先度:
   2. DECISIONS.md に意思決定を記録
      理由: 設計判断が記録されていません

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 調査結果:
   変更ファイル数: 12
   変更行数: +234 / -45 (合計: 279)
   ファイルタイプ: typescript, test, documentation

⚠️ 検出された問題:
   ⚠️ [multi-domain] 複数の領域にまたがる変更です
   ℹ️ [new-pattern] 新規の変更パターンです

💡 推奨事項:
   🟡 [MEDIUM] コード品質を向上させる
      理由: 2件の警告があります
      詳細:
         - ファイル数が多い
         - 複数領域にまたがる変更

🎯 次にやるべきこと:
   1. 📖 関連指示書を確認し、ルールに従っているか検証する
   2. 📚 過去の類似コミットを参考にする

==============================================================================
💡 このレポートを参考に、次のステップを決めてください。
   詳細が必要な場合は、Servant の各種コマンドで追加調査が可能です。
==============================================================================
```

## 🎯 ユーザーが取るべきアクション

### ケース1: 総合スコア 80点以上（🟢）

**状態**: 高品質なコード

**推奨アクション**:
1. レポートの「強み」を確認
2. 軽微な推奨事項があれば対応
3. コミット準備完了

### ケース2: 総合スコア 60〜79点（🟡）

**状態**: いくつか改善点あり

**推奨アクション**:
1. 「中優先度」の推奨事項を確認
2. 重要な問題は修正
3. 軽微な問題は次回対応も可

### ケース3: 総合スコア 59点以下（🔴）

**状態**: 品質基準を満たしていない

**推奨アクション**:
1. **コミット前に必ず修正**
2. 「高優先度」の推奨事項を全て対応
3. 必要に応じて作業を分割・やり直し

## 🛠️ 利用方法

### 事後照会（Copilot向け）→ JSON取り込み

1. 作業完了後、Output に「事後照会（Copilot/AI向け）」プロンプトが出る
2. Copilot Chat に貼り付けて回答（JSONコードブロック）を得る
3. 回答JSONをコピー
4. `Cmd+Shift+P` → `Servant: Ingest Autopilot Post-Review (from Clipboard)` を実行
5. `.aitk/autopilot/interactions.jsonl` に記録され、提案効果が学習に反映される

### 手動で品質チェックを実行する（将来実装予定）

```
Cmd+Shift+P → "Servant: Check Code Quality"
```

## 📚 関連ドキュメント

- [Servant Autopilot 設定ガイド](../README.md)
- [AI評価システム](../../docs/AI_INTEGRATION_GUIDE.md)
- [指示書システム](.aitk/instructions/)
- [DECISIONS.md](../../DECISIONS.md)

## 💡 ベストプラクティス

### DO ✅

- 「分からない」と感じたら、遠慮なくAI自動調査を使う
- 総合スコアが低い場合は、コミット前に必ず改善する
- 推奨事項を次回の作業に活かす
- レポートを保存して、チームで共有する

### DON'T ❌

- スコアが低いまま無視してコミットする
- 「高優先度」の推奨事項を無視する
- 毎回同じ問題を繰り返す
- レポートを読まずに作業を続ける

## 🔄 改善サイクル

```
1. 作業実施
   ↓
2. サーバント事後レビュー
   ↓
3. 「分からない」→ AI自動調査
   ↓
4. レポート確認
   ↓
5. 推奨事項を対応
   ↓
6. 品質向上 → 次回作業へ
```

このサイクルを繰り返すことで、コード品質が継続的に向上します。

## 📊 メトリクス

サーバントは以下のメトリクスを追跡します:

- **総合スコアの推移**: 時系列でのコード品質の変化
- **カテゴリ別スコア**: どの領域が強み/弱みか
- **推奨事項の対応率**: どれだけ改善しているか
- **自動調査の利用頻度**: どれだけ活用されているか

これらのメトリクスは、AI評価システムと統合され、長期的な品質改善に活用されます。

---

**最終更新**: 2026年1月4日
**バージョン**: 1.0.0
