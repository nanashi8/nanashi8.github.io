# 機能復元ガイド v2（簡素化後）

**最終更新**: 2025-10-28  
**バージョン**: 2.0（簡素化対応版）

このドキュメントは、SimpleWordの主要機能が喪失した場合に、迅速かつ正確に復元するためのガイドです。

---

## ⚠️ 重要: 簡素化後のアーキテクチャ

**このガイドは簡素化プロジェクト完了後（2025-10-28以降）の実装に基づいています。**

### 主な変更点
- ❌ **削除**: AdaptiveScheduler（適応型学習システム）
- ❌ **削除**: Core Data（Itemエンティティ）
- ✅ **採用**: シンプルバッチ学習
- ✅ **採用**: QuizSessionStoreによるセッション管理
- ✅ **採用**: QuestionItemRepository（CSV読み込み統一）

---

## 📋 目次

1. [復元の基本方針](#復元の基本方針)
2. [優先度別復元計画](#優先度別復元計画)
3. [機能別復元手順](#機能別復元手順)
4. [検証チェックリスト](#検証チェックリスト)
5. [よくある質問](#よくある質問)

---

## 復元の基本方針

### 復元時の参照順序

1. **v2仕様書（最優先）**:
   - `docs/仕様書/01_クイズ機能_仕様書_v2.md`
   - `docs/仕様書/02_出題設定_仕様書_v2.md`
   - `docs/仕様書/09_出題ロジック_仕様書_v2.md`

2. **UIコンポーネント仕様**:
   - `docs/仕様書/12_クイズUIコンポーネント_仕様書.md`

3. **実装ファイル**: 既存のコード（破損していない場合）

4. **旧版仕様書（参考）**: 適応型学習の設計思想を知りたい場合のみ

### 復元の原則

- ✅ **段階的復元**: 基本機能から順番に復元
- ✅ **検証を徹底**: 各ステップで動作確認
- ✅ **仕様書優先**: v2仕様書を正として実装
- ✅ **シンプル第一**: 過度な複雑性を避ける

---

## 優先度別復元計画

### 最優先（P0）: アプリ起動に必要

| 機能 | 復元時間 | 参照ドキュメント | 実装ファイル |
|---|---|---|---|
| アプリエントリーポイント | 10分 | なし | `SimpleWordApp.swift` |
| メインナビゲーション | 20分 | なし | `ContentView.swift` |
| データモデル | 30分 | 仕様書v2 | `QuestionItem.swift` |
| CSV読み込み | 40分 | 仕様書v2 | `QuestionItemRepository.swift`, `CSVDataSource.swift` |

**復元時間合計**: 約1.5時間

---

### 高優先（P1）: 基本学習機能

| 機能 | 復元時間 | 参照ドキュメント | 実装ファイル |
|---|---|---|---|
| クイズ画面 | 2時間 | 01_クイズ機能_仕様書_v2.md | `QuizView.swift` |
| 出題設定 | 1時間 | 02_出題設定_仕様書_v2.md | `QuizSettingsView.swift`, `QuizSettings.swift` |
| セッション管理 | 1時間 | 09_出題ロジック_仕様書_v2.md | `QuizSessionStore.swift` |
| UIコンポーネント | 1.5時間 | 12_クイズUIコンポーネント_仕様書.md | `QuizComponents/*.swift` |

**復元時間合計**: 約5.5時間

---

### 中優先（P2）: 成績管理

| 機能 | 復元時間 | 参照ドキュメント | 実装ファイル |
|---|---|---|---|
| 単語別成績 | 1時間 | 05_成績表示_仕様書.md | `WordScoreStore.swift` |
| クイズ結果 | 1時間 | 05_成績表示_仕様書.md | `ScoreStore.swift`, `ScoreView.swift` |

**復元時間合計**: 約2時間

---

### 低優先（P3）: その他機能

| 機能 | 復元時間 | 参照ドキュメント | 実装ファイル |
|---|---|---|---|
| ナビゲーター | 1時間 | 04_ナビゲーター機能_仕様書.md | `NavigatorView.swift` |
| CSV管理 | 1時間 | 03_問題集管理_CSV_仕様書.md | `CSVManagerView.swift` |
| IDマップ管理 | 1時間 | 06_IDマップ管理_仕様書.md | `IDMapAdminView.swift` |
| 外観設定 | 30分 | 08_外観_仕様書.md | `Appearance.swift`, `AppearanceManager.swift` |

**復元時間合計**: 約3.5時間

---

## 機能別復元手順

### 1. クイズ機能（QuizView）の復元

#### 参照ドキュメント
- `docs/仕様書/01_クイズ機能_仕様書_v2.md`

#### ステップ1: データ構造の復元
```swift
// QuizView.swift

// データ状態
@State private var items: [QuestionItem] = []
@State private var order: [QuestionItem] = []
@State private var pool: [QuestionItem] = []
@State private var currentItem: QuestionItem? = nil

// UI状態
@State private var choices: [Choice] = []
@State private var selectedChoiceID: UUID? = nil
@State private var correctAnswerID: UUID? = nil

// 環境オブジェクト
@EnvironmentObject var wordScoreStore: WordScoreStore
@EnvironmentObject var currentCSV: CurrentCSV
@EnvironmentObject var quizSettings: QuizSettings
@EnvironmentObject var scoreStore: ScoreStore
@StateObject private var sessionStore = QuizSessionStore.shared
```

#### ステップ2: CSV読み込み
```swift
private func loadCSVAndStart() {
    guard let csvName = currentCSV.name else {
        errorMessage = "CSVファイルが選択されていません。"
        isLoading = false
        return
    }

    let base = csvName.replacingOccurrences(of: ".csv", with: "")
    let repository = QuestionItemRepository(fileName: base)
    
    switch repository.fetch() {
    case .success(let items):
        allItems = items
    case .failure(let error):
        errorMessage = "CSV読み込み失敗: \(error.localizedDescription)"
    }
}
```

#### ステップ3: バッチ準備
```swift
private func prepareBatch() {
    let batchItems = Array(order.prefix(sessionStore.batchSize))
    
    var poolItems: [QuestionItem] = []
    let repeatCount = max(1, quizSettings.repeatCount)
    
    for item in batchItems {
        for _ in 0..<repeatCount {
            poolItems.append(item)
        }
    }
    
    pool = roundRobinShuffle(items: batchItems, pool: poolItems)
    prepareQuestion()
}
```

#### ステップ4: 検証
- [ ] CSV読み込みが成功する
- [ ] バッチが正しく準備される
- [ ] 選択肢が表示される
- [ ] 回答が記録される

---

### 2. セッション管理（QuizSessionStore）の復元

#### 参照ドキュメント
- `docs/仕様書/09_出題ロジック_仕様書_v2.md`（セッション管理セクション）

#### 実装
```swift
// QuizSessionStore.swift

@MainActor
public class QuizSessionStore: ObservableObject {
    @Published public var score: Int = 0
    @Published public var questionCount: Int = 0
    @Published public var batchCorrect: Int = 0
    @Published public var batchSize: Int = 10
    @Published public var isSessionActive: Bool = false
    @Published public var currentCSVName: String? = nil
    
    public static let shared = QuizSessionStore()
    
    private init() {
        loadSession()
    }
    
    public func startSession(csvName: String, batchSize: Int, totalQuestions: Int) {
        self.currentCSVName = csvName
        self.batchSize = max(1, batchSize)
        self.score = 0
        self.questionCount = 0
        self.batchCorrect = 0
        self.isSessionActive = true
        saveSession()
    }
    
    public func recordAnswer(correct: Bool) {
        questionCount += 1
        if correct {
            score += 1
            batchCorrect += 1
        }
        saveSession()
    }
    
    // 永続化処理
    private func saveSession() {
        let session: [String: Any] = [
            "score": score,
            "questionCount": questionCount,
            "batchCorrect": batchCorrect,
            "batchSize": batchSize,
            "isSessionActive": isSessionActive,
            "currentCSVName": currentCSVName as Any
        ]
        UserDefaults.standard.set(session, forKey: "QuizSession")
    }
}
```

#### 検証
- [ ] セッション開始が成功する
- [ ] 回答記録が正しく動作する
- [ ] アプリ再起動後にセッションが復元される

---

### 3. UIコンポーネントの復元

#### 参照ドキュメント
- `docs/仕様書/12_クイズUIコンポーネント_仕様書.md`

#### 復元順序
1. QuestionCardView（問題カード）
2. ChoiceCardView（選択肢カード）
3. DontKnowCardView（分からないボタン）
4. QuizStatisticsView（統計表示）
5. QuizNavigationButtonsView（ナビゲーション）

#### 各コンポーネントの復元時間: 約15〜20分

---

### 4. 出題設定（QuizSettings）の復元

#### 参照ドキュメント
- `docs/仕様書/02_出題設定_仕様書_v2.md`

#### 重要なポイント
- **CSV別設定管理**: PerCSVSettingsによる内部管理
- **UserDefaultsへの保存**: storageKeyは "QuizPerCSVSettings_v1"
- **CurrentCSVとの連携**: CSV変更時の設定切り替え

#### 検証
- [ ] 設定の保存が成功する
- [ ] CSV切り替え時に設定が変わる
- [ ] アプリ再起動後に設定が復元される

---

## 検証チェックリスト

### 基本機能
- [ ] アプリが起動する
- [ ] メイン画面が表示される
- [ ] CSV一覧が表示される

### クイズ機能
- [ ] CSVを選択できる
- [ ] クイズが開始できる
- [ ] 問題が表示される
- [ ] 選択肢が表示される（4択）
- [ ] 回答できる
- [ ] 正誤判定が正しい
- [ ] 次の問題に進める
- [ ] バッチが完了する

### セッション管理
- [ ] クイズ途中でアプリを閉じても、再開時に続きから開始できる
- [ ] 統計（正答率、合格数）が正しく表示される

### 成績管理
- [ ] 単語別の成績が記録される
- [ ] クイズ結果が保存される
- [ ] 学習結果画面で成績が確認できる

### 設定
- [ ] 出題設定が保存される
- [ ] CSV別に設定が管理される
- [ ] 分野・難易度フィルタが動作する

---

## よくある質問

### Q1: 適応型学習（AdaptiveScheduler）は復元できますか？

**A**: 簡素化により削除されました。復元する場合は以下を参照してください：
- `docs/仕様書/09_出題ロジック_仕様書.md`（旧版）
- `ADAPTIVE_LEARNING_GUIDE.md`
- `アーカイブ/横断検索と補修モード診断ガイド.md`

**推奨**: まずシンプルバッチ学習で復元し、必要に応じて段階的に適応型学習を実装

---

### Q2: Core Dataは使用していますか？

**A**: 部分的に使用：
- ❌ **Itemエンティティ**: 削除済み
- ✅ **IDマップ機能**: 独自のCore Dataスタック使用（`Services/CoreDataIDs/`）

---

### Q3: CSVLoaderとQuestionItemRepositoryの違いは？

**A**: 
- **CSVLoader**: 旧実装、URL直接ロード用に一部残存
- **QuestionItemRepository**: 新実装、推奨（簡素化後）
- **使い分け**: 新規実装はQuestionItemRepositoryを使用

---

### Q4: 復元にどれくらい時間がかかりますか？

**A**: 
- 最小限（P0のみ）: 約1.5時間
- 基本機能まで（P0+P1）: 約7時間
- 全機能: 約13時間

---

### Q5: 仕様書が古い場合はどうすれば？

**A**: 
1. v2仕様書を確認（2025-10-28以降）
2. v2がない場合は実装を優先
3. 仕様書を更新してv3を作成

---

## 📚 関連ドキュメント

### 仕様書（v2シリーズ）
- `01_クイズ機能_仕様書_v2.md`
- `02_出題設定_仕様書_v2.md`
- `09_出題ロジック_仕様書_v2.md`
- `12_クイズUIコンポーネント_仕様書.md`

### プロジェクト文書
- `SIMPLIFICATION_COMPLETION_REPORT.md` - 簡素化プロジェクト完了レポート
- `SPECIFICATION_REVISION_REPORT.md` - 仕様書改訂レポート

### アーカイブ（旧版・参考用）
- `アーカイブ/機能復元ガイド_v1.md` - 旧版（AdaptiveScheduler時代）
- `アーカイブ/大規模リファクタリング実現方策.md`

---

**最終更新**: 2025年10月28日  
**対応バージョン**: 簡素化後（v2.0以降）  
**復元可能性**: ★★★★★
