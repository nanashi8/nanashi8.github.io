# 外観設定（ライト・ダーク・システム対応）

**最終更新: 2025-10-19**

この文書は、アプリ全体の外観（カラーテーマ）設定の編集・実装ガイドです。

## 概要

### 何を実現しているか
- ライトモード・ダークモード・システム設定追従の3つから選択
- アプリ全体に即座に反映
- ユーザー設定の永続化
- 全画面で一貫した見た目を保証

## 画面構成

### 外観選択（出題設定内）
```
外観
○ システム設定に従う
○ ライトモード
○ ダークモード
```

## 関係するファイル

### 設定管理
- **Appearance.swift** - AppearanceManager クラス
  - 外観設定の状態管理
  - UserDefaultsへの保存・読み込み
  - `.preferredColorScheme` の制御

### アプリ起動
- **SimpleWordApp.swift** - アプリのエントリーポイント
  - AppearanceManager の注入（`.environmentObject`）
  - `.preferredColorScheme` の適用

### UI画面
- **QuizSettingsView.swift** - 外観選択UI
- 全ての画面 - 外観設定を自動的に反映

## 実装の仕組み

### AppearanceManager の構造
```swift
enum AppearanceMode: String, CaseIterable, Codable {
    case system = "system"
    case light = "light"
    case dark = "dark"
    
    var displayName: String {
        switch self {
        case .system: return "システム設定"
        case .light: return "ライトモード"
        case .dark: return "ダークモード"
        }
    }
    
    var colorScheme: ColorScheme? {
        switch self {
        case .system: return nil
        case .light: return .light
        case .dark: return .dark
        }
    }
}

class AppearanceManager: ObservableObject {
    @Published var mode: AppearanceMode = .system
    
    private let key = "AppearanceMode"
    
    init() {
        load()
    }
    
    func save() {
        UserDefaults.standard.set(mode.rawValue, forKey: key)
    }
    
    func load() {
        if let saved = UserDefaults.standard.string(forKey: key),
           let mode = AppearanceMode(rawValue: saved) {
            self.mode = mode
        }
    }
}
```

### アプリへの適用
```swift
@main
struct SimpleWordApp: App {
    @StateObject private var appearanceManager = AppearanceManager()
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(appearanceManager)
                .preferredColorScheme(appearanceManager.mode.colorScheme)
        }
    }
}
```

### UI での選択
```swift
struct AppearanceSettingsView: View {
    @EnvironmentObject var appearanceManager: AppearanceManager
    
    var body: some View {
        Picker("外観", selection: $appearanceManager.mode) {
            ForEach(AppearanceMode.allCases, id: \.self) { mode in
                Text(mode.displayName).tag(mode)
            }
        }
        .pickerStyle(.segmented)
        .onChange(of: appearanceManager.mode) { _, _ in
            appearanceManager.save()
        }
    }
}
```

## 編集時の注意点

### 即時反映の仕組み
**重要**: `@Published` と `.preferredColorScheme` の組み合わせで実現

```swift
// AppearanceManager で @Published を使用
@Published var mode: AppearanceMode = .system

// App で監視して即座に反映
.preferredColorScheme(appearanceManager.mode.colorScheme)
```

**チェックポイント**:
- [ ] 選択変更が即座に全画面に反映される
- [ ] @EnvironmentObject が全画面で利用可能
- [ ] `.preferredColorScheme` が正しく適用される

### カスタムカラーの対応
**実装例**: ライト/ダーク両対応のカスタムカラー

```swift
extension Color {
    static let customBackground = Color("CustomBackground")
    static let customText = Color("CustomText")
}

// Assets.xcassets で定義
// CustomBackground
//   - Any Appearance: #FFFFFF
//   - Dark Appearance: #1C1C1E
```

**チェックポイント**:
- [ ] Assets.xcassets でライト/ダーク両方定義
- [ ] システムカラー（`.primary`, `.secondary`）を優先使用
- [ ] カスタムカラーは必要最小限

### セマンティックカラーの使用
**推奨**: システム提供のセマンティックカラーを使用

```swift
// ✅ 推奨: 自動的にライト/ダークに対応
Text("Hello")
    .foregroundColor(.primary)
    .background(Color(.systemBackground))

// ❌ 非推奨: 固定色（ダークモードで見づらい）
Text("Hello")
    .foregroundColor(.black)
    .background(.white)
```

## テスト観点

### 基本動作
- [ ] システム設定で切り替えた時に自動追従する
- [ ] ライトモードで全画面が明るく表示される
- [ ] ダークモードで全画面が暗く表示される
- [ ] 設定が永続化される（再起動後も保持）

### 色の一貫性
- [ ] 全画面で統一された配色
- [ ] テキストが背景に対して十分なコントラスト
- [ ] ボタンやリンクが視認しやすい
- [ ] 選択状態が明確に分かる

### エッジケース
- [ ] システム設定を変更した時の即時反映
- [ ] アプリ起動時の外観が正しい
- [ ] 画面遷移時に外観がちらつかない

## よくある編集パターン

### 外観モードの追加
```swift
enum AppearanceMode: String, CaseIterable, Codable {
    case system = "system"
    case light = "light"
    case dark = "dark"
    case highContrast = "highContrast"  // 新規追加
    
    var colorScheme: ColorScheme? {
        switch self {
        case .system: return nil
        case .light: return .light
        case .dark, .highContrast: return .dark
        }
    }
    
    var accessibilityContrast: ColorSchemeContrast? {
        switch self {
        case .highContrast: return .increased
        default: return .standard
        }
    }
}

// 適用
.environment(\.colorSchemeContrast, 
    appearanceManager.mode.accessibilityContrast ?? .standard)
```

### カスタムテーマの実装
```swift
struct Theme {
    let primary: Color
    let secondary: Color
    let background: Color
    let text: Color
    
    static let light = Theme(
        primary: .blue,
        secondary: .gray,
        background: .white,
        text: .black
    )
    
    static let dark = Theme(
        primary: .cyan,
        secondary: .gray,
        background: Color(white: 0.1),
        text: .white
    )
}

class ThemeManager: ObservableObject {
    @Published var currentTheme: Theme = .light
    
    func updateTheme(for mode: AppearanceMode) {
        switch mode {
        case .light: currentTheme = .light
        case .dark: currentTheme = .dark
        case .system:
            // システム設定を検出
            let isDark = UITraitCollection.current.userInterfaceStyle == .dark
            currentTheme = isDark ? .dark : .light
        }
    }
}
```

### 外観変更のアニメーション
```swift
func changeAppearance(to mode: AppearanceMode) {
    withAnimation(.easeInOut(duration: 0.3)) {
        appearanceManager.mode = mode
    }
    appearanceManager.save()
}
```

## トラブルシューティング

### 外観が反映されない
- `.preferredColorScheme` の適用位置を確認
- @EnvironmentObject の注入を確認
- AppearanceManager の初期化タイミングを確認

### システム設定追従が動作しない
- `.preferredColorScheme(nil)` が設定されているか確認
- システム設定変更の通知を監視（必要に応じて）

### 一部の画面だけ外観がおかしい
- カスタムカラーがライト/ダーク両対応か確認
- 固定色（.black, .white）を使用していないか確認
- `.foregroundColor` と `.background` の組み合わせを確認

### パフォーマンス低下
- 外観変更時の再描画が重い場合、View の分割を検討
- 不要な監視を削除

## 関連ドキュメント
- `.copilot/structure-map.md` - アーキテクチャ全体像
- `QuizSettingsView.swift` - 設定UIの実装
- Apple Human Interface Guidelines - Dark Mode
