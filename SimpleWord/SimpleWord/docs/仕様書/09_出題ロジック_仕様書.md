# 出題ロジック仕様書

**最終更新: 2025-10-25**

この文書は SimpleWord の出題ロジックを復元・理解するための詳細仕様です。本アプリは単なるランダム出題ではなく、ユーザーの学習状況に適応する高度な適応型学習システムを実装しています。

## ⚠️ 重要: 復元のための必須情報

このドキュメントは、適応型学習システムが喪失した場合に完全復元するために必要なすべての情報を含んでいます。

### 復元時の参照順序
1. このドキュメント（全体設計・アルゴリズム）
2. `docs/COMPREHENSIVE_SPECIFICATION.md`（データモデル詳細）
3. `ADAPTIVE_LEARNING_GUIDE.md`（記憶定着段階の実装）
4. 実装ファイル（`AdaptiveScheduler.swift`, `StudyRecord.swift`等）

---

## 概要

### 何を実現しているか
- **適応型学習**: 各単語の習熟度・正答率・応答時間を記録し、個別の学習間隔を管理
- **バッチ学習**: 出題をバッチ（セット）単位で管理し、一定の成功率に達したら次のバッチへ進む
- **動的な繰り返し**: 低正答率の単語は自動的に繰り返し回数を増やす
- **補修モード**: バッチ内の低正答率単語が一定割合を超えると補修モードに入り、苦手な単語を集中的に出題
- **ローテーション**: 習熟した単語を低出題回数の単語と入れ替えて、均等に学習を進める

### なぜこの設計か
- 脳科学・記憶科学の知見（忘却曲線、間隔反復学習）を取り入れ、効率的な記憶定着を目指す
- ユーザーごとの学習ペースや忘却傾向を推定し、出題間隔を個別最適化
- 単なる反復ではなく、必要な単語に学習時間を集中させる

---

## アーキテクチャ

### 主要コンポーネント

1. **AdaptiveScheduler** (`Features/Study/Logic/AdaptiveScheduler.swift`)
   - 学習スケジューラの中核
   - 各単語の回答結果を記録し、次回出題時刻・優先度を計算
   - バッチ単位で出題する単語リストを優先度順に返す

2. **StudyRecord** (`Features/Study/Domain/StudyRecord.swift`)
   - 1単語ごとの学習履歴を保持
   - 出題間隔（interval）、次回出題時刻（nextDueAt）、正答率、連続正誤、容易度（ease）などを管理
   - SM-2アルゴリズムを簡易化した間隔更新ロジックを実装

3. **LearningAnalytics** (`Features/Study/Logic/LearningAnalytics.swift`)
   - ユーザー全体の学習傾向を分析
   - 学習ペース（paceFactor）、忘却傾向（forgettingFactor）、交互傾向（alternationBoost）を推定

4. **QuizView** (`QuizView.swift`)
   - UI層：出題・回答・結果表示
   - AdaptiveScheduler と連携し、回答結果を記録
   - バッチ管理・評価・進行制御を担当

5. **WordScoreStore** (`Stores/WordScoreStore.swift`)
   - 単語別の成績（正答数・出題回数・正答率）を保存
   - UI表示やフィルタリングに使用

---

## 出題フロー（全体像）

```
[起動]
  ↓
[CSV読み込み] → フィルタ（分野・難易度） → 出題対象リスト（items）作成
  ↓
[バッチ準備] (prepareBatch)
  ↓
  1. AdaptiveScheduler.scheduleNextBatch() で優先度順にバッチサイズ分の単語を取得
  2. 補修モード判定：低正答率単語が一定割合以上なら補修モード
  3. ローテーション：前バッチで高正答率（85%以上）の単語を低出題回数単語と入れ替え
  4. 繰り返し回数計算：各単語ごとに個別の繰り返し回数を決定（低正答率は多く）
  5. プール作成：繰り返し回数分の問題をラウンドロビンで配置（連続を避ける）
  ↓
[問題出題] (prepareQuestion)
  ↓
  - 選択肢生成（重み付き：低正答率単語が選択肢に出やすい）
  - タイマー開始（設定が有効な場合）
  - 音声読み上げ（設定が有効な場合）
  ↓
[回答] (select / giveUp)
  ↓
  - 正誤判定
  - WordScoreStore に記録
  - AdaptiveScheduler.record() で StudyRecord を更新（応答時間込み）
  - 自動進行（設定が有効で正解の場合のみ）
  ↓
[次の問題] (next)
  ↓
  プール内の次の問題へ → プール終了ならバッチ評価へ
  ↓
[バッチ評価] (evaluateBatch)
  ↓
  成功率 >= しきい値？
    YES → 次のバッチサイズを増やして prepareBatch へ
    NO  → 再試行（最大3回）→ 3回失敗なら次バッチへ
  ↓
  全バッチ終了 → 結果保存 → 終了画面
```

---

## 詳細仕様

### 1. 初期読み込みとフィルタリング (`loadCSVAndStart`)

#### CSV読み込み優先順位
1. `currentCSV.name` で指定された CSV を Documents ディレクトリから探す
2. Documents になければ Bundle から探す
3. 指定がなければデフォルト順: `高校単語.csv` → `サンプル単語.csv`

#### フィルタリング
- **分野フィルタ** (`quizSettings.fields`): 
  - 空でなければ、`item.relatedFields` に含まれる単語のみ抽出
  - 大文字小文字を区別しない部分一致
  
- **難易度フィルタ** (`quizSettings.difficulties`):
  - 空でなければ、`item.difficulty` に含まれる単語のみ抽出
  - 大文字小文字を区別しない部分一致

#### 出題数とシャッフル
- `quizSettings.numberOfQuestions` で出題総数を指定
- `quizSettings.isRandomOrder` が true なら全体をシャッフルしてから切り出し
- false なら CSV の元の順序を維持

---

### 2. バッチ準備 (`prepareBatch`)

#### 2.1 AdaptiveScheduler による優先度選択

`scheduler.scheduleNextBatch(itemIDs: ids, count: batchSize)` を呼び出し、次に出題すべき単語のIDリストを取得。

**優先度スコア計算式**（AdaptiveScheduler 内部）:
```
final = dueFactor * accFactor * intervalFactor * attemptScore * troubleFactor * masteredPenalty
        * easeFactor * (1.0 + (1.0 - recallEstimate)) * forgettingBoost * alternationBoost
```

各要素の意味：
- `dueFactor`: 次回出題時刻（nextDueAt）を過ぎているほど高い
- `accFactor`: 正答率（smoothedAccuracy）が低いほど高い
- `intervalFactor`: 出題間隔（interval）が短いほど高い
- `attemptScore`: 出題回数（totalAttempts）が少ないほど高い
- `troubleFactor`: 誤答連続（wrongStreak）や交互変化（alternationCount）が多いほど高い
- `masteredPenalty`: 習熟済み（mastered）なら 0.25 倍に減衰
- `easeFactor`: 容易度（ease）が高い（簡単）ほど低い
- `recallEstimate`: 想起確率の推定（経過時間から指数減衰）、想起しにくいほど高い
- `forgettingBoost`: 全体の忘却傾向に基づくブースト
- `alternationBoost`: 全体の交互傾向に基づくブースト

スコアが高い順に並べ、上位 `batchSize` 件を返す。

#### 2.2 補修モード判定

```swift
let lowAccThreshold = quizSettings.model.lowAccuracyThreshold  // デフォルト 0.6
let lowCount = pickedItems.filter { wordScoreStore.score(for: $0.id).accuracy < lowAccThreshold }.count
let lowRatio = Double(lowCount) / Double(pickedItems.count)
remediationMode = (lowRatio >= quizSettings.model.maxLowAccuracyRatio)  // デフォルト 0.5
```

- バッチ内で正答率 < 60% の単語が 50% 以上なら補修モードに入る
- 補修モード時は低正答率の単語のみをピックアップして出題

#### 2.3 ローテーション（セット終了後の入れ替え）

前バッチ終了後、以下の条件を満たす単語を入れ替え：
- **置換対象**: 前バッチで正答率 >= 85% かつ出題回数 >= 3 回の単語
- **置換候補**: 全体の中で出題回数が少ない単語（昇順にソート）
- **置換数**: バッチサイズの 20%（最低1件）

これにより、習熟した単語の出題頻度を下げ、未学習単語に学習時間を振り向ける。

#### 2.4 繰り返し回数の個別計算

各単語ごとに繰り返し回数（perItemRepeat）を動的に決定：

```swift
let isHighMemory = (ws.accuracy >= 0.85 && ws.attempts >= 3) || rec.mastered || rec.correctStreak >= 3

if remediationMode {
    perItemRepeat[it.id] = isHighMemory ? 1 : max(2, repeatCount * 4)
} else {
    if ws.accuracy < lowAccThreshold {
        perItemRepeat[it.id] = max(2, repeatCount * 3)
    } else {
        perItemRepeat[it.id] = isHighMemory ? 1 : repeatCount
    }
}
```

- **高記憶単語**: 1回のみ
- **低正答率単語**: 通常時は `repeatCount * 3`、補修時は `repeatCount * 4`
- **中間**: `repeatCount`（デフォルト値）

#### 2.5 プール作成（ラウンドロビン配置）

繰り返し回数分の問題を、同じ単語が連続しないようにラウンドロビンで配置：
```
残回数が多い順にソート → 前回と異なる単語を選択 → プールに追加 → 残回数を減算
```

これにより、同じ単語が連続して出題されることを防ぎ、学習効果を高める。

---

### 3. 問題出題 (`prepareQuestion`)

#### 選択肢の生成

**選択肢数**: `quizSettings.numberOfChoices`（デフォルト 4）

**誤答の選択（重み付き）**:
```swift
let weight = {
    if accuracy < lowAccThreshold { return 4.0 }  // 低正答率: 高頻度
    if accuracy >= 0.85 { return 0.5 }            // 高正答率: 低頻度
    return 1.0                                     // 中間: 通常
}
```

重み付き確率で誤答を選択することで、低正答率の単語が選択肢として表示される機会を増やし、間接的に学習を促進。

#### 表示内容
- **メイン表示**: `meaning`（日本語訳）を優先、空なら `term`（語句）
- **補助表示**（回答後のみ）: `term`, `reading`, `etymology`, `relatedWords`, `relatedFields`, `difficulty`
- **正答率表示**: `wordScoreStore.score(for: item.id)` から過去の正答率と出題回数を表示

#### タイマー
`quizSettings.isTimerEnabled` が true なら：
- 制限時間: `quizSettings.timeLimit`（秒）
- 時間切れは `giveUp()` と同等に扱う

#### 音声読み上げ
`quizSettings.isSpeechEnabled` が true なら：
- `AVSpeechSynthesizer` で `item.term` を読み上げ
- 言語: `en-US`（英語）

---

### 4. 回答処理 (`select`, `giveUp`)

#### `select(choiceID)` - 選択肢をタップ

1. **正誤判定**: `choiceID == correctAnswerID`
2. **スコア更新**: 正解なら `score++`, `batchCorrect++`
3. **WordScoreStore 記録**: `wordScoreStore.recordResult(itemID, correct)`
4. **AdaptiveScheduler 記録**:
   ```swift
   let responseTime = Date().timeIntervalSince(questionShownAt)
   let outcome = wasCorrect ? .correct : .wrong
   scheduler.record(itemID: item.id, result: outcome, responseTime: responseTime)
   ```
5. **自動進行**: 正解かつ `quizSettings.model.autoAdvance` が true なら 1 秒後に `next()` を自動実行

#### `giveUp()` - 「分からない」をタップ

1. **不正解として記録**: `wordScoreStore.recordResult(itemID, correct: false)`
2. **AdaptiveScheduler 記録**: `outcome = .gaveUp`
3. **自動進行なし**: 解説を見せるため自動進行は抑止

---

### 5. AdaptiveScheduler の内部ロジック

#### StudyRecord の更新 (`StudyRecord.apply`)

**間隔更新アルゴリズム**（SM-2 ベース）:

1. **容易度（ease）の更新**:
   ```swift
   quality = {
       correct && fast: 5
       correct && slow: 4
       wrong: 2
       gaveUp: 1
   }
   easeDelta = 0.06 * (quality - 3.0)
   ease = clamp(ease + easeDelta, 1.1, 3.0)
   ```

2. **正解時の間隔伸長**:
   ```swift
   streakBonus = min(3, correctStreak)
   growth = (1.2 + 0.12 * streakBonus) * ease * paceFactor * forgettingFactor * (1.0 - altPenalty)
   interval *= growth
   ```
   - 連続正解するほど間隔が伸びる（最大3回まで加速）
   - ease が高いほど間隔が伸びやすい
   - paceFactor（学習ペース）と forgettingFactor（忘却傾向）で個別調整

3. **誤答時の間隔短縮**:
   ```swift
   wrongPower = min(4, wrongStreak)
   interval *= pow(0.5, wrongPower) * forgettingFactor
   ```
   - 連続誤答するほど指数的に短縮（最大 1/16）

4. **次回出題時刻**:
   ```swift
   nextDueAt = now + interval
   ```

#### 指標の意味
- `interval`: 次回出題までの時間（秒）。範囲: 15秒 ~ 14日
- `ease`: 単語ごとの容易度。範囲: 1.1 ~ 3.0
- `smoothedAccuracy`: EWMA（指数移動平均）正答率。範囲: 0.0 ~ 1.0
- `avgResponseTime`: EWMA 応答時間（秒）
- `correctStreak`: 連続正解回数
- `wrongStreak`: 連続誤答回数
- `alternationCount`: 正誤が交互に変化した回数
- `mastered`: 直近5回すべて正解で true

---

### 6. バッチ評価 (`evaluateBatch`)

#### 成功判定

```swift
successRate = batchCorrect / pool.count
threshold = quizSettings.threshold  // デフォルト 0.8
```

#### 成功時（successRate >= threshold）
1. 前バッチのIDリストを記録（ローテーション用）: `lastBatchItemIDs = lastPickedItems.map { $0.id }`
2. **バッチサイズを増やす**: `batchSize = min(items.count, batchSize + questionsPerBatch)`
3. `batchAttempts = 0`
4. 次のバッチを準備: `prepareBatch()`

#### 失敗時（successRate < threshold）
1. `batchAttempts++`
2. `batchAttempts < 3` なら同じバッチを再実行: `prepareBatch()`
3. `batchAttempts >= 3` なら次のバッチへ強制進行:
   - `lastBatchItemIDs` を記録（ローテーション適用）
   - `batchStart += batchSize`
   - `batchAttempts = 0`
   - `prepareBatch()`

#### 全バッチ終了判定
```swift
if batchStart >= order.count {
    finished = true
    // QuizResult を作成して scoreStore に保存
}
```

---

## 設定パラメータ一覧

| パラメータ | デフォルト値 | 説明 |
|----------|------------|------|
| `numberOfQuestions` | 50 | 出題総数 |
| `questionsPerBatch` | 10 | 初期バッチサイズ |
| `repeatCount` | 2 | 基本繰り返し回数（低正答率は自動増加） |
| `threshold` | 0.8 | バッチ成功判定のしきい値（80%） |
| `lowAccuracyThreshold` | 0.6 | 低正答率の判定基準（60%） |
| `maxLowAccuracyRatio` | 0.5 | 補修モードに入るしきい値（50%） |
| `numberOfChoices` | 4 | 選択肢数 |
| `isRandomOrder` | true | ランダム順序で出題 |
| `autoAdvance` | false | 正解時の自動進行 |
| `isTimerEnabled` | false | タイマー有効化 |
| `timeLimit` | 30 | タイマー制限時間（秒） |
| `isSpeechEnabled` | false | 音声読み上げ有効化 |

---

## 復元手順

### 最小構成で復元する場合

1. **必須ファイル**:
   ```
   SimpleWord/Features/Study/Domain/StudyRecord.swift
   SimpleWord/Features/Study/Logic/AdaptiveScheduler.swift
   SimpleWord/Features/Study/Logic/LearningAnalytics.swift
   SimpleWord/Features/Study/Infrastructure/FileStudyProgressRepository.swift
   SimpleWord/QuizView.swift
   SimpleWord/Stores/WordScoreStore.swift
   SimpleWord/Stores/QuizSettings.swift
   ```

2. **依存関係の確認**:
   - `StudyRecord` が `ReviewOutcome` enum を使用
   - `AdaptiveScheduler` が `StudyProgressRepository` プロトコルを使用
   - `QuizView` が `@EnvironmentObject` で各ストアを注入

3. **初期化の確認** (`SimpleWordApp.swift`):
   ```swift
   @StateObject private var quizSettings = QuizSettings()
   @StateObject private var scoreStore = ScoreStore()
   @StateObject private var wordScoreStore = WordScoreStore()
   @StateObject private var currentCSV = CurrentCSV()
   
   ContentView()
       .environmentObject(quizSettings)
       .environmentObject(scoreStore)
       .environmentObject(wordScoreStore)
       .environmentObject(currentCSV)
   ```

4. **データ永続化**:
   - `StudyRecord` は `Documents/study_progress/{itemID}.json` に保存
   - `WordScoreStore` は `UserDefaults` に保存
   - CSV は `Documents` または `Bundle` から読み込み

### テスト観点

- [ ] 初回起動でクラッシュしない
- [ ] CSV が空でもエラー表示のみでクラッシュしない
- [ ] 低正答率単語が繰り返し出題される
- [ ] 高正答率単語の出題頻度が下がる
- [ ] 補修モードに入る（低正答率単語が多い場合）
- [ ] バッチ評価が正しく動作する（成功→次バッチ、失敗→再試行）
- [ ] タイマー・音声・自動進行の設定が反映される
- [ ] ローテーションが働く（習熟単語が入れ替わる）

---

## トラブルシューティング

### 問題: 出題される単語が偏る
- **原因**: AdaptiveScheduler の優先度計算が正しく動作していない
- **確認**: `StudyRecord` が正しく保存されているか確認（`Documents/study_progress/`）
- **対処**: StudyProgressRepository の save/load メソッドをデバッグ

### 問題: 補修モードに入らない
- **原因**: `lowAccuracyThreshold` または `maxLowAccuracyRatio` の設定が不適切
- **確認**: `quizSettings.model.lowAccuracyThreshold` と `maxLowAccuracyRatio` の値
- **対処**: 設定を調整（例: threshold を 0.7 に上げる）

### 問題: バッチが進まない
- **原因**: しきい値が高すぎる
- **確認**: `quizSettings.threshold` の値（デフォルト 0.8）
- **対処**: しきい値を下げる（例: 0.6 に設定）

### 問題: 同じ単語が連続して出題される
- **原因**: ラウンドロビン配置が正しく動作していない
- **確認**: `prepareBatch()` のラウンドロビンロジック
- **対処**: `lastID` が正しく更新されているか確認

---

## 参考文献・理論背景

- **忘却曲線** (Ebbinghaus): 時間経過による記憶の減衰
- **間隔反復学習** (Spaced Repetition): 適切な間隔で復習することで長期記憶を強化
- **SM-2 アルゴリズム** (SuperMemo): 容易度と出題間隔を動的に調整する学習アルゴリズム
- **EWMA** (Exponential Weighted Moving Average): 指数移動平均による平滑化

---

## 将来の拡張候補

- [ ] AI による難易度自動調整
- [ ] 学習グラフの可視化（進捗・忘却曲線）
- [ ] 複数デバイス間での学習履歴同期（iCloud）
- [ ] 音声認識による回答入力
- [ ] カスタム学習プロファイル（集中型・分散型など）
- [ ] 学習目標設定と達成通知

---

## まとめ

本アプリの出題ロジックは、以下の特徴を持つ高度な適応型学習システムです：

1. **個別最適化**: 各単語の習熟度に応じて出題間隔と繰り返し回数を動的調整
2. **バッチ学習**: セット単位で学習を進め、段階的に範囲を拡大
3. **補修機能**: 苦手な単語を自動検出し集中学習
4. **ローテーション**: 習熟単語と未学習単語のバランスを自動調整
5. **脳科学ベース**: 忘却曲線・間隔反復学習の理論を実装

このロジックを復元する際は、単なるシャッフルや固定繰り返しではなく、上記の適応型要素を必ず含める必要があります。各コンポーネントが密接に連携しているため、部分的な実装では効果が得られません。
