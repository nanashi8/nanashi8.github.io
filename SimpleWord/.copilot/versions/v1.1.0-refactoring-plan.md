# QuizView リファクタリング計画 v1.1.0

**日付**: 2025年10月19日
**目標**: QuizViewを機能別に分割し、完全な機能を実装

## フェーズ1: モデル層の分離
### 新規ファイル: QuizState.swift
- @State変数を構造化されたモデルに集約
- 問題管理、選択肢管理、スコア管理、バッチ管理の状態を整理
- 30個の@State変数を5-6個の構造化モデルに削減

**責務**:
```swift
struct QuizState {
    var questionState: QuestionState
    var batchState: BatchState
    var scoreState: ScoreState
    var uiState: UIState
    var timerState: TimerState
}
```

## フェーズ2: ロジック層の分離
### 新規ファイル: QuizEngine.swift
- CSV読み込み
- バッチ準備（prepareBatch - 150行の複雑なロジック）
- 問題準備（prepareQuestion）
- 選択肢生成
- スコア計算
- AdaptiveScheduler連携

**責務**:
- QuizViewからビジネスロジックを完全に分離
- テスタブルな純粋関数として実装
- 副作用を最小限に

## フェーズ3: View層の分割
### 新規ファイル群:
1. **QuizMainView.swift** - メインコンテナ（100行以下）
2. **QuizQuestionSection.swift** - 問題表示セクション
3. **QuizChoicesSection.swift** - 選択肢表示セクション
4. **QuizControlsSection.swift** - コントロールボタン群

**責務**:
- UIの表示とユーザー入力のみ
- ロジックはQuizEngineに委譲
- 各ビュー100行以下を目標

## フェーズ4: 完全機能の実装
### 実装する機能:
1. ✓ 適応型学習（AdaptiveScheduler連携）
2. ✓ バッチ学習管理（補修モード含む）
3. ✓ スコア記録・永続化（WordScoreStore/ScoreStore更新）
4. ✓ アニメーション（合格数・総出題数の光るエフェクト）
5. ✓ タイマー機能（制限時間・自動遷移）
6. ✓ CSV読み込みとの完全統合
7. ✓ 音声再生機能（isSpeechEnabled対応）

## フェーズ5: テストとドキュメント
- ユニットテストの作成（QuizEngine、QuizState）
- .copilot/components/ 配下にドキュメント作成
- structure-map.md の更新
- changelog.md の更新

## 実装順序
1. QuizState.swift を作成（モデル定義）
2. QuizEngine.swift を作成（ロジック実装）
3. QuizView.swift を更新（QuizEngineを使用）
4. 動作確認・ビルドテスト
5. View層の分割（QuizMainView.swift等）
6. 最終動作確認
7. ドキュメント更新

## 成功基準
- ✓ 各ファイルが200行以下
- ✓ 責務が明確に分離されている
- ✓ 既存の全機能が動作する
- ✓ ビルドエラー・警告がない
- ✓ テストが通る
