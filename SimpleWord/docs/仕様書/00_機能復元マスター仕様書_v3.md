# SimpleWord 機能復元マスター仕様書 v3.0

**最終更新**: 2025年10月30日  
**ステータス**: ✅ 最新（実装と完全一致）  
**復元可能性**: ★★★★★

---

## 🎯 このドキュメントの目的

このドキュメントは、**SimpleWordの全機能を完全に復元できる**ことを目的としています。

### 使用シーン
- ✅ 機能が失われた時の復元
- ✅ 新しい開発者のオンボーディング
- ✅ リファクタリング前の設計確認
- ✅ 類似プロジェクトの立ち上げ

---

## 📋 プロジェクト全体概要

### アプリケーション名
**SimpleWord** - CSV駆動型の単語学習アプリ

### 対象プラットフォーム
- **iOS**: 15.0以降
- **開発環境**: Xcode 15.0以降、Swift 5.9以降
- **アーキテクチャ**: SwiftUI + Combine

### 技術スタック
```
UI Framework: SwiftUI
状態管理: @Published, @State, @EnvironmentObject
非同期処理: Combine
データ永続化: UserDefaults, FileManager
データ形式: CSV (UTF-8)
```

### プロジェクト構造（Feature-First）
```
SimpleWord/
├── SimpleWord/
│   ├── SimpleWordApp.swift          # アプリエントリーポイント
│   ├── ContentView.swift             # ホーム画面
│   ├── Features/                     # 機能別モジュール
│   │   ├── Quiz/                     # クイズ機能
│   │   ├── QuizSettings/             # 出題設定
│   │   ├── Results/                  # 成績表示
│   │   ├── Navigator/                # 単語一覧
│   │   ├── CSVEditor/                # CSV編集
│   │   ├── IDMap/                    # ID管理
│   │   ├── Filters/                  # フィルタ機能
│   │   ├── ChoiceCard/               # 選択肢カード
│   │   └── WordList/                 # 単語リスト
│   ├── Services/                     # 共通サービス
│   ├── Stores/                       # 状態管理（旧構造）
│   └── Utils/                        # ユーティリティ
├── Common/                           # 共通モジュール
│   ├── Models/                       # データモデル
│   ├── Data/                         # データアクセス層
│   ├── Extensions/                   # 拡張機能
│   └── Utility/                      # 共通ユーティリティ
├── Appearance/                       # 外観設定
└── Resources/                        # リソース（CSV等）
```

---

## 🏗️ アーキテクチャ原則

### 1. Feature-First / Vertical Slice Architecture
各機能は独立したモジュールとして配置され、View/ViewModel/Service/Modelを含みます。

### 2. 責務分離
- **View**: UI表示のみ
- **ViewModel/Store**: 状態管理・ビジネスロジック
- **Service**: データ処理・アルゴリズム
- **Model**: データ構造

### 3. データフロー
```
CSV → QuestionItemRepository → QuizDataLoader → QuizView
                                      ↓
                              WordScoreStore（成績記録）
                                      ↓
                              UserDefaults（永続化）
```

### 4. 状態管理パターン
```swift
// 環境オブジェクト（グローバル状態）
@EnvironmentObject var wordScoreStore: WordScoreStore
@EnvironmentObject var currentCSV: CurrentCSV
@EnvironmentObject var quizSettings: QuizSettings
@EnvironmentObject var scoreStore: ScoreStore

// ローカル状態
@StateObject private var state = QuizViewState()
@StateObject private var sessionStore = QuizSessionStore.shared
```

---

## 📦 主要機能一覧

### 1. クイズ機能（Quiz）
- **ファイル**: `Features/Quiz/QuizView.swift`
- **仕様書**: `01_クイズ機能_仕様書_v2.md`
- **概要**: 4択クイズでCSVから問題を出題
- **主要機能**:
  - バッチ学習（設定可能なサイズ）
  - ラウンドロビン配置（同じ問題の連続回避）
  - セッション管理（中断・再開対応）
  - 前へ/次へナビゲーション
  - アニメーション効果

### 2. 出題設定（QuizSettings）
- **ファイル**: `Features/QuizSettings/QuizSettingsView.swift`
- **仕様書**: `02_出題設定_仕様書_v2.md`
- **概要**: CSV別の出題条件を設定
- **主要機能**:
  - CSV選択
  - 分野・難易度フィルタ
  - バッチサイズ設定
  - 繰り返し回数設定
  - 学習モード選択
  - CSV別設定保存

### 3. 成績表示（Results）
- **ファイル**: `Features/Results/Views/`
- **仕様書**: `05_成績表示_仕様書.md`
- **概要**: 学習結果の可視化
- **主要機能**:
  - CSV別成績一覧
  - 単語別成績詳細
  - 正答率・出題回数表示
  - 成績のリセット

### 4. 単語一覧（Navigator）
- **ファイル**: `Features/Navigator/NavigatorView.swift`
- **仕様書**: `04_ナビゲーター機能_仕様書.md`
- **概要**: CSVの全単語を一覧表示
- **主要機能**:
  - 単語リスト表示
  - 検索・フィルタ
  - 詳細表示
  - ファイル変更監視

### 5. CSV編集（CSVEditor）
- **ファイル**: `Features/CSVEditor/Views/CSVEditorView.swift`
- **仕様書**: `07_CSV編集_仕様書.md`
- **概要**: アプリ内でCSVを編集
- **主要機能**:
  - 行の追加・削除・編集
  - プレビュー表示
  - 保存・取り消し

### 6. ID管理（IDMap）
- **ファイル**: `Features/IDMap/Views/IDMapAdminView.swift`
- **仕様書**: `06_IDマップ管理_仕様書.md`
- **概要**: 単語IDの整合性管理
- **主要機能**:
  - ID生成
  - 整合性チェック
  - 修復機能

### 7. 外観設定（Appearance）
- **ファイル**: `Appearance/Appearance.swift`
- **仕様書**: `08_外観_仕様書.md`
- **概要**: ライト/ダークモード切り替え
- **主要機能**:
  - システム設定追従
  - 手動切り替え
  - アプリ全体への反映

---

## 🔑 コアモデル

### QuestionItem（問題データ）
```swift
public struct QuestionItem: Identifiable, Hashable {
    public let id: UUID
    public let term: String              // 語句
    public let reading: String           // 読み
    public let meaning: String           // 意味
    public let etymology: String         // 語源・解説
    public let relatedWords: [String]    // 関連語
    public let relatedFields: [String]   // 関連分野
    public let difficulty: String        // 難易度
}
```

**CSVフォーマット**:
```csv
語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度
いと,いと,とても,古語で強調を表す副詞,いみじ:非常に,家族,1
```

または:
```csv
語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度
Hello!,ハロー,こんにちは,英語の挨拶の定番,Hi:やあ,感情,1
```

### WordScore（単語別成績）
```swift
public struct WordScore: Codable {
    public var attempts: Int = 0          // 試行回数
    public var correct: Int = 0           // 正解数
    public var lastStudied: Date?         // 最終学習日時
    
    public var accuracy: Double {
        guard attempts > 0 else { return 0.0 }
        return Double(correct) / Double(attempts)
    }
}
```

### QuizResult（クイズ結果）
```swift
public struct QuizResult: Identifiable, Codable {
    public let id: UUID
    public let date: Date
    public let total: Int                 // 総問題数
    public let correct: Int               // 正解数
    public let settings: QuizSettingsModel
    
    public var accuracy: Double {
        guard total > 0 else { return 0.0 }
        return Double(correct) / Double(total)
    }
}
```

### QuizSettingsModel（出題設定）
```swift
public struct QuizSettingsModel: Codable {
    public var selectedCSV: String?
    public var selectedFields: [String] = []
    public var difficulties: [String] = []
    public var repeatCount: Int = 1
    public var successThreshold: Double = 0.8
    public var autoAdvance: Bool = false
    public var questionsPerBatch: Int = 10
    public var learningMode: LearningMode = .normal
}
```

---

## 🔄 主要データフロー

### 1. クイズ開始フロー
```
1. ユーザーが「クイズをはじめる」タップ
   ↓
2. QuizView.onAppear() → loadCSVAndStart()
   ↓
3. QuizDataLoader.loadQuizData()
   - CurrentCSV.name からCSV名を取得
   - QuestionItemRepository でCSV読み込み
   - フィルタ適用（分野・難易度）
   - 出題順序決定（ランダム/順番）
   ↓
4. QuizSessionStore でセッション管理
   - 既存セッション確認
   - 新規セッション開始 or 復元
   ↓
5. QuizBatchManager.prepareBatch()
   - バッチサイズ分の問題を取得
   - 繰り返し回数を適用
   - ラウンドロビンシャッフル
   ↓
6. prepareQuestion()
   - プールから1問取り出し
   - QuizQuestionGenerator で選択肢生成
   - 画面表示
```

### 2. 回答処理フロー
```
1. ユーザーが選択肢をタップ
   ↓
2. handleChoiceSelection(id)
   - 正解判定
   ↓
3. QuizAnswerHandler.handleAnswer()
   - QuizSessionStore にスコア記録
   - アニメーション判定
   ↓
4. WordScoreStore.recordResult()
   - 単語別成績を更新
   - UserDefaults に保存
   ↓
5. 自動進行（設定されている場合）
   - 1.5秒後に次の問題へ
```

### 3. 設定保存フロー
```
1. ユーザーが設定を変更
   ↓
2. QuizSettings.save()
   - 現在のmodelをPerCSVSettingsに変換
   - storage[csvName] に保存
   ↓
3. persistStorage()
   - JSON エンコード
   - UserDefaults に保存
```

---

## 🗄️ データ永続化戦略

### 1. QuizSettings（CSV別設定）
- **保存場所**: UserDefaults
- **キー**: `"QuizPerCSVSettings_v1"`
- **形式**: `[String: PerCSVSettings]` の JSON
- **CSV切り替え**: `CurrentCSV.$name` を監視し自動切り替え

### 2. WordScoreStore（単語別成績）
- **保存場所**: UserDefaults
- **キー**: `"SimpleWord.WordScoreStore.v2"`
- **形式**: `[String: [UUID: WordScore]]` の JSON
- **CSV別管理**: CSV名をキーにした二重辞書

### 3. ScoreStore（CSV別成績）
- **保存場所**: UserDefaults
- **キー**: CSV名ごとに `"QuizResults_\(csvName)"`
- **形式**: `[QuizResult]` の JSON配列

### 4. QuizSessionStore（セッション状態）
- **保存場所**: UserDefaults
- **キー**: `"QuizSession"`
- **形式**: Dictionary
- **内容**: score, questionCount, batchCorrect, currentCSVName等

---

## 🎨 UI/UXパターン

### 1. カード型UI（SectionCard）
```swift
SectionCard(backgroundColor: cardBackground) {
    // コンテンツ
}
.listRowInsets(EdgeInsets())
.listRowBackground(cardBackground)
```

### 2. セクションヘッダー
```swift
SectionHeader(systemImage: "doc", title: "出題するCSV")
```

### 3. 難易度バッジ
```swift
DifficultyBadge(difficulty: item.difficulty)
```

### 4. タグ表示
```swift
ForEach(item.relatedFields, id: \.self) { field in
    TagCapsule(text: field)
}
```

### 5. アニメーション効果
```swift
.scaleEffect(shouldAnimate ? 1.2 : 1.0)
.animation(.spring(response: 0.3, dampingFraction: 0.6), value: shouldAnimate)
```

---

## 🧩 主要アルゴリズム

### 1. ラウンドロビンシャッフル
**目的**: 同じ問題が連続しないように均等に分散配置

```swift
func roundRobinShuffle(items: [QuestionItem], pool: [QuestionItem]) -> [QuestionItem] {
    var result: [QuestionItem] = []
    var queues = [UUID: [QuestionItem]]()
    
    // 各問題のキューを作成
    for item in pool {
        queues[item.id, default: []].append(item)
    }
    
    // ラウンドロビン方式で取り出し
    var hasMore = true
    while hasMore {
        hasMore = false
        for item in items {
            if var queue = queues[item.id], !queue.isEmpty {
                result.append(queue.removeFirst())
                queues[item.id] = queue
                hasMore = true
            }
        }
    }
    
    return result
}
```

### 2. フィルタリング
**目的**: 分野・難易度で問題を絞り込む

```swift
func applyFilters(
    to items: [QuestionItem],
    fields: Set<String>,
    difficulties: Set<String>
) -> [QuestionItem] {
    var result = items

    // 分野フィルタ
    if !fields.isEmpty {
        result = result.filter { item in
            !Set(item.relatedFields).isDisjoint(with: fields)
        }
    }

    // 難易度フィルタ
    if !difficulties.isEmpty {
        result = result.filter { item in
            difficulties.contains(item.difficulty)
        }
    }

    return result
}
```

### 3. 選択肢生成
**目的**: 正解1つ+不正解N-1つの選択肢を生成

```swift
func generateChoices(
    correctItem: QuestionItem,
    allItems: [QuestionItem],
    numberOfChoices: Int
) -> (choices: [QuizChoice], correctAnswerID: UUID) {
    // 正解の選択肢
    let correctChoice = QuizChoice(
        id: UUID(),
        label: correctItem.meaning,
        explanation: correctItem.etymology,
        isCorrect: true,
        item: correctItem
    )
    
    // 不正解の選択肢
    let otherItems = allItems.filter { $0.id != correctItem.id }.shuffled()
    var incorrectChoices: [QuizChoice] = []
    
    for otherItem in otherItems.prefix(numberOfChoices - 1) {
        incorrectChoices.append(QuizChoice(
            id: UUID(),
            label: otherItem.meaning,
            explanation: otherItem.etymology,
            isCorrect: false,
            item: otherItem
        ))
    }
    
    // シャッフルして返す
    return (
        choices: ([correctChoice] + incorrectChoices).shuffled(),
        correctAnswerID: correctChoice.id
    )
}
```

---

## 🔧 重要なサービス/ユーティリティ

### 1. QuestionItemRepository
**役割**: CSVファイルから QuestionItem を読み込む

```swift
let repository = QuestionItemRepository(fileName: "中学英単語")
switch repository.fetch() {
case .success(let items):
    // 読み込み成功
case .failure(let error):
    // エラー処理
}
```

### 2. CSVHeaderParser
**役割**: CSVのヘッダを解析して表示ラベルマップを作成

```swift
let parser = CSVHeaderParser()
let headerLabels = parser.parseHeader(from: csvURL)
// ["term": "語句", "meaning": "意味", ...]
```

### 3. FileUtils
**役割**: ファイル操作のユーティリティ

```swift
// Bundle内のCSVファイル一覧
let bundleFiles = FileUtils.listBundleCSVFiles()

// Documents内のCSVファイル一覧
let docFiles = FileUtils.listCSVFilesInDocuments()
```

---

## 📝 コーディング規約

### 1. ファイル構成
```swift
// ファイル冒頭コメント（何を/なぜ）
// QuizView.swift
// クイズ画面（4択・バッチ学習）
// - 何を: CSV から問題を読み込み、4択形式で出題します
// - なぜ: ユーザーが効率的に単語学習を行えるようにするため

import SwiftUI

struct QuizView: View {
    // MARK: - Properties
    // MARK: - Body
    // MARK: - Private Methods
}
```

### 2. 命名規則
- **View**: `〇〇View.swift`
- **ViewModel/Store**: `〇〇Store.swift` または `〇〇ViewModel.swift`
- **Service**: `〇〇Service.swift` または具体的な名前
- **Model**: `〇〇Model.swift` または `〇〇.swift`

### 3. インデント
- スペース4つ

### 4. コメント
- 日本語で意図を補足
- 複雑なロジックには必ずコメント

---

## 🚨 重要な注意事項

### 1. CSV読み込みの優先順位
```
1. Documents/〇〇.csv （ユーザーが追加したファイル）
2. Bundle.main/〇〇.csv （アプリ同梱ファイル）
```

### 2. CSV列の整合性チェック
- ヘッダ駆動型パーサーを使用（柔軟な列順に対応）
- 必須列: `term`, `meaning`
- オプション列: `reading`, `etymology`, `relatedWords`, `relatedFields`, `difficulty`

### 3. エラーハンドリング
```swift
do {
    let result = try dataLoader.loadQuizData(...)
} catch {
    state.errorMessage = error.localizedDescription
    state.isLoading = false
}
```

### 4. 環境オブジェクトの注入
```swift
// SimpleWordApp.swift
QuizView()
    .environmentObject(wordScoreStore)
    .environmentObject(currentCSV)
    .environmentObject(quizSettings)
    .environmentObject(scoreStore)
```

---

## 🧪 テスト戦略

### 1. ユニットテスト
- QuestionItemRepository のテスト
- フィルタリングロジックのテスト
- 選択肢生成のテスト

### 2. 統合テスト
- QuizView のフロー全体
- 設定保存・読み込み

### 3. UIテスト
- 画面遷移
- ユーザー操作

---

## 📚 関連仕様書

| 仕様書 | 内容 | 復元可能性 |
|-------|------|-----------|
| `01_クイズ機能_仕様書_v2.md` | クイズ画面の詳細 | ★★★★★ |
| `02_出題設定_仕様書_v2.md` | 設定画面の詳細 | ★★★★★ |
| `03_問題集管理_CSV_仕様書.md` | CSV管理 | ★★★☆☆ |
| `04_ナビゲーター機能_仕様書.md` | 単語一覧 | ★★★☆☆ |
| `05_成績表示_仕様書.md` | 成績表示 | ★★★★☆ |
| `06_IDマップ管理_仕様書.md` | ID管理 | ★★★☆☆ |
| `07_CSV編集_仕様書.md` | CSV編集 | ★★☆☆☆ |
| `08_外観_仕様書.md` | 外観設定 | ★★★☆☆ |
| `09_出題ロジック_仕様書_v2.md` | 出題アルゴリズム | ★★★★★ |
| `10_記憶定着度表示_仕様書.md` | 記憶段階表示 | ★★★★★ |
| `11_学習モード推奨_仕様書.md` | モード推奨 | ★★★★★ |
| `12_クイズUIコンポーネント_仕様書.md` | UIコンポーネント | ★★★★★ |

---

## 🔄 変更履歴

### v3.0 (2025-10-30)
- 機能復元のための包括的な仕様書として新規作成
- 全機能の概要を一元化
- データフロー・アーキテクチャ・アルゴリズムを詳細に記載
- コード例を豊富に追加

---

## 🎓 次のステップ

### 新規開発者向け
1. このドキュメント全体を通読
2. `01_クイズ機能_仕様書_v2.md` で主要機能を理解
3. `02_出題設定_仕様書_v2.md` で設定管理を理解
4. 実装ファイルを読みながら動作確認

### 機能復元時
1. 失われた機能を特定
2. 該当する仕様書を確認
3. このドキュメントのデータフロー・アルゴリズムを参照
4. 段階的に実装・テスト

### 新機能追加時
1. このドキュメントのアーキテクチャ原則を確認
2. Feature-First構造に従って配置
3. 既存のパターンを踏襲
4. 仕様書を更新

---

**このドキュメントは、SimpleWordプロジェクトの「憲法」です。**  
**すべての機能・設計・実装パターンの基準となります。**
