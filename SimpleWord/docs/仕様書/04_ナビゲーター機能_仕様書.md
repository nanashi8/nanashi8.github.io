# ナビゲーター（CSV内容の一覧表示）

**最終更新: 2025-10-19**

この文書は、「Navigator」画面（CSV の単語リスト表示）の編集・実装ガイドです。

## 概要

### 何を実現しているか
- CSV全体の単語リストを一覧表示
- 各単語の詳細情報の確認（QuestionDetailView へ遷移）
- ファイル変更の監視と自動リロード
- 検索・フィルタ機能（将来実装予定）

## 画面構成

### 単語リスト
```
┌─────────────────────────┐
│ example                  │
│ 例、見本                 │
│ 難易度: 中級             │
├─────────────────────────┤
│ practice                 │
│ 練習、実践               │
│ 難易度: 初級             │
└─────────────────────────┘
```

### ツールバー
```
[更新] [インポート]
```

## 関係するファイル

### 画面
- **NavigatorView.swift** - ナビゲーター画面本体
- **QuestionDetailView.swift** - 単語詳細表示

### ユーティリティ
- **CSVLoader.swift** - CSV読み込み
- **FileWatcher.swift** - ファイル変更監視

### データモデル
- **QuestionItem.swift** - 単語データ

## 主要な処理

### CSV読み込み
```swift
func loadCSV() {
    let loader = CSVLoader()
    
    // Documents → Bundle の順で探索
    if let csvURL = getCSVURL() {
        if let items = try? loader.load(from: csvURL) {
            self.items = items
            startFileWatcher(url: csvURL)
        }
    }
}
```

### ファイル変更監視
```swift
func startFileWatcher(url: URL) {
    fileWatcher = FileWatcher(url: url) { [weak self] in
        // ファイルが変更されたら再読み込み
        DispatchQueue.main.async {
            self?.loadCSV()
        }
    }
}
```

### 単語詳細への遷移
```swift
NavigationLink(destination: QuestionDetailView(item: item)) {
    VStack(alignment: .leading, spacing: 4) {
        Text(item.term)
            .font(.headline)
        Text(item.meaning)
            .font(.subheadline)
            .foregroundColor(.secondary)
        if !item.difficulty.isEmpty {
            DifficultyBadge(text: item.difficulty)
        }
    }
}
```

## 編集時の注意点

### パフォーマンス最適化
**問題**: 大量の単語（1000件以上）でスクロールが重くなる

**対策**:
```swift
List {
    ForEach(items) { item in
        NavigationLink(destination: QuestionDetailView(item: item)) {
            WordRowView(item: item)  // 軽量な View に分離
        }
    }
}
.onAppear {
    // LazyVStack や遅延読み込みの検討
}
```

### ファイル監視の注意点
**実装箇所**: `onDisappear`

```swift
.onDisappear {
    fileWatcher?.stop()
    fileWatcher = nil
}
```

**チェックポイント**:
- [ ] 画面を離れる時に監視を停止
- [ ] メモリリークを防ぐ
- [ ] バッテリー消費を抑える

### 検索機能の実装例
```swift
@State private var searchText: String = ""

var filteredItems: [QuestionItem] {
    if searchText.isEmpty {
        return items
    }
    return items.filter {
        $0.term.localizedCaseInsensitiveContains(searchText) ||
        $0.meaning.localizedCaseInsensitiveContains(searchText)
    }
}

// UI
.searchable(text: $searchText, prompt: "単語を検索")
```

## テスト観点

### 基本動作
- [ ] CSV読み込みが成功する
- [ ] 単語リストが表示される
- [ ] タップで詳細画面に遷移する
- [ ] 更新ボタンで再読み込みできる

### パフォーマンス
- [ ] 100件の単語で快適にスクロール
- [ ] 1000件でも遅延なく表示
- [ ] 10000件でメモリ使用量が適切

### ファイル監視
- [ ] CSV更新時に自動リロード
- [ ] 画面を離れると監視が停止
- [ ] 複数回の開閉でメモリリークしない

### エッジケース
- [ ] 空のCSV
- [ ] 破損したCSV
- [ ] 特殊文字を含む単語

## よくある編集パターン

### フィルタ機能の追加
```swift
@State private var selectedDifficulty: String? = nil

var filteredItems: [QuestionItem] {
    var result = items
    
    // 難易度フィルタ
    if let difficulty = selectedDifficulty {
        result = result.filter { $0.difficulty == difficulty }
    }
    
    // 検索フィルタ
    if !searchText.isEmpty {
        result = result.filter {
            $0.term.localizedCaseInsensitiveContains(searchText) ||
            $0.meaning.localizedCaseInsensitiveContains(searchText)
        }
    }
    
    return result
}
```

### ソート機能の追加
```swift
enum SortOrder {
    case term, difficulty, mastery
}

@State private var sortOrder: SortOrder = .term

var sortedItems: [QuestionItem] {
    switch sortOrder {
    case .term:
        return filteredItems.sorted { $0.term < $1.term }
    case .difficulty:
        return filteredItems.sorted { $0.difficulty < $1.difficulty }
    case .mastery:
        return filteredItems.sorted {
            wordScoreStore.score(for: $0.id).accuracy >
            wordScoreStore.score(for: $1.id).accuracy
        }
    }
}
```

## トラブルシューティング

### リストが空
- CSV読み込みの成功を確認
- `items` 配列が正しく更新されているか確認

### 自動リロードが動作しない
- FileWatcher の初期化を確認
- ファイルURLが正しいか確認
- 監視が停止されていないか確認

### スクロールが重い
- View の階層を浅くする
- LazyVStack の使用を検討
- 画像の遅延読み込みを実装

## 関連ドキュメント
- `.copilot/structure-map.md` - アーキテクチャ全体像
- `QuestionDetailView.swift` - 詳細画面の実装
- `FileWatcher.swift` - ファイル監視の実装
