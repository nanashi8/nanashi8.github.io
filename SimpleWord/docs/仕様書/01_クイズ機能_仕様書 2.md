# クイズ機能_仕様書（QuizView）

**最終更新: 2025-10-28**  
**ステータス**: ✅ 最新（実装と完全一致）

この文書は「クイズをはじめる」画面（QuizView）の完全な仕様書です。
機能喪失時に、この文書から完全に復元できます。

---

## ⚠️ 復元のための重要情報

### 復元時の参照順序
1. **この仕様書**（全体設計・UI・データフロー）
2. `12_クイズUIコンポーネント_仕様書.md`（UIコンポーネント詳細）
3. `02_出題設定_仕様書.md`（設定値の詳細）
4. 実装ファイル

### アーキテクチャの変更履歴
- **2025-10-28**: AdaptiveScheduler削除、シンプルなバッチ学習に変更
- **2025-10-25**: QuizSessionStoreによるセッション管理追加
- **2025-10-19**: QuizComponentsへのUI分離

---

## 概要

### 何を実現しているか
- **CSV問題の4択クイズ**: 選択したCSVから問題を出題
- **バッチ学習**: 一定数（バッチサイズ）ごとに区切って学習
- **セッション管理**: アプリを閉じても続きから再開可能
- **成績記録**: 単語別・CSV別に正答率を記録
- **視覚的フィードバック**: アニメーション効果で学習進捗を表示

### 基本的な学習フロー
```
CSV選択 → バッチ準備 → 問題出題 → 回答 → 次の問題
           ↑                              ↓
           └──────── バッチ完了 ←─────────┘
```

---

## 画面構成

### 全体レイアウト
```
┌────────────────────────────────────┐
│ ← クイズ                            │
├────────────────────────────────────┤
│ [統計表示エリア]                    │
│ CSV: 中学英単語.csv                 │
│ 学習モード: 通常                    │
│ 正答率: 85% ・ 合格数: 12/15 ✨     │
│ バッチサイズ: 10問                  │
├────────────────────────────────────┤
│ [ナビゲーションボタン]              │
│ [← 前へ]         [次へ →]          │
├────────────────────────────────────┤
│ [問題カード]                        │
│ ┌────────────────────────────┐    │
│ │ apple          [初級]      │    │
│ │ アップル                    │    │
│ │ 正答率: 75% ・ 過去3回      │    │
│ └────────────────────────────┘    │
├────────────────────────────────────┤
│ [選択肢カード] ×4                   │
│ ┌────────────────────────────┐    │
│ │ ① りんご                    │    │
│ └────────────────────────────┘    │
│ ┌────────────────────────────┐    │
│ │ ② バナナ                    │    │
│ └────────────────────────────┘    │
│ （回答後は詳細情報表示）            │
├────────────────────────────────────┤
│ [分からないボタン]                  │
│ ┌────────────────────────────┐    │
│ │ 分からない                  │    │
│ └────────────────────────────┘    │
└────────────────────────────────────┘
```

---

## データフロー

### 1. 初期化（loadCSVAndStart）

#### CSV読み込み優先順位
1. `currentCSV.name` で指定されたCSVを `QuestionItemRepository` から読み込み
2. Documents → Bundle の順で検索
3. 見つからなければエラー表示

#### フィルタリング
```swift
func applyFilters(to items: [QuestionItem]) -> [QuestionItem] {
    var result = items
    
    // 分野フィルタ
    if !quizSettings.fields.isEmpty {
        result = result.filter { item in
            !Set(item.relatedFields).isDisjoint(with: quizSettings.fields)
        }
    }
    
    // 難易度フィルタ
    if !quizSettings.difficulties.isEmpty {
        result = result.filter { item in
            quizSettings.difficulties.contains(item.difficulty)
        }
    }
    
    return result
}
```

#### 出題順序の決定
```swift
// ランダム出題が有効な場合
if quizSettings.isRandomOrder {
    order = items.shuffled().prefix(totalQuestions).map { $0 }
} else {
    order = Array(items.prefix(totalQuestions))
}
```

#### セッション管理
```swift
// 既存セッションがあれば復元
if sessionStore.canResumeSession(csvName: csvName) {
    print("セッションを復元")
} else {
    // 新規セッション開始
    sessionStore.startSession(
        csvName: csvName,
        batchSize: batchSize,
        totalQuestions: totalQuestions
    )
}
```

---

### 2. バッチ準備（prepareBatch）

#### バッチサイズ分の問題を取得
```swift
let batchItems = Array(order.prefix(sessionStore.batchSize))
```

#### 繰り返し回数の適用
```swift
var poolItems: [QuestionItem] = []
let repeatCount = max(1, quizSettings.repeatCount)

for item in batchItems {
    for _ in 0..<repeatCount {
        poolItems.append(item)
    }
}
```

#### ラウンドロビン配置（連続回避）
```swift
func roundRobinShuffle(items: [QuestionItem], pool: [QuestionItem]) -> [QuestionItem] {
    var result: [QuestionItem] = []
    var queues = [UUID: [QuestionItem]]()
    
    // 各単語のキューを作成
    for item in pool {
        queues[item.id, default: []].append(item)
    }
    
    // ラウンドロビンで取り出し
    var hasMore = true
    while hasMore {
        hasMore = false
        for item in items {
            if var queue = queues[item.id], !queue.isEmpty {
                result.append(queue.removeFirst())
                queues[item.id] = queue
                hasMore = true
            }
        }
    }
    
    return result
}
```

---

### 3. 問題出題（prepareQuestion）

#### 現在の問題を設定
```swift
currentItem = pool.removeFirst()
selectedChoiceID = nil
correctAnswerID = nil
```

#### 選択肢の生成
```swift
// 正解の選択肢
let correctChoice = Choice(
    id: UUID(),
    label: item.meaning,
    explanation: item.etymology,
    isCorrect: true,
    item: item
)
correctAnswerID = correctChoice.id

// 不正解の選択肢（他の単語から）
var incorrectChoices: [Choice] = []
let otherItems = items.filter { $0.id != item.id }.shuffled()

for otherItem in otherItems.prefix(max(0, numberOfChoices - 1)) {
    let choice = Choice(
        id: UUID(),
        label: otherItem.meaning,
        explanation: otherItem.etymology,
        isCorrect: false,
        item: otherItem
    )
    incorrectChoices.append(choice)
}

// シャッフル
choices = ([correctChoice] + incorrectChoices).shuffled()
```

#### 履歴に追加
```swift
if historyIndex >= 0 && historyIndex < history.count - 1 {
    history = Array(history.prefix(historyIndex + 1))
}
history.append(item.id)
historyIndex = history.count - 1
```

---

### 4. 回答処理（handleChoiceSelection）

#### 正誤判定
```swift
let wasCorrect = (id == correctAnswerID)
```

#### セッションストアに記録
```swift
sessionStore.recordAnswer(correct: wasCorrect)
```

#### アニメーション判定
```swift
if sessionStore.questionCount > oldQuestionCount {
    shouldAnimateTotalCount = true
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.2) {
        self.shouldAnimateTotalCount = false
    }
}

if sessionStore.batchCorrect > oldBatchCorrect {
    shouldAnimatePassedCount = true
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.2) {
        self.shouldAnimatePassedCount = false
    }
}
```

#### 単語スコア記録
```swift
wordScoreStore.recordResult(itemID: item.id, correct: wasCorrect)
```

#### 自動進行
```swift
if wasCorrect && autoAdvanceEnabled {
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
        goToNextQuestion()
    }
}
```

---

### 5. ナビゲーション

#### 次の問題へ
```swift
func goToNextQuestion() {
    prepareQuestion()
}
```

#### 前の問題へ
```swift
func goToPreviousQuestion() {
    guard historyIndex > 0 else { return }
    
    historyIndex -= 1
    let previousID = history[historyIndex]
    
    // 前の問題を再表示
    if let previousItem = items.first(where: { $0.id == previousID }) {
        currentItem = previousItem
        // 選択肢を再生成
        // ...
    }
}
```

---

### 6. バッチ完了（completeBatch）

```swift
func completeBatch() {
    sessionStore.completeBatch()
    
    if order.count > sessionStore.batchSize {
        // 次のバッチへ
        order = Array(order.dropFirst(sessionStore.batchSize))
        prepareBatch()
    } else {
        // 全問題完了
        saveResults()
        sessionStore.endSession()
        dismiss()
    }
}
```

---

## 状態管理

### QuizView内部の状態

```swift
// データ状態
@State private var items: [QuestionItem] = []       // 全問題（フィルタ済み）
@State private var order: [QuestionItem] = []       // 出題順序
@State private var pool: [QuestionItem] = []        // 現在バッチのプール
@State private var currentItem: QuestionItem? = nil // 現在の問題

// UI状態
@State private var choices: [Choice] = []           // 選択肢
@State private var selectedChoiceID: UUID? = nil
@State private var correctAnswerID: UUID? = nil
@State private var dontKnowID: UUID = UUID()

// アニメーション状態
@State private var shouldAnimatePassedCount: Bool = false
@State private var shouldAnimateTotalCount: Bool = false

// ローディング・エラー状態
@State private var isLoading: Bool = true
@State private var errorMessage: String? = nil

// 学習履歴（戻る機能用）
@State private var history: [UUID] = []
@State private var historyIndex: Int = -1

// CSVヘッダ表示用
@State private var csvHeaderLabels: [String: String] = [:]
```

### 環境オブジェクト

```swift
@EnvironmentObject var wordScoreStore: WordScoreStore
@EnvironmentObject var currentCSV: CurrentCSV
@EnvironmentObject var quizSettings: QuizSettings
@EnvironmentObject var scoreStore: ScoreStore
@StateObject private var sessionStore = QuizSessionStore.shared
```

---

## UIコンポーネント

### Choice構造体
```swift
struct Choice: Identifiable {
    let id: UUID
    let label: String           // 選択肢テキスト（meaning）
    let explanation: String?    // 解説（etymology）
    let isCorrect: Bool         // 正解フラグ
    let item: QuestionItem?     // 詳細情報表示用
}
```

### 使用するコンポーネント（詳細は12_クイズUIコンポーネント_仕様書.md参照）
- **QuizStatisticsView**: 統計情報表示
- **QuizNavigationButtonsView**: ナビゲーションボタン
- **QuestionCardView**: 問題カード
- **ChoiceCardView**: 選択肢カード
- **DontKnowCardView**: 分からないボタン

---

## 設定値の取得

### QuizSettingsから取得する値
```swift
// 学習モード
private var learningModeDisplayName: String {
    quizSettings.model.learningMode.displayName
}

// 自動進行
private var autoAdvanceEnabled: Bool {
    quizSettings.model.autoAdvance
}

// 選択肢数
private var configuredNumberOfChoices: Int {
    quizSettings.numberOfChoices
}

// バッチサイズ
private var configuredQuestionsPerBatch: Int {
    quizSettings.questionsPerBatch
}
```

---

## エラーハンドリング

### エラー表示
```swift
if let error = errorMessage {
    errorView(error)
}
```

### エラーメッセージの例
- "CSVファイルが選択されていません。"
- "CSVファイル 'xxx.csv' が見つからないか、読み込みに失敗しました。"
- "フィルタ条件に一致する問題がありません。\n出題設定を確認してください。"

---

## 成績保存

### QuizResultの作成
```swift
private func saveResults() {
    guard currentCSV.name != nil else { return }
    
    let result = QuizResult(
        total: sessionStore.questionCount,
        correct: sessionStore.score,
        settings: quizSettings.model
    )
    scoreStore.addResult(result)
}
```

---

## CSVヘッダマッピング

### ヘッダラベルマップの生成
```swift
private func buildHeaderLabelMap(_ headerCols: [String]) -> [String: String] {
    var map: [String: String] = [:]
    
    for (_, raw) in headerCols.enumerated() {
        let trimmed = raw.trimmingCharacters(in: .whitespacesAndNewlines)
        let key = normalize(trimmed)
        
        // 各列の判定（詳細は省略）
        if key.contains("年号") {
            map["term"] = trimmed
        } else if key.contains("登場人物") {
            map["reading"] = trimmed
        }
        // ...
    }
    
    return map
}
```

### 正規化関数
```swift
func normalize(_ s: String) -> String {
    var t = s.trimmingCharacters(in: .whitespacesAndNewlines).lowercased()
    let remove = CharacterSet(charactersIn: "()（）\"' 　,、・")
    t = t.components(separatedBy: remove).joined()
    return t
}
```

---

## ファイル構成

### 主要ファイル
```
SimpleWord/Features/Quiz/Views/
└── QuizView.swift (約600行)
```

### 依存ファイル
```
QuizComponents/
├── QuestionCardView.swift
├── ChoiceCardView.swift
├── DontKnowCardView.swift
├── QuizStatisticsView.swift
└── QuizNavigationButtonsView.swift

Stores/
├── QuizSettings.swift
├── QuizSessionStore.swift
├── ScoreStore.swift
├── WordScoreStore.swift
└── CurrentCSV.swift

Common/Data/
├── Repository/QuestionItemRepository.swift
└── Model/QuestionItem.swift
```

---

## テスト項目

### 基本機能
- [ ] CSV読み込み（Documents / Bundle）
- [ ] フィルタリング（分野・難易度）
- [ ] 問題表示（term, reading, difficulty）
- [ ] 選択肢生成（4択）
- [ ] 正誤判定
- [ ] 成績記録（WordScoreStore）

### セッション管理
- [ ] セッション開始
- [ ] セッション復元（アプリ再起動後）
- [ ] セッション終了

### バッチ学習
- [ ] バッチ準備（ラウンドロビン）
- [ ] バッチ完了判定
- [ ] 次のバッチへ進む

### ナビゲーション
- [ ] 次へボタン（回答後のみ有効）
- [ ] 前へボタン（履歴参照）

### アニメーション
- [ ] 合格数増加時のアニメーション
- [ ] 総出題数増加時のアニメーション

### 自動進行
- [ ] 正解時の自動進行（設定が有効な場合）
- [ ] 不正解時は自動進行しない

---

## 復元手順

機能喪失時の復元手順：

### ステップ1: データフローの理解
1. この仕様書の「データフロー」セクションを読む
2. 各処理の入出力を理解

### ステップ2: UIコンポーネントの復元
1. `12_クイズUIコンポーネント_仕様書.md` を参照
2. QuizComponents/ 配下のファイルを復元

### ステップ3: QuizView本体の復元
1. 状態変数を定義
2. データフローに従って各関数を実装
3. UIコンポーネントを配置

### ステップ4: テスト
1. テスト項目を順次実行
2. エラーを修正

---

**最終更新**: 2025年10月28日  
**復元可能性**: ★★★★★（完全復元可能）
