# クイズ機能（4択・適応型学習・アニメーション）

**最終更新: 2025-10-25**

この文書は「クイズをはじめる」画面（4択クイズ）の編集・実装ガイドです。

## ⚠️ 重要: 現在の状態

このドキュメントは、機能喪失時の復元に必要なすべての情報を含んでいます。
実装とこの仕様書に齟齬がある場合は、実装を正として仕様書を更新してください。

## 概要

### 何を実現しているか
- CSV（単語リスト）から問題を作成し、4択で回答
- ユーザーの習熟度に応じた適応型出題（AdaptiveScheduler）
- 正解・不正解を単語別・CSV別に記録
- 視覚的フィードバック（合格数・総出題数の光るエフェクト）
- バッチ学習（一定の成功率で次のバッチへ進む）

### 最近の主要な更新（2025-10-19）
- ✅ 合格数と総出題数の変化時に光るアニメーション効果を追加
- ✅ 問題カード、選択肢カード、分からないカードを明確に分離
- ✅ 回答後の解説を展開不要で表示（語源を常時表示）
- ✅ CSV名の右側に学習モードを表示
- ✅ バッチ個数の表示を削除

## 画面構成

### 統計表示エリア
```
[CSV名: 中学英単語.csv] [学習モード: 標準]
[正答率: 85%] [合格数: 12 ✨] [総出題: 15 ✨] [バッチサイズ: 10]
```
- 合格数・総出題数: 値が増加すると1.2秒間光る（スプリングアニメーション）
  - 合格数: 緑色で1.2倍に拡大
  - 総出題数: オレンジ色で1.2倍に拡大

### ナビゲーションボタン
```
[← 前へ] [次へ →]
```
- 前へ: 直前の問題に戻る（再挑戦可能）
- 次へ: 回答後のみ有効

### 問題カード（独立表示）
```
┌─────────────────────┐
│ 語句: example       │
│ 読み: イグザンプル   │
│ 正答率: 75% (3回)   │
│ 難易度: [中級]      │
└─────────────────────┘
```

### 選択肢カード（独立セクション）
```
選択肢
┌─────────────────────┐
│ ① 例、見本          │
│    (回答後: 語句と解説表示) │
├─────────────────────┤
│ ② 練習             │
├─────────────────────┤
│ ③ 試験             │
├─────────────────────┤
│ ④ 宿題             │
└─────────────────────┘
```

### 分からないカード（独立セクション）
```
その他
┌─────────────────────┐
│ 分からない          │
└─────────────────────┘
```

## 関係するファイル

### 主要ファイル
- **QuizView.swift** (1100行) - クイズ画面本体
  - 内部コンポーネント:
    - `Choice` - 選択肢データ構造
    - `ChoiceView` - 選択肢カード
    - `DontKnowView` - 分からないカード
    - `questionHeaderCard` - 問題ヘッダ
    - `questionDisplayView` - 問題表示全体
    - `choicesListView` - 選択肢リスト
    - `dontKnowCardView` - 分からないカード

### データモデル
- **QuestionItem.swift** - 問題データ（CSV 1行 = 1問）
- **QuizSettings.swift** - 出題設定（@EnvironmentObject）
- **ScoreStore.swift** - CSV別の成績
- **WordScoreStore.swift** - 単語別の成績
- **CurrentCSV.swift** - 現在選択中のCSV名

### ビジネスロジック
- **CSVLoader.swift** - CSV読み込み
- **AdaptiveScheduler.swift** - 適応型学習スケジューリング
- **FileStudyProgressRepository.swift** - 学習進捗の永続化

### UIコンポーネント
- **StyleGuide.swift** - SectionCard, DifficultyBadge, TagCapsule

## 状態管理

### データ状態
```swift
@State private var items: [QuestionItem] = []           // 全問題
@State private var order: [QuestionItem] = []           // 出題順序
@State private var pool: [QuestionItem] = []            // 現在バッチ
@State private var currentItem: QuestionItem? = nil     // 現在の問題
```

### UI状態
```swift
@State private var choices: [Choice] = []               // 選択肢
@State private var selectedID: UUID? = nil              // 選択された選択肢
@State private var correctAnswerID: UUID? = nil         // 正解ID
@State private var expandedIDs: Set<UUID> = []          // 展開された解説
```

### スコア・バッチ管理
```swift
@State private var score: Int = 0                       // 累積正解数
@State private var questionCount: Int = 0               // 累積出題数
@State private var batchCorrect: Int = 0                // 現在バッチの正解数
@State private var batchSize: Int = 10                  // バッチサイズ
```

### アニメーション状態
```swift
@State private var shouldAnimatePassedCount: Bool = false   // 合格数アニメ
@State private var shouldAnimateTotalCount: Bool = false    // 総出題数アニメ
```

## 主要な処理フロー

### 1. 初期化（loadCSVAndStart）
```
CSV読み込み（Documents → Bundle）
  ↓
フィルタリング（分野・難易度）
  ↓
出題数・順序の決定
  ↓
prepareBatch()
```

### 2. バッチ準備（prepareBatch）
```
AdaptiveScheduler で優先度順に選択
  ↓
補修モード判定（低正答率が一定割合以上）
  ↓
ローテーション（高習熟度 ⇄ 低出題回数）
  ↓
繰り返し回数計算（個別最適化）
  ↓
プール作成（ラウンドロビン配置）
  ↓
prepareQuestion()
```

### 3. 回答処理（select）
```
値変更前の状態を保存
  ↓
questionCount++, 正解ならscore++, batchCorrect++
  ↓
アニメーション判定：
  - questionCount増加 → 総出題数が光る（オレンジ）
  - batchCorrect増加 → 合格数が光る（緑）
  ↓
WordScoreStoreに記録
  ↓
AdaptiveSchedulerに記録（応答時間込み）
  ↓
自動進行（正解 & 設定ON の場合）
```

## 編集時の注意点

### アニメーション機能の編集
**実装箇所**: `select()` 関数、`giveUp()` 関数

```swift
// 値変更前に保存
let oldQuestionCount = questionCount
let oldBatchCorrect = batchCorrect

// 値を更新
questionCount += 1
if wasCorrect { batchCorrect += 1 }

// アニメーション判定
if questionCount > oldQuestionCount {
    shouldAnimateTotalCount = true
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.2) {
        self.shouldAnimateTotalCount = false
    }
}
```

**チェックポイント**:
- [ ] 値の変更前に旧値を保存している
- [ ] アニメーションのタイミングが適切（1.2秒）
- [ ] メインスレッドで実行されている

### カード分離の編集
**実装箇所**: `questionDisplayView`

```swift
// 問題カードを独立して表示
questionHeaderCard(for: item)

// 選択肢カードを独立したセクションとして表示
VStack(alignment: .leading, spacing: 4) {
    Text("選択肢").font(.caption)
    choicesListView
}

// 分からないカードを独立して表示
VStack(alignment: .leading, spacing: 4) {
    Text("その他").font(.caption)
    dontKnowCardView
}
```

**チェックポイント**:
- [ ] 各カードが視覚的に分離されている
- [ ] セクションラベルが表示されている
- [ ] タップ領域が適切に設定されている

### 解説表示の編集
**実装箇所**: `ChoiceView` 内

```swift
// 語源は常に全文表示（展開不要）
if !explainItem.etymology.isEmpty {
    Text(explainItem.etymology)
        .font(.caption)
        .foregroundColor(textColorFaint)
        .lineLimit(nil)  // 重要: 無制限に表示
}
```

**チェックポイント**:
- [ ] 語源が常に表示される
- [ ] 関連語は「もっと見る」で展開
- [ ] テキスト色が背景に対してコントラスト適切

## テスト観点

### 基本動作
- [ ] CSV読み込みが成功する
- [ ] 4択が正しく生成される
- [ ] 正誤判定が正確
- [ ] スコアが正しく記録される

### アニメーション
- [ ] 正解時に合格数が光る（緑）
- [ ] 毎回答時に総出題数が光る（オレンジ）
- [ ] アニメーション時間が1.2秒
- [ ] 連続回答でもアニメーションが動作する

### UI/UX
- [ ] 問題カード・選択肢・分からないが明確に分離
- [ ] 回答後に語句・読み・語源が即座に見える
- [ ] 「もっと見る」で関連語が展開される
- [ ] ダークモード・ライトモードで正常表示

### エッジケース
- [ ] CSV空の場合のエラー処理
- [ ] 1問のみの場合
- [ ] 大量問題（1000問以上）でのパフォーマンス
- [ ] 前へボタンで正しく戻れる

## トラブルシューティング

### アニメーションが動作しない
→ `.copilot/prompts/fix-bug.md` のアニメーション実例を参照
→ `shouldAnimate` フラグが正しくトグルされているか確認

### カードのタップが反応しない
→ `.contentShape(Rectangle())` が設定されているか確認
→ `.onTapGesture` の位置を確認

### 解説が表示されない
→ `answered` フラグが true になっているか確認
→ `explainItem` の取得ロジックを確認

## 関連ドキュメント
- `.copilot/structure-map.md` - アーキテクチャ全体像
- `.copilot/components/QuizStatisticsView.md` - 統計表示の分割仕様
- `.copilot/components/ChoiceCardView.md` - 選択肢カードの分割仕様
- `09_出題ロジック_仕様書.md` - 適応型学習の詳細
