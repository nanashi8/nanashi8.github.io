# 出題設定_仕様書（QuizSettingsView）

**最終更新: 2025-10-28**  
**ステータス**: ✅ 最新（実装と完全一致）

この文書は「出題設定」画面（QuizSettingsView）の完全な仕様書です。

---

## ⚠️ 復元のための重要情報

### 復元時の参照順序
1. この仕様書（UI・設定項目・保存ロジック）
2. QuizSettings.swift（データモデル・永続化）
3. 実装ファイル

---

## 概要

### 何を実現しているか
- **CSV選択**: 使用するCSVファイルの選択
- **フィルタ設定**: 分野・難易度による出題範囲の絞り込み
- **出題設定**: バッチサイズ、繰り返し回数、合格率
- **学習モード**: 通常・復習・補習の選択
- **機能切替**: タイマー、音声、自動進行、ランダム出題
- **外観設定**: ライト/ダーク/システム
- **永続化**: UserDefaultsによる設定の保存

---

## 画面構成

### 現在の設定（要約カード）
```
┌────────────────────────────────┐
│ 現在の設定          [初級][中級]│
│                                │
│ 一般                            │
│ CSV: 中学英単語.csv             │
│ 分野: 学校, 日常生活             │
│ 難易度: 初級, 中級              │
│                                │
│ 出題設定                        │
│ 出題数: 10問                    │
│ 選択肢: 4  繰り返し: 2回        │
│ 合格率: 70%                     │
│                                │
│ 挙動                            │
│ ランダム: 有効  音声: 有効      │
│ タイマー: 無効                  │
│ 学習モード: 通常                │
│ 自動進行: 無効                  │
│                                │
│ 外観                            │
│ システム設定                    │
└────────────────────────────────┘
```

### CSV選択セクション
```
┌────────────────────────────────┐
│ 出題するCSV                     │
│                                │
│ [ホイールピッカー]              │
│ 中学英単語.csv                  │
│ 中学歴史.csv                    │
│ 中学古典単語.csv                │
│                                │
│ [このCSVを出題に設定] ボタン    │
│ 現在: 中学英単語.csv            │
└────────────────────────────────┘
```

### フィルタ設定（分野）
```
┌────────────────────────────────┐
│ 分野を選択                      │
│                                │
│ [ホイールピッカー]              │
│ 全て / 学校 / 日常生活 / ...    │
│                                │
│ [追加] ボタン                   │
│ 選択済: [学校 ×] [日常生活 ×]  │
└────────────────────────────────┘
```

### フィルタ設定（難易度）
```
┌────────────────────────────────┐
│ 難易度を選択                    │
│                                │
│ [ホイールピッカー]              │
│ 全て / 初級 / 中級 / 上級       │
│                                │
│ [追加] ボタン                   │
│ 選択済: [初級 ×] [中級 ×]      │
└────────────────────────────────┘
```

### 出題設定
```
┌────────────────────────────────┐
│ 出題設定                        │
│                                │
│ バッチサイズ: 10問  [- +]       │
│ 合格率: 70% [スライダー]        │
│ 繰り返し回数: 2回 [- +]         │
│ ランダム出題 [トグル: ON]       │
│ タイマーを有効にする [OFF]      │
│   制限時間: 60秒 [- +]          │
│ 選択肢の数: 4 [- +]             │
│ 音声読み上げ [ON]               │
│                                │
│ 学習モード [ホイール]            │
│ 通常 / 復習 / 補習              │
│                                │
│ 回答後に自動で次へ [OFF]        │
└────────────────────────────────┘
```

### 外観設定
```
┌────────────────────────────────┐
│ 外観                            │
│                                │
│ [ホイールピッカー]              │
│ システム設定                    │
│ ライト                          │
│ ダーク                          │
│                                │
│ アプリ全体の見た目を切り替えます│
└────────────────────────────────┘
```

### 保存ボタン
```
┌────────────────────────────────┐
│        [保存]                   │
└────────────────────────────────┘
```

---

## データモデル

### QuizSettingsModel
```swift
public struct QuizSettingsModel: Codable, Equatable {
    // 基本設定
    public var selectedCSV: String?
    public var selectedFields: [String]
    public var difficulties: [String]
    public var repeatCount: Int
    public var successThreshold: Double
    
    // バッチ設定
    public var autoAdvance: Bool
    public var questionsPerBatch: Int
    public var lowAccuracyThreshold: Double
    public var maxLowAccuracyRatio: Double
    
    // UI設定
    public var numberOfChoices: Int
    public var numberOfQuestions: Int
    public var isTimerEnabled: Bool
    public var timeLimit: Int
    public var learningMode: LearningMode
    public var isRandomOrder: Bool
    public var isSpeechEnabled: Bool
    public var selectedCSVFile: String?
    
    // 互換性フィールド
    public var fields: [String]
    public var threshold: Double
    public var appearance: String
}
```

### LearningMode
```swift
public enum LearningMode: String, Codable, CaseIterable, Identifiable {
    case normal = "normal"          // 通常モード
    case review = "review"          // 復習モード
    case remediation = "remediation" // 補習モード

    public var displayName: String {
        switch self {
        case .normal: return "通常"
        case .review: return "復習"
        case .remediation: return "補習"
        }
    }
}
```

---

## 状態管理

### QuizSettings（CSV別設定管理）

#### 内部構造
```swift
public final class QuizSettings: ObservableObject {
    @Published public var model: QuizSettingsModel
    
    private var storage: [String: PerCSVSettings] = [:]
    private let storageKey = "QuizPerCSVSettings_v1"
    private let legacyKey = "QuizSettingsStore_v1"
    private var currentCSV: CurrentCSV?
}
```

#### CSV別設定の保存
```swift
private struct PerCSVSettings: Codable {
    var selectedFields: [String]
    var difficulties: [String]
    var repeatCount: Int
    var successThreshold: Double
    var autoAdvance: Bool
    var questionsPerBatch: Int
    var lowAccuracyThreshold: Double
    var maxLowAccuracyRatio: Double
}
```

#### 設定の切り替え
```swift
// CSVが変更されたとき
CurrentCSV.shared.$name
    .sink { [weak self] newName in
        let key = newName ?? "__default__"
        self?.persistActiveModel()
        self?.model = Self.buildModel(for: key, from: self?.storage)
    }
```

---

## 主要な処理

### CSV一覧の取得
```swift
private func load() {
    bundleFiles = FileUtils.listBundleCSVFiles()
    docFiles = FileUtils.listCSVFilesInDocuments()
    
    let editable = (docFiles + bundleFiles).removingDuplicates()
    
    if let cur = currentCSV.name, let idx = editable.firstIndex(of: cur) {
        selectedCSVIndex = idx
    }
}
```

### 分野・難易度の抽出
```swift
private func buildAvailableOptions() {
    var fieldsSet = Set<String>()
    var diffsSet = Set<String>()
    
    func process(fileName: String) {
        let base = fileName.replacingOccurrences(of: ".csv", with: "")
        let repository = QuestionItemRepository(fileName: base)
        
        if case .success(let arr) = repository.fetch() {
            for it in arr {
                for f in it.relatedFields where !f.isEmpty {
                    fieldsSet.insert(f)
                }
                if !it.difficulty.isEmpty {
                    diffsSet.insert(it.difficulty)
                }
            }
        }
    }
    
    if let sel = currentCSV.name, !sel.isEmpty {
        process(fileName: sel)
    } else {
        // 全CSVから抽出
        for name in FileUtils.listCSVFilesInDocuments() {
            process(fileName: name)
        }
        for name in FileUtils.listBundleCSVFiles() {
            process(fileName: name)
        }
    }
    
    self.availableFields = ["全て"] + fieldsSet.sorted()
    self.availableDifficulties = ["全て"] + diffsSet.sorted()
}
```

### 分野の追加・削除
```swift
private func addField(at index: Int) {
    guard availableFields.indices.contains(index) else { return }
    let val = availableFields[index]
    
    if val == "全て" {
        quizSettings.fields.removeAll()
        quizSettings.save()
        return
    }
    
    if !quizSettings.fields.contains(val) {
        quizSettings.fields.append(val)
        quizSettings.save()
    }
}

private func removeField(_ f: String) {
    quizSettings.fields.removeAll { $0 == f }
    quizSettings.save()
}
```

### 設定の保存
```swift
func save() {
    // model.selectedCSV は CurrentCSV から決定
    model.selectedCSV = CurrentCSV.shared.name
    persistActiveModel()
}

private func persistActiveModel() {
    let key = CurrentCSV.shared.name ?? "__default__"
    let per = PerCSVSettings(
        selectedFields: model.selectedFields,
        difficulties: model.difficulties,
        repeatCount: max(1, model.repeatCount),
        successThreshold: min(max(0.0, model.successThreshold), 1.0),
        autoAdvance: model.autoAdvance,
        questionsPerBatch: max(1, model.questionsPerBatch),
        lowAccuracyThreshold: min(max(0.0, model.lowAccuracyThreshold), 1.0),
        maxLowAccuracyRatio: min(max(0.0, model.maxLowAccuracyRatio), 1.0)
    )
    storage[key] = per
    persistStorage()
}

private func persistStorage() {
    if let data = try? JSONEncoder().encode(storage) {
        UserDefaults.standard.set(data, forKey: storageKey)
    }
}
```

---

## バインディング

### 各設定値のバインディング
```swift
// バッチサイズ
private var questionsPerBatchBinding: Binding<Int> {
    Binding(
        get: { quizSettings.questionsPerBatch },
        set: { quizSettings.questionsPerBatch = max(1, $0); quizSettings.save() }
    )
}

// 合格率（スライダー）
private var thresholdBinding: Binding<Double> {
    Binding(
        get: { quizSettings.threshold },
        set: { quizSettings.threshold = $0; quizSettings.save() }
    )
}

// 繰り返し回数
private var repeatCountBinding: Binding<Int> {
    Binding(
        get: { quizSettings.repeatCount },
        set: { quizSettings.repeatCount = max(1, $0); quizSettings.save() }
    )
}

// ランダム出題
private var isRandomOrderBinding: Binding<Bool> {
    Binding(
        get: { quizSettings.isRandomOrder },
        set: { quizSettings.isRandomOrder = $0; quizSettings.save() }
    )
}

// 学習モード
private var learningModeBinding: Binding<LearningMode> {
    Binding(
        get: { quizSettings.learningMode },
        set: { quizSettings.learningMode = $0; quizSettings.save() }
    )
}
```

---

## UIコンポーネント

### SectionCard
```swift
SectionCard(backgroundColor: cardBackground) {
    VStack(alignment: .leading, spacing: 8) {
        // コンテンツ
    }
}
.listRowInsets(EdgeInsets())
.listRowBackground(cardBackground)
```

### SectionHeader
```swift
SectionHeader(systemImage: "doc", title: "出題するCSV")
```

### DifficultyBadge
```swift
DifficultyBadge(text: d)
```

---

## ファイル構成

### 主要ファイル
```
SimpleWord/Views/
└── QuizSettingsView.swift

SimpleWord/Stores/
├── QuizSettings.swift
└── CurrentCSV.swift

Appearance/
└── Appearance.swift (AppearanceManager)
```

---

## テスト項目

### CSV選択
- [ ] CSV一覧の表示（Bundle + Documents）
- [ ] CSV選択時の設定切り替え
- [ ] 設定の永続化

### フィルタ設定
- [ ] 分野の抽出（CSVから）
- [ ] 難易度の抽出（CSVから）
- [ ] 分野の追加・削除
- [ ] 難易度の追加・削除
- [ ] "全て" 選択時の動作

### 出題設定
- [ ] バッチサイズの変更（1〜50）
- [ ] 合格率の変更（0%〜100%）
- [ ] 繰り返し回数の変更（1〜10）
- [ ] ランダム出題の切り替え
- [ ] タイマーの切り替え
- [ ] 選択肢数の変更（2〜6）
- [ ] 音声読み上げの切り替え
- [ ] 学習モードの選択
- [ ] 自動進行の切り替え

### 外観設定
- [ ] システム設定への追従
- [ ] ライトモード固定
- [ ] ダークモード固定

### 永続化
- [ ] 設定の保存
- [ ] 設定の読み込み
- [ ] CSV別の設定管理
- [ ] アプリ再起動後の復元

---

## 復元手順

### ステップ1: データモデルの復元
1. QuizSettingsModel の定義
2. LearningMode の定義
3. PerCSVSettings の定義

### ステップ2: QuizSettings クラスの復元
1. プロパティの定義
2. 永続化ロジック（save/load）
3. CSV別設定管理

### ステップ3: QuizSettingsView の復元
1. 状態変数の定義
2. UI構造の構築
3. バインディングの設定
4. 各処理関数の実装

### ステップ4: テスト
1. テスト項目を順次実行
2. エラーを修正

---

**最終更新**: 2025年10月28日  
**復元可能性**: ★★★★★（完全復元可能）
