# 出題設定（CSV・分野・難易度・学習モード）

**最終更新: 2025-10-19**

この文書は、「出題設定」画面の編集・実装ガイドです。

## 概要

### 何を実現しているか
- 使用するCSVの選択
- 出題する分野・難易度のフィルタリング
- 出題数、バッチサイズ、合格率の設定
- 学習モード（標準・集中・復習）の選択
- タイマー、音声読み上げ、自動進行などの機能切替
- 設定の永続化（再起動後も保持）

### 最近の主要な更新（2025-10-19）
- ✅ 学習モードがクイズ画面に表示されるように連携
- ✅ 設定項目の整理と UI 改善

## 画面構成

### CSV選択セクション
```
┌─────────────────────┐
│ CSV: 中学英単語.csv  │
│ [変更]              │
└─────────────────────┘
```

### 分野・難易度選択
```
分野
[ホイールピッカー]
[追加] ボタン
選択中: [数学] [理科] ...

難易度
[ホイールピッカー]
[追加] ボタン
選択中: [中級] [上級] ...
```

### 出題設定
```
出題数: [50] 問
バッチサイズ: [10] 問
合格率: [80] %
繰り返し回数: [2] 回
```

### 学習モード
```
○ 標準モード
○ 集中モード（苦手を重点的に）
○ 復習モード（習熟度順）
```

### 機能切替
```
☑ ランダム出題
☑ タイマー有効 (制限時間: 30秒)
☐ 音声読み上げ
☑ 正解時に自動で次へ
```

### 外観設定
```
外観: [システム設定] [ライト] [ダーク]
```

## 関係するファイル

### 画面
- **QuizSettingsView.swift** - 設定画面本体

### ストア（状態管理）
- **QuizSettings.swift** - 設定値の保持・永続化
  - `QuizSettingsModel` - 設定データモデル
  - `LearningMode` - 学習モード（standard/focus/review）
  - `save()` / `load()` - UserDefaults への保存・読み込み
- **CurrentCSV.swift** - 現在選択中のCSV名
- **AppearanceManager.swift** - 外観設定

### ユーティリティ
- **CSVLoader.swift** - CSV読み込み（分野・難易度の抽出）
- **FileUtils.swift** - ファイル一覧取得

### UIコンポーネント
- **StyleGuide.swift** - SectionCard, SectionHeader

## 状態管理

### 主要なプロパティ（QuizSettings）
```swift
// CSV選択
@Published var selectedCSV: String?

// フィルタ
@Published var fields: [String] = []
@Published var difficulties: [String] = []

// 出題設定
@Published var numberOfQuestions: Int = 50
@Published var questionsPerBatch: Int = 10
@Published var threshold: Double = 0.8
@Published var repeatCount: Int = 2

// 学習モード
@Published var learningMode: LearningMode = .standard

// 機能切替
@Published var isRandomOrder: Bool = true
@Published var isTimerEnabled: Bool = true
@Published var timeLimit: Int = 30
@Published var isSpeechEnabled: Bool = false

// 自動進行
var model: QuizSettingsModel {
    get { ... }
    set { ... }
}
```

### 永続化
```swift
func save() {
    let encoder = JSONEncoder()
    if let data = try? encoder.encode(model) {
        UserDefaults.standard.set(data, forKey: "QuizSettings")
    }
}

func load() {
    guard let data = UserDefaults.standard.data(forKey: "QuizSettings") else { return }
    let decoder = JSONDecoder()
    if let loaded = try? decoder.decode(QuizSettingsModel.self, from: data) {
        // 各プロパティに反映
    }
}
```

## 編集時の注意点

### CSV一覧の取得
**実装箇所**: `onAppear`

```swift
// Documents と Bundle の両方から取得
var allCSVs: [String] = []
allCSVs.append(contentsOf: FileUtils.listCSVFilesInDocuments())
allCSVs.append(contentsOf: FileUtils.listBundleCSVFiles())
```

**チェックポイント**:
- [ ] Documents が優先される
- [ ] 重複を除外している
- [ ] 空の場合のエラー処理

### 分野・難易度の抽出
**実装箇所**: CSV読み込み後

```swift
// CSV から一意な分野・難易度を抽出
let uniqueFields = Set(items.flatMap { $0.relatedFields })
let uniqueDifficulties = Set(items.map { $0.difficulty })
```

**チェックポイント**:
- [ ] 空文字を除外
- [ ] 重複を排除
- [ ] ソートが適切

### 設定変更の反映
**実装箇所**: 保存ボタン

```swift
Button("保存") {
    quizSettings.save()
    // QuizView で自動的に反映される（@EnvironmentObject）
}
```

**チェックポイント**:
- [ ] save() が呼ばれる
- [ ] 他の画面に即座に反映
- [ ] 再起動後も保持

### 学習モードの連携
**QuizView での表示**:
```swift
Text(learningModeStatus)
    .font(.caption)
    .foregroundColor(.blue)

private var learningModeStatus: String { 
    quizSettings.learningMode.displayName 
}
```

**チェックポイント**:
- [ ] 学習モードが QuizView に表示される
- [ ] displayName が正しく取得される
- [ ] モード変更が即座に反映

## テスト観点

### 基本動作
- [ ] CSV選択が動作する
- [ ] 分野・難易度の追加・削除が動作する
- [ ] 出題数の変更が反映される
- [ ] 保存・読み込みが正常に動作する

### データの永続化
- [ ] 設定を変更して保存
- [ ] アプリを再起動
- [ ] 設定が保持されている

### QuizView との連携
- [ ] 設定変更がクイズに反映される
- [ ] 学習モードがクイズ画面に表示される
- [ ] タイマーの ON/OFF が動作に影響する

### エッジケース
- [ ] CSVが1つもない場合のエラー処理
- [ ] 不正な値（負の数など）の入力制限
- [ ] 極端に大きい値（出題数10000など）の処理

## よくある編集パターン

### 新しい設定項目を追加
1. `QuizSettingsModel` に新しいプロパティを追加
2. `QuizSettings` に `@Published` プロパティを追加
3. `save()` / `load()` メソッドを更新
4. UI に入力フィールドを追加

### 学習モードを追加
1. `LearningMode` enum にケースを追加
2. `displayName` を追加
3. QuizView の出題ロジックに分岐を追加

### デフォルト値の変更
```swift
// QuizSettings.swift
@Published var numberOfQuestions: Int = 50  // ← ここを変更
```

## トラブルシューティング

### 設定が保存されない
- `UserDefaults.standard.synchronize()` を呼ぶ
- Codable プロトコルの実装を確認

### CSV一覧が表示されない
- FileUtils のパス取得ロジックを確認
- Bundle リソースが正しく含まれているか確認

### 学習モードが反映されない
- `@EnvironmentObject` の注入を確認
- QuizView の参照を確認

## 関連ドキュメント
- `.copilot/structure-map.md` - アーキテクチャ全体像
- `01_クイズ機能_仕様書.md` - クイズ画面との連携
- `09_出題ロジック_仕様書.md` - 学習モードの詳細
