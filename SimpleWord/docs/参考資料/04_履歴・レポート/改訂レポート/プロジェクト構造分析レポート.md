# プロジェクト構造分析レポート

作成日: 2025年10月28日  
分析対象: SimpleWord v1.13.0

## 📊 Executive Summary

### 主要な発見
- **最大ファイル行数**: 696行（QuizView.swift）
- **基準超過ファイル数**: 4ファイル
- **分割検討ファイル数**: 4ファイル
- **推定リファクタリング工数**: 4週間

### 健全性スコア
| 項目 | スコア | 状態 |
|------|--------|------|
| ファイルサイズ | 45/100 | 🔴 要改善 |
| 責務分離 | 60/100 | 🟠 注意 |
| アーキテクチャ一貫性 | 75/100 | 🟡 良好 |
| 総合評価 | **60/100** | 🟠 改善推奨 |

---

## 📂 現在のディレクトリ構造

```
SimpleWord/
├── Features/
│   ├── Quiz/
│   │   ├── Views/
│   │   │   ├── QuizView.swift (696行) ⚠️⚠️⚠️
│   │   │   ├── LearningModeRecommendationView.swift (166行)
│   │   │   ├── QuizResultsDetailView.swift (144行)
│   │   │   ├── QuizResultsByCSVView.swift (113行)
│   │   │   └── FlowLayout.swift (88行)
│   │   └── WordManagement/
│   └── Study/
├── Views/
│   ├── QuizSettingsView.swift (553行) ⚠️⚠️⚠️
│   ├── NavigatorView.swift (193行)
│   ├── ContentView.swift (176行)
│   ├── CSVManagerView.swift (174行)
│   ├── CSVItemListEditorView.swift (168行)
│   ├── WordScoresView.swift (164行)
│   ├── FilterEditorView.swift (156行)
│   ├── IDMapAdminView.swift (149行)
│   ├── QuestionDetailView.swift (95行)
│   ├── CSVItemEditView.swift (80行)
│   ├── CSVEditorView.swift (79行)
│   └── Components/
│       └── StyleGuide.swift (96行)
├── QuizComponents/
│   ├── ChoiceCardView.swift (514行) ⚠️⚠️⚠️
│   ├── QuestionCardView.swift (144行)
│   ├── QuizStatisticsView.swift (103行)
│   └── DontKnowCardView.swift (90行)
├── Stores/
│   ├── QuizSettings.swift (429行) ⚠️⚠️
│   ├── QuizSettingsStore.swift (209行) ⚠️
│   ├── WordScoreStore.swift (138行)
│   └── QuizSessionStore.swift (121行)
├── Services/
│   └── CoreDataIDs/
│       ├── IDMapMaintenance.swift (222行) ⚠️
│       └── CoreDataWordIDProvider.swift (102行)
└── Utils/
    ├── FileUtils.swift (284行) ⚠️
    ├── CSVIDEnsurer.swift (260行) ⚠️
    └── CSVLoader.swift (202行) ⚠️
```

---

## 🚨 詳細分析: 問題ファイル

### 1. QuizView.swift (696行) - 最優先対応

**場所**: `Features/Quiz/Views/QuizView.swift`

**問題点:**
- ファイル行数が基準の232%（696行 vs 300行）
- 複数の責務が混在
  - UI表示（loadingView, errorView, emptyView, quizContent）
  - データロード（loadCSVAndStart）
  - CSV解析（buildHeaderLabelMap, splitCSVLineLocal）
  - バッチ管理（prepareBatch, roundRobinShuffle）
  - 履歴管理（goToPreviousQuestion, goToNextQuestion）
  - 選択処理（handleChoiceSelection）
- 状態変数が20個以上
- テストが困難

**含まれる主要機能:**
1. **UI コンポーネント** (約150行)
   - loadingView
   - errorView
   - emptyView
   - quizContent

2. **データロード** (約150行)
   - loadCSVAndStart
   - applyFilters
   - CSV URLの解決
   - ヘッダ読み取り

3. **バッチ管理** (約100行)
   - prepareBatch
   - roundRobinShuffle

4. **問題準備** (約120行)
   - prepareQuestion
   - generateChoices
   - 選択肢生成ロジック

5. **ユーザーインタラクション** (約80行)
   - handleChoiceSelection
   - goToNextQuestion
   - goToPreviousQuestion

6. **CSV解析** (約100行)
   - buildHeaderLabelMap
   - splitCSVLineLocal
   - ヘッダ正規化

**推奨分割:**
- UI: 4ファイル（Loading, Error, Empty, Content）
- Services: 4ファイル（DataLoader, BatchManager, HistoryManager, HeaderParser）
- Models: 2ファイル（Choice, State）

**期待効果:**
- メインファイル: 696行 → 150行（78%削減）
- テスト容易性: 大幅向上
- 可読性: 著しく向上

---

### 2. QuizSettingsView.swift (553行) - 最優先対応

**場所**: `Views/QuizSettingsView.swift`

**問題点:**
- ファイル行数が基準の184%（553行 vs 300行）
- 設定項目が多岐にわたる
  - 基本設定（問題数、選択肢数、バッチサイズ）
  - フィルタ設定（分野、難易度）
  - 詳細設定（学習モード、繰り返し回数）
  - プリセット管理
- 単一ファイルで全設定を管理

**含まれる主要機能:**
1. **基本設定セクション** (約100行)
   - 問題数
   - 選択肢数
   - バッチサイズ
   - ランダム出題

2. **フィルタ設定セクション** (約150行)
   - 分野選択
   - 難易度選択
   - カスタムフィルタ

3. **詳細設定セクション** (約150行)
   - 学習モード
   - 繰り返し回数
   - 自動進行
   - アニメーション

4. **プリセット管理** (約100行)
   - プリセット一覧
   - プリセット適用
   - プリセット保存

**推奨分割:**
- Components: 4ファイル（BasicSettings, FilterSettings, AdvancedSettings, PresetSelector）

**期待効果:**
- メインファイル: 553行 → 150行（73%削減）
- 設定セクションごとの独立テスト可能

---

### 3. ChoiceCardView.swift (514行) - 最優先対応

**場所**: `QuizComponents/ChoiceCardView.swift`

**問題点:**
- ファイル行数が基準の171%（514行 vs 300行）
- 複雑なアニメーション処理
- 詳細表示ロジックが混在
- 状態管理が複雑

**含まれる主要機能:**
1. **カード表示** (約80行)
   - 基本レイアウト
   - 選択状態の表示

2. **詳細表示** (約200行)
   - 語源・解説の表示
   - 関連語の表示
   - 分野情報の表示
   - ヘッダ対応表示

3. **アニメーション** (約100行)
   - 選択アニメーション
   - 正解/不正解のフィードバック
   - トランジション

4. **スタイル管理** (約80行)
   - カラースキーム
   - フォントサイズ
   - パディング/マージン

**推奨分割:**
- Components: 4ファイル（CardContent, DetailView, Animation, Styles）

**期待効果:**
- メインファイル: 514行 → 100行（81%削減）
- アニメーションの再利用性向上

---

### 4. QuizSettings.swift (429行) - 高優先度

**場所**: `Stores/QuizSettings.swift`

**問題点:**
- ファイル行数が基準の107%（429行 vs 400行）
- ViewModel と Store の責務が混在
- バリデーションロジックが含まれる
- プリセット管理が含まれる

**含まれる主要機能:**
1. **状態管理** (約100行)
   - @Published プロパティ
   - Combine パイプライン

2. **バリデーション** (約100行)
   - 入力値チェック
   - 範囲検証
   - 依存関係検証

3. **プリセット管理** (約120行)
   - プリセット定義
   - プリセット適用
   - カスタムプリセット

4. **永続化** (約100行)
   - UserDefaults への保存
   - データ復元
   - マイグレーション

**推奨分割:**
- Services: 3ファイル（Validator, Presets, Persistence）

**期待効果:**
- メインファイル: 429行 → 150行（65%削減）
- バリデーション・プリセットの独立テスト可能

---

## ⚠️ 分割検討ファイル

### 5. FileUtils.swift (284行)

**場所**: `Utils/FileUtils.swift`

**状態**: 境界線（基準: 特に規定なし、ユーティリティとして長めは許容）

**推奨**: 現時点では保留。QuizView等の優先ファイル完了後に再評価。

---

### 6. CSVIDEnsurer.swift (260行)

**場所**: `Utils/CSVIDEnsurer.swift`

**状態**: 境界線（基準に近い）

**推奨**: 現時点では保留。

---

### 7. IDMapMaintenance.swift (222行)

**場所**: `Services/CoreDataIDs/IDMapMaintenance.swift`

**状態**: 境界線

**推奨**: 現時点では保留。

---

### 8. QuizSettingsStore.swift (209行)

**場所**: `Stores/QuizSettingsStore.swift`

**状態**: 境界線（基準: 200-300行）

**推奨**: QuizSettings.swift の分割に合わせて見直し。

---

## 📈 ファイルサイズ分布

### 行数別ファイル数

| 行数範囲 | ファイル数 | 割合 | 健全性 |
|----------|-----------|------|--------|
| 0-100行 | 多数 | - | ✅ 理想的 |
| 101-200行 | 10+ | - | ✅ 良好 |
| 201-300行 | 4 | - | 🟡 境界線 |
| 301-400行 | 1 | - | 🟠 要検討 |
| 401-500行 | 1 | - | 🔴 要分割 |
| 501行以上 | 2 | - | 🔴 緊急対応 |

### トップ10の長大ファイル

| 順位 | ファイル | 行数 | 状態 |
|------|---------|------|------|
| 1 | QuizView.swift | 696 | 🔴 緊急 |
| 2 | QuizSettingsView.swift | 553 | 🔴 緊急 |
| 3 | ChoiceCardView.swift | 514 | 🔴 緊急 |
| 4 | QuizSettings.swift | 429 | 🔴 高 |
| 5 | FileUtils.swift | 284 | 🟡 中 |
| 6 | CSVIDEnsurer.swift | 260 | 🟡 中 |
| 7 | IDMapMaintenance.swift | 222 | 🟡 中 |
| 8 | QuizSettingsStore.swift | 209 | 🟡 中 |
| 9 | CSVLoader.swift | 202 | 🟡 境界 |
| 10 | NavigatorView.swift | 193 | ✅ 良好 |

---

## 🎯 アーキテクチャ評価

### Feature-First アーキテクチャの遵守状況

#### ✅ 良好な点
1. `Features/Quiz/` ディレクトリが存在
2. View と ViewModel の分離が概ね実施されている
3. 共通コンポーネントが `QuizComponents/` に集約

#### ⚠️ 改善点
1. `Views/` と `Features/Quiz/Views/` が混在
   - QuizSettingsView は Features/Quiz/ に移動すべき
2. Components サブディレクトリが不足
   - QuizView の部品化が未実施
3. Services サブディレクトリが不足
   - ビジネスロジックが View に混在

#### 📋 推奨構造

```
Features/
└── Quiz/
    ├── QuizView.swift (メイン画面)
    ├── QuizSettingsView.swift (設定画面) ← Views/ から移動
    ├── Components/
    │   ├── QuizLoadingView.swift (新規)
    │   ├── QuizErrorView.swift (新規)
    │   ├── QuizEmptyView.swift (新規)
    │   ├── QuizContentView.swift (新規)
    │   ├── QuizBasicSettingsSection.swift (新規)
    │   ├── QuizFilterSettingsSection.swift (新規)
    │   └── ... (他の部品)
    ├── Services/
    │   ├── QuizDataLoader.swift (新規)
    │   ├── QuizBatchManager.swift (新規)
    │   ├── QuizHistoryManager.swift (新規)
    │   ├── CSVHeaderParser.swift (新規)
    │   ├── QuizSettingsValidator.swift (新規)
    │   └── ... (他のサービス)
    └── Models/
        ├── QuizChoice.swift (新規)
        ├── QuizState.swift (新規)
        └── ... (他のモデル)
```

---

## 📊 複雑度分析

### 循環的複雑度（推定）

| ファイル | 推定複雑度 | 状態 |
|---------|-----------|------|
| QuizView.swift | 50+ | 🔴 非常に高い |
| QuizSettingsView.swift | 40+ | 🔴 高い |
| ChoiceCardView.swift | 35+ | 🟠 やや高い |
| QuizSettings.swift | 30+ | 🟠 やや高い |

**備考**: 複雑度が20を超えるとテストが困難になり、30を超えると保守が困難になる。

---

## 🧪 テスタビリティ評価

### 現状の課題

1. **QuizView.swift**
   - UI と ロジックが密結合
   - モック注入が困難
   - 単体テストが書けない

2. **QuizSettingsView.swift**
   - 設定ロジックが View に混在
   - バリデーションのテストが困難

3. **ChoiceCardView.swift**
   - アニメーションのテストが困難
   - 状態遷移のテストが複雑

### リファクタリング後の改善

分割により以下が可能に:
- サービスクラスの単体テスト
- モック注入による View のテスト
- 状態管理の独立テスト

---

## 💡 推奨事項

### 即時対応（1ヶ月以内）

1. **QuizView.swift の分割** （最優先）
   - 影響範囲が最も大きい
   - 保守性への影響が深刻

2. **QuizSettingsView.swift の分割**
   - 設定変更時の影響範囲を限定

3. **ChoiceCardView.swift の分割**
   - UI コンポーネントの再利用性向上

### 短期対応（3ヶ月以内）

4. **QuizSettings.swift の分割**
   - ビジネスロジックの整理

5. **アーキテクチャの統一**
   - Views/ から Features/Quiz/ への移動
   - Components/Services の体系化

### 長期対応（6ヶ月以内）

6. **その他ファイルの見直し**
   - FileUtils.swift の分割検討
   - CSVIDEnsurer.swift の最適化

7. **テストカバレッジの向上**
   - 分割後の各モジュールに単体テスト追加
   - 統合テストの整備

---

## 📚 関連ドキュメント

- `参考資料/ファイル分割ガイド.md`: 分割の具体的手順
- `参考資料/リファクタリング計画_v1.13.0.md`: 詳細なリファクタリング計画
- `.github/copilot-instructions.md`: プロジェクト固有の分割基準

---

## 📝 結論

**総評**: プロジェクトの基本アーキテクチャは良好だが、一部のファイルが肥大化し、保守性が低下している。特に **QuizView.swift（696行）** は緊急対応が必要。

**推奨アクション**: 
1. リファクタリング計画に基づき、フェーズ1（QuizView.swift）から着手
2. 小さく頻繁にコミット、都度ビルド確認
3. 各フェーズ完了後に進捗を記録

**期待される成果**:
- ファイル行数の平均78%削減
- テスト容易性の大幅向上
- 保守性・可読性の著しい改善

---

**作成者**: AI Assistant  
**分析日**: 2025年10月28日  
**次回レビュー予定**: リファクタリング完了後
