# SimpleWord アーキテクチャ入門

**最終更新**: 2025年10月30日  
**対象読者**: SimpleWord の設計思想を理解したい開発者  
**学習時間**: 30分

---

## 📋 このガイドについて

SimpleWord プロジェクトで採用されているアーキテクチャパターンと設計思想を、初心者にも分かりやすく解説します。

**前提知識**: [クイックスタートガイド](./クイックスタートガイド.md) を読んでいること

---

## 🎯 学習目標

1. ✅ Feature-First アーキテクチャの基本を理解する
2. ✅ Store パターンによる状態管理を理解する
3. ✅ Services による責務分離を理解する
4. ✅ SimpleWord の設計原則を理解する

---

## 📖 第1章: Feature-First アーキテクチャ

### 1.1 なぜ Feature-First なのか？

従来の Layer-First（レイヤー優先）アーキテクチャでは、以下のような問題がありました：

```
❌ Layer-First（従来）
SimpleWord/
├── Views/              # すべてのViewが混在
│   ├── QuizView.swift
│   ├── SettingsView.swift
│   └── ResultsView.swift
├── ViewModels/         # すべてのViewModelが混在
│   ├── QuizViewModel.swift
│   ├── SettingsViewModel.swift
│   └── ResultsViewModel.swift
└── Models/             # すべてのModelが混在
    ├── Question.swift
    ├── Settings.swift
    └── Results.swift

問題点:
- 機能追加時に複数のフォルダを横断する必要がある
- 関連ファイルが離れた場所に配置される
- プロジェクトが大きくなると管理が困難
```

Feature-First では、機能ごとに縦割りで管理します：

```
✅ Feature-First（SimpleWord）
SimpleWord/
├── Features/
│   ├── Quiz/              # クイズ機能（完結）
│   │   ├── QuizView.swift
│   │   ├── Models/
│   │   ├── ViewModels/
│   │   └── Services/
│   ├── QuizSettings/      # 出題設定機能（完結）
│   │   ├── QuizSettingsView.swift
│   │   ├── Models/
│   │   └── ViewModels/
│   └── Results/           # 成績表示機能（完結）
│       ├── ResultsView.swift
│       └── Models/

利点:
- 機能単位で完結している
- 関連ファイルが近くにある
- 機能追加・削除が容易
- 複数人での開発がしやすい
```

### 1.2 Feature-First の3原則

1. **機能ごとに完結させる**
   - 各 Feature は独立して動作する
   - 他の Feature への依存は最小限に

2. **共通部分は Common へ**
   - 複数の Feature で使うものは `Common/` に配置
   - 例: QuestionItem、CSVLoader など

3. **縦に切る、横には切らない**
   - 機能ごとに縦割り（View, ViewModel, Model をセット）
   - レイヤーごとに横割りしない

---

## 📖 第2章: Store パターン（状態管理）

### 2.1 Store とは？

**Store** は、アプリの状態を一元管理するパターンです。SimpleWord では以下の Store を使用しています。

### 2.2 主要な Store

#### WordScoreStore
**責務**: 単語別の成績を管理

```swift
class WordScoreStore: ObservableObject {
    @Published var scores: [String: WordScore] = [:]
    
    // 単語の成績を取得
    func getScore(for word: String) -> WordScore
    
    // 正解を記録
    func recordCorrect(for word: String)
    
    // 不正解を記録
    func recordIncorrect(for word: String)
    
    // UserDefaultsに保存
    func save()
}
```

**使用例**:
```swift
@EnvironmentObject var wordScoreStore: WordScoreStore

// 正解を記録
wordScoreStore.recordCorrect(for: "apple")

// 成績を取得
let score = wordScoreStore.getScore(for: "apple")
print("正答率: \(score.correctRate)")
```

#### QuizSessionStore
**責務**: クイズセッションの状態を管理

```swift
class QuizSessionStore: ObservableObject {
    @Published var currentSessionId: UUID?
    @Published var sessionStart: Date?
    
    // 新しいセッションを開始
    func startNewSession()
    
    // セッションを終了
    func endSession()
}
```

#### CurrentCSV
**責務**: 現在選択中のCSVを管理

```swift
class CurrentCSV: ObservableObject {
    @Published var selectedFileName: String = ""
    @Published var csvType: String = ""
    
    // CSVを選択
    func selectCSV(fileName: String, type: String)
}
```

### 2.3 Store の使い方

**1. App エントリーポイントで生成**
```swift
@main
struct SimpleWordApp: App {
    @StateObject private var wordScoreStore = WordScoreStore()
    @StateObject private var currentCSV = CurrentCSV()
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(wordScoreStore)
                .environmentObject(currentCSV)
        }
    }
}
```

**2. View で使用**
```swift
struct QuizView: View {
    @EnvironmentObject var wordScoreStore: WordScoreStore
    @EnvironmentObject var currentCSV: CurrentCSV
    
    var body: some View {
        // ...
    }
}
```

---

## 📖 第3章: Services（ビジネスロジック）

### 3.1 Services とは？

**Services** は、ビジネスロジックを View や ViewModel から分離するためのパターンです。

### 3.2 主要な Services

#### QuizDataLoader
**責務**: CSVからクイズデータを読み込む

```swift
class QuizDataLoader {
    // CSVファイルからQuestionItemの配列を読み込む
    func loadQuestions(from fileName: String) -> [QuestionItem]
}
```

#### QuizBatchManager
**責務**: バッチ学習を管理

```swift
class QuizBatchManager {
    // 次のバッチを取得
    func getNextBatch(
        from questions: [QuestionItem],
        batchSize: Int,
        currentIndex: Int
    ) -> [QuestionItem]
    
    // バッチの進捗を計算
    func calculateProgress(
        currentBatch: Int,
        totalBatches: Int
    ) -> Double
}
```

#### QuizQuestionGenerator
**責務**: 選択肢を生成

```swift
class QuizQuestionGenerator {
    // 4択の選択肢を生成
    func generateChoices(
        for question: QuestionItem,
        from allQuestions: [QuestionItem]
    ) -> [String]
}
```

### 3.3 Services の使い方

```swift
struct QuizView: View {
    // Services をインスタンス化
    private let dataLoader = QuizDataLoader()
    private let batchManager = QuizBatchManager()
    private let generator = QuizQuestionGenerator()
    
    func loadQuiz() {
        // データ読み込み
        let questions = dataLoader.loadQuestions(from: fileName)
        
        // バッチ取得
        let batch = batchManager.getNextBatch(
            from: questions,
            batchSize: 10,
            currentIndex: 0
        )
        
        // 選択肢生成
        let choices = generator.generateChoices(
            for: batch[0],
            from: questions
        )
    }
}
```

---

## 📖 第4章: Models（データ構造）

### 4.1 Models の役割

**Models** は、アプリ内で扱うデータ構造を定義します。

### 4.2 主要な Models

#### QuestionItem
**責務**: 問題の基本情報

```swift
struct QuestionItem: Identifiable, Codable {
    let id: UUID
    let word: String           // 単語
    let meaning: String        // 意味
    let etymology: String?     // 語源
    let difficulty: String?    // 難易度
    let category: String?      # カテゴリ
}
```

#### WordScore
**責務**: 単語別の成績

```swift
struct WordScore: Codable {
    var totalAttempts: Int     // 総出題回数
    var correctCount: Int      // 正解回数
    var lastStudied: Date?     // 最終学習日
    
    // 正答率を計算
    var correctRate: Double {
        guard totalAttempts > 0 else { return 0 }
        return Double(correctCount) / Double(totalAttempts)
    }
}
```

---

## 📖 第5章: SimpleWord の設計原則

### 5.1 基本原則

1. **単一責任の原則（SRP）**
   - 各クラス・構造体は1つの責務のみを持つ
   - 例: QuizDataLoader はデータ読み込みのみ

2. **依存性逆転の原則（DIP）**
   - 具象ではなく抽象に依存する
   - 例: プロトコルを使用して依存を抽象化

3. **開放閉鎖の原則（OCP）**
   - 拡張には開いているが、修正には閉じている
   - 例: 新しい CSV 形式の追加は既存コードを変更しない

### 5.2 命名規則

#### ファイル名
- View: `〇〇View.swift`
- ViewModel/Store: `〇〇Store.swift` または `〇〇ViewModel.swift`
- Model: `〇〇Model.swift` または `〇〇.swift`
- Service: `〇〇Service.swift` または具体的な名前

#### 変数名
- View の Store: `@EnvironmentObject var wordScoreStore`
- View の Services: `private let dataLoader`
- @State: `@State private var currentIndex`

### 5.3 コメント規約

```swift
// MARK: - Properties（プロパティ）
@State private var currentIndex: Int = 0

// MARK: - Lifecycle（ライフサイクル）
var body: some View {
    // ...
}

// MARK: - Methods（メソッド）
private func loadQuestions() {
    // ...
}
```

---

## 📖 第6章: データフロー

### 6.1 データの流れ

```
CSV ファイル
    ↓
QuizDataLoader（読み込み）
    ↓
[QuestionItem]（配列）
    ↓
QuizBatchManager（バッチ分け）
    ↓
View（表示）
    ↓
ユーザーの回答
    ↓
WordScoreStore（成績記録）
    ↓
UserDefaults（永続化）
```

### 6.2 状態の管理

```
View の @State
    ↓ 変更
@Published プロパティ（Store）
    ↓ 通知
View の更新
```

---

## 📖 第7章: 実践例

### 7.1 新機能の追加

**例**: 単語帳機能を追加する

```
1. Features/WordList/ フォルダを作成

2. WordListView.swift を作成
   - メイン画面

3. Models/WordListItem.swift を作成
   - データ構造

4. ViewModels/WordListStore.swift を作成
   - 状態管理

5. ContentView.swift にナビゲーションを追加
```

### 7.2 既存機能の修正

**例**: クイズの選択肢を5択に変更する

```
1. Services/QuizQuestionGenerator.swift を修正
   - generateChoices() メソッドを変更
   - 4択 → 5択

2. Views/ChoiceCardView.swift を修正（必要に応じて）
   - レイアウトの調整

3. テスト実行
```

---

## 📚 次のステップ

### さらに学ぶ
1. **[機能復元ガイド](../02_開発者向け/機能復元ガイド.md)**
   - 機能が壊れた時の復元方法

2. **[ファイル分割ガイド](../02_開発者向け/ファイル分割ガイド.md)**
   - コードが大きくなった時の分割方法

3. **[リファクタリング実践ガイド](../02_開発者向け/リファクタリング実践ガイド.md)**
   - 大規模なリファクタリングの方法

### より詳しい仕様
1. **[docs/ARCHITECTURE_GUIDE.md](../../ARCHITECTURE_GUIDE.md)**
   - プロジェクト全体のアーキテクチャ詳細

2. **[docs/COMPREHENSIVE_SPECIFICATION.md](../../COMPREHENSIVE_SPECIFICATION.md)**
   - 包括的な仕様書

---

## ✅ チェックリスト

アーキテクチャを理解できたか確認してください：

- [ ] Feature-First の利点を説明できる
- [ ] Store パターンの役割を理解した
- [ ] Services の責務を理解した
- [ ] Models の役割を理解した
- [ ] データフローを追跡できる
- [ ] 新機能の追加方法をイメージできる

---

**おめでとうございます！** 🎉  
これで SimpleWord のアーキテクチャの基礎を理解しました。次は実際に開発を始めてみましょう。
