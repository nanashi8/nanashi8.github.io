# 大規模リファクタリング - クイックスタートガイド

**作成日**: 2025年10月19日  
**対象読者**: プロジェクト開発者、AI エージェント

---

## 📋 概要

このガイドは、QuizView.swift (1,100行) のような大規模ファイルのリファクタリングを安全に実施するためのクイックリファレンスです。

---

## 🚀 クイックスタート（5分で理解）

### 大規模リファクタリングを始める前に読むべきドキュメント

1. **参考資料/リファクタリング失敗分析_20251019.md** (必読)
   - 過去の失敗から学ぶ
   - 何をやってはいけないか
   - 約10分で読める

2. **参考資料/大規模リファクタリング実現方策.md** (必読)
   - 成功のための具体的な手順
   - プロンプトテンプレート
   - 約20分で読める

3. **.copilot/prompts/large-scale-refactoring.md** (実行時に使用)
   - AI エージェントに渡すプロンプト
   - コピー＆ペーストで使える

---

## 📝 AI エージェントへの指示方法

### ステップ1: 事前準備を依頼

AI エージェントに以下のように指示：

```
「.copilot/prompts/large-scale-refactoring.md のプロンプト0（事前準備）を実行してください」
```

AI が実施すること:
- テストコードの作成
- Git ブランチの作成
- 依存関係マップの作成
- 現状確認レポート

**所要時間**: 30-60分

---

### ステップ2: Phase 1 を開始

事前準備が完了したら：

```
「Phase 1, Step 1.1 を実行してください」
```

AI が実施すること:
- QuizEngine.swift のスケルトンを作成
- Xcode プロジェクトに追加
- ビルド確認
- Git コミット

**所要時間**: 15-30分

---

### ステップ3: 各ステップを順次実行

各ステップが完了したら：

```
「Step 1.2 を実行してください」
「Step 1.3 を実行してください」
...
```

**重要**: 各ステップで以下を確認
- ✅ ビルド成功
- ✅ テスト green
- ✅ 動作確認OK
- ✅ Git コミット完了

---

### ステップ4: 問題発生時

「進まない」「動かない」などの問題が発生したら：

```
「中断してロールバックしてください」
```

AI が実施すること:
- 即座に `git reset --hard HEAD~1` でロールバック
- 元の動作する状態に復元
- ビルド確認

**重要**: 深追いせず、すぐにロールバック

---

## ⚠️ 絶対に守るべきルール

### 🚫 やってはいけないこと

1. **一度に複数のファイルを作成・変更**
   - 問題の切り分けが困難になる

2. **ビルド確認なしで次のステップに進む**
   - 小さなエラーが蓄積して大きな問題になる

3. **テストを実行せずにコミット**
   - リグレッションを検出できない

4. **問題が出たら深追い**
   - 5分以内に解決できない場合は即座にロールバック

### ✅ 必ずやること

1. **各ステップで Git コミット**
   - いつでも安全にロールバックできる

2. **ビルド → テスト → 動作確認のサイクル**
   - この順番を必ず守る

3. **影響範囲を最小化**
   - 1ステップ = 1ファイル変更

4. **ログを記録**
   - print 文で動作を可視化

---

## 📊 作業の目安

| フェーズ | 内容 | 所要時間 | リスク |
|---------|------|---------|-------|
| 事前準備 | テスト作成、Git準備 | 30-60分 | 低 |
| Phase 1 | QuizEngine 抽出 | 1-2時間 | 中 |
| Phase 2 | 選択肢生成ロジック抽出 | 1-2時間 | 中 |
| Phase 3 | スコア更新ロジック抽出 | 1-2時間 | 中 |
| **合計** | | **4-7時間** | **中-高** |

**推奨**: 1日に1フェーズまで

---

## 🔍 トラブルシューティング

### Q: ビルドエラーが出た

**A**: 5分以内に解決できない場合は即座にロールバック

```bash
git reset --hard HEAD~1
```

### Q: テストが red になった

**A**: 変更を元に戻して、より小さな単位で再挑戦

```bash
git reset --hard HEAD~1
```

### Q: 「進まない」とユーザーが報告

**A**: 即座に作業を中断してロールバック

```bash
git reset --hard HEAD
```

### Q: Xcode プロジェクトへのファイル追加に失敗

**A**: 手動で Xcode を開いて追加するか、xcodeproj gem を使用

```bash
gem install xcodeproj
```

---

## 📚 詳細ドキュメント

- **参考資料/リファクタリング失敗分析_20251019.md**
  - 3回の失敗の詳細分析
  - 根本原因と教訓

- **参考資料/大規模リファクタリング実現方策.md**
  - 前提条件の整備方法
  - Phase 1-3 の詳細手順
  - AI エージェント向けプロンプト全文
  - チェックリスト
  - トラブルシューティング詳細

- **.copilot/prompts/large-scale-refactoring.md**
  - プロンプト0（事前準備）
  - プロンプト1.1（QuizEngine スケルトン）
  - プロンプト1.2（QuizEngine 初期化）
  - 各ステップのプロンプト

- **.copilot/README.md**
  - 作業規模別の参照フロー
  - タスク別の指示例

- **.copilot/changelog.md**
  - 今回の作業の記録

---

## ✨ 成功のポイント

1. **慎重な計画**: 事前準備を徹底する
2. **小さく刻む**: 1ステップ = 1ファイル変更
3. **確認を怠らない**: ビルド、テスト、動作確認
4. **すぐにロールバック**: 問題が出たら深追いしない
5. **記録を残す**: Git コミット、ログ

---

## 🎯 次のアクション

大規模リファクタリングを実施する場合：

1. このガイドを読む（5分）
2. 参考資料の2つのドキュメントを読む（30分）
3. AI エージェントに事前準備を依頼（60分）
4. Phase 1 から段階的に実施（2-3時間）

**合計所要時間**: 4-7時間（複数日に分けることを推奨）

---

**作成者メモ**: このガイドは 2025年10月19日の3回のリファクタリング失敗から学んだ教訓をまとめたものです。同じ失敗を繰り返さないために作成しました。
