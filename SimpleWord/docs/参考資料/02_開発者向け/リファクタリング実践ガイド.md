# 大規模リファクタリング実現方策 - 学習ガイド

**最終更新**: 2025年10月30日  
**対象読者**: 大規模なコードをリファクタリングしたい開発者  
**学習時間**: 30分

---

## 📋 このガイドについて

このガイドでは、1,000行を超える大規模なファイルを安全にリファクタリングする方法を学びます。SimpleWord プロジェクトでの実例に基づいた実践的な内容です。

**実例**: QuizView.swift (1,100行) → Services に分割済み

---

## 🎯 学習目標

このガイドを読むと以下ができるようになります：

1. ✅ 大規模ファイルのリファクタリング手順を理解する
2. ✅ Feature-First アーキテクチャへの移行方法を学ぶ
3. ✅ 安全なリファクタリングのベストプラクティスを習得する
4. ✅ AI を活用した効率的な作業方法を身につける

---

## 📖 第1章: リファクタリングの基本原則

### 1.1 なぜリファクタリングが必要か

**大規模ファイルの問題点**:
- 全体像の把握が困難
- 変更の影響範囲が不明確
- テストが書きにくい
- バグの温床になりやすい
- 複数人での開発が困難

**リファクタリングの効果**:
- コードの可読性向上
- 保守性の向上
- テスタビリティの向上
- 開発速度の向上

### 1.2 Feature-First アーキテクチャ

SimpleWord では **Feature-First / Vertical Slice Architecture** を採用しています。

**従来の層別アーキテクチャ**（避けるべき）:
```
Models/
  - QuestionItem.swift
  - Choice.swift
Services/
  - QuizService.swift
  - ScoreService.swift
Views/
  - QuizView.swift
  - SettingsView.swift
```

**Feature-First アーキテクチャ**（推奨）:
```
Features/
  Quiz/
    QuizView.swift         # メイン画面
    Models/                # クイズ固有のモデル
      QuestionItem.swift
    ViewModels/            # 状態管理
      QuizSessionStore.swift
      WordScoreStore.swift
    Services/              # ビジネスロジック
      QuizDataLoader.swift
      QuizBatchManager.swift
      QuizQuestionGenerator.swift
    Views/                 # UI部品
      QuestionCardView.swift
```

**メリット**:
- 機能ごとに独立してい開発できる
- 関連するコードが近くにある
- 影響範囲が明確
- 削除・移動が容易

---

## 📖 第2章: リファクタリングの準備

### 2.1 現状分析

リファクタリングを始める前に、現状を正確に把握します。

**分析項目**:

1. **ファイルサイズ**
   ```bash
   wc -l SimpleWord/Features/Quiz/QuizView.swift
   # 例: 1100行
   ```

2. **責務の洗い出し**
   - UI表示: 問題カード、選択肢、統計表示
   - データロード: CSVからの読み込み
   - バッチ管理: 問題のグループ化
   - 選択肢生成: 4択問題の作成
   - 回答処理: 正誤判定、スコア更新
   - ナビゲーション: 前へ/次へ

3. **依存関係**
   ```swift
   // Environment Objects
   @EnvironmentObject var wordScoreStore: WordScoreStore
   @EnvironmentObject var currentCSV: CurrentCSV
   @EnvironmentObject var quizSettings: QuizSettings
   
   // State Objects
   @StateObject private var sessionStore = QuizSessionStore.shared
   @StateObject private var state = QuizViewState()
   ```

4. **子コンポーネント**
   - QuestionCardView
   - ChoiceCardView
   - QuizStatisticsView
   - QuizNavigationButtonsView

### 2.2 分割計画

**分割の優先順位**:

1. **Phase 1**: データロード（低リスク）
   - `QuizDataLoader.swift` を作成
   - CSV読み込みロジックを移動

2. **Phase 2**: ビジネスロジック（中リスク）
   - `QuizBatchManager.swift` を作成
   - `QuizQuestionGenerator.swift` を作成
   - `QuizAnswerHandler.swift` を作成

3. **Phase 3**: UI部品（低リスク）
   - 既存の子コンポーネントを `Views/` に整理

**各フェーズの目標**:
- ファイルサイズ: 200〜300行以下
- 単一責任原則を遵守
- テストが書ける構造

---

## 📖 第3章: 実践的なリファクタリング手順

### 3.1 Phase 1: データロード分離

**目標**: CSV読み込みロジックを独立したServiceに抽出

#### Step 1: 新しいファイルを作成

```swift
// Features/Quiz/Services/QuizDataLoader.swift

import Foundation

/// CSVからクイズデータを読み込むサービス
struct QuizDataLoader {
    
    /// クイズデータの読み込み結果
    struct LoadResult {
        let items: [QuestionItem]
        let order: [QuestionItem]
        let headerLabels: [String: String]
    }
    
    /// CSVファイルからクイズデータを読み込む
    func loadQuizData(
        csvName: String,
        fields: Set<String>,
        difficulties: Set<String>,
        numberOfQuestions: Int,
        isRandomOrder: Bool
    ) throws -> LoadResult {
        // 実装をQuizViewから移動
        // ...
    }
}
```

#### Step 2: QuizView で利用

```swift
// QuizView.swift

private func loadCSVAndStart() {
    // 旧コード（削除）
    // let csvData = ...
    // let filtered = ...
    
    // 新コード
    let dataLoader = QuizDataLoader()
    do {
        let result = try dataLoader.loadQuizData(
            csvName: csvName,
            fields: Set(quizSettings.fields),
            difficulties: Set(quizSettings.difficulties),
            numberOfQuestions: quizSettings.numberOfQuestions,
            isRandomOrder: quizSettings.isRandomOrder
        )
        
        state.items = result.items
        state.order = result.order
        state.csvHeaderLabels = result.headerLabels
        
    } catch {
        state.errorMessage = error.localizedDescription
    }
}
```

#### Step 3: 動作確認

```bash
# ビルド
⌘ + B

# 実行
⌘ + R

# 確認項目
- [ ] CSV読み込みが正常に動作する
- [ ] フィルタリングが正しく機能する
- [ ] エラーハンドリングが動作する
```

#### Step 4: Git コミット

```bash
git add Features/Quiz/Services/QuizDataLoader.swift
git add Features/Quiz/QuizView.swift
git commit -m "refactor: Extract QuizDataLoader service

- CSVからのデータ読み込みロジックをサービスに分離
- QuizViewの行数を100行削減
- ビルド: ✅ 成功
- 動作確認: ✅ CSV読み込み正常"
```

### 3.2 Phase 2: バッチ管理分離

**目標**: 問題のバッチ管理ロジックを独立したServiceに抽出

#### 実装例

```swift
// Features/Quiz/Services/QuizBatchManager.swift

import Foundation

/// クイズのバッチ学習を管理するサービス
struct QuizBatchManager {
    
    /// バッチを準備する
    /// - Parameters:
    ///   - items: 全問題リスト
    ///   - order: 出題順序
    ///   - batchSize: バッチサイズ
    ///   - repeatCount: 繰り返し回数
    /// - Returns: バッチ用の問題リスト
    func prepareBatch(
        from items: [QuestionItem],
        order: [QuestionItem],
        batchSize: Int,
        repeatCount: Int
    ) -> [QuestionItem] {
        // バッチ生成ロジック
        // ...
    }
}
```

### 3.3 Phase 3: 選択肢生成分離

**目標**: 選択肢生成ロジックを独立したServiceに抽出

#### 実装例

```swift
// Features/Quiz/Services/QuizQuestionGenerator.swift

import Foundation

/// クイズの選択肢を生成するサービス
struct QuizQuestionGenerator {
    
    /// 選択肢生成結果
    struct GenerateResult {
        let choices: [ChoiceItem]
        let correctAnswerID: UUID
    }
    
    /// 選択肢を生成する
    /// - Parameters:
    ///   - correctItem: 正解の問題
    ///   - allItems: 全問題リスト
    ///   - numberOfChoices: 選択肢の数
    /// - Returns: 生成結果
    func generateChoices(
        correctItem: QuestionItem,
        allItems: [QuestionItem],
        numberOfChoices: Int
    ) -> GenerateResult {
        // 選択肢生成ロジック
        // ...
    }
}
```

---

## 📖 第4章: 安全なリファクタリングのベストプラクティス

### 4.1 小さく始める

**原則**: 1回の変更は1ファイルまで

❌ **悪い例**:
```bash
# 一度に5ファイルを作成・変更
git add Services/QuizDataLoader.swift
git add Services/QuizBatchManager.swift
git add Services/QuizQuestionGenerator.swift
git add ViewModels/QuizViewModel.swift
git add QuizView.swift
git commit -m "refactor: Extract all quiz logic"
```

✅ **良い例**:
```bash
# 1ファイルずつ作成・確認・コミット
git add Services/QuizDataLoader.swift
git commit -m "refactor: Extract QuizDataLoader"
# ビルド・動作確認

git add Services/QuizBatchManager.swift
git commit -m "refactor: Extract QuizBatchManager"
# ビルド・動作確認
```

### 4.2 頻繁にコミット

**推奨頻度**: 15〜30分に1回

**コミットメッセージのテンプレート**:
```
refactor: <変更内容の要約>

変更内容:
- 詳細1
- 詳細2

影響範囲:
- ファイルA: XX行削減
- ファイルB: 新規作成

確認項目:
- [x] ビルド成功
- [x] 動作確認OK
- [x] エラーなし
```

### 4.3 問題が出たら即座にロールバック

**5分ルール**: 5分以内に解決できない問題は深追いしない

```bash
# 直前のコミットに戻す
git reset --hard HEAD~1

# 動作確認
⌘ + B  # ビルド
⌘ + R  # 実行
```

### 4.4 テストを書く

**最低限のテスト**:

```swift
import XCTest
@testable import SimpleWord

class QuizDataLoaderTests: XCTestCase {
    
    func testLoadValidCSV() throws {
        let loader = QuizDataLoader()
        let result = try loader.loadQuizData(
            csvName: "テスト単語.csv",
            fields: [],
            difficulties: [],
            numberOfQuestions: 10,
            isRandomOrder: false
        )
        
        XCTAssertFalse(result.items.isEmpty)
        XCTAssertEqual(result.items.count, result.order.count)
    }
}
```

---

## 📖 第5章: AI を活用した効率化

### 5.1 AI への依頼の仕方

**効果的なプロンプト**:

```
QuizView.swift のCSV読み込みロジックを
新しいファイル QuizDataLoader.swift に抽出してください。

要件:
- Features/Quiz/Services/ に配置
- エラーハンドリングを含める
- 既存の機能を壊さない
- コメントで説明を追加

実装後:
- ビルドが通ることを確認
- QuizView.swift を更新して利用
```

### 5.2 段階的な指示

**1回の指示は1ステップまで**:

❌ **悪い例**:
```
QuizView.swiftをリファクタリングして、
データロード、バッチ管理、選択肢生成を
すべて別ファイルに分離してください
```

✅ **良い例**:
```
Step 1: QuizDataLoader.swift を作成してください
（完了後、次のステップへ）

Step 2: QuizBatchManager.swift を作成してください
（完了後、次のステップへ）
```

---

## 📖 第6章: トラブルシューティング

### 6.1 ビルドエラー

**症状**: Xcode でビルドが失敗する

**解決策**:
1. エラーメッセージを確認
2. 5分以内に解決できない場合はロールバック
3. より小さな単位で再挑戦

```bash
# ロールバック
git reset --hard HEAD~1

# Clean Build
⌘ + Shift + K

# ビルド
⌘ + B
```

### 6.2 動作が変わった

**症状**: リファクタリング後に動作が異なる

**解決策**:
1. 即座にロールバック
2. 変更箇所を特定
3. より慎重に実装

### 6.3 ファイルが Xcode に追加されない

**症状**: 新規ファイルがプロジェクトに表示されない

**解決策**:
1. Finder でファイルが存在するか確認
2. Xcode で手動追加
   - 右クリック → Add Files to "SimpleWord"
3. Target Membership を確認

---

## 📚 まとめ

### 重要ポイント

1. ✅ **Feature-First** でコードを整理する
2. ✅ **小さく** 始めて頻繁にコミット
3. ✅ **問題が出たら即ロールバック**
4. ✅ **テストで安全性を確保**
5. ✅ **AI を活用して効率化**

### 次のステップ

1. 実際のプロジェクトで練習する
2. 小さなファイルから始める
3. 成功体験を積み重ねる
4. 徐々に大きなリファクタリングに挑戦

---

## 📖 参考資料

- **[クイックスタートガイド](../クイックスタートガイド_新版.md)** - プロジェクトの基本
- **[ファイル分割ガイド](../ファイル分割ガイド.md)** - 分割の基準
- **[AIとのやり取り_クイックリファレンス](../AIとのやり取り_クイックリファレンス.md)** - AI活用法

---

**頑張ってください！** 🚀  
リファクタリングはスキルが必要ですが、練習すれば必ず上達します。
