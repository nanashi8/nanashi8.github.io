# QuizView リファクタリング失敗分析レポート

**日付**: 2025年10月19日  
**対象**: QuizView.swift (約1,100行) の出題ロジック整理  
**結果**: 失敗（3回中断・ロールバック）

---

## エグゼクティブサマリー

QuizView.swift の大規模リファクタリング（出題ロジックの分離）を試みたが、以下の理由で3回失敗し、すべてロールバックを余儀なくされた：

1. **一度に大きな変更を行った**（QuizManager, QuestionSelector, ScoreUpdater を同時作成）
2. **Xcode プロジェクトファイルへの新規ファイル追加に失敗**（手動 pbxproj 編集の難しさ）
3. **動作確認の欠如**（各ステップでビルド・実行確認をせずに進行）
4. **依存関係の複雑さ**（QuizView が30個以上の @State と多数のコンポーネントに依存）
5. **バックアップ戦略の不備**（複数のバックアップファイルが混在し、どれが正しいか不明瞭）

---

## 試行の詳細

### 試行1: 一括リファクタリング（失敗）

**実施内容**:
- Features/Quiz/Logic/ フォルダを新規作成
- QuizManager.swift (500行) を作成
- QuestionSelector.swift (100行) を作成
- ScoreUpdater.swift (30行) を作成
- QuizView.swift を新バージョン（330行）に置き換え

**問題点**:
- 新規ファイルが Xcode プロジェクトに登録されず、ビルドエラー
- QuizView の大幅な書き換えで動作確認ができない状態に
- ユーザーが「動いていない」と中断

**ロールバック方法**:
- 手動でファイル削除
- バックアップから QuizView を復元（しかし誤ったバージョンを使用）

---

### 試行2: バックアップからの復元試行（失敗）

**実施内容**:
- QuizView_Original_Backup.swift から復元を試みた
- しかしバックアップファイル自体が新バージョンだった

**問題点**:
- 複数のバックアップファイルが存在（.old, _Original_Backup, など）
- どれが元の動作するバージョンか不明
- バックアップのバージョン管理が不適切

**ロールバック方法**:
- Git リポジトリから復元を試みた

---

### 試行3: Git を使った復元と段階的リファクタリング（失敗）

**実施内容**:
- `git checkout -- SimpleWord/QuizView.swift` で元に戻した
- QuestionCardView.swift の ViewBuilder エラーを修正
- 「段階的リファクタリング」として QuestionSelector.swift のみを作成
- QuizView で QuestionSelector を使用するように部分修正

**問題点**:
- QuestionSelector を使用した状態でも「進まない」とユーザーが報告
- ビルドは成功したが、実行時の問題か UI の反応性の問題が発生した可能性
- 詳細なエラーログや動作確認をする前に中断

**ロールバック方法**:
- QuestionSelector.swift を削除
- QuizView.swift は変更されていなかったため、そのまま維持

---

## 根本原因分析（5-Why）

### Why 1: なぜリファクタリングが失敗したのか？
→ 一度に大きな変更を行い、動作確認をせずに進めたため

### Why 2: なぜ動作確認をせずに進めたのか？
→ 各ステップでのビルド・実行確認の重要性を軽視していたため

### Why 3: なぜビルド・実行確認を軽視したのか？
→ リファクタリング計画に「動作確認のチェックポイント」が明記されていなかったため

### Why 4: なぜチェックポイントが明記されていなかったのか？
→ リファクタリングの作業手順書・チェックリストが存在しなかったため

### Why 5: なぜ作業手順書が存在しなかったのか？
→ 大規模リファクタリングの標準プロセスが定義されていなかったため

**根本原因**: 大規模リファクタリングの標準プロセス・手順書・チェックリストが未整備

---

## 技術的な障害

### 1. Xcode プロジェクトファイル管理の難しさ

**問題**:
- 新規ファイルを作成しても、Xcode プロジェクト（.pbxproj）に自動登録されない
- 手動で pbxproj を編集するのは非常にリスクが高い（XML形式で複雑）
- Xcode IDE を使わずにファイルを追加する方法が確立されていない

**影響**:
- ビルド時に「ファイルが見つからない」エラーが多発
- プロジェクトの整合性が崩れる

### 2. QuizView の高い結合度

**問題**:
- QuizView が 30個以上の @State 変数を持つ
- 多数の子コンポーネント（QuestionCardView, ChoiceCardView, DontKnowCardView など）と密結合
- 複数の Store (@EnvironmentObject) に依存
  - QuizSettings
  - ScoreStore
  - WordScoreStore
  - CurrentCSV

**影響**:
- 出題ロジックだけを抽出しようとしても、状態変数の依存関係が複雑
- 部分的な変更でも影響範囲が広い

### 3. バックアップ戦略の不備

**問題**:
- 複数のバックアップファイルが作成された：
  - QuizView_Original_Backup.swift
  - QuizView.swift.old
  - QuizView.swift.backup_YYYYMMDD
- どれが「動作する元のバージョン」か不明瞭
- バックアップのタイミングとバージョンが記録されていない

**影響**:
- ロールバック時に誤ったバージョンを使用
- 復元作業が長引く

### 4. テスト不足

**問題**:
- ユニットテストが存在しない（または実行されていない）
- UI テストも実行されていない
- リファクタリング後の動作確認が手動のみ

**影響**:
- リグレッション（既存機能の破壊）を早期に検出できない
- 「動作する」ことを客観的に証明できない

---

## 成功要因の欠如

リファクタリングを成功させるために必要だった要素：

### 1. 明確な作業手順書
- [ ] ステップバイステップの詳細な手順
- [ ] 各ステップの目的と期待結果
- [ ] チェックポイントの明記
- [ ] ロールバック条件の定義

### 2. 自動テストの整備
- [ ] 既存機能のユニットテスト
- [ ] UI テスト
- [ ] リグレッションテストの自動実行

### 3. Git ワークフローの確立
- [ ] 各ステップでのコミット
- [ ] ブランチ戦略（feature ブランチの使用）
- [ ] コミットメッセージの標準化

### 4. Xcode プロジェクト管理の自動化
- [ ] 新規ファイル追加の自動化スクリプト
- [ ] プロジェクトファイルの整合性チェック

### 5. 段階的な変更計画
- [ ] マイクロステップに分割（1ステップ = 1クラス抽出）
- [ ] 各ステップの影響範囲の事前評価
- [ ] 依存関係マップの作成

---

## 教訓

### やってはいけないこと

1. **一度に複数のファイルを作成・変更しない**
   - 問題の切り分けが困難になる

2. **ビルド確認なしで次のステップに進まない**
   - 小さなエラーが蓄積して大きな問題になる

3. **バックアップを複数作らない**
   - Git を信頼し、バックアップは Git で管理する

4. **手動で .pbxproj を編集しない**
   - Xcode IDE を使うか、自動化スクリプトを用意する

### やるべきこと

1. **各ステップで Git コミット**
   - いつでも安全にロールバックできる状態を維持

2. **ビルド → 実行 → 動作確認のサイクルを必ず回す**
   - 自動テストがあれば実行する

3. **影響範囲を最小化する**
   - 1ステップで変更するファイルは1つまで
   - 新規ファイル追加は別ステップで行う

4. **依存関係を事前に把握する**
   - クラス図、シーケンス図を作成する

---

## リファクタリングの難易度評価

### QuizView.swift の複雑性指標

| 指標 | 値 | 評価 |
|------|------|------|
| 行数 | 1,100行 | 非常に高い（推奨: 200行以下） |
| @State 変数数 | 30個以上 | 非常に高い（推奨: 5個以下） |
| メソッド数 | 15個以上 | 高い（推奨: 10個以下） |
| 依存 Store 数 | 4個 | 中程度 |
| 子コンポーネント数 | 10個以上 | 高い |
| ネストレベル | 6階層以上 | 非常に高い（推奨: 3階層以下） |

**結論**: QuizView.swift は「非常に高い複雑性」を持ち、リファクタリング難易度は「上級」

---

## 次のアクションへの推奨

### オプション A: 段階的リファクタリング（改訂版）
- **条件**: 詳細な作業手順書と自動テストを整備してから実施
- **期間**: 2-3週間
- **リスク**: 中程度

### オプション B: 現状維持 + 新機能は別ファイル
- **条件**: QuizView.swift は触らず、新機能のみ独立ファイルで実装
- **期間**: 即時
- **リスク**: 低い

### オプション C: 全面書き直し
- **条件**: テスト駆動開発（TDD）で新規実装
- **期間**: 1-2ヶ月
- **リスク**: 高い

**推奨**: オプション B（現状維持 + 新機能は別ファイル）

---

## 参照ドキュメント

- `.copilot/structure-map.md` - プロジェクト構造
- `docs/仕様書/` - 既存仕様書
- Git ログ - 今回の変更履歴

---

## 付録: タイムライン

| 時刻 | イベント | 結果 |
|------|----------|------|
| T+0 | 試行1開始（一括リファクタリング） | - |
| T+15min | QuizManager, QuestionSelector, ScoreUpdater 作成 | ビルドエラー |
| T+20min | ユーザーが中断 | ロールバック1 |
| T+25min | 試行2開始（バックアップから復元） | - |
| T+30min | 誤ったバックアップを使用 | ビルドエラー |
| T+35min | ユーザーが中断 | ロールバック2 |
| T+40min | 試行3開始（Git 復元 + 段階的） | - |
| T+50min | QuestionSelector のみ作成 | ビルド成功 |
| T+55min | ユーザーが「進まない」と報告 | ロールバック3 |
| T+60min | 完全に元の状態に復元 | ビルド成功 |

**総作業時間**: 約60分  
**成功率**: 0%  
**ロールバック回数**: 3回
