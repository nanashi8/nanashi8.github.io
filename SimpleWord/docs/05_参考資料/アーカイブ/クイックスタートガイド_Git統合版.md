# 大規模リファクタリング - クイックスタートガイド（Git統合版）

**作成日**: 2025年10月19日  
**更新日**: 2025年10月19日（Git統合ワークフロー対応）  
**対象読者**: プロジェクト開発者、AI エージェント

---

## 📋 概要

このガイドは、QuizView.swift (1,100行) のような大規模ファイルのリファクタリングを、**Git統合ワークフロー**を使って安全に実施するためのクイックリファレンスです。

**🆕 Git統合ワークフローの特徴:**
- AIが自動的にGit操作を実行（ブランチ作成、コミット、ロールバック）
- 各ステップでチェックポイントを自動作成
- 問題発生時は5秒で前の状態に復旧
- バージョン管理も完全自動

---

## 🚀 クイックスタート（5分で理解）

### 大規模リファクタリングを始める前に読むべきドキュメント

1. **このガイド**（5分で読める）
   - Git統合ワークフローの基本を理解

2. **参考資料/リファクタリング失敗分析_20251019.md** (推奨)
   - 過去の失敗から学ぶ
   - 約10分で読める

3. **.copilot/prompts/ai-git-workflow.md** (推奨)
   - Git統合ワークフローの詳細
   - 約15分で読める

4. **参考資料/大規模リファクタリング実現方策.md** (詳細版)
   - 成功のための具体的な手順
   - 約20分で読める

---

## 📝 AI エージェントへの指示方法

### ステップ1: 事前準備を依頼

AI エージェントに以下のように指示：

```
「.copilot/prompts/large-scale-refactoring.md のプロンプト0（事前準備）を
Git統合ワークフローで実行してください」
```

AI が実施すること:
- ✅ Gitブランチ作成（`refactor-quiz-view-20251019`）
- ✅ 初期コミット（作業開始マーカー）
- ✅ テストコードの作成
- ✅ 依存関係マップの作成
- ✅ 現状確認レポート

**所要時間**: 30-60分

---

### ステップ2: Phase 1 を開始

事前準備が完了したら：

```
「Phase 1, Step 1.1 を実行してください」
```

AI が実施すること:
- ✅ QuizEngine.swift のスケルトンを作成
- ✅ Xcode プロジェクトに追加
- ✅ ビルド確認
- ✅ Git コミット（自動）

**所要時間**: 15-30分

---

### ステップ3: 各ステップを順次実行

各ステップが完了したら：

```
「Step 1.2 を実行してください」
「Step 1.3 を実行してください」
...
```

**重要**: 各ステップでAIが自動的に以下を実行
- ✅ ファイル変更
- ✅ ビルド確認
- ✅ テスト実行
- ✅ Git コミット（自動、チェックポイント作成）
- ✅ 問題発生時は自動ロールバック（5秒）

---

### ステップ4: 問題発生時

「進まない」「動かない」などの問題が発生したら：

```
「中断してロールバックしてください」
```

AI が実施すること:
- ✅ 即座に `git reset --hard HEAD~1` でロールバック
- ✅ 元の動作する状態に復元（5秒）
- ✅ ビルド確認
- ✅ 原因分析と代替案提示

**重要**: 深追いせず、すぐにロールバック

---

## 🆕 Git統合ワークフローとバージョン管理

### AIが自動実行すること

**Git操作（完全自動）:**
- Gitブランチ作成（`refactor-quiz-view-YYYYMMDD`、`feature-xxx`、`fix-xxx` など）
- 各ステップでのコミット（チェックポイント作成）
- 問題発生時の自動ロールバック（5秒）
- コミットメッセージの自動生成（✨新機能、🐛修正、♻️リファクタなど絵文字付き）

**バージョン管理（完全自動）:**
- 変更規模を自動判定（ファイル数、行数、所要時間から）
- バージョン番号を自動計算（Semantic Versioning 準拠）
- Gitタグを自動作成（注釈付き）
- changelog.md を自動更新

### あなたがすること

- ✅ 自然言語で指示するだけ
- ✅ Gitコマンドを覚える必要なし
- ✅ バージョン番号を考える必要なし
- ✅ 問題が起きたら「中断してロールバック」と言うだけ

### 使用例

#### 小規模機能追加（MINOR +1）
```
あなた: 「合格数のアニメーションを追加してください。Git統合ワークフローで」

AI自動実行:
1. ブランチ作成: feature-animation-20251019
2. 実装 → ビルド → コミット
3. changelog.md 更新
4. バージョンタグ: v0.2.0 (MINOR +1)
5. 完了報告（次回: v0.3.0 or v1.0.0 or v0.2.1）
```

#### バグ修正（PATCH +1）
```
あなた: 「アニメーション二重発火を修正してください」

AI自動実行:
1. ブランチ作成: fix-double-animation-20251019
2. 修正 → ビルド → コミット
3. changelog.md 更新
4. バージョンタグ: v0.2.1 (PATCH +1)
5. 完了報告
```

#### 実験的な変更
```
あなた: 「アニメーション速度を2倍にしてみてください。気に入らなければ元に戻します」

AI実行:
1. ブランチ作成: experiment-animation-speed
2. 実装 → ビルド → コミット
3. ユーザー確認待ち

あなた: 「やっぱり元に戻して」

AI実行:
git reset --hard HEAD~1  # 5秒で復旧！
```

#### 大規模リファクタリング（MAJOR +1）
```
あなた: 「.copilot/prompts/large-scale-refactoring.md をGit統合ワークフローで実行」

AI自動実行:
1. ブランチ作成: refactor-quiz-view-20251019
2. Phase 1-3 を順次実行（各ステップでコミット）
3. 問題発生時は自動ロールバック（5秒）
4. changelog.md 更新
5. バージョンタグ: v1.0.0 (MAJOR +1)
6. 完了報告
```

詳細は以下を参照：
- `.copilot/prompts/ai-git-workflow.md`（Git統合ワークフロー）
- `.copilot/prompts/version-management.md`（バージョン管理）

---

## ⚠️ 絶対に守るべきルール

### 🚫 やってはいけないこと

1. **一度に複数のファイルを作成・変更しない**
   - 1ステップ = 1ファイル変更が原則
   - 問題の切り分けが困難になる

2. **ビルド確認なしで次のステップに進まない**
   - AIが自動確認するので、指示に従う

3. **問題が出たら深追いしない**
   - 5分以内に解決できない場合は「中断してロールバック」
   - AIが5秒で前の状態に戻す

4. **Gitコマンドを手動で実行しない**
   - すべてAIに任せる

### ✅ 必ずやること

1. **AIの自動Git操作を信頼する**
   - ブランチ作成、コミット、ロールバックは全てAI

2. **問題が起きたら即座に報告**
   - 「中断してロールバック」と指示
   - AIが5秒で復旧

3. **各フェーズ完了後に動作確認**
   - シミュレータで実際に動かす
   - 問題なければ次のフェーズへ

4. **自然言語で明確に指示**
   - 「Git統合ワークフローで」と明記
   - 何をしたいかを具体的に

---

## 📊 作業の目安（Git統合版）

| フェーズ | 内容 | 所要時間 | AIの自動操作 |
|---------|------|---------|-------------|
| 事前準備 | テスト作成、Git準備 | 30-60分 | ブランチ作成、コミット |
| Phase 1 | QuizEngine 抽出 | 1-2時間 | 各ステップでコミット |
| Phase 2 | 選択肢生成ロジック抽出 | 1-2時間 | 各ステップでコミット |
| Phase 3 | スコア更新ロジック抽出 | 1-2時間 | 各ステップでコミット |
| 完了 | バージョンタグ作成 | 5分 | タグ作成、changelog更新 |
| **合計** | | **4-7時間** | **完全自動** |

**従来との比較:**
- Git操作時間: 60分 → 0分（100%削減）
- ロールバック時間: 30分 → 5秒（99.7%削減）
- バージョン管理時間: 20分 → 0分（100%削減）

**推奨**: 1日に1フェーズまで

---

## 🔍 トラブルシューティング

### Q: ビルドエラーが出た

**A**: AIが自動的にロールバック（5秒）して原因を報告します

```
AI: 「⚠️ ビルドエラーが発生しました。自動的に前の状態に戻しました（5秒）。

エラー内容: QuizEngine.start() のシグネチャ不一致

提案: 引数を確認してから再試行しますか？」
```

### Q: テストが red になった

**A**: AIが自動的にロールバック（5秒）して失敗理由を報告します

```
AI: 「⚠️ テストが失敗しました。自動的に前の状態に戻しました（5秒）。

失敗したテスト: testQuizEngineIntegration

原因: QuizEngine.generateChoices() が空の配列を返している

提案: より小さな単位で統合しますか？」
```

### Q: 「進まない」とユーザーが報告

**A**: 即座に「中断してロールバック」と指示

```
あなた: 「中断してロールバックしてください」

AI: 即座にロールバック（5秒）
「✅ 前の安定版に戻しました。
現在の状態: Phase 1, Step 1.1 完了時点
コミット: a1b2c3d

別のアプローチで再挑戦します。」
```

### Q: Gitブランチが多くなった

**A**: AIが不要なブランチを削除します

```
あなた: 「実験ブランチを削除してください」

AI: git branch -D experiment-animation-speed
「✅ ブランチを削除しました」
```

---

## 📚 詳細ドキュメント

- **参考資料/リファクタリング失敗分析_20251019.md**
  - 3回の失敗の詳細分析
  - 根本原因と教訓

- **参考資料/大規模リファクタリング実現方策.md**
  - 前提条件の整備方法
  - Phase 1-3 の詳細手順
  - AI エージェント向けプロンプト全文

- **.copilot/prompts/ai-git-workflow.md**
  - Git統合ワークフローの詳細
  - コミットメッセージフォーマット
  - エラー時の自動対応フロー

- **.copilot/prompts/version-management.md**
  - バージョン管理ルール（Semantic Versioning）
  - AIの自動バージョニング手順
  - changelog.md のフォーマット

- **.copilot/prompts/large-scale-refactoring.md**
  - Git統合版リファクタリングプロンプト
  - プロンプト0〜Phase 3 まで

- **.copilot/README.md**
  - 作業規模別の参照フロー
  - タスク別の指示例

- **.copilot/changelog.md**
  - 実際の変更履歴

---

## ✨ 成功のポイント（Git統合版）

1. **AIを信頼する**: すべてのGit操作をAIに任せる
2. **小さく刻む**: 1ステップ = 1ファイル変更（AIが自動コミット）
3. **確認を怠らない**: 各フェーズ完了後に動作確認
4. **すぐにロールバック**: 問題が出たら「中断してロールバック」（5秒）
5. **記録は自動**: changelog、バージョンタグはAIが自動作成

---

## 🎯 次のアクション

大規模リファクタリングを実施する場合：

1. このガイドを読む（5分）
2. 必要に応じて詳細ドキュメントを読む（30分）
3. AI エージェントに事前準備を依頼（60分）
4. Phase 1 から段階的に実施（2-3時間）

**合計所要時間**: 4-7時間（複数日に分けることを推奨）

**Git操作時間**: 0分（AIが全て自動実行）

---

## 🎓 まとめ

**Git統合ワークフローの利点:**
- **Git学習コスト**: ゼロ（AIが全て自動実行）
- **ロールバック時間**: 30分 → 5秒（99.7%削減）
- **バージョン管理**: 完全自動（考える必要なし）
- **失敗への恐怖**: ゼロ（いつでも5秒で戻れる）

**あなたがすること:**
- 自然言語で指示するだけ
- 問題が起きたら「中断してロールバック」
- 各フェーズ完了後に動作確認

**AIがすること:**
- Git操作を全て自動実行
- ビルド・テスト確認
- 問題発生時は自動ロールバック（5秒）
- バージョン管理（タグ作成、changelog更新）

---

**作成者メモ**: このガイドは 2025年10月19日の3回のリファクタリング失敗から学んだ教訓をもとに、Git統合ワークフローとバージョン管理を組み込んで作成しました。同じ失敗を繰り返さず、安全で効率的なリファクタリングを実現するためのガイドです。
