# 01-02 アーキテクチャ仕様

**文書番号**: 01-02  
**最終更新**: 2025-11-04  
**バージョン**: 2.0  
**ステータス**: 最新

---

## 📋 目次

1. [設計原則](#設計原則)
2. [アーキテクチャパターン](#アーキテクチャパターン)
3. [ディレクトリ構造](#ディレクトリ構造)
4. [主要コンポーネント](#主要コンポーネント)
5. [データフロー](#データフロー)
6. [状態管理](#状態管理)
7. [依存関係](#依存関係)

---

## 🎯 設計原則

### 1. Feature-First Architecture

機能ごとに垂直方向でコードを分割し、各機能が自己完結できるように設計しています。

**利点**:
- 機能追加・修正時の影響範囲が明確
- チーム開発時の並行作業が容易
- テストとメンテナンスが簡単

### 2. 単一責任の原則（SRP）

各コンポーネントは単一の責務のみを持ちます。

**例**:
- `QuizView`: クイズ画面の表示のみ
- `AdaptiveScheduler`: 出題順序の決定のみ
- `CSVLoader`: CSVファイルの読み込みのみ

### 3. 依存性の注入（DI）

コンポーネント間の結合度を下げるため、依存性を注入します。

**実装方法**:
```swift
// ❌ 悪い例：直接依存
class QuizView: View {
    let scheduler = AdaptiveScheduler()
}

// ✅ 良い例：依存性注入
class QuizView: View {
    @StateObject var scheduler: AdaptiveScheduler
    
    init(scheduler: AdaptiveScheduler) {
        _scheduler = StateObject(wrappedValue: scheduler)
    }
}
```

### 4. テスタビリティ

すべてのビジネスロジックはテスト可能な設計にします。

**実装方法**:
- Protocolを使用した抽象化
- モック可能な依存関係
- 純粋関数の優先使用

---

## 🏗️ アーキテクチャパターン

### Feature-First / Vertical Slice Architecture

```
SimpleWord/
├── Features/                    # 機能別モジュール（垂直分割）
│   ├── Quiz/                   # クイズ機能
│   │   ├── Views/              # UI層
│   │   │   ├── QuizView.swift
│   │   │   └── QuizResultView.swift
│   │   ├── Logic/              # ビジネスロジック
│   │   └── Models/             # 機能固有のモデル
│   │
│   ├── Study/                  # 学習管理機能
│   │   ├── Domain/             # ドメインモデル
│   │   │   ├── MemoryStage.swift
│   │   │   └── StudyRecord.swift
│   │   ├── Logic/              # ビジネスロジック
│   │   │   ├── AdaptiveScheduler.swift
│   │   │   └── MemoryConsolidationTracker.swift
│   │   └── Data/               # データアクセス
│   │
│   ├── CSV/                    # CSV管理機能
│   │   ├── Views/
│   │   ├── Logic/
│   │   └── Models/
│   │
│   └── Statistics/             # 成績管理機能
│       ├── Views/
│       ├── Logic/
│       └── Models/
│
├── Common/                      # 共通コンポーネント（横断的関心事）
│   ├── Data/                   # データ層
│   │   ├── Schema/             # データスキーマ
│   │   │   └── QuestionItemCSVSchema.swift
│   │   └── DataSource/         # データソース
│   │       └── CSVDataSource.swift
│   ├── Extensions/             # 拡張機能
│   ├── Models/                 # 共通モデル
│   │   └── QuestionItem.swift
│   └── Utility/                # ユーティリティ
│
├── Stores/                      # 状態管理（グローバル状態）
│   ├── QuizSessionStore.swift  # クイズセッション
│   ├── QuizSettings.swift      # クイズ設定
│   └── WordScoreStore.swift    # 単語別成績
│
├── Services/                    # サービス層（インフラ層）
│   ├── FileService.swift       # ファイル管理
│   └── DataService.swift       # データ永続化
│
└── Utils/                       # ユーティリティ
    ├── CSVLoader.swift         # CSV読み込み
    └── IDMapManager.swift      # ID管理
```

### レイヤー構造

```
┌─────────────────────────────────────┐
│         Presentation Layer          │  SwiftUI Views
│          (Features/*/Views/)        │
├─────────────────────────────────────┤
│         Application Layer           │  Stores, Logic
│    (Stores/ + Features/*/Logic/)    │
├─────────────────────────────────────┤
│           Domain Layer              │  Models, Business Rules
│      (Features/*/Domain/)           │
├─────────────────────────────────────┤
│         Infrastructure Layer        │  Services, DataSource
│         (Services/ + Common/)       │
└─────────────────────────────────────┘
```

---

## 📁 ディレクトリ構造詳細

### Features/ - 機能別モジュール

各機能は自己完結した垂直スライスとして実装します。

#### Quiz/ - クイズ機能

```
Quiz/
├── Views/
│   ├── QuizView.swift              # メインクイズ画面
│   ├── QuizResultView.swift        # 結果表示画面
│   └── QuizSettingsView.swift      # 設定画面
├── Logic/
│   └── ChoiceGenerator.swift       # 選択肢生成ロジック
└── Models/
    └── QuizSession.swift            # クイズセッションモデル
```

#### Study/ - 学習管理機能

```
Study/
├── Domain/
│   ├── MemoryStage.swift           # 記憶段階モデル
│   ├── StudyRecord.swift           # 学習履歴モデル
│   └── LearningMode.swift          # 学習モード定義
├── Logic/
│   ├── AdaptiveScheduler.swift     # 適応型スケジューラ
│   └── MemoryConsolidationTracker.swift  # 記憶定着追跡
└── Data/
    └── StudyRecordRepository.swift # 学習履歴永続化
```

#### CSV/ - CSV管理機能

```
CSV/
├── Views/
│   ├── CSVListView.swift           # CSV一覧画面
│   └── CSVEditorView.swift         # CSV編集画面
├── Logic/
│   └── CSVValidator.swift          # CSV検証ロジック
└── Models/
    └── CSVMetadata.swift            # CSVメタデータ
```

#### Statistics/ - 成績管理機能

```
Statistics/
├── Views/
│   ├── StatisticsView.swift        # 成績画面
│   └── WordStatsDetailView.swift   # 単語別詳細
├── Logic/
│   └── StatisticsCalculator.swift  # 統計計算
└── Models/
    └── StatisticsData.swift         # 統計データモデル
```

### Common/ - 共通コンポーネント

横断的な関心事を扱う共通コンポーネント。

```
Common/
├── Data/
│   ├── Schema/
│   │   └── QuestionItemCSVSchema.swift  # CSV列定義
│   └── DataSource/
│       └── CSVDataSource.swift          # CSV読み込み実装
├── Extensions/
│   ├── Date+Extensions.swift
│   ├── Array+Extensions.swift
│   └── String+Extensions.swift
├── Models/
│   ├── QuestionItem.swift              # 問題アイテムモデル
│   └── FieldCategory.swift             # 分野カテゴリ
└── Utility/
    ├── Logger.swift                    # ログ出力
    └── Formatter.swift                 # フォーマット処理
```

### Stores/ - 状態管理

グローバル状態を管理するストア。

```
Stores/
├── QuizSessionStore.swift          # クイズセッション管理
├── QuizSettings.swift              # 出題設定
├── WordScoreStore.swift            # 単語別成績
├── CSVMetadataStore.swift          # CSVメタデータ
└── AppState.swift                  # アプリ全体の状態
```

### Services/ - サービス層

インフラストラクチャ層のサービス。

```
Services/
├── FileService.swift               # ファイル操作
├── DataService.swift               # データ永続化
└── NotificationService.swift       # 通知サービス
```

---

## 🧩 主要コンポーネント

### 1. QuizView（クイズ画面）

**責務**: クイズ画面の表示と操作

**主要プロパティ**:
```swift
@StateObject var sessionStore: QuizSessionStore
@ObservedObject var settings: QuizSettings
@State private var currentQuestionIndex: Int = 0
@State private var selectedChoice: Int?
```

**主要メソッド**:
- `submitAnswer()`: 回答を送信
- `moveToNext()`: 次の問題へ移動
- `moveToPrevious()`: 前の問題へ移動

### 2. AdaptiveScheduler（適応型スケジューラ）

**責務**: 学習履歴に基づいて最適な出題順序を決定

**主要プロパティ**:
```swift
var studyRecords: [String: StudyRecord]
var learningMode: LearningMode
```

**主要メソッド**:
- `scheduleNextBatch(from:size:)`: 次のバッチを生成
- `calculatePriority(for:)`: 優先度を計算

### 3. MemoryStage（記憶段階）

**責務**: 記憶定着度の段階を表現

**定義**:
```swift
enum MemoryStage: Int, Codable {
    case unlearned = 0          // 未学習
    case initial = 1            // 初回接触
    case shortTerm = 2          // 短期記憶
    case midTerm = 3            // 中期記憶
    case longTerm = 4           // 長期記憶
    case mastered = 5           // 習熟済み
}
```

### 4. StudyRecord（学習履歴）

**責務**: 個別単語の学習履歴とSM-2アルゴリズムの実装

**主要プロパティ**:
```swift
var questionID: String
var memoryStage: MemoryStage
var correctCount: Int
var incorrectCount: Int
var consecutiveCorrect: Int
var lastStudied: Date?
var nextReviewDate: Date?
var easinessFactor: Double
var interval: TimeInterval
```

**主要メソッド**:
- `recordAnswer(isCorrect:)`: 回答を記録
- `updateMemoryStage()`: 記憶段階を更新
- `calculateNextReview()`: 次回復習日を計算（SM-2）

### 5. QuizSessionStore（クイズセッション管理）

**責務**: クイズセッションの状態管理

**主要プロパティ**:
```swift
@Published var currentBatch: [QuestionItem]
@Published var currentIndex: Int
@Published var results: [QuizResult]
@Published var isCompleted: Bool
```

**主要メソッド**:
- `startSession(with:)`: セッション開始
- `submitAnswer(_:for:)`: 回答を記録
- `completeSession()`: セッション完了

### 6. CSVDataSource（CSVデータソース）

**責務**: CSVファイルからデータを読み込む

**主要メソッド**:
```swift
func load(from url: URL) async throws -> [QuestionItem]
func detectHeaders(in csvContent: String) -> [String: String]
func parseRow(_ row: [String], schema: QuestionItemCSVSchema) -> QuestionItem?
```

---

## 🔄 データフロー

### クイズ機能のデータフロー

```
1. ユーザー操作
   ↓
2. QuizView（View層）
   ↓
3. QuizSessionStore（状態管理）
   ↓
4. AdaptiveScheduler（ビジネスロジック）
   ↓
5. StudyRecord（ドメインモデル）
   ↓
6. DataService（永続化）
```

### CSV読み込みフロー

```
1. ファイル選択（UI）
   ↓
2. FileService.selectFile()
   ↓
3. CSVDataSource.load(from:)
   ↓
4. QuestionItemCSVSchema.parse()
   ↓
5. QuizSettings.updateQuestions()
   ↓
6. QuizView更新（SwiftUI自動更新）
```

### 適応型学習フロー

```
1. セッション開始
   ↓
2. AdaptiveScheduler.scheduleNextBatch()
   ├─ StudyRecord読み込み
   ├─ 優先度計算
   ├─ MemoryStage判定
   └─ LearningMode適用
   ↓
3. バッチ生成
   ↓
4. QuizView表示
   ↓
5. 回答記録
   ↓
6. StudyRecord更新
   ├─ SM-2アルゴリズム適用
   ├─ MemoryStage更新
   └─ 次回復習日計算
   ↓
7. DataService永続化
```

---

## 📊 状態管理

### SwiftUIの状態管理パターン

#### @State - ローカル状態

```swift
struct QuizView: View {
    @State private var selectedChoice: Int? = nil
    @State private var showResult: Bool = false
}
```

**用途**: View内部でのみ使用する一時的な状態

#### @StateObject - オブジェクトの所有

```swift
struct QuizView: View {
    @StateObject var sessionStore = QuizSessionStore()
}
```

**用途**: Viewがライフサイクルを管理するオブジェクト

#### @ObservedObject - オブジェクトの監視

```swift
struct QuizView: View {
    @ObservedObject var settings: QuizSettings
}
```

**用途**: 外部から注入されるオブジェクトの監視

#### @EnvironmentObject - グローバル状態

```swift
struct QuizView: View {
    @EnvironmentObject var appState: AppState
}
```

**用途**: アプリ全体で共有する状態

### 状態管理の設計方針

1. **できるだけローカルに保つ**: `@State`を優先
2. **共有が必要な場合のみグローバル化**: `@EnvironmentObject`
3. **ライフサイクルを明確に**: `@StateObject` vs `@ObservedObject`
4. **不変性を保つ**: 可能な限り値型を使用

---

## 🔗 依存関係

### 外部依存関係

現在、外部ライブラリへの依存はありません（Pure Swift実装）。

**理由**:
- シンプルさの維持
- ビルド時間の短縮
- セキュリティリスクの低減
- 長期メンテナンス性の向上

### 内部依存関係の原則

```
Presentation (Views)
    ↓ depends on
Application (Logic, Stores)
    ↓ depends on
Domain (Models)
    ↓ depends on
Infrastructure (Services)
```

**ルール**:
- 上位層は下位層に依存できる
- 下位層は上位層に依存してはならない
- 同一レイヤー内の依存は最小化

---

## 🧪 テスタビリティ

### テスト可能な設計

#### 1. Protocol Oriented Programming

```swift
protocol QuestionDataSource {
    func load(from url: URL) async throws -> [QuestionItem]
}

// 本番実装
class CSVDataSource: QuestionDataSource { ... }

// テスト用モック
class MockDataSource: QuestionDataSource { ... }
```

#### 2. 依存性注入

```swift
class AdaptiveScheduler {
    private let dataSource: QuestionDataSource
    
    init(dataSource: QuestionDataSource = CSVDataSource()) {
        self.dataSource = dataSource
    }
}
```

#### 3. 純粋関数の使用

```swift
// ✅ テスト可能（純粋関数）
func calculatePriority(record: StudyRecord, mode: LearningMode) -> Double {
    // 副作用なし、同じ入力には同じ出力
}

// ❌ テストしにくい（副作用あり）
func calculatePriority() -> Double {
    // グローバル状態に依存
}
```

---

## 📚 関連ドキュメント

- **前のドキュメント**: `01-01_プロジェクト概要.md`
- **次のドキュメント**: `01-03_データモデル仕様.md`
- **実装ガイド**: `02-03_ディレクトリ構造.md`
- **開発ガイド**: `03-01_新規機能追加ガイド.md`

---

**文書履歴**:
- 2025-11-04: 初版作成
- Feature-First Architectureの詳細説明を追加

**管理者**: SimpleWord開発チーム
