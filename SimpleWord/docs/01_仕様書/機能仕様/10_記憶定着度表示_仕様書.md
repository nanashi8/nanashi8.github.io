# 記憶定着度表示機能_仕様書

**最終更新: 2025-10-25**

この文書は、記憶定着度の進捗表示機能（MemoryProgressView）の復元・実装ガイドです。

## ⚠️ 重要: 復元のための必須情報

この機能が喪失した場合、このドキュメントから完全に復元できます。

---

## 概要

### 何を実現しているか
- 6段階の記憶定着レベル別の単語数を視覚化
- 各段階の割合を進捗バーで表示
- 全体の習熟率を計算して表示
- 色分けによる直感的な理解

### なぜ必要か
- 学習の進捗を可視化し、モチベーションを高める
- どの記憶段階の単語が多いかを一目で把握
- 学習の偏りを発見し、バランスを調整

---

## 画面構成

```
┌────────────────────────────┐
│ 記憶定着状況                │
├────────────────────────────┤
│ ○ 未学習      15 (30%)     │
│ ━━━━━━━━━━━━━━━━━━━━       │
│                             │
│ ○ 初回接触     8 (16%)     │
│ ━━━━━━━                     │
│                             │
│ ○ 短期記憶    12 (24%)     │
│ ━━━━━━━━━━                  │
│                             │
│ ○ 中期記憶     7 (14%)     │
│ ━━━━━                       │
│                             │
│ ○ 長期記憶     5 (10%)     │
│ ━━━━                        │
│                             │
│ ○ 習熟済み     3 (6%)      │
│ ━━                          │
├────────────────────────────┤
│ 習熟率: 6.0%                │
└────────────────────────────┘
```

---

## データ構造

### 入力データ

```swift
struct MemoryProgressView: View {
    let statistics: [MemoryStage: Int]  // 各段階の単語数
    let totalItems: Int                  // 総単語数
}
```

### 記憶段階（MemoryStage）

```swift
enum MemoryStage: String, Codable {
    case unseen         // 未学習
    case initial        // 初回接触（1-2回）
    case shortTerm      // 短期記憶（3-5回、30秒-5分間隔）
    case midTerm        // 中期記憶（6-10回、1時間-1日間隔）
    case longTerm       // 長期記憶（11回以上、1日以上間隔）
    case mastered       // 習熟済み（連続5回正解＆高精度）
    
    var displayName: String
    var description: String
}
```

---

## UI仕様

### 色の割り当て

各記憶段階に対応する色：

| 段階 | 色 | 16進数 | 意味 |
|---|---|---|---|
| 未学習 | Gray | #808080 | まだ学習していない |
| 初回接触 | Blue | #007AFF | 初めて触れる単語 |
| 短期記憶 | Cyan | #32ADE6 | 短期的に記憶中 |
| 中期記憶 | Yellow | #FFD60A | 中期的に保持 |
| 長期記憶 | Orange | #FF9500 | 長期的に記憶 |
| 習熟済み | Green | #34C759 | 完全に習得 |

```swift
private var stageColor: Color {
    switch stage {
    case .unseen: return .gray
    case .initial: return .blue
    case .shortTerm: return .cyan
    case .midTerm: return .yellow
    case .longTerm: return .orange
    case .mastered: return .green
    }
}
```

### 進捗バー

```swift
GeometryReader { geometry in
    ZStack(alignment: .leading) {
        // 背景
        RoundedRectangle(cornerRadius: 4)
            .fill(Color(uiColor: .tertiarySystemFill))
            .frame(height: 6)
        
        // 進捗
        RoundedRectangle(cornerRadius: 4)
            .fill(stageColor)
            .frame(width: geometry.size.width * percentage, height: 6)
    }
}
.frame(height: 6)
```

### 習熟率の計算

```swift
if totalItems > 0 {
    let masteredCount = statistics[.mastered] ?? 0
    let masteryRate = Double(masteredCount) / Double(totalItems) * 100
    
    Text(String(format: "%.1f%%", masteryRate))
        .foregroundColor(masteryRate >= 80 ? .green : 
                        (masteryRate >= 50 ? .orange : .red))
}
```

**色の閾値**:
- 80%以上: 緑色（優秀）
- 50%以上: オレンジ色（普通）
- 50%未満: 赤色（要努力）

---

## 実装詳細

### ファイル構成

```
Features/Quiz/Views/MemoryProgressView.swift
├── MemoryProgressView          # メインビュー
└── MemoryStageRow              # 各段階の行表示（private）
```

### MemoryProgressView（メインビュー）

```swift
struct MemoryProgressView: View {
    let statistics: [MemoryStage: Int]
    let totalItems: Int

    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("記憶定着状況")
                .font(.headline)
                .foregroundColor(.primary)

            // 各段階の進捗バー
            ForEach(MemoryStage.allCases, id: \.self) { stage in
                if let count = statistics[stage], count > 0 {
                    MemoryStageRow(stage: stage, count: count, total: totalItems)
                }
            }

            // 全体の習熟率
            if totalItems > 0 {
                let masteredCount = statistics[.mastered] ?? 0
                let masteryRate = Double(masteredCount) / Double(totalItems) * 100

                Divider()
                    .padding(.vertical, 4)

                HStack {
                    Text("習熟率")
                        .font(.subheadline)
                        .foregroundColor(.secondary)
                    Spacer()
                    Text(String(format: "%.1f%%", masteryRate))
                        .font(.subheadline)
                        .fontWeight(.semibold)
                        .foregroundColor(masteryRate >= 80 ? .green : 
                                        (masteryRate >= 50 ? .orange : .red))
                }
            }
        }
        .padding()
        .background(Color(uiColor: .secondarySystemGroupedBackground))
        .cornerRadius(12)
    }
}
```

### MemoryStageRow（行表示）

```swift
private struct MemoryStageRow: View {
    let stage: MemoryStage
    let count: Int
    let total: Int

    private var percentage: Double {
        guard total > 0 else { return 0 }
        return Double(count) / Double(total)
    }

    private var stageColor: Color {
        // ... 上記の色定義
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            HStack {
                Circle()
                    .fill(stageColor)
                    .frame(width: 8, height: 8)
                Text(stage.displayName)
                    .font(.subheadline)
                    .foregroundColor(.primary)
                Spacer()
                Text("\(count)")
                    .font(.subheadline)
                    .fontWeight(.medium)
                    .foregroundColor(.secondary)
                Text(String(format: "(%.0f%%)", percentage * 100))
                    .font(.caption)
                    .foregroundColor(.secondary)
            }

            // 進捗バー
            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    RoundedRectangle(cornerRadius: 4)
                        .fill(Color(uiColor: .tertiarySystemFill))
                        .frame(height: 6)
                    
                    RoundedRectangle(cornerRadius: 4)
                        .fill(stageColor)
                        .frame(width: geometry.size.width * percentage, height: 6)
                }
            }
            .frame(height: 6)
        }
    }
}
```

---

## QuizViewへの統合

### 統計データの取得

```swift
// QuizView.swift内

// 記憶定着度の統計
@State private var memoryStatistics: [MemoryStage: Int] = [:]

// デバッグフラグ
private let enableMemoryTracking = false  // 有効化時にtrueに

// 統計更新
private func updateMemoryStatistics() {
    if enableMemoryTracking {
        let itemIDs = items.map { $0.id }
        memoryStatistics = memoryTracker.statistics(for: itemIDs)
    }
}

// バッチ準備時に統計更新
private func prepareBatch() {
    // ... 既存のロジック
    
    updateMemoryStatistics()
}
```

### ビュー表示

```swift
// QuizView.swift内のquizContent

VStack(spacing: 16) {
    // 既存の統計表示
    QuizStatisticsView(...)
    
    // 記憶定着度表示（デバッグフラグで制御）
    if enableMemoryTracking && !memoryStatistics.isEmpty {
        MemoryProgressView(
            statistics: memoryStatistics,
            totalItems: items.count
        )
        .padding(.horizontal)
    }
    
    // ... 問題表示等
}
```

---

## データソース

### MemoryConsolidationTracker

記憶段階の統計を計算するヘルパークラス：

```swift
// Features/Study/Domain/MemoryStage.swift

public struct MemoryConsolidationTracker {
    private let repo: StudyProgressRepository

    public init(repo: StudyProgressRepository = FileStudyProgressRepository())

    /// 記憶段階の統計を取得
    public func statistics(for itemIDs: [UUID]) -> [MemoryStage: Int] {
        let stages = self.stages(for: itemIDs)
        var stats: [MemoryStage: Int] = [:]
        
        // 全段階を0で初期化
        for stage in MemoryStage.allCases {
            stats[stage] = 0
        }
        
        // 各単語の段階をカウント
        for (_, stage) in stages {
            stats[stage, default: 0] += 1
        }
        
        return stats
    }

    /// 各アイテムの記憶段階を取得
    public func stages(for itemIDs: [UUID]) -> [UUID: MemoryStage] {
        var result: [UUID: MemoryStage] = [:]
        for id in itemIDs {
            let record = repo.load(id: id)
            result[id] = MemoryStage.determine(from: record)
        }
        return result
    }
}
```

---

## 段階的な有効化

### フェーズ1: 無効（現在のデフォルト）

```swift
private let enableMemoryTracking = false
```

- 従来の動作を維持
- MemoryProgressViewは表示されない

### フェーズ2: 有効化

```swift
private let enableMemoryTracking = true
```

- 記憶段階の統計が表示される
- パフォーマンスへの影響を確認

---

## テスト観点

### 表示テスト

- [ ] 各記憶段階の色が正しい
- [ ] カウント数が正確
- [ ] パーセンテージが正確（小数点以下0桁）
- [ ] 進捗バーの幅が割合と一致
- [ ] 習熟率の色が閾値に応じて変化

### エッジケース

- [ ] 全単語が同じ段階の場合
- [ ] 特定の段階の単語が0の場合（表示されない）
- [ ] 総単語数が0の場合
- [ ] 習熟率が0%, 50%, 80%, 100%の境界値

### ダークモード

- [ ] ライトモードで適切な色
- [ ] ダークモードで適切な色
- [ ] 背景色との十分なコントラスト

---

## パフォーマンス考慮

### 計算コスト

```swift
// O(n) where n = 単語数
public func statistics(for itemIDs: [UUID]) -> [MemoryStage: Int]
```

- 各単語のStudyRecordをロード: O(n)
- 記憶段階を判定: O(n)
- 合計: O(n)

### 最適化

- 統計更新はバッチ準備時のみ（頻繁ではない）
- キャッシュは不要（データ量が少ない）
- 1000単語でも十分高速

---

## トラブルシューティング

### 統計が表示されない

**原因**: `enableMemoryTracking`が`false`
**対処**: QuizView.swiftで`true`に変更

### カウントが0になる

**原因**: StudyRecordが存在しない（初回起動時）
**対処**: 正常な動作。問題に回答すると記録される

### 色がおかしい

**原因**: ダークモード未対応のカラー
**対処**: `Color(uiColor:)`を使用してシステムカラーを使用

---

## 将来の拡張

### 予定されている機能

1. **アニメーション**: 段階変化時にアニメーション
2. **詳細表示**: タップで各段階の単語リストを表示
3. **履歴グラフ**: 時系列での変化をグラフ化
4. **目標設定**: 習熟率の目標を設定

---

## 関連ドキュメント

- `ADAPTIVE_LEARNING_GUIDE.md` - 適応型学習システムの全体像
- `docs/COMPREHENSIVE_SPECIFICATION.md` - データモデル詳細
- `09_出題ロジック_仕様書.md` - 出題アルゴリズム
- `Features/Study/Domain/MemoryStage.swift` - 実装ファイル

---

## 復元手順

機能が喪失した場合の復元手順：

1. **MemoryStage.swift**を確認（6段階の定義と判定ロジック）
2. **MemoryConsolidationTracker**を実装（統計計算）
3. **MemoryProgressView.swift**を作成（このドキュメントのコードを参考）
4. **QuizView.swift**に統合（統計更新とビュー表示）
5. デバッグフラグで段階的に有効化

---

**最終更新**: 2025-10-25  
**ファイル**: `Features/Quiz/Views/MemoryProgressView.swift`  
**依存**: `MemoryStage.swift`, `MemoryConsolidationTracker`
