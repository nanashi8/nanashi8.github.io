# 出題ロジック_仕様書（シンプルバッチ学習）

**最終更新: 2025-10-28**  
**ステータス**: ✅ 最新（実装と完全一致）

この文書はSimpleWordの出題ロジックの完全な仕様書です。

---

## ⚠️ 重要: アーキテクチャの変更

### 変更履歴
- **2025-10-28**: AdaptiveScheduler削除、シンプルなバッチ学習に変更
- **以前**: 複雑な適応型学習システム（SM-2ベース）

### 現在の設計思想
- **シンプル第一**: 過度な複雑性を避け、保守性を優先
- **バッチ学習**: 一定数ごとに区切って学習
- **繰り返し学習**: 同じ単語を複数回出題
- **ラウンドロビン**: 連続して同じ単語が出ないように配置

---

## 概要

### 何を実現しているか
- **CSV読み込み**: 選択したCSVから問題を読み込み
- **フィルタリング**: 分野・難易度で出題範囲を絞り込み
- **バッチ学習**: 設定したバッチサイズ（出題数）で区切る
- **繰り返し学習**: 各単語を指定回数繰り返す
- **ラウンドロビン配置**: 同じ単語の連続出題を避ける
- **成績記録**: WordScoreStoreに単語別の成績を記録

### なぜこの設計か
- **わかりやすい**: 学習フローが直感的
- **予測可能**: 出題順序が明確
- **保守しやすい**: コードがシンプル
- **拡張しやすい**: 必要に応じて機能追加可能

---

## 全体フロー

```
[起動]
  ↓
[CSV読み込み]
  ↓
[フィルタリング] (分野・難易度)
  ↓
[出題順序決定] (ランダム or 順番)
  ↓
[バッチ準備]
  ├─ バッチサイズ分を切り出し
  ├─ 繰り返し回数を適用
  └─ ラウンドロビン配置
  ↓
[問題出題]
  ├─ 選択肢生成
  └─ 表示
  ↓
[回答]
  ├─ 正誤判定
  ├─ 成績記録 (WordScoreStore)
  └─ セッション記録 (QuizSessionStore)
  ↓
[次の問題] or [バッチ完了]
  ↓
[次のバッチ] or [全問題完了]
  ↓
[結果保存]
  └─ ScoreStoreに記録
```

---

## 詳細仕様

### 1. CSV読み込み（loadCSVAndStart）

#### 読み込み優先順位
```swift
// 1. QuestionItemRepositoryを使用
let base = csvName.replacingOccurrences(of: ".csv", with: "")
let repository = QuestionItemRepository(fileName: base)

switch repository.fetch() {
case .success(let items):
    allItems = items
case .failure(let error):
    errorMessage = "CSV読み込み失敗: \(error.localizedDescription)"
}
```

#### フィルタリング
```swift
func applyFilters(to items: [QuestionItem]) -> [QuestionItem] {
    var result = items
    
    // 分野フィルタ
    if !quizSettings.fields.isEmpty {
        result = result.filter { item in
            !Set(item.relatedFields).isDisjoint(with: quizSettings.fields)
        }
    }
    
    // 難易度フィルタ
    if !quizSettings.difficulties.isEmpty {
        result = result.filter { item in
            quizSettings.difficulties.contains(item.difficulty)
        }
    }
    
    return result
}
```

#### 出題順序の決定
```swift
let totalQuestions = min(quizSettings.numberOfQuestions, items.count)

if quizSettings.isRandomOrder {
    // ランダム出題
    order = items.shuffled().prefix(totalQuestions).map { $0 }
} else {
    // CSV順
    order = Array(items.prefix(totalQuestions))
}
```

---

### 2. バッチ準備（prepareBatch）

#### バッチサイズ分を切り出し
```swift
let batchItems = Array(order.prefix(sessionStore.batchSize))
```

#### 繰り返し回数の適用
```swift
var poolItems: [QuestionItem] = []
let repeatCount = max(1, quizSettings.repeatCount)

for item in batchItems {
    for _ in 0..<repeatCount {
        poolItems.append(item)
    }
}
```

**例**: バッチサイズ3、繰り返し回数2の場合
```
batchItems: [A, B, C]
poolItems: [A, A, B, B, C, C]
```

#### ラウンドロビン配置（roundRobinShuffle）
```swift
func roundRobinShuffle(
    items: [QuestionItem],
    pool: [QuestionItem]
) -> [QuestionItem] {
    var result: [QuestionItem] = []
    var queues = [UUID: [QuestionItem]]()
    
    // 各単語のキューを作成
    for item in pool {
        queues[item.id, default: []].append(item)
    }
    
    // ラウンドロビンで取り出し
    var hasMore = true
    while hasMore {
        hasMore = false
        for item in items {
            if var queue = queues[item.id], !queue.isEmpty {
                result.append(queue.removeFirst())
                queues[item.id] = queue
                hasMore = true
            }
        }
    }
    
    return result
}
```

**例**: バッチサイズ3、繰り返し回数2の場合
```
ラウンドロビン前: [A, A, B, B, C, C]
ラウンドロビン後: [A, B, C, A, B, C]
```

**効果**: 同じ単語が連続しない → 記憶定着に有効

---

### 3. 問題出題（prepareQuestion）

#### 現在の問題を設定
```swift
currentItem = pool.removeFirst()
selectedChoiceID = nil
correctAnswerID = nil
dontKnowID = UUID()
```

#### 選択肢の生成
```swift
// 正解の選択肢
let correctChoice = Choice(
    id: UUID(),
    label: item.meaning,
    explanation: item.etymology,
    isCorrect: true,
    item: item
)
correctAnswerID = correctChoice.id

// 不正解の選択肢
var incorrectChoices: [Choice] = []
let otherItems = items.filter { $0.id != item.id }.shuffled()

for otherItem in otherItems.prefix(max(0, numberOfChoices - 1)) {
    let choice = Choice(
        id: UUID(),
        label: otherItem.meaning,
        explanation: otherItem.etymology,
        isCorrect: false,
        item: otherItem
    )
    incorrectChoices.append(choice)
}

// シャッフル
choices = ([correctChoice] + incorrectChoices).shuffled()
```

#### 履歴に追加（戻る機能用）
```swift
if historyIndex >= 0 && historyIndex < history.count - 1 {
    // 途中の履歴から進んだ場合、それ以降の履歴を削除
    history = Array(history.prefix(historyIndex + 1))
}
history.append(item.id)
historyIndex = history.count - 1
```

---

### 4. 回答処理（handleChoiceSelection）

#### 正誤判定
```swift
selectedChoiceID = id
let wasCorrect = (id == correctAnswerID)
```

#### 成績記録

**QuizSessionStore**: セッション内の統計
```swift
sessionStore.recordAnswer(correct: wasCorrect)
// questionCount += 1
// score += (wasCorrect ? 1 : 0)
// batchCorrect += (wasCorrect ? 1 : 0)
```

**WordScoreStore**: 単語別の成績
```swift
wordScoreStore.recordResult(itemID: item.id, correct: wasCorrect)
// 単語ごとの正答数・出題回数・正答率を記録
```

#### アニメーション
```swift
// 総出題数が増加した場合
if sessionStore.questionCount > oldQuestionCount {
    shouldAnimateTotalCount = true
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.2) {
        self.shouldAnimateTotalCount = false
    }
}

// 合格数が増加した場合
if sessionStore.batchCorrect > oldBatchCorrect {
    shouldAnimatePassedCount = true
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.2) {
        self.shouldAnimatePassedCount = false
    }
}
```

#### 自動進行
```swift
if wasCorrect && autoAdvanceEnabled {
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
        goToNextQuestion()
    }
}
```

---

### 5. バッチ完了（completeBatch）

```swift
func completeBatch() {
    // バッチ完了をセッションストアに記録
    sessionStore.completeBatch()
    // currentBatchIndex += 1
    // batchCorrect = 0
    
    if order.count > sessionStore.batchSize {
        // 次のバッチがある
        order = Array(order.dropFirst(sessionStore.batchSize))
        prepareBatch()
    } else {
        // 全問題完了
        saveResults()
        sessionStore.endSession()
        dismiss()
    }
}
```

---

### 6. 結果保存（saveResults）

```swift
private func saveResults() {
    guard currentCSV.name != nil else { return }
    
    let result = QuizResult(
        total: sessionStore.questionCount,
        correct: sessionStore.score,
        settings: quizSettings.model
    )
    scoreStore.addResult(result)
}
```

---

## セッション管理（QuizSessionStore）

### 目的
- **永続化**: アプリを閉じても続きから再開
- **統計管理**: 正答率、合格数、総出題数の記録

### 主要プロパティ
```swift
@Published public var score: Int = 0                // 累積正解数
@Published public var questionCount: Int = 0        // 累積出題数
@Published public var batchCorrect: Int = 0         // 現在バッチの正解数
@Published public var batchSize: Int = 10           // バッチサイズ
@Published public var isSessionActive: Bool = false // セッション状態
@Published public var currentCSVName: String? = nil // 現在のCSV名
@Published public var currentBatchIndex: Int = 0    // 現在のバッチ番号
@Published public var totalBatches: Int = 0         // 総バッチ数
```

### 主要メソッド
```swift
// セッション開始
func startSession(csvName: String, batchSize: Int, totalQuestions: Int)

// 回答記録
func recordAnswer(correct: Bool)

// バッチ完了
func completeBatch()

// セッション終了
func endSession()

// セッション復元可能か
func canResumeSession(csvName: String) -> Bool

// 正答率計算
func calculateAccuracy() -> Int
```

### 永続化
```swift
// 保存
private func saveSession() {
    let session: [String: Any] = [
        "score": score,
        "questionCount": questionCount,
        "batchCorrect": batchCorrect,
        "batchSize": batchSize,
        "isSessionActive": isSessionActive,
        "currentCSVName": currentCSVName as Any,
        "currentBatchIndex": currentBatchIndex,
        "totalBatches": totalBatches
    ]
    UserDefaults.standard.set(session, forKey: sessionKey)
}

// 読み込み
private func loadSession() {
    guard let session = UserDefaults.standard.dictionary(forKey: sessionKey) else { return }
    
    score = session["score"] as? Int ?? 0
    questionCount = session["questionCount"] as? Int ?? 0
    batchCorrect = session["batchCorrect"] as? Int ?? 0
    batchSize = session["batchSize"] as? Int ?? 10
    isSessionActive = session["isSessionActive"] as? Bool ?? false
    currentCSVName = session["currentCSVName"] as? String
    currentBatchIndex = session["currentBatchIndex"] as? Int ?? 0
    totalBatches = session["totalBatches"] as? Int ?? 0
}
```

---

## 成績管理

### WordScoreStore（単語別）

#### 目的
- 各単語の正答数・出題回数・正答率を記録
- CSV別にファイルを分けて保存

#### データ構造
```swift
struct WordScore: Codable {
    let wordID: UUID
    var correctCount: Int
    var totalAttempts: Int
    
    var accuracy: Double {
        guard totalAttempts > 0 else { return 0.0 }
        return Double(correctCount) / Double(totalAttempts)
    }
}
```

#### 保存場所
```
Documents/word_scores_{csvName}.json
```

#### 主要メソッド
```swift
// CSV切り替え
func switchToCSV(_ csvName: String)

// 結果記録
func recordResult(itemID: UUID, correct: Bool)

// スコア取得
func score(for itemID: UUID) -> WordScore?
```

### ScoreStore（クイズ結果）

#### 目的
- クイズ終了時の結果を記録
- 学習履歴として表示

#### データ構造
```swift
struct QuizResult: Identifiable, Codable {
    let id: UUID
    let date: Date
    let total: Int
    let correct: Int
    let settings: QuizSettingsModel
    
    var accuracy: Double {
        guard total > 0 else { return 0.0 }
        return Double(correct) / Double(total)
    }
}
```

#### 保存場所
```
UserDefaults (key: "QuizResults")
```

---

## 設定値

### QuizSettings（設定管理）

#### バッチ学習関連
```swift
@Published public var questionsPerBatch: Int = 10   // バッチサイズ
@Published public var repeatCount: Int = 2          // 繰り返し回数
@Published public var threshold: Double = 0.7       // 合格率（未使用）
```

#### 出題設定
```swift
@Published public var numberOfChoices: Int = 4      // 選択肢数
@Published public var numberOfQuestions: Int = 50   // 総出題数
@Published public var isRandomOrder: Bool = true    // ランダム出題
```

#### フィルタ
```swift
@Published public var fields: [String] = []         // 分野フィルタ
@Published public var difficulties: [String] = []   // 難易度フィルタ
```

#### 機能切替
```swift
@Published public var isTimerEnabled: Bool = false  // タイマー
@Published public var timeLimit: Int = 60           // 制限時間
@Published public var isSpeechEnabled: Bool = true  // 音声読み上げ
@Published public var learningMode: LearningMode = .normal
```

#### 自動進行
```swift
public var model: QuizSettingsModel {
    var m = QuizSettingsModel.default()
    m.autoAdvance = autoAdvanceEnabled
    return m
}
```

---

## ファイル構成

### 主要ファイル
```
SimpleWord/Features/Quiz/Views/
└── QuizView.swift

SimpleWord/Stores/
├── QuizSettings.swift
├── QuizSessionStore.swift
├── ScoreStore.swift
├── WordScoreStore.swift
└── CurrentCSV.swift

SimpleWord/QuizComponents/
├── QuestionCardView.swift
├── ChoiceCardView.swift
├── DontKnowCardView.swift
├── QuizStatisticsView.swift
└── QuizNavigationButtonsView.swift

Common/Data/Repository/
└── QuestionItemRepository.swift

Common/Data/Model/
└── QuestionItem.swift
```

---

## 復元手順

### ステップ1: データフローの理解
1. この仕様書の「全体フロー」を確認
2. 各処理の入出力を理解

### ステップ2: セッション管理の実装
1. QuizSessionStore の実装
2. 永続化ロジックの実装

### ステップ3: QuizView の実装
1. バッチ準備ロジック
2. ラウンドロビン配置
3. 問題出題・回答処理
4. バッチ完了判定

### ステップ4: 成績管理の実装
1. WordScoreStore の実装
2. ScoreStore の実装

### ステップ5: テスト
1. バッチ学習の動作確認
2. ラウンドロビン配置の確認
3. セッション復元の確認
4. 成績記録の確認

---

## 将来の拡張案

### 適応型学習の再実装（オプション）
現在のシンプルな設計を維持しつつ、以下を追加可能：

1. **学習履歴の分析**: WordScoreStore から正答率の低い単語を抽出
2. **優先度付き出題**: 正答率に応じて出題頻度を調整
3. **間隔反復学習**: 時間経過を考慮した再出題

---

**最終更新**: 2025年10月28日  
**復元可能性**: ★★★★★（完全復元可能）
