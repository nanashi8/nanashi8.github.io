# 学習結果（CSV別・単語別の成績表示）

**最終更新: 2025-10-19**

この文書は、「学習結果」画面の編集・実装ガイドです。

## 概要

### 何を実現しているか
- CSV別の学習成績表示（教材ごとの統計）
- 単語別の学習成績表示（各単語の正答率・出題回数）
- 学習履歴の可視化
- 成績データの永続化

## 画面構成

### セグメント切り替え
```
[CSV別] [単語別]
```

### CSV別表示
```
┌─────────────────────────┐
│ 中学英単語.csv           │
│ 正答率: 85%              │
│ 問題数: 50/500           │
│ 最終学習: 2025-10-19     │
├─────────────────────────┤
│ 高校単語.csv             │
│ 正答率: 72%              │
│ 問題数: 30/1000          │
│ 最終学習: 2025-10-18     │
└─────────────────────────┘
```

### 単語別表示
```
┌─────────────────────────┐
│ example                  │
│ 正答率: 100% (3/3)       │
│ 連続正解: 3回            │
│ 習熟度: ★★★★★         │
├─────────────────────────┤
│ practice                 │
│ 正答率: 67% (2/3)        │
│ 連続正解: 1回            │
│ 習熟度: ★★★☆☆         │
└─────────────────────────┘
```

## 関係するファイル

### 画面
- **ScoreView.swift** - セグメント切り替え
- **QuizResultsByCSVView.swift** - CSV別表示
- **QuizResultsDetailView.swift** - CSV詳細表示
- **WordScoresView.swift** - 単語別表示

### ストア（状態管理）
- **ScoreStore.swift** - CSV別成績の永続化
  - `QuizResult` - 1回のクイズ結果
  - `addResult()` - 結果の追加
  - `results(for:)` - 特定CSVの結果一覧
- **WordScoreStore.swift** - 単語別成績の永続化
  - `WordScore` - 単語ごとの成績
  - `recordResult()` - 回答結果の記録
  - `score(for:)` - 特定単語の成績取得

### データモデル
- **QuestionItem.swift** - 単語データ

## 状態管理

### ScoreStore の構造
```swift
class ScoreStore: ObservableObject {
    @Published var results: [QuizResult] = []
    
    struct QuizResult: Codable, Identifiable {
        let id: UUID
        let date: Date
        let total: Int      // 総問題数
        let correct: Int    // 正解数
        let settings: QuizSettingsModel
        
        var accuracy: Double {
            guard total > 0 else { return 0 }
            return Double(correct) / Double(total)
        }
    }
    
    func addResult(_ result: QuizResult) {
        results.append(result)
        save()
    }
    
    func results(for csvName: String) -> [QuizResult] {
        results.filter { $0.settings.selectedCSV == csvName }
    }
}
```

### WordScoreStore の構造
```swift
class WordScoreStore: ObservableObject {
    @Published private var scores: [UUID: WordScore] = [:]
    
    struct WordScore {
        var correctCount: Int = 0
        var totalAttempts: Int = 0
        
        var accuracy: Double {
            guard totalAttempts > 0 else { return 0 }
            return Double(correctCount) / Double(totalAttempts)
        }
    }
    
    func recordResult(itemID: UUID, correct: Bool) {
        var score = scores[itemID, default: WordScore()]
        score.totalAttempts += 1
        if correct { score.correctCount += 1 }
        scores[itemID] = score
        save()
    }
    
    func score(for itemID: UUID) -> WordScore {
        scores[itemID, default: WordScore()]
    }
}
```

## 編集時の注意点

### CSV別集計の実装
**実装箇所**: QuizResultsByCSVView

```swift
func aggregateByCSV() -> [(csvName: String, accuracy: Double, count: Int)] {
    let grouped = Dictionary(grouping: scoreStore.results) { 
        $0.settings.selectedCSV ?? "不明" 
    }
    
    return grouped.map { csvName, results in
        let totalCorrect = results.reduce(0) { $0 + $1.correct }
        let totalQuestions = results.reduce(0) { $0 + $1.total }
        let accuracy = totalQuestions > 0 ? 
            Double(totalCorrect) / Double(totalQuestions) : 0.0
        
        return (csvName, accuracy, results.count)
    }.sorted { $0.csvName < $1.csvName }
}
```

**チェックポイント**:
- [ ] 空のCSV名を「不明」として扱う
- [ ] 正答率の計算が正確
- [ ] ソートが適切（CSV名順など）

### 単語別表示の実装
**実装箇所**: WordScoresView

```swift
var sortedWords: [(item: QuestionItem, score: WordScore)] {
    items.map { item in
        (item, wordScoreStore.score(for: item.id))
    }
    .filter { $0.score.totalAttempts > 0 }  // 未出題を除外
    .sorted { $0.score.accuracy < $1.score.accuracy }  // 正答率の低い順
}
```

**チェックポイント**:
- [ ] 未出題の単語を除外
- [ ] ソート順が適切（苦手順など）
- [ ] 大量データでもパフォーマンス劣化しない

### 永続化の注意点
**実装箇所**: save() メソッド

```swift
func save() {
    let encoder = JSONEncoder()
    if let data = try? encoder.encode(results) {
        UserDefaults.standard.set(data, forKey: "QuizResults")
    }
}

func load() {
    guard let data = UserDefaults.standard.data(forKey: "QuizResults") else {
        return
    }
    let decoder = JSONDecoder()
    if let loaded = try? decoder.decode([QuizResult].self, from: data) {
        results = loaded
    }
}
```

**チェックポイント**:
- [ ] エンコード/デコードが成功する
- [ ] アプリ起動時に自動的に load() が呼ばれる
- [ ] データサイズが大きくなっても問題ない

## テスト観点

### 基本動作
- [ ] CSV別/単語別の切り替えが動作する
- [ ] クイズ完了後に成績が反映される
- [ ] 正答率が正確に計算される
- [ ] データが永続化される

### データの整合性
- [ ] 同じCSVで複数回クイズをした場合の集計
- [ ] 同じ単語が複数回出題された場合の更新
- [ ] 削除したCSVの成績が残る（履歴として）

### UI/UX
- [ ] 成績が見やすく表示される
- [ ] ソート機能が動作する
- [ ] フィルタ機能が動作する（将来実装）

### パフォーマンス
- [ ] 1000件の履歴でも快適に表示
- [ ] 集計処理が高速
- [ ] メモリ使用量が適切

## よくある編集パターン

### グラフ表示の追加
```swift
import Charts

struct AccuracyChartView: View {
    let results: [QuizResult]
    
    var body: some View {
        Chart {
            ForEach(results.prefix(10)) { result in
                BarMark(
                    x: .value("日付", result.date, unit: .day),
                    y: .value("正答率", result.accuracy * 100)
                )
            }
        }
        .chartYAxis {
            AxisMarks(position: .leading) { value in
                AxisValueLabel {
                    Text("\(value.as(Double.self) ?? 0, specifier: "%.0f")%")
                }
            }
        }
    }
}
```

### フィルタ機能の追加
```swift
@State private var minAccuracy: Double = 0.0
@State private var dateRange: ClosedRange<Date>?

var filteredResults: [QuizResult] {
    var filtered = scoreStore.results
    
    // 正答率フィルタ
    filtered = filtered.filter { $0.accuracy >= minAccuracy }
    
    // 日付範囲フィルタ
    if let range = dateRange {
        filtered = filtered.filter { range.contains($0.date) }
    }
    
    return filtered
}
```

### エクスポート機能
```swift
func exportToCSV() -> String {
    var csv = "日付,CSV名,正解数,総問題数,正答率\n"
    
    for result in scoreStore.results {
        let line = """
        \(result.date),\
        \(result.settings.selectedCSV ?? "不明"),\
        \(result.correct),\
        \(result.total),\
        \(Int(result.accuracy * 100))%
        """
        csv += line + "\n"
    }
    
    return csv
}
```

## トラブルシューティング

### 成績が表示されない
- クイズを完了させたか確認
- ScoreStore.addResult() が呼ばれているか確認
- load() が正常に動作しているか確認

### 正答率が正しくない
- 計算式を確認（correct / total）
- 0除算のエラーハンドリングを確認

### データが消える
- save() のタイミングを確認
- UserDefaults のキー名を確認
- データサイズの上限を確認

## 関連ドキュメント
- `.copilot/structure-map.md` - アーキテクチャ全体像
- `01_クイズ機能_仕様書.md` - 成績記録の実装
- `ScoreStore.swift` - 永続化の実装詳細
