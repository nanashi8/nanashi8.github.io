# クイズUIコンポーネント_仕様書

**最終更新: 2025-10-25**

この文書は、クイズ画面で使用されるUIコンポーネント（QuizComponents/）の復元・実装ガイドです。

## ⚠️ 重要: 復元のための必須情報

これらのコンポーネントが喪失した場合、このドキュメントから完全に復元できます。

---

## 概要

### 何を実現しているか
QuizView.swiftから以下のUIコンポーネントを分離し、再利用可能で保守性の高い構造を実現：

1. **QuestionCardView**: 問題カード表示
2. **ChoiceCardView**: 選択肢カード表示
3. **DontKnowCardView**: 「分からない」ボタン
4. **QuizStatisticsView**: 統計情報表示
5. **QuizNavigationButtonsView**: ナビゲーションボタン

### なぜコンポーネント分離したか
- **QuizView.swiftの肥大化防止**: 1100行から適切なサイズに管理
- **可読性の向上**: 各コンポーネントの責務が明確
- **再利用性**: 他の画面でも使用可能
- **テスト容易性**: 個別にプレビュー・テスト可能

---

## ファイル構成

```
QuizComponents/
├── QuestionCardView.swift           # 問題カード
├── ChoiceCardView.swift             # 選択肢カード
├── DontKnowCardView.swift           # 分からないボタン
├── QuizStatisticsView.swift         # 統計情報
└── QuizNavigationButtonsView.swift  # ナビゲーション
```

---

## 1. QuestionCardView（問題カード）

### 責務
- 問題（語句）の表示
- 読みの表示
- 難易度バッジの表示
- 過去の正答率の表示

### データ構造

```swift
struct QuestionCardView: View {
    let item: QuestionItem
    @EnvironmentObject var wordScoreStore: WordScoreStore
}
```

### UI構造

```
┌────────────────────────────────┐
│ apple              [初級]      │
│ アップル                        │
│ 正答率: 75% ・ 過去3回          │
└────────────────────────────────┘
```

### 実装

```swift
struct QuestionCardView: View {
    let item: QuestionItem
    @EnvironmentObject var wordScoreStore: WordScoreStore
    
    var body: some View {
        let ws = wordScoreStore.score(for: item.id)
        
        SectionCard {
            VStack(alignment: .leading, spacing: 6) {
                HStack(alignment: .firstTextBaseline) {
                    Text(item.term)
                        .font(.title2)
                        .bold()
                    Spacer()
                    if !item.difficulty.isEmpty {
                        DifficultyBadge(text: item.difficulty)
                    }
                }
                
                if !item.reading.isEmpty {
                    Text(item.reading)
                        .font(.subheadline)
                        .foregroundColor(.secondary)
                }
                
                // 過去の正答率
                HStack(spacing: 8) {
                    if ws.attempts > 0 {
                        Text("正答率: \(Int(round(ws.accuracy * 100)))% ・ 過去\(ws.attempts)回")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    } else {
                        Text("正答率: データなし")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
            }
        }
        .padding(.top, 4)
        .frame(maxWidth: .infinity)
    }
}
```

### 依存コンポーネント

- **SectionCard**: `Utils/StyleGuide.swift`
- **DifficultyBadge**: `Utils/StyleGuide.swift`
- **WordScoreStore**: `Stores/WordScoreStore.swift`

---

## 2. ChoiceCardView（選択肢カード）

### 責務
- 選択肢テキストの表示
- 選択状態の視覚的フィードバック
- 正誤判定後の色変化
- 解説の表示（回答後）

### データ構造

```swift
struct ChoiceCardView: View {
    let id: UUID
    let text: String
    let explanation: String?  // 回答後の解説
    let selectedID: UUID?
    let correctID: UUID?
    let onSelect: (UUID) -> Void
}
```

### 状態遷移

```
[未回答]
  ↓ タップ
[選択済み]
  ↓ 判定
[正解] または [誤答]
```

### 色の定義

| 状態 | 背景色 | テキスト色 |
|---|---|---|
| 未回答 | secondarySystemBackground | primary |
| 選択（正解） | green.opacity(0.9) | white |
| 選択（誤答） | red.opacity(0.9) | white |
| 正解（未選択） | green.opacity(0.6) | white |
| その他（回答後） | secondarySystemBackground.opacity(0.6) | white |

### 実装

```swift
struct ChoiceCardView: View {
    let id: UUID
    let text: String
    let explanation: String?
    let selectedID: UUID?
    let correctID: UUID?
    let onSelect: (UUID) -> Void

    var body: some View {
        let answered = (selectedID != nil)
        let isChosen = (selectedID != nil && selectedID == id)
        let isCorrect = (correctID != nil && correctID == id)

        // 背景色の決定
        let bgColor: Color = {
            if !answered { return Color(uiColor: .secondarySystemBackground) }
            if isChosen && isCorrect { return Color.green.opacity(0.9) }
            if isChosen && !isCorrect { return Color.red.opacity(0.9) }
            if isCorrect { return Color.green.opacity(0.6) }
            return Color(uiColor: .secondarySystemBackground).opacity(0.6)
        }()

        let textColor: Color = answered ? .white : .primary
        let textFont: Font = answered ? .body.weight(.semibold) : .body

        SectionCard(backgroundColor: bgColor) {
            VStack(alignment: .leading, spacing: 8) {
                HStack(spacing: 12) {
                    Text(text)
                        .foregroundColor(textColor)
                        .font(textFont)
                        .lineLimit(2)

                    Spacer()

                    // チェックマーク/×マークの表示
                    if answered && isChosen {
                        Image(systemName: isCorrect ? "checkmark.circle.fill" : "xmark.circle.fill")
                            .foregroundColor(textColor)
                    }
                }

                // 解説の表示（回答後のみ）
                if answered, let expl = explanation, !expl.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty {
                    Text(expl)
                        .font(.caption)
                        .foregroundColor(textColor.opacity(0.9))
                        .lineLimit(nil)
                        .fixedSize(horizontal: false, vertical: true)
                }
            }
        }
        .frame(maxWidth: .infinity)
        .contentShape(Rectangle())
        .onTapGesture {
            if selectedID == nil {
                onSelect(id)
            }
        }
    }
}
```

### タップ動作

- **未回答時**: `onSelect(id)`を呼び出し
- **回答後**: タップ無効（再選択不可）

---

## 3. DontKnowCardView（分からないボタン）

### 責務
- 「分からない」選択肢の表示
- 選択時の視覚的フィードバック
- 常に誤答として扱う

### データ構造

```swift
struct DontKnowCardView: View {
    let id: UUID
    let selectedID: UUID?
    let correctAnswerID: UUID?
    let onSelect: (UUID) -> Void
}
```

### 色の定義

| 状態 | 背景色 | テキスト色 |
|---|---|---|
| 未回答 | secondarySystemBackground | primary |
| 選択済み | red.opacity(0.9) | white |
| 回答後（未選択） | secondarySystemBackground.opacity(0.6) | white |

### 実装

```swift
struct DontKnowCardView: View {
    let id: UUID
    let selectedID: UUID?
    let correctAnswerID: UUID?
    let onSelect: (UUID) -> Void
    
    var body: some View {
        let answered = (selectedID != nil)
        let isChosen = (selectedID != nil && selectedID == id)
        
        let bgColor: Color = {
            if !answered { return Color(uiColor: .secondarySystemBackground) }
            if isChosen { return Color.red.opacity(0.9) }
            return Color(uiColor: .secondarySystemBackground).opacity(0.6)
        }()
        
        let textColor: Color = answered ? .white : .primary
        let textFont: Font = answered ? .body.weight(.semibold) : .body
        
        SectionCard(backgroundColor: bgColor) {
            HStack(spacing: 12) {
                Text("分からない")
                    .foregroundColor(textColor)
                    .font(textFont)
                    .lineLimit(2)
                
                Spacer()
                
                if let _ = selectedID {
                    if isChosen {
                        Image(systemName: "xmark.circle.fill")
                            .foregroundColor(textColor)
                    }
                }
            }
        }
        .frame(maxWidth: .infinity)
        .contentShape(Rectangle())
        .onTapGesture {
            if selectedID == nil {
                onSelect(id)
            }
        }
    }
}
```

### QuizViewでの使用

```swift
// QuizView.swift内

DontKnowCardView(
    id: dontKnowID,
    selectedID: selectedChoiceID,
    correctAnswerID: correctAnswerID,
    onSelect: { _ in giveUp() }
)
```

---

## 4. QuizStatisticsView（統計情報）

### 責務
- CSV名と学習モードの表示
- 正答率の表示
- 合格数の表示（アニメーション付き）
- 総出題数の表示（アニメーション付き）
- バッチサイズの表示

### データ構造

```swift
struct QuizStatisticsView: View {
    let csvName: String
    let learningMode: String
    let accuracy: Int
    let passedCount: Int
    let totalCount: Int
    let batchSize: Int
    
    @Binding var shouldAnimatePassedCount: Bool
    @Binding var shouldAnimateTotalCount: Bool
}
```

### UI構造

```
┌────────────────────────────────────────┐
│ CSV: 中学英単語.csv  学習モード: 通常  │
│ 正答率: 85%  合格数: 12 ✨             │
│ 総出題: 15 ✨  バッチサイズ: 10       │
└────────────────────────────────────────┘
```

### アニメーション仕様

#### 合格数の光るエフェクト

```swift
Text("合格数: \(passedCount)")
    .foregroundColor(shouldAnimatePassedCount ? .green : .secondary)
    .scaleEffect(shouldAnimatePassedCount ? 1.3 : 1.0)
    .animation(.spring(response: 0.4, dampingFraction: 0.5), value: shouldAnimatePassedCount)
```

- **トリガー**: `batchCorrect`が増加したとき
- **色**: 緑色
- **スケール**: 1.3倍
- **持続時間**: 1.2秒
- **アニメーション**: スプリング

#### 総出題数の光るエフェクト

```swift
Text("総出題: \(totalCount)")
    .foregroundColor(shouldAnimateTotalCount ? .orange : .secondary)
    .scaleEffect(shouldAnimateTotalCount ? 1.3 : 1.0)
    .animation(.spring(response: 0.4, dampingFraction: 0.5), value: shouldAnimateTotalCount)
```

- **トリガー**: `questionCount`が増加したとき
- **色**: オレンジ色
- **スケール**: 1.3倍
- **持続時間**: 1.2秒
- **アニメーション**: スプリング

### 実装

```swift
struct QuizStatisticsView: View {
    let csvName: String
    let learningMode: String
    let accuracy: Int
    let passedCount: Int
    let totalCount: Int
    let batchSize: Int
    
    @Binding var shouldAnimatePassedCount: Bool
    @Binding var shouldAnimateTotalCount: Bool
    
    var body: some View {
        SectionCard {
            VStack(alignment: .leading, spacing: 8) {
                // CSV名と学習モード
                HStack {
                    Text("CSV:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    Text(csvName)
                        .font(.caption)
                    Spacer()
                    Text("学習モード:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    Text(learningMode)
                        .font(.caption)
                        .foregroundColor(.blue)
                }
                
                // 統計情報
                HStack(spacing: 12) {
                    Text("正答率: \(accuracy)%")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Text("合格数: \(passedCount)")
                        .font(.caption)
                        .foregroundColor(shouldAnimatePassedCount ? .green : .secondary)
                        .scaleEffect(shouldAnimatePassedCount ? 1.3 : 1.0)
                        .animation(.spring(response: 0.4, dampingFraction: 0.5), value: shouldAnimatePassedCount)
                    
                    Text("総出題: \(totalCount)")
                        .font(.caption)
                        .foregroundColor(shouldAnimateTotalCount ? .orange : .secondary)
                        .scaleEffect(shouldAnimateTotalCount ? 1.3 : 1.0)
                        .animation(.spring(response: 0.4, dampingFraction: 0.5), value: shouldAnimateTotalCount)
                    
                    Spacer()
                    
                    Text("バッチサイズ: \(batchSize)")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
        }
        .frame(maxWidth: .infinity)
    }
}
```

### QuizViewでの使用

```swift
// QuizView.swift内

QuizStatisticsView(
    csvName: currentCSV.name ?? "不明",
    learningMode: learningModeDisplayName,
    accuracy: questionCount > 0 ? Int(round(Double(score) / Double(questionCount) * 100)) : 0,
    passedCount: batchCorrect,
    totalCount: questionCount,
    batchSize: batchSize,
    shouldAnimatePassedCount: $shouldAnimatePassedCount,
    shouldAnimateTotalCount: $shouldAnimateTotalCount
)
```

---

## 5. QuizNavigationButtonsView（ナビゲーション）

### 責務
- 「前へ」ボタンの表示と制御
- 「次へ」ボタンの表示と制御
- ボタンの有効/無効状態の管理

### データ構造

```swift
struct QuizNavigationButtonsView: View {
    let canGoPrevious: Bool
    let canGoNext: Bool
    let onPrevious: () -> Void
    let onNext: () -> Void
}
```

### UI構造

```
┌──────────────┐  ┌──────────────┐
│ ← 前へ       │  │ 次へ →       │
└──────────────┘  └──────────────┘
```

### ボタンスタイル

- **前へ**: `.buttonStyle(.bordered)` - 枠線のみ
- **次へ**: `.buttonStyle(.borderedProminent)` - 塗りつぶし

### 実装

```swift
struct QuizNavigationButtonsView: View {
    let canGoPrevious: Bool
    let canGoNext: Bool
    let onPrevious: () -> Void
    let onNext: () -> Void
    
    var body: some View {
        HStack(spacing: 12) {
            Button(action: onPrevious) {
                HStack {
                    Image(systemName: "chevron.left")
                    Text("前へ")
                }
                .frame(maxWidth: .infinity)
            }
            .buttonStyle(.bordered)
            .disabled(!canGoPrevious)
            
            Button(action: onNext) {
                HStack {
                    Text("次へ")
                    Image(systemName: "chevron.right")
                }
                .frame(maxWidth: .infinity)
            }
            .buttonStyle(.borderedProminent)
            .disabled(!canGoNext)
        }
    }
}
```

### 有効/無効の条件

#### 前へボタン
- **有効**: `historyIndex > 0`
- **無効**: `historyIndex <= 0`（履歴の先頭）

#### 次へボタン
- **有効**: `selectedChoiceID != nil`（回答済み）
- **無効**: `selectedChoiceID == nil`（未回答）

---

## コンポーネント間の依存関係

```
QuizView.swift
├─ QuizStatisticsView
│  └─ SectionCard (StyleGuide)
├─ QuestionCardView
│  ├─ SectionCard (StyleGuide)
│  ├─ DifficultyBadge (StyleGuide)
│  └─ WordScoreStore (EnvironmentObject)
├─ ChoiceCardView (×4)
│  └─ SectionCard (StyleGuide)
├─ DontKnowCardView
│  └─ SectionCard (StyleGuide)
└─ QuizNavigationButtonsView
```

---

## テスト観点

### QuestionCardView
- [ ] 語句が正しく表示される
- [ ] 読みが正しく表示される
- [ ] 難易度バッジが表示される
- [ ] 正答率が正しく計算される
- [ ] データなしの場合の表示

### ChoiceCardView
- [ ] 未回答時の色
- [ ] 正解時の色（選択/未選択）
- [ ] 誤答時の色
- [ ] 解説の表示（回答後のみ）
- [ ] タップで選択できる
- [ ] 回答後はタップ無効

### DontKnowCardView
- [ ] 未回答時の色
- [ ] 選択時の色（赤）
- [ ] ×マークの表示
- [ ] タップで選択できる

### QuizStatisticsView
- [ ] すべての統計が表示される
- [ ] アニメーションが動作する（合格数）
- [ ] アニメーションが動作する（総出題数）
- [ ] 1.2秒で元に戻る

### QuizNavigationButtonsView
- [ ] 前へボタンの有効/無効
- [ ] 次へボタンの有効/無効
- [ ] タップでコールバック呼び出し

---

## パフォーマンス考慮

### レンダリング最適化

各コンポーネントは軽量で、頻繁な再描画でもパフォーマンス問題なし：

- **QuestionCardView**: 単純なテキスト表示
- **ChoiceCardView**: 条件分岐あり、但し軽量
- **QuizStatisticsView**: アニメーションあり、但しBindingのみ更新
- **QuizNavigationButtonsView**: ボタン2つのみ

### メモリ使用量

すべてのコンポーネントはstructで、値型のため軽量。

---

## 復元手順

コンポーネントが喪失した場合の復元手順：

1. **QuizComponents/**ディレクトリを作成
2. 各コンポーネントファイルを作成（このドキュメントのコード参照）
3. **StyleGuide.swift**の依存を確認（SectionCard, DifficultyBadge）
4. **QuizView.swift**から各コンポーネントを参照
5. プレビューで個別に動作確認
6. QuizView全体で統合テスト

---

## 関連ドキュメント

- `01_クイズ機能_仕様書.md` - QuizView全体の仕様
- `Utils/StyleGuide.swift` - SectionCard等の定義
- `docs/COMPREHENSIVE_SPECIFICATION.md` - アーキテクチャ全体

---

**最終更新**: 2025-10-25  
**ディレクトリ**: `QuizComponents/`  
**依存**: `StyleGuide.swift`, `WordScoreStore.swift`
