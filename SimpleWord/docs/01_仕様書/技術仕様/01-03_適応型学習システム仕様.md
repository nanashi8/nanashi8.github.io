# 01-03 適応型学習システム仕様

**文書番号**: 01-03  
**最終更新**: 2025-11-05  
**バージョン**: 1.0  
**ステータス**: 最新

---

## 📋 目次

1. [概要](#概要)
2. [記憶定着段階モデル](#記憶定着段階モデル)
3. [学習履歴管理](#学習履歴管理)
4. [適応型スケジューラ](#適応型スケジューラ)
5. [学習モード](#学習モード)
6. [アルゴリズム詳細](#アルゴリズム詳細)
7. [実装ガイドライン](#実装ガイドライン)

---

## 🎯 概要

### 目的

SimpleWordの適応型学習システムは、**脳科学と記憶理論に基づく科学的アプローチ**により、ユーザーの学習効率を最大化します。

### 主要機能

1. **6段階の記憶定着度管理**
   - 未学習 → 初回接触 → 短期記憶 → 中期記憶 → 長期記憶 → 習熟済み

2. **SM-2アルゴリズムベースの出題間隔調整**
   - 正答率・応答時間・連続正解数に基づく動的な間隔調整

3. **学習モード別の最適化**
   - 通常モード：バランス型学習
   - 復習モード：短期・中期記憶を重点復習
   - 補習モード：苦手単語を集中学習

4. **個別最適化**
   - ユーザーの学習ペース・忘却傾向を分析
   - 単語ごとの難易度を動的調整

---

## 📊 記憶定着段階モデル

### MemoryStage定義

記憶定着の進行を6段階で表現します。

| 段階 | 名称 | 説明 | 推奨間隔 | 繰り返し回数 |
|-----|------|------|---------|-----------|
| 0 | `unseen` | 未学習 | - | 3回 |
| 1 | `initial` | 初回接触 | 即時 | 3回 |
| 2 | `shortTerm` | 短期記憶 | 5分 | 2回 |
| 3 | `midTerm` | 中期記憶 | 1日 | 2回 |
| 4 | `longTerm` | 長期記憶 | 7日 | 1回 |
| 5 | `mastered` | 習熟済み | 30日+ | 1回 |

### 判定ロジック

**実装場所**: `Features/Study/Domain/MemoryStage.swift`（想定）

```swift
enum MemoryStage: Int, Codable {
    case unseen = 0      // 未学習
    case initial = 1     // 初回接触（試行回数 <= 2）
    case shortTerm = 2   // 短期記憶（試行回数 <= 5 || 間隔 < 5分）
    case midTerm = 3     // 中期記憶（試行回数 <= 10 || 間隔 < 1日）
    case longTerm = 4    // 長期記憶（試行回数 > 10 && 間隔 >= 1日）
    case mastered = 5    // 習熟済み（正答率 >= 90% && 連続正解 >= 5）
    
    /// StudyRecordから記憶段階を判定
    static func determine(from record: StudyRecord) -> MemoryStage {
        // 習熟済み判定
        if record.mastered 
           && record.smoothedAccuracy >= 0.9 
           && record.correctStreak >= 5 {
            return .mastered
        }
        
        let attempts = record.totalAttempts
        let interval = record.interval
        
        if attempts == 0 { return .unseen }
        if attempts <= 2 { return .initial }
        if attempts <= 5 || interval < 300 { return .shortTerm }
        if attempts <= 10 || interval < 86400 { return .midTerm }
        return .longTerm
    }
}
```

### 各段階の特性

#### 1. 未学習 (unseen)
- **試行回数**: 0回
- **特徴**: まだ一度も学習していない単語
- **出題優先度**: 最高（新規学習を促進）

#### 2. 初回接触 (initial)
- **試行回数**: 1〜2回
- **特徴**: 学習を始めたばかりの段階
- **出題優先度**: 高（早期定着を促進）
- **繰り返し**: 同一セッション内で3回出題

#### 3. 短期記憶 (shortTerm)
- **試行回数**: 3〜5回
- **間隔**: 5分未満
- **特徴**: 短期記憶として保持されている段階
- **出題優先度**: 中〜高（忘却防止）

#### 4. 中期記憶 (midTerm)
- **試行回数**: 6〜10回
- **間隔**: 5分〜1日
- **特徴**: 記憶が定着し始めた段階
- **出題優先度**: 中（定着確認）

#### 5. 長期記憶 (longTerm)
- **試行回数**: 11回以上
- **間隔**: 1日以上
- **特徴**: 長期記憶として定着
- **出題優先度**: 低〜中（維持確認）

#### 6. 習熟済み (mastered)
- **条件**: 正答率90%以上 & 連続正解5回以上
- **特徴**: 完全に習得済み
- **出題優先度**: 最低（復習のみ）

---

## 📝 学習履歴管理

### StudyRecord構造

**実装場所**: `Features/Study/Domain/StudyRecord.swift`（想定）

各単語の学習履歴を保存し、次回出題タイミングを計算します。

```swift
struct StudyRecord: Codable, Identifiable {
    let id: UUID                    // 単語ID
    var totalAttempts: Int          // 総試行回数
    var correctCount: Int           // 正解回数
    var wrongCount: Int             // 誤答回数
    var correctStreak: Int          // 連続正解数
    var wrongStreak: Int            // 連続誤答数
    var lastReviewDate: Date?       // 最終復習日時
    var nextReviewDate: Date?       // 次回復習予定日時
    var interval: TimeInterval      // 出題間隔（秒）
    var ease: Double                // 容易度係数（1.1〜3.0）
    var smoothedAccuracy: Double    // 平滑化された正答率
    var mastered: Bool              // 習熟フラグ
    
    // 学習ペース分析
    var learningPace: Double        // 学習速度（0.5〜2.0）
    var forgettingRate: Double      // 忘却率（0.0〜1.0）
    var alternationTendency: Double // 交互傾向（0.0〜1.0）
}
```

### 主要プロパティ

| プロパティ | 型 | 説明 | 範囲 |
|-----------|-----|------|------|
| `totalAttempts` | Int | 総試行回数 | 0〜 |
| `correctStreak` | Int | 連続正解数 | 0〜 |
| `interval` | TimeInterval | 出題間隔（秒） | 0〜 |
| `ease` | Double | 容易度係数 | 1.1〜3.0 |
| `smoothedAccuracy` | Double | 平滑化正答率 | 0.0〜1.0 |
| `learningPace` | Double | 学習速度 | 0.5〜2.0 |
| `forgettingRate` | Double | 忘却率 | 0.0〜1.0 |

---

## 🧠 適応型スケジューラ

### AdaptiveScheduler責務

**実装場所**: `Features/Study/Logic/AdaptiveScheduler.swift`（想定）

ユーザーの学習履歴を分析し、最も効果的な出題順序を決定します。

### 主要メソッド

#### 1. scheduleNextBatch

次のバッチ（出題セット）を生成します。

```swift
class AdaptiveScheduler {
    /// 次のバッチをスケジュール
    /// - Parameters:
    ///   - itemIDs: 候補となる単語IDリスト
    ///   - count: バッチサイズ
    ///   - mode: 学習モード
    /// - Returns: 優先度順にソートされた単語IDリスト
    func scheduleNextBatch(
        from itemIDs: [UUID], 
        size count: Int,
        mode: LearningMode
    ) -> [UUID] {
        // 1. 各単語の優先度スコアを計算
        let scored = itemIDs.map { id in
            (id: id, score: calculatePriority(for: id, mode: mode))
        }
        
        // 2. スコア順にソート
        let sorted = scored.sorted { $0.score > $1.score }
        
        // 3. 上位count件を返す
        return Array(sorted.prefix(count).map(\.id))
    }
}
```

#### 2. calculatePriority

単語の出題優先度を計算します。

```swift
/// 優先度スコアを計算
/// - Parameters:
///   - itemID: 単語ID
///   - mode: 学習モード
/// - Returns: 優先度スコア（高いほど優先）
private func calculatePriority(
    for itemID: UUID, 
    mode: LearningMode
) -> Double {
    guard let record = studyRecords[itemID] else { 
        return 1000.0  // 未学習は最高優先度
    }
    
    var score = 0.0
    
    // 基本スコア計算
    score += dueScore(record)          // 期日超過スコア
    score += accuracyPenalty(record)   // 正答率ペナルティ
    score += streakBonus(record)       // 連続スコア
    score += easeWeight(record)        // 容易度重み
    score += recallEstimate(record)    // 想起確率推定
    
    // 学習モード別調整
    score *= modeMultiplier(record, mode)
    
    return score
}
```

#### 3. record

学習結果を記録し、StudyRecordを更新します。

```swift
/// 学習結果を記録
/// - Parameters:
///   - itemID: 単語ID
///   - result: 学習結果（correct/wrong/gaveUp）
///   - responseTime: 応答時間（秒）
func record(
    itemID: UUID, 
    result: ReviewOutcome, 
    responseTime: TimeInterval
) {
    var record = studyRecords[itemID] ?? StudyRecord(id: itemID)
    
    // SM-2アルゴリズムで間隔・容易度を更新
    record.apply(outcome: result, responseTime: responseTime)
    
    studyRecords[itemID] = record
    
    // 永続化
    saveRecords()
}
```

---

## 🎓 学習モード

### LearningMode定義

```swift
enum LearningMode: String, Codable {
    case normal       // 通常モード
    case review       // 復習モード
    case remediation  // 補習モード
}
```

### 各モードの特性

#### 1. 通常モード (normal)

**目的**: 新規学習と復習をバランスよく実施

**優先度調整**:
- 未学習単語: 高優先度
- 期日超過単語: 中〜高優先度
- 短期・中期記憶: 中優先度
- 長期記憶・習熟済み: 低優先度

**出題比率**:
- 新規：40%
- 復習：60%

#### 2. 復習モード (review)

**目的**: 短期・中期記憶の定着を促進

**優先度調整**:
- 短期記憶 (shortTerm): 最高優先度 (×3.0)
- 中期記憶 (midTerm): 高優先度 (×2.0)
- その他: 通常優先度 (×1.0)

**フィルタ**:
- 習熟済み単語を除外

#### 3. 補習モード (remediation)

**目的**: 苦手単語を集中的に学習

**優先度調整**:
- 正答率 < 50%: 最高優先度 (×4.0)
- 連続誤答 >= 2: 高優先度 (×2.0)
- 長期未復習: 高優先度 (×2.0)

**フィルタ**:
- 正答率60%以上の単語を除外

---

## 🔬 アルゴリズム詳細

### SM-2アルゴリズム実装

**実装場所**: `StudyRecord.apply(outcome:responseTime:)`

#### 容易度（ease）の更新

```swift
// 品質スコアの計算
let quality: Double = {
    switch outcome {
    case .correct:
        return responseTime < 3.0 ? 5.0 : 4.0  // 速い正解は5、遅い正解は4
    case .wrong:
        return 2.0
    case .gaveUp:
        return 1.0
    }
}()

// 容易度の更新
let easeDelta = 0.06 * (quality - 3.0)
ease = max(1.1, min(3.0, ease + easeDelta))
```

#### 間隔（interval）の更新

**正解時の間隔伸長**:

```swift
if outcome == .correct {
    let streakBonus = min(3, correctStreak)  // 連続正解ボーナス（最大3）
    let growth = (1.2 + 0.12 * Double(streakBonus)) 
                 * ease 
                 * learningPace 
                 * (1.0 - forgettingRate * 0.5)
    
    interval *= growth
    interval = min(interval, 90 * 86400)  // 最大90日
}
```

**誤答時の間隔短縮**:

```swift
if outcome == .wrong || outcome == .gaveUp {
    interval *= 0.5  // 半分に短縮
    interval = max(interval, 60)  // 最小1分
}
```

### 優先度スコア計算式

#### 1. dueScore（期日超過スコア）

```swift
func dueScore(_ record: StudyRecord) -> Double {
    guard let nextDate = record.nextReviewDate else { return 100.0 }
    let overdue = Date().timeIntervalSince(nextDate)
    return overdue > 0 ? overdue / 3600.0 : 0.0  // 時間単位でスコア化
}
```

#### 2. accuracyPenalty（正答率ペナルティ）

```swift
func accuracyPenalty(_ record: StudyRecord) -> Double {
    return (1.0 - record.smoothedAccuracy) * 50.0
}
```

#### 3. streakBonus（連続スコア）

```swift
func streakBonus(_ record: StudyRecord) -> Double {
    if record.wrongStreak > 0 {
        return Double(record.wrongStreak) * 20.0  // 誤答連続でスコア増
    }
    return 0.0
}
```

#### 4. easeWeight（容易度重み）

```swift
func easeWeight(_ record: StudyRecord) -> Double {
    return 1.0 / max(record.ease, 1.1)  // 難しい単語ほど高スコア
}
```

#### 5. recallEstimate（想起確率推定）

忘却曲線に基づく想起確率の推定：

```swift
func recallEstimate(_ record: StudyRecord) -> Double {
    guard let lastDate = record.lastReviewDate else { return 100.0 }
    let timeSince = Date().timeIntervalSince(lastDate)
    let recall = exp(-timeSince / max(record.interval, 1.0))
    return (1.0 - recall) * 30.0  // 忘れそうなほど高スコア
}
```

### バッチ準備の流れ

```
1. 候補選択
   ↓
2. 学習モード別フィルタリング
   ├─ normal: 全候補から選択
   ├─ review: 短期・中期記憶を優先
   └─ remediation: 低正答率を優先
   ↓
3. 優先度スコア計算
   ├─ 期日超過スコア
   ├─ 正答率ペナルティ
   ├─ 連続スコア
   ├─ 容易度重み
   └─ 想起確率推定
   ↓
4. スコア順ソート
   ↓
5. 上位N件を選択
   ↓
6. 記憶段階別の繰り返し回数設定
   ├─ unseen/initial: 3回
   ├─ shortTerm/midTerm: 2回
   └─ longTerm/mastered: 1回
   ↓
7. ラウンドロビン配置
   （同じ単語が連続しないように分散）
```

---

## 🛠️ 実装ガイドライン

### 段階的な有効化

デバッグフラグで機能を段階的に有効化できます：

```swift
// QuizView内のデバッグフラグ
private let enableMemoryTracking = true      // 記憶段階追跡
private let enableAdaptiveScheduling = true  // 適応型スケジューリング
```

### フェーズ別実装

#### フェーズ1: 基本機能（従来）
- `enableMemoryTracking = false`
- `enableAdaptiveScheduling = false`
- 既存のランダム出題

#### フェーズ2: 記憶追跡のみ
- `enableMemoryTracking = true`
- `enableAdaptiveScheduling = false`
- 記憶段階の統計表示
- 繰り返し回数の最適化

#### フェーズ3: 完全な適応型学習
- `enableMemoryTracking = true`
- `enableAdaptiveScheduling = true`
- 記憶追跡 + 適応型スケジューラによる最適な出題順序

### データ永続化

**保存場所**: `FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)`

**ファイル名**: `study_records_{csvName}.json`

**保存タイミング**:
- 各問題の回答後
- セッション終了時
- アプリ終了時

### パフォーマンス考慮事項

1. **バッチサイズ**: 10〜20問が最適
2. **キャッシュ**: StudyRecordをメモリにキャッシュ
3. **非同期保存**: ファイル書き込みはバックグラウンドで実行

---

## 📊 統計情報

### 記憶進捗統計

**実装場所**: `Features/Quiz/Views/MemoryProgressView.swift`（想定）

各記憶段階の単語数と割合を表示：

```swift
struct MemoryProgress {
    let unseen: Int
    let initial: Int
    let shortTerm: Int
    let midTerm: Int
    let longTerm: Int
    let mastered: Int
    
    var total: Int {
        unseen + initial + shortTerm + midTerm + longTerm + mastered
    }
    
    var masteryRate: Double {
        guard total > 0 else { return 0.0 }
        return Double(mastered) / Double(total)
    }
}
```

### 表示内容

- 段階別の単語数
- 各段階の割合（進捗バー）
- 全体の習熟率
- 学習完了までの推定日数

---

## 🔄 今後の拡張

### 追加予定機能

1. **学習履歴グラフ**
   - 日別・週別・月別の学習量
   - 正答率の推移

2. **学習分析**
   - 得意・苦手分野の特定
   - 最適な学習時間帯の推奨

3. **カスタマイズ**
   - 各パラメータの調整
   - 学習アルゴリズムの切り替え

---

## 📚 参考文献

### アルゴリズム

- **SM-2アルゴリズム**: SuperMemo社開発の間隔反復アルゴリズム
- **忘却曲線**: Hermann Ebbinghaus の記憶理論

### 関連ドキュメント

- `docs/ADAPTIVE_LEARNING_GUIDE.md`: 適応型学習実装ガイド
- `docs/04_レポート/02_技術的課題と解決策.md`: 技術的な実装詳細
- `docs/99_アーカイブ/CSV_HEADER_UPDATE_REPORT_20251027.md`: 包括的仕様（アーカイブ）

---

**本仕様書は、実装が損失した際に完全復元できるように記述されています。**
