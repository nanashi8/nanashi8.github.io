# CSV種類別表示順序実装レポート

**作成日**: 2025年10月28日  
**最終更新**: 2025年11月4日（固定列順選択肢生成追記）  
**対応内容**: CSV種類別に最適化された選択肢カード詳細表示の実装

---

## 📋 実装概要

回答後の選択肢カードの詳細表示を、CSV種類（中学歴史、中学古典単語、中学英単語・英会話など）に応じて最適な順序で表示するように実装しました。

**重要**: 選択肢自体は**CSV固定列3（`rawColumns[2]`：意味/和訳/史実名）**から生成されます。これにより、ヘッダ駆動型パーサの影響を受けずに正確な選択肢が表示されます。

---

## ✅ 実装内容

### 1. CSV種類の判定ロジック

**ファイル**: `SimpleWord/QuizComponents/ChoiceCardView.swift`

**CSV種類の定義**:
```swift
private enum CSVType {
    case history    // 中学歴史
    case classical  // 中学古典単語
    case english    // 中学英単語・英熟語・英会話・xcode
}
```

**判定方法**:
CSVヘッダラベル（`headerLabels`）の内容から自動判定：
- **中学歴史**: `term`に「年号」、`reading`に「登場人物」、`meaning`に「史実」が含まれる
- **中学古典単語**: `reading`に「ひらがな」が含まれる
- **中学英単語・英会話**: `reading`に「カタカナ」または「発音」が含まれる、または`meaning`に「和訳」が含まれる

### 2. 各CSV種類別の表示順序

#### パターン1: 中学歴史
**表示順序**: 年号 → 史実名（表示済み） → 解説 → 登場人物 → 関連史実 → 関連分野 & 難易度

**実装関数**: `displayHistoryDetails(_:_:)`

**表示例**:
```
大和政権の成立 ✓

年号: 4世紀頃
解説: 弥生時代後期に各地の豪族が力を持つようになる...
登場人物: 大和朝廷の豪族たち
関連史実: 古墳文化・律令以前の統合過程
関連分野: その他  難易度: 2
```

**特徴**:
- 史実名（meaning）はメインテキストで既に表示されているため詳細では省略
- 時系列がわかる「年号」を最初に表示
- 「解説」で史実の背景を説明
- 「登場人物」で関係者を明示

#### パターン2: 中学古典単語
**表示順序**: 語句 → 発音 → 意味（表示済み） → 用法 → 関連語 → 関連分野 & 難易度

**実装関数**: `displayClassicalDetails(_:_:)`

**表示例**:
```
しみじみとした情趣 ✓

語句: あはれ
読み: あはれ
用法: 感動詞「あはれ」から
関連語: 「もののあはれ」
関連分野: 文学・美学  難易度: 2
```

**特徴**:
- 意味（meaning）はメインテキストで既に表示されているため詳細では省略
- 「語句」と「読み」を並べて表示（古典単語の学習に重要）
- 「用法」として語源等解説を表示（古典では用法が重要）

#### パターン3: 中学英単語・英熟語・英会話・xcode
**表示順序**: 語句(発音) → 和訳（表示済み） → 語源等解説 → 関連語と意味 → 関連分野 & 難易度

**実装関数**: `displayEnglishDetails(_:_:)`

**表示例**:
```
こんにちは！ ✓

語句: Hello! (ハロー)
語源等解説: 古英語の挨拶語
関連語と意味: Hi / やあ
関連分野: 挨拶  難易度: 1
```

**特徴**:
- 和訳（meaning）はメインテキストで既に表示されているため詳細では省略
- **発音を語句の直後に括弧付きで表示**（英語学習に重要）
- 「語源等解説」で単語の由来を説明
- 「関連語と意味」で類似表現を学習

---

## 🎯 共通仕様

### 1. メインテキストとの重複回避
すべてのパターンで、選択肢のメインテキスト（`meaning`）は詳細情報では表示しません。
- **理由**: 情報の重複を避け、画面をすっきりさせるため
- **効果**: ユーザーが必要な情報を見つけやすくなる

### 2. 関連分野と難易度の1行表示
すべてのパターンで、関連分野と難易度を1行にまとめて表示します。
- **理由**: 画面スペースの効率的な利用
- **表示**: `関連分野: その他  難易度: 2`

### 3. 動的なラベル表示
CSVヘッダの実際の列名を優先的に使用します。
- **例**: CSVヘッダが「史実名」なら「史実名:」と表示
- **フォールバック**: ヘッダがない場合はデフォルトラベルを使用

---

## 📊 技術的な実装詳細

### 1. ViewBuilder構文の活用
各表示関数は`@ViewBuilder`を使用し、条件付きレンダリングを実現：
```swift
@ViewBuilder
private func displayHistoryDetails(_ questionItem: QuestionItem, _ textColor: Color) -> some View {
    Group {
        if !questionItem.term.isEmpty {
            // 年号を表示
        }
        if !questionItem.etymology.isEmpty {
            // 解説を表示
        }
        // ...
    }
}
```

### 2. 共通ヘルパー関数
`labelFor(_:fallback:)`関数でラベル取得ロジックを共通化：
```swift
private func labelFor(_ key: String, fallback: String) -> String {
    if let header = headerLabels[key], !header.isEmpty {
        return header.hasSuffix(":") ? header : "\(header):"
    }
    return fallback
}
```

### 3. CSV種類の自動判定
ヘッダラベルの内容から自動的にCSV種類を判定し、適切な表示関数を呼び出し：
```swift
let csvType = detectCSVType(from: headerLabels)

switch csvType {
case .history:
    displayHistoryDetails(questionItem, textColor)
case .classical:
    displayClassicalDetails(questionItem, textColor)
case .english:
    displayEnglishDetails(questionItem, textColor)
}
```

---

## ✅ 検証結果

### ビルド結果
- **コンパイルエラー**: なし ✅
- **警告**: なし ✅
- **ビルドステータス**: BUILD SUCCEEDED ✅

### コード品質
- **構文チェック**: 正常 ✅
- **型チェック**: 正常 ✅
- **ViewBuilder構文**: 正しく動作 ✅

---

## 🎯 対応するCSVファイル

### 自動判定されるCSV種類

1. **中学歴史** (`history`)
   - ヘッダ: `年号,登場人物,史実名,解説,関連史実,関連分野,難易度`
   - 判定条件: 「年号」「登場人物」「史実」が含まれる

2. **中学古典単語** (`classical`)
   - ヘッダ: `語句,読み（ひらがな）,意味,語源等解説（日本語）,関連語と意味,関連分野,難易度`
   - 判定条件: 「ひらがな」が含まれる

3. **中学英単語・英熟語・英会話・xcode** (`english`)
   - ヘッダ: `語句,発音（カタカナ）,和訳,語源等解説（日本語）,関連語（英語）と意味（日本語）,関連分野（日本語）,難易度`
   - 判定条件: 「カタカナ」「発音」「和訳」が含まれる

---

## 🚀 今後の拡張性

### 新しいCSV種類の追加
新しいCSV種類を追加する場合：

1. `CSVType` enumに新しいケースを追加
2. `detectCSVType`関数に判定ロジックを追加
3. 専用の表示関数を作成（例: `displayNewTypeDetails`）
4. `switch`文に新しいケースを追加

### カスタマイズ可能な点
- 表示順序の変更（関数内の順序を入れ替え）
- 表示する項目の追加/削除（条件分岐で制御）
- ラベルのカスタマイズ（`labelFor`のフォールバック値を変更）

---

## 📝 まとめ

### 達成できたこと
✅ CSV種類を自動判定する機能を実装  
✅ 中学歴史の最適な表示順序を実装  
✅ 中学古典単語の最適な表示順序を実装  
✅ 中学英単語・英会話の最適な表示順序を実装（発音表示を含む）  
✅ メインテキストとの重複を排除  
✅ 動的なラベル表示に対応  
✅ すべてのビルドエラー・警告を解消  

### ユーザーへの影響
- CSV種類に応じた最適な情報表示順序
- 各科目の学習に必要な情報が適切な順序で表示される
- 画面が読みやすく、理解しやすい
- 英語学習では発音が語句の直後に表示され、学習効率が向上

### 次のステップ
アプリを起動して以下を確認してください：
1. **中学歴史**で回答後、年号→解説→登場人物の順に表示される
2. **中学古典単語**で回答後、語句→読み→用法の順に表示される
3. **中学英会話**で回答後、語句(発音)→語源等解説→関連語の順に表示される
4. すべてのCSVで適切な表示順序になっている

---

**以上、CSV種類別の最適な表示順序の実装が完了しました！** 🎉
