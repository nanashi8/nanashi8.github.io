---
description: テスト実装時の必須確認事項と品質基準
applyTo: 'tests/**'
priority: critical
---

# テスト実装ガイドライン（必須遵守）

## 🚨 テスト実装前の必須確認事項

### 1. 仕様書の確認（MUST）
テストコードを書く前に、**必ず以下を確認**すること:

- [ ] データ構造の仕様書を読む
- [ ] サンプルデータを実際に確認する
- [ ] フォーマット・命名規則を理解する
- [ ] 既存の実装コードを確認する
- [ ] コメント・ドキュメントを読む

**❌ 絶対にやってはいけないこと:**
- 仕様を確認せずに「推測」でテストを書く
- サンプルデータを見ずにバリデーションルールを決める
- 既存の動作を壊すテストを追加する

### 2. データフォーマットの確認手順

#### CSVファイルのテスト実装時
```typescript
// ❌ NG: 推測でパース
const parts = line.split(',');

// ✅ OK: 実際のデータを確認してから実装
// 1. まずサンプル行を表示
console.log('Sample CSV line:', lines[1]);

// 2. ダブルクォート・カンマ含有を確認
// 3. 適切なパーサーを選択
```

#### JSONファイルのテスト実装時
```typescript
// ❌ NG: 推測で型定義
type Question = {
  id: string;
  text: string; // 本当にtext?
};

// ✅ OK: 実際のJSONを読んで型定義
// 1. public/data/から実ファイルを読む
// 2. フィールド名・型を確認
// 3. 正確な型定義を作成
```

### 3. フォーマット仕様の確認

**例: IPA発音記号の仕様**
```
❌ 誤った仮定: "IPA記号のみ"
✅ 実際の仕様: "IPA記号 (カタカナ読み)"

実例:
- 正しい: ˈeɪ.bl̩ (エ́イブル)
- 誤って検出: "カタカナ混入"と判定 ← 仕様違反
```

### 4. テスト実装チェックリスト

#### Phase 1: 調査（実装前）
- [ ] 対象ファイルのパスを確認
- [ ] 実際のファイルを開いて内容を確認
- [ ] 先頭5-10行をログ出力して構造を理解
- [ ] 既存のパーサー・ローダーコードを確認
- [ ] 仕様書・README・コメントを読む

#### Phase 2: 設計（テスト設計）
- [ ] 何をテストするか明確化
- [ ] 期待する動作を定義
- [ ] エッジケースをリストアップ
- [ ] 既存動作を壊さないか確認

#### Phase 3: 実装（コーディング）
- [ ] サンプルデータで動作確認
- [ ] エラーメッセージを分かりやすく
- [ ] 失敗時に詳細情報を出力
- [ ] 既存テストが通ることを確認

#### Phase 4: 検証（実行後）
- [ ] テスト結果が妥当か確認
- [ ] 誤検出していないか確認
- [ ] エラーメッセージが正確か確認
- [ ] 仕様に沿っているか最終確認

## 📋 データフォーマット仕様一覧

### Vocabulary CSV
```csv
語句,読み,意味,語源等解説,関連語,関連分野,難易度
able,ˈeɪ.bl̩ (エ́イブル),〜できる,"...",関連語,人・社会,beginner
```

**重要な仕様:**
- 列数: 7列（語句,読み,意味,語源等解説,関連語,関連分野,難易度）
- 読み: IPA記号 + (カタカナ読み) の形式
- ダブルクォート: 語源等解説・関連語はカンマを含むため"で囲まれる
- 難易度: beginner/intermediate/advanced
- 関連分野: 日本語（人・社会、言語基本、場所・移動 等）

### Grammar JSON
```json
{
  "id": "vf-g1-u0-001",
  "japanese": "私は学生です",
  "sentence": "I ____ a student.",
  "choices": ["am", "is", "are", "be"],
  "correctAnswer": "am",
  "difficulty": "beginner",
  "explanation": "...",
  "hint": "..."
}
```

**重要な仕様:**
- ID形式: {type}-g{grade}-u{unit}-{number}
- 空欄マーカー: ____ (4つのアンダースコア)
- 選択肢: 必ず4つ
- difficulty: beginner/intermediate/advanced

## 🔧 パイプライン統合

### Pre-commit Hook拡張
```bash
# tests/ 配下のファイルをコミット時にチェック
if git diff --cached --name-only | grep -q "^tests/"; then
  echo "📋 テストファイルの変更を検出"
  echo "⚠️  以下を確認してください:"
  echo "  1. 仕様書を確認しましたか？"
  echo "  2. 実際のデータを確認しましたか？"
  echo "  3. 既存の動作を壊していませんか？"
  
  # 対話的確認を追加予定
fi
```

## ⚠️ よくある失敗パターン

### パターン1: CSV分割の誤り
```typescript
// ❌ 間違い
line.split(',') // ダブルクォート内のカンマも分割される

// ✅ 正しい
// ダブルクォート対応のCSVパーサーを使用
```

### パターン2: フォーマット仕様の誤解
```typescript
// ❌ 間違い: "IPA記号にカタカナ混入"と誤検出
expect(ipa).not.toMatch(/[\u30A0-\u30FF]/);

// ✅ 正しい: 仕様に沿った検証
// 仕様: "IPA (カタカナ)" の形式
expect(ipa).toMatch(/^[IPA文字]+\s*\([カタカナ]+\)$/);
```

### パターン3: 型定義の推測
```typescript
// ❌ 間違い: フィールド名を推測
type Question = {
  text: string, // 実際は "sentence"
}

// ✅ 正しい: 実ファイルから確認
type Question = {
  sentence: string, // 実データを確認済み
}
```

## 📖 参考ドキュメント

テスト実装前に必ず確認すべきドキュメント:
- `docs/specifications/` - データ構造仕様
- `README.md` - プロジェクト概要
- `public/data/` - 実際のデータファイル
- `src/` - 実装コード（パーサー・ローダー）

## 🎯 品質基準

### テストの品質基準
- [ ] 誤検出率 0%
- [ ] 仕様違反を100%検出
- [ ] 既存動作への影響 0%
- [ ] エラーメッセージが明確

### ドキュメント品質基準
- [ ] テストの意図が明確
- [ ] 検証ロジックの根拠を記載
- [ ] エッジケースの説明あり
- [ ] 誤検出時の修正手順あり

---

**重要:** このガイドラインに従わないテストは、アプリケーションを破壊する可能性があります。
必ず仕様確認を最優先してください。
