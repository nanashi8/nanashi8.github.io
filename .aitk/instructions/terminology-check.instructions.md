---
description: プロジェクト固有の用語・変数・関数名を扱う際の事前確認ルール
applyTo: '**'
priority: critical
---

# 用語確認必須ルール

## 原則

**プロジェクト固有の命名規則や特殊な意味を持つ用語を扱う際は、必ずサーバントの用語辞書で確認する**

## トリガー条件（以下に該当する場合は必ず確認）

### 1. パラメータ・変数の追加/変更時
- 既存の命名パターンに似た名前を使う場合
- `is～`, `last～`, `～Ref`などの接頭辞/接尾辞付き変数
- 例：`isSkipped`, `lastAnswerCorrectRef`, `questionStartTimeRef`

### 2. 既存関数の呼び出しパラメータ変更時
- 関数シグネチャに新しいパラメータを追加する場合
- オプショナルパラメータの意味が不明確な場合
- 例：`processAnswerAndGetNext()`の`isSkipped`パラメータ

### 3. 複数ファイルで使用されている用語
- `grep_search`で複数の使用箇所が見つかった場合
- テストファイルに使用例がある場合

### 4. コメントや型定義に「専用」「特殊」などの記述がある場合
- 例：「スキップボタン専用」「Tell, Don't Ask専用」

## 確認手順

### Step 1: まず用語辞書を確認
```bash
python3 scripts/project_ai_servant.py --query-term <用語名>
```

### Step 2: 辞書に無い場合はgrep検索
```bash
grep_search(query="<用語名>", includePattern="**/*.{ts,tsx}")
```

### Step 3: テストコードで使用例を確認
- `tests/unit/*.test.ts`内の実際の使用例を読む
- コメントから意図を理解する

### Step 4: 型定義で仕様を確認
- `src/types.ts`や関数定義の型から仕様を確認
- オプショナル（`?`）かどうか、デフォルト値は何か

## 過去の失敗例と教訓

### 失敗例1: `isSkipped`の誤用
**状況**: 初回問題の記録スキップに`isSkipped=true`を使おうとした

**問題**: `isSkipped`は「スキップボタンを押した場合」専用で、正解扱い（定着済み）として記録される

**正しい対応**: 
- サーバント確認：`python3 scripts/project_ai_servant.py --query-term isSkipped`
- 出力を確認：「使用禁止: 初回問題や未回答状態の表現には使わない」

**教訓**: オプショナルパラメータの意味は推測せず、必ず確認する

## 実装ワークフロー

```
コード変更を検討
    ↓
既存用語・パラメータを使う？
    ↓ YES
サーバントで用語確認 ← 【ここが重要】
    ↓
意味・制約を理解
    ↓
テストコードで使用例確認
    ↓
実装
    ↓
型チェック・テスト実行
```

## チェックリスト

コード変更前に以下を確認：

- [ ] 使用するパラメータ・変数の意味を理解しているか？
- [ ] サーバントの用語辞書で確認したか？
- [ ] テストコードで使用例を確認したか？
- [ ] 「～専用」「特殊な意味」などの制約を理解したか？
- [ ] アンチパターンに該当していないか？

## サーバント用語辞書の拡張

新しい重要な用語を発見した場合：

1. `scripts/context_database.py`の`_load_terminology()`に追加
2. 以下の情報を記載：
   - `type`: parameter/variable/function/enum/type
   - `location`: ファイルパスと行番号
   - `purpose`: 目的
   - `behavior`: 動作（特に副作用）
   - `when_to_use`: 使用すべき場面
   - `when_not_to_use`: 使用禁止の場面
   - `anti_patterns`: よくある誤用例
   - `test_example`: テストファイルでの使用例

## 緊急時の対応

既に誤用してしまった場合：

1. サーバントで正しい意味を確認
2. `grep_search`で影響範囲を特定
3. 修正前に全テスト実行
4. 修正実装
5. 再度テスト実行で検証
6. 用語辞書に誤用例を追加（再発防止）

## まとめ

**「推測するな、確認しろ」**

プロジェクト固有の用語は、一見明白に見えても特殊な意味を持つ可能性がある。
数秒の確認で、数十分のデバッグを回避できる。
