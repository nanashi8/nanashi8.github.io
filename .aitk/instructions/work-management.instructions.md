---
description: 作業管理とタスク制限ルール - 15分ルール、段階的実施、進捗記録の徹底
applyTo: '**'
priority: CRITICAL
---

# 作業管理ルール（強制適用）

## 📌 適用範囲
**すべての作業** - 機能追加、バグ修正、リファクタリング、ドキュメント作成

## 🔢 段階的実施ルール（厳守）

### 原則
各作業は**3-5ステップ以内に分割**し、各ステップは**独立してcommit可能**にする。

### 実施方法
```
✅ 良い例:
Step 1: TypeScript型定義を追加 → commit
Step 2: 実装コード追加 → commit  
Step 3: テスト追加 → commit
→ 各ステップが5-10ファイル以内、独立して動作

❌ 悪い例:
Step 1: 30ファイル変更 → commit
→ ユーザーが途中で中断できない
→ レビュー不可能
```

### AIが検知可能なトリガー（自動中断）

私（AI）が以下を検知したら**即座に中断**：

| トリガー | 検知方法 | アクション |
|---------|---------|----------|
| **ファイル数超過** | 10ファイル以上変更 | 進捗記録 → commit提案 |
| **ツール連続失敗** | 同一ツール3回失敗 | アプローチ変更提案 |
| **コード量超過** | 1ファイル100行以上変更 | ステップ分割提案 |
| **ステップ数超過** | 5ステップ以上計画 | タスク分割提案 |
| **ターミナル実行前** | テスト/ビルド/インストール | タイムアウト設定（必須） |

### ステップ分割の具体例

```markdown
❌ 悪い計画:
Task: progressStorage.ts (3607行) をリファクタリング

✅ 良い計画:
Step 1 (3ファイル): 型定義を分離 → commit
Step 2 (2ファイル): Core機能を抽出 → commit
Step 3 (2ファイル): Statistics機能を抽出 → commit
→ 各ステップで動作確認可能
```

---

## 📋 作業開始前のチェックリスト

すべての作業開始時に以下を確認：

```markdown
□ `docs/.copilot-work-management.md`を開いた
□ 現在の作業履歴セクションを確認した
□ タスクを15分単位のステップに分割した
□ 各ステップのcommitポイントを決めた
```

---

## ⏱️ ターミナルコマンド保護ルール（厳守）

### 原則
**すべてのターミナルコマンドに明示的なタイムアウトを設定する**

### タイムアウト設定（必須）

| コマンド種別 | タイムアウト | 実装方法 |
|------------|------------|---------|
| **テスト実行** | 60秒 | `timeout 60s npm test` |
| **ビルド** | 120秒 | `timeout 120s npm run build` |
| **パッケージインストール** | 180秒 | `timeout 180s npm install` |
| **Lint/Format** | 30秒 | `timeout 30s npm run lint` |
| **型チェック** | 45秒 | `timeout 45s npm run type-check` |

### macOS対応

```bash
# macOSではgtimeoutが必要
# 初回のみインストール
brew install coreutils

# 使用例
gtimeout 60s npm test
gtimeout 120s npm run build
```

### バックグラウンド実行（推奨）

長時間かかる可能性があるコマンドは**バックグラウンド実行**：

```typescript
// ❌ 悪い例：完了まで待機
run_in_terminal("npm test", isBackground: false)
→ ユーザーが中断できない

// ✅ 良い例：バックグラウンド実行
run_in_terminal("npm test", isBackground: true)
→ 他の作業を並行実施
→ get_terminal_output()で結果確認
```

### 実行前の警告（必須）

ターミナルコマンド実行前に**必ず通知**：

```markdown
⏱️ テストを実行します（タイムアウト: 60秒）
- バックグラウンドで実行します
- 完了後に結果を確認します
```

---

## 📝 進捗記録（必須）

### 作業開始時
`docs/.copilot-work-management.md`の「作業履歴」セクションに追記：

```markdown
### YYYY-MM-DD HH:MM: [タスク名]

**目的**: 
**分割ステップ**:
- Step 1 (見積10分): XXX → commitポイント
- Step 2 (見積12分): YYY → commitポイント
- Step 3 (見積8分): ZZZ → commitポイント

**開始時刻**: HH:MM
```

### 各ステップ完了時
```markdown
- ✅ Step 1完了 (実績9分) - commit: abc1234
```

### 中断時
```markdown
**中断理由**: [15分超過/ユーザー指示/エラー発生]
**完了率**: XX%
**次回開始手順**:
1. XXXファイルを開く
2. YYY関数を確認
3. ZZZを実装
```

---

## 🚨 自動中断トリガー（AI検知可能）

私（AI）が以下を検知したら**自動的に作業中断**：

| トリガー | 検知方法 | アクション |
|---------|---------|----------|
| **ファイル数超過** | git status で10ファイル以上変更検知 | 進捗記録 → commit → 報告 |
| **ツール連続失敗** | 同一ツール3回連続失敗 | アプローチ変更提案 |
| **コード量超過** | 1ファイル100行以上変更 | ステップ分割 → commit |
| **長時間ツール実行** | 30秒以上応答なし | 別タスク提案（並行作業） |
| **エラー多発** | 5個以上のエラー検出 | 段階的修正提案 |

---

## ✅ 完了報告ルール

### タスク完了時は即座に報告

```markdown
✅ 完了しました

**実施内容**:
- [簡潔な箇条書き]

**commit**: abc1234
**所要時間**: XX分
```

### ❌ 禁止事項
- 完了後に追加作業を探す
- 完了後にリファクタリングを始める
- 完了後に関連タスクを見つけて実施

→ **ユーザーの指示を待つ**

---

## 📊 作業記録の確認

定期的に`docs/.copilot-work-management.md`を開いて確認：

```bash
# 最近の作業履歴
cat docs/.copilot-work-management.md | grep "###" | tail -5

# 平均作業時間
# 15分以内に収まっているか確認
```

---
（AIが測定可能）

- ✅ 1ステップあたりのファイル数: 10ファイル以内
- ✅ 1ステップあたりのコード量: 100行以内/ファイル
- ✅ タスク完了率: 80%以上  
- ✅ 中断後の再開成功率: 95%以上
- ✅ ツール呼び出し回数: 1ステップ15回5%以上
- ✅ ユーザー待機時間: 2分以内

---

## 📚 関連ドキュメント

- [作業管理詳細](../../docs/.copilot-work-management.md) - 全ルールの詳細
- [進捗記録パターン](./progress-tracking-patterns.instructions.md) - 記録例
- [リファクタリング安全ガイド](./refactoring-safety.instructions.md) - 大規模変更の分割方法

---

**最終更新**: 2025-12-15  
**優先度**: CRITICAL  
**違反時**: 作業やり直し
