---
description: 仕様書遵守強制ルール - ユーザーの明示的指示なしに既存仕様・設定値を変更してはならない
applyTo: '**'
---

# 仕様書遵守強制ルール

## 🚨 最優先確認事項

**コード修正前に必ず以下を確認してください：**

1. **modification-enforcement.instructions.md** - 修正前の強制チェックリスト【最優先】
2. **batch-system-enforcement.instructions.md** - バッチ方式の絶対原則
3. **position-hierarchy-enforcement.instructions.md** - Position階層の不変条件
4. **category-slots-enforcement.instructions.md** - カテゴリースロット方式

## 🚨 絶対原則

**ユーザーの明示的な指示がない限り、既存の仕様・設定値を変更してはならない**

## ⚠️ 違反の典型例

### 例1: 音声速度の勝手な変更
```typescript
// ❌ 禁止
utterance.rate = 0.95; // 0.85から勝手に変更

// ✅ 理由: 0.85は「高校受験用に調整済み」という仕様
// ✅ ユーザーの質問「流暢な音声はないか？」≠「速度を上げろ」
```

### 例2: レイアウトの最適化
```tsx
// ❌ 禁止（ユーザー指示なし）
<div className="grid grid-cols-2 gap-6"> // flexからgridに変更

// ✅ 既存UIは調整済み、勝手な最適化は副作用を生む
```

### 例3: デフォルト値の変更
```typescript
// ❌ 禁止
const DEFAULT_SPEED = 1.0; // 0.85から変更

// ✅ 既存値には理由がある
```

---

## 🔒 変更前の必須確認

### 確認すべきドキュメント

1. **CRITICAL_RULES.md** - 絶対禁止事項
2. **該当ファイルのコメント** - 設定理由
3. **README.md** - プロジェクト方針
4. **仕様書** - 機能仕様

### 確認すべき項目

```markdown
□ 既存の設定値とその理由を確認した
□ 「調整済み」「最適化済み」等のコメントを確認した
□ ユーザーの真の意図を理解した（質問 vs 変更指示）
□ 変更が他の機能に影響しないか確認した
```

---

## 🚫 変更禁止の判断基準

### ケース1: 理由付きの設定値

```typescript
// ❌ 変更禁止
utterance.rate = 0.85; // 高校受験用に調整済み
const FONT_SIZE = 16; // 視認性を考慮
```

**理由**: コメントに「調整済み」「最適化済み」等がある

### ケース2: デフォルト値・定数

```typescript
// ❌ 変更禁止
const DEFAULT_SPEED = 0.85;
const MAX_RETRIES = 3;
```

**理由**: 既存の動作を変えうる

### ケース3: レイアウト構造

```tsx
// ❌ 変更禁止（ユーザー指示がない限り）
<div className="flex flex-col gap-4">
```

**禁止される変更**:
- `flex` ↔ `grid` の変更
- `gap-*`, `space-*` の大幅変更
- `w-*`, `h-*` の変更
- `relative`, `absolute`, `fixed` の変更
- `m-*`, `p-*` の大幅変更

**理由**: 
- 既存UIはユーザー体験のため調整済み
- レスポンシブ対応に影響
- アクセシビリティに影響
- 他のコンポーネントとの整合性が崩れる

### ケース4: スタイル値（CSS）

```css
/* ❌ 変更禁止 */
--border-radius: 8px; /* UI統一のため固定値 */
--transition-duration: 200ms; /* UX最適化済み */
```

---

## ✅ 質問の意図を正確に理解する

### 質問 ≠ 変更指示

| ユーザーの質問 | 誤った解釈 | 正しい理解 |
|-------------|----------|----------|
| 「流暢な音声はないか？」 | 速度を上げる | 音声エンジンの品質改善 |
| 「見やすくできないか？」 | レイアウト変更 | 現在の問題点を質問 |
| 「もっと速くならないか？」 | 設定値変更 | パフォーマンス改善方法の提案 |

### 正しい対応フロー

```
1. ユーザーの質問を受け取る
   ↓
2. 「変更指示」か「情報要求」かを判断
   ↓
3. 情報要求の場合 → 選択肢を提案
   変更指示の場合 → 既存仕様を確認
   ↓
4. 既存仕様に理由がある場合 → ユーザーに確認
   ↓
5. ユーザーの明示的承認後 → 変更実施
```

---

## 🔧 許可される変更

### 1. ユーザーが明示的に指示した変更

```
ユーザー: "音声速度を0.95に変更してください"
→ ✅ OK
```

### 2. バグ修正

```typescript
// ✅ OK: バグ修正
if (value === undefined) { // 以前: value == undefined
```

### 3. 新機能の追加（既存動作は維持）

```typescript
// ✅ OK: 新オプション追加、既存動作は変えない
const VOICE_QUALITY_LEVELS = ['high', 'medium', 'low'];
```

---

## 📋 変更前のチェックリスト

```markdown
変更を実施する前に、以下を確認してください:

□ ユーザーの指示が「明示的な変更指示」であることを確認した
□ 既存のコメント・仕様書を読んだ
□ 「調整済み」「最適化済み」等の記述がないことを確認した
□ 変更が他の機能に影響しないことを確認した
□ 疑問点はユーザーに質問した
```

---

## 🚨 違反時の対応

### 誤って変更してしまった場合

1. **即座に元に戻す**
```bash
git checkout HEAD -- <ファイル>
```

2. **ユーザーに報告**
```
申し訳ありません。誤って[変更内容]を変更してしまいました。
元に戻しました。
```

3. **原因を記録**
```
違反理由: [なぜ変更してしまったか]
防止策: [今後どうするか]
```

---

## 📚 関連ドキュメント

- [CSS修正ルール](./css-modification-rules.instructions.md) - CSS変更の詳細
- [work-management](./work-management.instructions.md) - 作業管理ルール

---

## 🎯 行動原則

1. **ユーザーの指示を最優先する**
2. **勝手な「改善」「最適化」はしない**
3. **迷ったら確認する**
4. **間違えたら即座に修正して報告する**

---

**このルールを守れないAIは、このプロジェクトで作業してはいけません。**

**最終更新**: 2025-12-15
**優先度**: CRITICAL
